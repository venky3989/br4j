<!--

      Licensed to the Apache Software Foundation (ASF) under one or more
      contributor license agreements.  See the NOTICE file distributed with
      this work for additional information regarding copyright ownership.
      The ASF licenses this file to you under the Apache License, Version 2.0
      (the "License"); you may not use this file except in compliance with
      the License.  You may obtain a copy of the License at

          http://www.apache.org/licenses/LICENSE-2.0

      Unless required by applicable law or agreed to in writing, software
      distributed under the License is distributed on an "AS IS" BASIS,
      WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
      See the License for the specific language governing permissions and
      limitations under the License.

-->
﻿<?xml version="1.0" encoding="UTF-8"?>
<queries process-package="com.aplana.dbmi.jbr.processors">

	<object type="Card">
		<store>
			<!-- Шаблон Запрос на смену рассматривающего: 967 -->
			<specific property="template" value="jbr.request.change">
				<specific property="state" value="draft">
					<!-- Размещает валидаторы с перехода "На рассмотрение", чтобы не было возможности сохранить карточку в статусе Черновик без осуществления перехода -->
						<validator class="TestEmptyAttrProcessor" runOrder="10">
							<parameter name="test_attr" value="list:jbr.request.type"/>
							<parameter name="must_empty" value="false"/>
							<parameter name="empty_message" value="Атрибут Тип запроса должен быть заполнен."/>
						</validator>
						<validator class="TestEmptyAttrProcessor" runOrder="12">
							<parameter name="test_attr" value="link:jbr.request.cons"/>
							<parameter name="must_empty" value="false"/>
							<parameter name="empty_message" value="Атрибут Рассматривающий должен быть заполнен."/>
						</validator>
						<!-- Выбранная карточка Рассмотрение(или соответствующая текущему рассматривающему) должна 
							 содержать отвественного рассматривающего, если тип запроса "Смена ответственного рассматривающего"
							 Так же статус карточки рассмотрения должен быть отличным от Отменено и Корзина
						-->
						<validator class="ComparationListAttr" runOrder="15">
							<parameter name="test_attr" value="jbr.request.type=jbr.considerator.change.respon"/>
							<parameter name="compare_path" value="jbr.request.cons"/>
							<parameter name="ignored_states" value="poruchcancelled,trash"/>
							<parameter name="compare_attr" value="jbr.responsibility.consider=jbr.commission.control.yes"/>
							<parameter name="error_message" value="Запрос на смену ответственного рассматривающего может создаваться только для сотрудника, являющегося ответственным рассматривающим"/>
						</validator>
						<validator class="TestEmptyAttrProcessor" runOrder="20">
							<parameter name="test_attr" value="datedTypedLink:jbr.request.new"/>
							<parameter name="condition" value="list:jbr.request.type=jbr.considerator.change,jbr.considerator.change.respon,jbr.considerator.add"/>
							<parameter name="must_empty" value="false"/>
							<parameter name="empty_message" value="Атрибут Новые рассматривающие должен быть заполнен."/>
						</validator>
						<validator class="TestEmptyAttrProcessor" runOrder="30">
							<parameter name="test_attr" value="date:jbr.request.change"/>
							<parameter name="condition" value="list:jbr.request.type=jbr.considerator.change.term"/>
							<parameter name="must_empty" value="false"/>
							<parameter name="empty_message" value="Атрибут Изменение срока должен быть заполнен."/>
						</validator>
						<validator class="TestEmptyAttrProcessor" runOrder="40">
							<parameter name="test_attr" value="text:jbr.request.comm"/>
							<parameter name="must_empty" value="false"/>
							<parameter name="empty_message" value="Атрибут Комментарий должен быть заполнен."/>
						</validator>
				</specific>
					<!-- Оставляем валидатор только для проверки статусов карточек Рассмотрение -->
					<!--validator class="ComparationListAttr" runOrder="5">
						<parameter name="compare_path" value="jbr.maindoc.request->jbr.exam.set"/>
						<parameter name="ignored_states" value="poruchcancelled,trash"/>
		    			<parameter name="error_message" value="Запрос на смену рассматривающего может создаваться только для сотрудника, для которого есть карточка Рассмотрение в любом статусе кроме Отменен и Корзина"/>
		    		</validator-->
		    		<!--post-process class="CopyCardLink" runOrder="50">
						<parameter name="from" value="->jbr.maindoc.request@jbr.exam.set"/>
						<parameter name="to" value="@jbr.request.cons"/>
						<parameter name="merge" value="false"/>
						<parameter name="condition" value="link:jbr.request.cons=NULL"/>
						<parameter name="from_condition1" value=".state#poruchcancelled"/>
						<parameter name="from_condition2" value=".state#trash"/>
						<parameter name="from_condition3" value="user:jbr.exam.person=CURRENT_USER,BOSS"/>
					</post-process-->
				<post-process class="FillNewConsideratorProcessor" runOrder="5"/>
		   		<!--/specific-->
				<post-process class="DeepGenerateName" runOrder="1000">
 					<parameter name="format" value="Запрос {0} от {1} (автор {2}) по документу {3} от {4}"/>
  					<parameter name="dstAttrId" value="NAME"/>
 					<parameter name="srcAttrIds" value=" 
 					list: jbr.request.type;
  					date: created;
 					link: jbr.request.cons@jbr.exam.person@jbr.person.lastnameNM;
 					link: jbr.maindoc.request@regnumber;
  					link: jbr.maindoc.request@regdate;
  					"/>
  					<parameter name="forceSave" value="true" />
					<parameter name="forceSaveMode" value="ATTRIBUTE" />
  				</post-process>
			</specific>
			<!-- Шаблон Импорта: 966 -->
			<specific property="template" value="jbr.import">
				<specific property="state" value="published">
					<validator class="TestEmptyAttrProcessor" runOrder="1">
						<parameter name="test_attr" value="list:jbr.loadingDict"/>
						<parameter name="empty_message" value="Атрибут Загружаемый справочник должен быть заполнен."/>
					</validator>
					<validator class="TestEmptyAttrProcessor" runOrder="2">
						<parameter name="test_attr" value="link:jbr.files"/>
						<parameter name="empty_message" value="Атрибут Вложения должен быть заполнен."/>
					</validator>
					<validator class="CheckAttributeUniquenessProcessor" runOrder="3">
						<parameter name="attrIds" value="list:jbr.loadingDict"/>
						<parameter name="statusIds" value="published"/>
						<parameter name="error_message" value="Значение атрибута Загружаемый справочник должно быть уникальным среди карточек текущего шаблона"/>
					</validator>
				</specific>
				<post-process class="DeepGenerateName" runOrder="1">
					<parameter name="format" value="{0}" />
					<parameter name="dstAttrId" value="string: name" />
					<parameter name="srcAttrIds" value="list: jbr.loadingDict" />
					<parameter name="forceSave" value="true" />
					<parameter name="forceSaveMode" value="ATTRIBUTE" />
				</post-process>
			</specific>
			<!-- Шаблон Типовые резолюции АРМа: 545 -->
			<specific property="template" value="jbr.ARMResolut">
				<validator class="TestEmptyAttrProcessor">
					<parameter name="test_attr" value="text:jbr.typeResolution.resolution"/>
					<parameter name="must_empty" value="false"/>
					<parameter name="empty_message" value="Атрибут Текст резолюции должен быть заполнен."/>
				</validator>
				<pre-process class="GenerateName" runOrder="5">
					<parameter name="format" value="{0}" />
					<parameter name="dstAttrId" value="string: name" />
					<parameter name="srcAttrIds" value="text: jbr.typeResolution.resolution" />
				</pre-process>
			</specific>
			<!-- Шаблон Список внутренних персон: 1204 -->
			<specific property="template" value="jbr.acquaintanceList">
				<!-- (fix)BR4J00034336 -->
				<!-- Возвращаем проверку BR4J00035384 -->
				<validator class="CheckRequiredAttributes"/>
			</specific>
			<!-- Для Образец входящего и Образец исходящего делаем атрибут Имя обязательным -->
			<specific property="template" value="jbr.incomingExample">
				<validator class="TestEmptyAttrProcessor">
					<parameter name="test_attr" value="string:name"/>
					<parameter name="empty_message" value="Атрибут Название должен быть заполнен."/>
				</validator>
			</specific>
			<specific property="template" value="jbr.outcomingExample">
				<validator class="TestEmptyAttrProcessor">
					<parameter name="test_attr" value="string:name"/>
					<parameter name="empty_message" value="Атрибут Название должен быть заполнен."/>
				</validator>
			</specific>
			
			<!-- Шаблон Список внешних персон: 944 -->
			<specific property="template" value="jbr.distributionList">
				<!-- (fix)BR4J00034336 -->
				<!-- Возвращаем проверку BR4J00035384 -->
				<validator class="CheckRequiredAttributes"/>
			</specific>

			<!-- Шаблон Сертификат: 1228 -->
			<specific property="template" value="jbr.certificate">
				<validator class="TestEmptyAttrProcessor" runOrder="2">
					<parameter name="test_attr" value="string:jbr.certificate.cert"/>
					<parameter name="empty_message" value="Атрибут Сертификат должен быть заполнен."/>
				</validator>
				<pre-process class="GenerateCertificateName" />
			</specific>

			<!-- Шаблон Хранение документа: 1244 -->
			<specific property="template" value="jbr.paper_storage">
				<validator class="TestEmptyAttrProcessor">
					<parameter name="test_attr" value="link:namelist.index"/>
					<parameter name="must_empty" value="false"/>
					<parameter name="empty_message" value="Атрибут Индекс номенкулатуры должен быть заполнен."/>
				</validator>
			</specific>

			<!-- Шаблон Информация о регистрации: 1284 -->
			<specific property="template" value="jbr.regInfo">
				<pre-process class="GenerateName" runOrder="5">
					<parameter name="format" value="{0} от {1}, {2}" />
					<parameter name="dstAttrId" value="string: name" />
					<parameter name="srcAttrIds" value="
						string: regnumber; 
						date:regdate; 
						link: jbr.regInfo.sourceOrganization@jbr.organization.shortName;" />
				</pre-process>
			</specific>

			<!-- Шаблон Визирование: 348 -->
			<specific property="template" value="jbr.visa" async="false">
				<pre-process class="GenerateName" runOrder="5">
					<parameter name="format" value="{0}" />
					<parameter name="dstAttrId" value="text: DESCR" />
					<parameter name="srcAttrIds" value="date: JBR_VISA_TODATE" />
				</pre-process>
				<!-- Keywords for search -->
				<pre-process class="GenerateName" runOrder="10">
					<parameter name="format" value="{0}; {1}; {2}" />
					<parameter name="dstAttrId" value="string: KEYWORDS" />
					<parameter name="srcAttrIds"
						value="
						user: jbr.visa.person;
						user: jbr.visa.actual_consent;
						text: jbr.visa.decision
					" />
					<parameter name="maxArgStrLen" value="500" />
				</pre-process>

				<!--  Срочность из документа-основания -->
				<pre-process class="CopyAttributeFromParent" runOrder="15">
					<parameter name="parent" value="JBR_VISA_PARENT_DOC" />
					<parameter name="from" value="ADMIN_290575" />
					<parameter name="to" value="JBR_HOWFAST" />
					<parameter name="type" value="L" />
				</pre-process>

				<!-- (2013/11/27, YNikitin) При изменении Согласующего в статусе Согласование добавляем Согласующего в атрибут Предыдущий согласующий -->
				<specific property="state" value="agreement">
					<pre-process class="CopyAttributeToChildren" runOrder="16">
						<parameter name="from" value="jbr.visa.person" />
						<parameter name="to" value="jbr.visa.previous.person" />
						<parameter name="writeOperation" value="append" />
						<parameter name="changeAttribute" value="user:jbr.visa.person"/>
					</pre-process>
				</specific>

				<!-- Ответственный за ДОУ документа-основания -->
				<pre-process class="CopyPersonFromPaths" runOrder="20">
					<parameter name="targetAttr" value="jbr.responsible_dow.resp_dow.maindoc" />
					<parameter name="paths"
						value="
						backLink: jbr.visa.parent ->user:jbr.responsible_dow.resp_dow;
						backLink: jbr.visa.parent ->user:jbr.responsible_dow.resp_dow_read;
					" />
				</pre-process>

				<!--
					В случае если в поле согласующий несколько значений то создаем
					карточку согласующего на каждое значение
				-->
				<pre-process class="CteateVisaFromMultyNegotiators" runOrder="25" />

				<!-- Добавление версии в файлы вложений при сохранении документа -->
				<post-process class="IterationNumberAdditionToFiles" runOrder="30">
					<parameter name="IterationNumber" value="jbr.visa.visa.round" />
				</post-process>
				
				<!-- Обновляет поле NAME Визирование (348) -->
				<post-process class="CallOriginsProcessor" runOrder="100">
					<parameter name="backLinkAttrId" value="link: jbr.visa.enclosedSet" />
					<parameter name="processorClassName"
						value="com.aplana.dbmi.jbr.processors.DeepGenerateName" />
					<parameter name="format" value="{0}" />
					<parameter name="srcAttrIds"
						value="backLink: jbr.visa.parentVisa@NAME" />
					<parameter name="dstAttrId" value="NAME" />
					<parameter name="forceSave" value="true" />
					<parameter name="maxArgStrLen" value="-1" />
				</post-process>
				
			</specific>
			
			<!-- Шаблон Визирование (внешняя персона): 1184 -->
			<specific property="template" value="jbr.visa.ext">
				<!-- Keywords for search -->
				<pre-process class="GenerateName">
					<parameter name="format" value="{0}; {1}" />
					<parameter name="dstAttrId" value="string: KEYWORDS" />
					<parameter name="srcAttrIds"
						value="
						link: jbr.visa.ext.externalPerson;
						text: jbr.visa.ext.decision
					" />
					<parameter name="maxArgStrLen" value="500" />
				</pre-process>
			</specific>

			<!-- Шаблон Подписание: 365 -->
			<specific property="template" value="jbr.sign">

				<!-- Keywords for search -->
				<pre-process class="GenerateName" runOrder="10">
					<parameter name="format" value="{0}; {1}; {2}" />
					<parameter name="dstAttrId" value="string: KEYWORDS" />
					<parameter name="srcAttrIds"
						value="
						user: jbr.sign.person;
						text: jbr.sign.comment;
						user: jbr.sign.actual_signer
					" />
					<parameter name="maxArgStrLen" value="500" />
				</pre-process>

				<!--  Срочность из документа-основания -->
				<pre-process class="CopyAttributeFromParent" runOrder="15">
					<parameter name="parent" value="JBR_SIGN_PARENT" />
					<parameter name="from" value="ADMIN_290575" />
					<parameter name="to" value="JBR_HOWFAST" />
					<parameter name="type" value="L" />
				</pre-process>

				<!-- (2013/11/27, YNikitin) При изменении Подписанта в статусе Подписание добавляем Подписанта в атрибут Предыдущий подписант -->
				<specific property="state" value="sign">
					<pre-process class="CopyAttributeToChildren" runOrder="16">
						<parameter name="from" value="jbr.sign.person" />
						<parameter name="to" value="jbr.sign.previous.person" />
						<parameter name="writeOperation" value="append" />
						<parameter name="changeAttribute" value="user:jbr.sign.person"/>
					</pre-process>
				</specific>

				<!-- Ответственный за ДОУ документа-основания -->
				<pre-process class="CopyPersonFromPaths" runOrder="20">
					<parameter name="targetAttr" value="jbr.responsible_dow.resp_dow.maindoc" />
					<parameter name="paths"
						value="
						backLink: jbr.sign.parent -> user:jbr.responsible_dow.resp_dow;
						backLink: jbr.sign.parent -> user:jbr.responsible_dow.resp_dow_read;
					" />
				</pre-process>
				
				<pre-process class="GenerateName" runOrder="25">
					<parameter name="format" value="{0}" />
					<parameter name="dstAttrId" value="text: DESCR" />
					<parameter name="srcAttrIds" value="date: JBR_OUT_SIGNATORY" />
				</pre-process>
				
				<pre-process class="CopyPreviousManager" runOrder="26">
					<parameter name="from" value="JBR_SIGN_RESPONSIBLE" />
					<parameter name="to" value="JBR_OUT_SIGNATORY" />
				</pre-process>

				<!-- Добавление версии в файлы вложений при сохранении документа -->
				<post-process class="IterationNumberAdditionToFiles" runOrder="27">
					<parameter name="IterationNumber" value="jbr.sign.sign.round"/>
					<parameter name="filesAttr" value="jbr.sign.attachments"/>
				</post-process>



				<!-- Для АРМ руководителя -->
				<post-process class="CopyAttributeFromParent" runOrder="45">
					<parameter name="from" value="JBR_INFD_TYPEDOC" />
					<parameter name="to" value="JBR_C_INFD_TYPEDOC" />
					<parameter name="parent" value="JBR_SIGN_PARENT" />
				</post-process>

			</specific>

			<!-- Шаблон Рассмотрение: 504 -->
			<specific property="template" value="jbr.examination">
				<pre-process class="GenerateName" runOrder="5">
					<parameter name="format" value="{0}" />
					<parameter name="dstAttrId" value="text: DESCR" />
					<parameter name="srcAttrIds" value="date: JBR_RASSM_TODATE" />
				</pre-process>
				<!-- Keywords for search -->
				<pre-process class="GenerateName" runOrder="10">
					<parameter name="format" value="{0}; {1}" />
					<parameter name="dstAttrId" value="string: KEYWORDS" />
					<parameter name="srcAttrIds"
						value="
						user: jbr.exam.person;
						list: jbr.exam.leaderDecision 
					" />
					<parameter name="maxArgStrLen" value="500" />
				</pre-process>

				<!--
					Скопировать предыдущего рассматривающего в скрытый персон атрибут
					Адресат (JBR_INFD_RECEIVER) документа основания для предоставления
					прав доступа по этому атрибуту.
				-->
				<!-- (YNikitin, 2013/11/13, BR4J00034081) в рамках оптимизации системы, убираем лишние процессоры и донастраиваем оставшиеся, чтобы не было лишних пересчётов прав и лишних копирований атрибутов -->
				<!-- (YNikitin, 2013/11/29, BR4J00033966) Непонятно, зачем надо копировать рассматривающих из рассмотрения в атрибут Адресат -->
				<!-- pre-process class="CopyAttributeToChildren" runOrder="11">
					<parameter name="updateAccessList" value="true" />
					<parameter name="from" value="JBR_RASSM_PERSON" />
					<parameter name="linkAttrId" value="backLink:JBR_RASSM_PARENT_DOC" />
					<parameter name="to" value="JBR_INFD_RECEIVER" />
				</pre-process-->

				<!--  Срочность из документа-основания -->
				<pre-process class="CopyAttributeFromParent" runOrder="15">
					<parameter name="parent" value="JBR_RASSM_PARENT_DOC" />
					<parameter name="from" value="ADMIN_290575" />
					<parameter name="to" value="JBR_HOWFAST" />
					<parameter name="type" value="L" />
				</pre-process>

				<!-- (2014/04/07, YNikitin, BR4J00035578) Если Зона ДОУ пустая, то атрибут Зона ДОУ заполняется на основе Зоны ДОУ Автора и Зоны ДОУ Рассматривающего -->
				<pre-process class="CopyAttributeFromParent" runOrder="16">
					<parameter name="isOnlyModel" value="true" />
					<parameter name="attr_condition_2" value="link:jbr.zoneDOW=NULL"/>
					<parameter name="from" value="jbr.zoneDOW"/>
					<parameter name="to" value="jbr.zoneDOW"/>
					<parameter name="parent" value="author"/>
					<parameter name="parentTemplate" value="jbr.internalPerson"/>
					<parameter name="type" value="C"/>
				</pre-process>
				<pre-process class="CopyAttributeFromParent" runOrder="17">
					<parameter name="isOnlyModel" value="true" />
					<parameter name="attr_condition_2" value="link:jbr.zoneDOW=NULL"/>
					<parameter name="from" value="jbr.zoneDOW"/>
					<parameter name="to" value="jbr.zoneDOW"/>
					<parameter name="parent" value="jbr.exam.person"/>
					<parameter name="parentTemplate" value="jbr.internalPerson"/>
					<parameter name="type" value="C"/>
				</pre-process>
				<!-- (2014/04/07, YNikitin, BR4J00035578) Если Рассматривающий поменялся, то атрибут Зона ДОУ заполняется на основе Зоны ДОУ Автора и Зоны ДОУ Рассматривающего -->
				<pre-process class="CopyAttributeFromParent" runOrder="18">
					<parameter name="isOnlyModel" value="true" />
					<parameter name="from" value="jbr.zoneDOW"/>
					<parameter name="to" value="jbr.zoneDOW"/>
					<parameter name="parent" value="author"/>
					<parameter name="parentTemplate" value="jbr.internalPerson"/>
					<parameter name="writeOperation" value="preclear+overwrite"/>
					<parameter name="type" value="C"/>
					<parameter name="changeAttribute" value="user:jbr.exam.person"/>
				</pre-process>
				<pre-process class="CopyAttributeFromParent" runOrder="19">
					<parameter name="isOnlyModel" value="true" />
					<parameter name="from" value="jbr.zoneDOW"/>
					<parameter name="to" value="jbr.zoneDOW"/>
					<parameter name="parent" value="jbr.exam.person"/>
					<parameter name="parentTemplate" value="jbr.internalPerson"/>
					<parameter name="type" value="C"/>
					<parameter name="writeOperation" value="append" />
					<parameter name="changeAttribute" value="user:jbr.exam.person"/>
				</pre-process>
				
				<!-- (2013/11/27, YNikitin) При изменении Рассматривающего в статусе Рассмотрение добавляем Рассматривающего в атрибут Предыдущий рассматривающий -->
				<specific property="state" value="consideration">
					<pre-process class="CopyAttributeToChildren" runOrder="16">
						<parameter name="from" value="jbr.exam.person" />
						<parameter name="to" value="jbr.exam.previous.person" />
						<parameter name="writeOperation" value="append" />
						<parameter name="changeAttribute" value="user:jbr.exam.person"/>
					</pre-process>
					<!-- (2015/04/08, ppolushkin) При изменении Рассматривающего в статусе Рассмотрение перезаписываем Рассматривающего в атрибут Последний предыдущий рассматривающий -->
					<pre-process class="CopyAttributeToChildren" runOrder="17">
						<parameter name="from" value="jbr.exam.person" />
						<parameter name="to" value="jbr.exam.last.previous.person" />
						<parameter name="changeAttribute" value="user:jbr.exam.person"/>
					</pre-process>
				</specific>
				<!-- Для АРМ руководителя -->
				<post-process class="CopyAttributeFromParent" runOrder="20">
					<parameter name="from" value="JBR_IMPL_KIND" />
					<parameter name="to" value="JBR_C_IMPL_KIND" />
					<parameter name="parent" value="JBR_RASSM_PARENT_DOC" />
					<parameter name="async" value="true" />
				</post-process>
			</specific>

			<!--
				Шаблон Ознакомление: 524 своего "времени окончания" не имеет, а это
				время хранится в родительской (главной) карточке, так что процессор
				надо искать в др шаблонах (например, Входящие)
			-->
			<specific property="template" value="jbr.inform">
				<!-- Keywords for search -->
				<pre-process class="GenerateName" runOrder="5">
					<parameter name="format" value="{0}" />
					<parameter name="dstAttrId" value="string: KEYWORDS" />
					<parameter name="srcAttrIds" value="user: jbr.information.person" />
					<parameter name="maxArgStrLen" value="200" />
				</pre-process>
				
				<!--  Срочность из документа-основания -->
				<pre-process class="CopyAttributeFromParent" runOrder="10">
					<parameter name="parent" value="JBR_INFORM_DOC" />
					<parameter name="from" value="ADMIN_290575" />
					<parameter name="to" value="JBR_HOWFAST" />
					<parameter name="type" value="L" />
				</pre-process>

			</specific>

			<!-- Шаблон ОРД: 764 -->
			<specific property="template" value="jbr.ord" async="false">

				<!-- проверка заполнения "На контроле"/"Срок"/"Контролер" -->
				<validator class="ChkOnCtrlInfo" runOrder="5">
					<parameter name="forceSave" value="false" />
				</validator>

				<pre-process class="GenerateName" runOrder="10">
					<!--  <parameter name="format" value="{0} {1}, {3}" /> -->
					<parameter name="format" value="{0} {1} от {2}, {3}" />
					<parameter name="dstAttrId" value="string: NAME" />
					<parameter name="srcAttrIds"
						value="link: JBR_INFD_TYPEDOC; 
						string: regnumber; 
						date: regdate; 
						text: JBR_INFD_SHORTDESC" />
				</pre-process>
				<!-- При сохранении ОРД в случае изменения поля ФИО Подписанта и Исполнителя обновлять атрибут Зона ДОУ на основе Зоны ДОУ ФИО Подписанта, Исполнителя документа и Автора (предыдущее значение перед изменением очищать) -->
				<pre-process class="CopyAttributeFromParent" runOrder="16">
					<parameter name="isOnlyModel" value="true" />
					<parameter name="from" value="jbr.zoneDOW"/>
					<parameter name="to" value="jbr.zoneDOW"/>
					<parameter name="parent" value="jbr.outcoming.signatory"/>
					<parameter name="parentTemplate" value="jbr.internalPerson"/>
					<parameter name="type" value="C"/>
					<parameter name="writeOperation" value="preclear+overwrite"/>
					<parameter name="changeAttribute" value="user:jbr.outcoming.signatory;user:jbr.document.executor"/>
					<parameter name="changeAttributeOption" value="OR"/>
				</pre-process>
				<pre-process class="CopyAttributeFromParent" runOrder="18">
					<parameter name="isOnlyModel" value="true" />
					<parameter name="from" value="jbr.zoneDOW"/>
					<parameter name="to" value="jbr.zoneDOW"/>
					<parameter name="parent" value="jbr.document.executor"/>
					<parameter name="parentTemplate" value="jbr.internalPerson"/>
					<parameter name="type" value="C"/>
					<parameter name="writeOperation" value="append" />
					<parameter name="changeAttribute" value="user:jbr.outcoming.signatory;user:jbr.document.executor"/>
					<parameter name="changeAttributeOption" value="OR"/>
				</pre-process>
				<pre-process class="CopyAttributeFromParent" runOrder="19">
					<parameter name="isOnlyModel" value="true" />
					<parameter name="from" value="jbr.zoneDOW"/>
					<parameter name="to" value="jbr.zoneDOW"/>
					<parameter name="parent" value="author"/>
					<parameter name="parentTemplate" value="jbr.internalPerson"/>
					<parameter name="type" value="C"/>
					<parameter name="writeOperation" value="append" />
					<parameter name="changeAttribute" value="user:jbr.outcoming.signatory;user:jbr.document.executor"/>
					<parameter name="changeAttributeOption" value="OR"/>
				</pre-process>

				<!-- Добавление версии в файлы вложений при сохранении документа -->
				<post-process class="IterationNumberAdditionToFiles" runOrder="20">
					<parameter name="IterationNumber" value="jbr.visa.round" />					
				</post-process>
				<!--
					"Скрытая срочность" заполняется из обычной срочности копирование
					происходит непосредственно в БД, так что это возможно только в
					пост-фазе, после сохранения карточки.
				-->
				<post-process class="CopyAttributeToChildren" runOrder="25">
					<parameter name="from" value="ADMIN_290575" />
					<parameter name="to" value="JBR_HOWFAST" />
				</post-process>

				<post-process class="TreeProcessor" runOrder="30">
					<parameter name="forestOriginBackLinkAttrId" value="@Self" />
					<parameter name="forestOriginLinkAttrIds"
						value="
								JBR_VISA_VISA,
								JBR_SIGN_SIGNING,
								backLink:JBR_IMPL_RESOLUT,
								JBR_INFORM_LIST,
								jbr.Distribution.DistributionList
							" />
					<parameter name="nodeLinkAttrIds"
						value="
								JBR_IMPL_ACQUAINT,
								backLink:JBR_IMPL_RESOLUT,
								JBR_INFORM_LIST,
								JBR_VISA_VISA,
								ADMIN_893724,
								JBR_SIGN_SIGNING,
								JBR_IMPL_ACQUAINT,
								backLink:JBR_IMPL_RESOLUT,
								JBR_INFORM_LIST,
								backLink:JBR_RIMP_RELASSIG,
								backLink:jbr.reports, 
								backLink:jbr.resolution.ExtReport, 
								jbr.resolution.FyiReport,
								backLink:jbr.visa.res
							" />
					<parameter name="leafLinkAttrIds" value="" />
					<parameter name="processorClassName"
						value="com.aplana.dbmi.jbr.processors.docgraph.copyAttribute" />
					<parameter name="srcAttrId" value="ADMIN_290575" />
					<parameter name="dstAttrId" value="JBR_HOWFAST" />
				</post-process>

				<!-- Обновляет поле NAME Подписания (365) -->
				<post-process class="CallOriginsProcessor" runOrder="90">
					<parameter name="backLinkAttrId" value="link: JBR_SIGN_SIGNING" />
					<parameter name="processorClassName"
						value="com.aplana.dbmi.jbr.processors.DeepGenerateName" />
					<!-- parameter name="format"
						value="Подписать документ ОРД, дата создания: {0},  исполнитель: {1}, {2}" /-->
					<parameter name="format"
						value="Подписать документ %MAINDOC.TEMPLATE.NAME%, Исполнитель: {0}, {1}" />
					<parameter name="srcAttrIds"
						value="
						backLink: JBR_SIGN_PARENT@jbr.resolutionExecutor;
						backLink: JBR_SIGN_PARENT@jbr.document.title" />
					<parameter name="dstAttrId" value="NAME" />
					<parameter name="forceSave" value="true" />
					<!-- (YNikitin, 2013/07/18) При формировании названий дочерних карточек, сохранять сами карточки не надо, достаточно обновить атрибут, 
					это позволяет ускорить процесс сохранения документа основания, а значит и создание нового поручения -->
					<parameter name="forceSaveMode" value="ATTRIBUTE" />
				</post-process>

				<!-- Обновляет поле NAME Ознакомления (524) -->
				<post-process class="CallOriginsProcessor" runOrder="95">
					<parameter name="backLinkAttrId" value="link: JBR_INFORM_LIST" />
					<parameter name="processorClassName"
						value="com.aplana.dbmi.jbr.processors.DeepGenerateName" />
					<!--
						parameter name="format" value="Ознакомиться с документом ОРД № {0}
						от {1}, {2}"/
					-->
					<!-- parameter name="format"
						value="Ознакомиться с документом ОРД № {0}, {2}" /-->
					<parameter name="format"
						value="Ознакомиться с документом {3} № {0}, {2}" />
					<parameter name="srcAttrIds"
						value="
						backLink: JBR_INFORM_DOC@regnumber; 
						backLink: JBR_INFORM_DOC@regdate;
						backLink: JBR_INFORM_DOC@jbr.document.title;
						backLink: JBR_INFORM_DOC@jbr.reg.doctype@name" />
					<parameter name="dstAttrId" value="NAME" />
					<parameter name="forceSave" value="true" />
					<!-- (YNikitin, 2013/07/18) При формировании названий дочерних карточек, сохранять сами карточки не надо, достаточно обновить атрибут, 
					это позволяет ускорить процесс сохранения документа основания, а значит и создание нового поручения -->
					<parameter name="forceSaveMode" value="ATTRIBUTE" />
				</post-process>
				<!-- Обновляет поле NAME Визирование (348) -->
				<post-process class="CallOriginsProcessor" runOrder="100">
					<parameter name="backLinkAttrId" value="link: JBR_VISA_VISA" />
					<parameter name="processorClassName"
						value="com.aplana.dbmi.jbr.processors.DeepGenerateName" />
					<!-- parameter name="format"
						value="Согласовать документ ОРД, дата создания: {0},  исполнитель: {1}, {2}" /-->
					<parameter name="format"
						value="Согласовать %MAINDOC.TEMPLATE.NAME%, Исполнитель: {0}, {1}" />
					<parameter name="srcAttrIds"
						value="
						backLink: JBR_VISA_PARENT_DOC@jbr.resolutionExecutor;
						backLink: JBR_VISA_PARENT_DOC@jbr.document.title" />
					<parameter name="dstAttrId" value="NAME" />
					<parameter name="forceSave" value="true" />
					<!-- (YNikitin, 2013/07/18) При формировании названий дочерних карточек, сохранять сами карточки не надо, достаточно обновить атрибут, 
					это позволяет ускорить процесс сохранения документа основания, а значит и создание нового поручения -->
					<parameter name="forceSaveMode" value="ATTRIBUTE" />
				</post-process>
				<!-- Обновляем поле NAME "Отчета об исполнении" (1044) -->
				<post-process class="CallCardsLinkedToBaseProcessor" runOrder="105">
					<parameter name="processorClassName"
						value="com.aplana.dbmi.jbr.processors.DeepGenerateName" />
					<parameter name="templateId" value="jbr.report.internal" />
					<parameter name="linkId" value="link: ADMIN_702604" />
					<!--
						parameter name="format" value='Поручение ({0} №{1} от {2}) от {3}:
						"{4}", исполнитель: {5} по документу № {6} от {7}, {8}{9}'/
					-->
					<parameter name="format"
						value='Поручение по документу №{0} от {1}, {2}' />
					<parameter name="srcAttrIds"
						value="
						link: ADMIN_702604@regnumber;
						link: ADMIN_702604@regdate;
						link: ADMIN_702604@jbr.document.title;" />
					<parameter name="dstAttrId" value="NAME" />
					<parameter name="forceSave" value="true" />
					<!-- (YNikitin, 2013/07/18) При формировании названий дочерних карточек, сохранять сами карточки не надо, достаточно обновить атрибут, 
					это позволяет ускорить процесс сохранения документа основания, а значит и создание нового поручения -->
					<parameter name="forceSaveMode" value="ATTRIBUTE" />
				</post-process>

				<!-- Обновляем поле NAME "Ознакомления с поручением" (1144) -->
				<post-process class="CallCardsLinkedToBaseProcessor" runOrder="110">
					<parameter name="processorClassName"
						value="com.aplana.dbmi.jbr.processors.DeepGenerateName" />
					<parameter name="templateId" value="jbr.adnotamCommission" />
					<parameter name="linkId" value="link: ADMIN_726877" />
					<!--
						parameter name="format" value='Ознакомиться с поручением от {0}:
						"{1}" по документу № {2} от {3}, {4}{5}'/
					-->
					<parameter name="format"
						value='Ознакомиться с поручением  от {0}: "{1}" по документу № {2} от {3}, {5}' />
					<parameter name="srcAttrIds"
						value="
						backLink: ADMIN_726876@jbr.resolution.FioSign;
						backLink: ADMIN_726876@jbr.resolutionText;
						link: ADMIN_726877@regnumber;
						link: ADMIN_726877@regdate;
						link: ADMIN_726877@jbr.document.title;
						link: ADMIN_726877@jbr.shortcontext;" />
					<parameter name="dstAttrId" value="NAME" />
					<parameter name="forceSave" value="true" />
					<!-- (YNikitin, 2013/07/18) При формировании названий дочерних карточек, сохранять сами карточки не надо, достаточно обновить атрибут, 
					это позволяет ускорить процесс сохранения документа основания, а значит и создание нового поручения -->
					<parameter name="forceSaveMode" value="ATTRIBUTE" />
				</post-process>
				<!--
					Обновляем поле NAME "Отчета об исполнении внешнего исполнителя"
					(1064)
				-->
				<post-process class="CallCardsLinkedToBaseProcessor" runOrder="115">
					<parameter name="processorClassName"
						value="com.aplana.dbmi.jbr.processors.DeepGenerateName" />
					<parameter name="templateId" value="jbr.report.external" />
					<parameter name="linkId" value="link: ADMIN_702602" />
					<parameter name="format"
						value='Поручение (№ {0}) от {1}: "{2}", Вн. исполнитель: {3} {4}. {5}. ({6}) по документу {7}' />
					<parameter name="srcAttrIds"
						value="
						link: jbr.report.ext.document@regnumber;
						link: jbr.report.ext.parent@jbr.resolution.FioSign;
						link: jbr.report.ext.parent@jbr.resolutionText;
						link: jbr.report.ext.executor@jbr.person.lastName;
						link: jbr.report.ext.executor@jbr.person.firstName#1;
						link: jbr.report.ext.executor@jbr.person.middleName#1;
						link: jbr.report.ext.executor@jbr.person.organization@jbr.organization.shortName;
						link: jbr.report.ext.document@jbr.shortcontext;" />
					<parameter name="dstAttrId" value="NAME" />
					<parameter name="forceSave" value="true" />
					<!-- (YNikitin, 2013/07/18) При формировании названий дочерних карточек, сохранять сами карточки не надо, достаточно обновить атрибут, 
					это позволяет ускорить процесс сохранения документа основания, а значит и создание нового поручения -->
					<parameter name="forceSaveMode" value="ATTRIBUTE" />
				</post-process>

				<!-- Ответственный за ДОУ -->
				<post-process class="CopyPersonFromPaths" runOrder="120">
					<parameter name="targetAttr" value="jbr.responsible_dow.resp_dow" />
					<parameter name="paths"
						value="
						user:jbr.resolutionExecutor->link:jbr.personInternal.department->user:jbr.department.resp_dow
					" />
					<parameter name="reloadCard" value="true" />
				</post-process>

				<!-- Ответственный за ДОУ на чтение -->
				<post-process class="CopyPersonFromPaths" runOrder="125">
					<parameter name="targetAttr" value="jbr.responsible_dow.resp_dow_read" />
					<parameter name="paths"
						value="
						user:admin_473763->link:jbr.personInternal.department->user:jbr.department.resp_dow;
						user:jbr.inform.hidden->link:jbr.personInternal.department->user:jbr.department.resp_dow;
						user:jbr.incoming.addressee->link:jbr.personInternal.department->user:jbr.department.resp_dow;
						user:jbr.hidden.visa->link:jbr.personInternal.department->user:jbr.department.resp_dow;
						user:jbr.outcoming.signatory->link:jbr.personInternal.department->user:jbr.department.resp_dow;
						user:jbr.npa.curator->link:jbr.personInternal.department->user:jbr.department.resp_dow;
						link:ADMIN_6079618->user:jbr.department.resp_dow;
					" />
					<parameter name="reloadCard" value="true" />
				</post-process>


				<!-- Формируем атрибут NAME для запросов на резервирование -->
				<post-process class="GenerateChildrenNames" runOrder="135">
					<parameter name="childrenCardLinkAttrId" value="jbr.doc.reservationRequests" />
					<parameter name="format"
						value="Запрос на резервирование номера для документа {0}" />
					<parameter name="dstAttrId" value="string: NAME" />
					<parameter name="srcAttrIds" value="text: jbr.document.title" />
					<parameter name="forceSave" value="true" />
				</post-process>

				<!-- @deprecated (YNikitin, 2013/07/23, 30687) Переносим данный код в сохранение поручения -->
				<!-- post-process class="CopyCardLinkAttributeToParent" runOrder="140">
					<parameter name="parent" value="@Self"/>
					<parameter name="from" value="jbr.resolutions"/>
					<parameter name="to" value="JBR_ALL_RESOLUTIONS"/>
				</post-process-->
			</specific>

			<!-- Шаблон НПА: 1226 -->
			<specific property="template" value="jbr.npa" async="true" policy="IterationPolicy">

				<!-- проверка заполнения "На контроле"/"Срок"/"Контролер" -->
				<validator class="ChkOnCtrlInfo" runOrder="5">
					<parameter name="forceSave" value="false" />
				</validator>

				<pre-process class="GenerateName" runOrder="10">
					<!-- <parameter name="format" value="{0} {1}, {3}" /> -->
					<parameter name="format" value="{0} {1} от {2}, {3}"/> 
					<parameter name="dstAttrId" value="string: NAME" />
					<parameter name="srcAttrIds"
						value="
						link: JBR_INFD_TYPEDOC;
						string: regnumber; 
						date: regdate; 
						text: JBR_INFD_SHORTDESC
					" />
				</pre-process>
				<pre-process class="GenerateName" runOrder="15">
					<parameter name="format"
						value="{0}; {1}; {2}; {3}; {4}; {5}; {6}; {7}; {8}; {9}; {10}; {11}; {12}" />
					<parameter name="dstAttrId" value="string: KEYWORDS" />
					<parameter name="srcAttrIds"
						value="
						user: author;
						link: jbr.hidden.external.executor;
						link: jbr.visa.ext.set;
						user: jbr.outcoming.signatory;	
						user: jbr.incoming.addressee;	
						user: jbr.resolutionExecutor;
						link: jbr.reg.doctype;
						link: regjournal;
						link: index;
						user: jbr.incoming.registrar;
						user: jbr.incoming.inspector;
						user: jbr.ext.curator.editor;
						user: jbr.npa.curator
					" />
					<parameter name="maxArgStrLen" value="3000" />
				</pre-process>
				<!-- При сохранении ОРД/НПА/Внутр в случае изменения поля ФИО Подписанта, Исполнителя обновлять атрибут Зона ДОУ на основе Зоны ДОУ ФИО Подписанта, Исполнителя документа и Автора (предыдущее значение перед изменением очищать) -->
				<pre-process class="CopyAttributeFromParent" runOrder="18">
					<parameter name="isOnlyModel" value="true" />
					<parameter name="from" value="jbr.zoneDOW"/>
					<parameter name="to" value="jbr.zoneDOW"/>
					<parameter name="parent" value="jbr.outcoming.signatory"/>
					<parameter name="parentTemplate" value="jbr.internalPerson"/>
					<parameter name="type" value="C"/>
					<parameter name="writeOperation" value="preclear+overwrite"/>
					<parameter name="changeAttribute" value="user:jbr.outcoming.signatory;user:jbr.document.executor"/>
					<parameter name="changeAttributeOption" value="OR"/>
				</pre-process>
				<pre-process class="CopyAttributeFromParent" runOrder="19">
					<parameter name="isOnlyModel" value="true" />
					<parameter name="from" value="jbr.zoneDOW"/>
					<parameter name="to" value="jbr.zoneDOW"/>
					<parameter name="parent" value="jbr.document.executor"/>
					<parameter name="parentTemplate" value="jbr.internalPerson"/>
					<parameter name="type" value="C"/>
					<parameter name="writeOperation" value="append" />
					<parameter name="changeAttribute" value="user:jbr.outcoming.signatory;user:jbr.document.executor"/>
					<parameter name="changeAttributeOption" value="OR"/>
				</pre-process>
				<pre-process class="CopyAttributeFromParent" runOrder="20">
					<parameter name="isOnlyModel" value="true" />
					<parameter name="from" value="jbr.zoneDOW"/>
					<parameter name="to" value="jbr.zoneDOW"/>
					<parameter name="parent" value="author"/>
					<parameter name="parentTemplate" value="jbr.internalPerson"/>
					<parameter name="type" value="C"/>
					<parameter name="writeOperation" value="append" />
					<parameter name="changeAttribute" value="user:jbr.outcoming.signatory;user:jbr.document.executor"/>
					<parameter name="changeAttributeOption" value="OR"/>
				</pre-process>

				<!-- Добавление версии в файлы вложений при сохранении документа -->
				<post-process class="IterationNumberAdditionToFiles" runOrder="21">
					<parameter name="IterationNumber" value="jbr.visa.round" />					
				</post-process>
				<!--
					"Скрытая срочность" заполняется из обычной срочности копирование
					происходит непосредственно в БД, так что это возможно только в
					пост-фазе, после сохранения карточки.
				-->
				<post-process class="CopyAttributeToChildren" runOrder="25">
					<parameter name="from" value="ADMIN_290575" />
					<parameter name="to" value="JBR_HOWFAST" />				
				</post-process>

				<post-process class="TreeProcessor" runOrder="30">
					<parameter name="forestOriginBackLinkAttrId" value="@Self" />
					<parameter name="forestOriginLinkAttrIds"
						value="
								JBR_VISA_VISA,
								JBR_SIGN_SIGNING,
								backLink:JBR_IMPL_RESOLUT,
								JBR_INFORM_LIST,
								jbr.Distribution.DistributionList
							" />
					<parameter name="nodeLinkAttrIds"
						value="
								JBR_IMPL_ACQUAINT,
								backLink:JBR_IMPL_RESOLUT,
								JBR_INFORM_LIST,
								JBR_VISA_VISA,
								ADMIN_893724,
								JBR_SIGN_SIGNING,
								JBR_IMPL_ACQUAINT,
								backLink:JBR_IMPL_RESOLUT,
								JBR_INFORM_LIST,
								backLink:JBR_RIMP_RELASSIG,
								backLink:jbr.reports, 
								backLink:jbr.resolution.ExtReport, 
								jbr.resolution.FyiReport,
								backLink:jbr.visa.res
							" />
					<parameter name="leafLinkAttrIds" value="" />
					<parameter name="processorClassName"
						value="com.aplana.dbmi.jbr.processors.docgraph.copyAttribute" />
					<parameter name="srcAttrId" value="ADMIN_290575" />
					<parameter name="dstAttrId" value="JBR_HOWFAST" />					
				</post-process>

				<!-- Обновляет поле NAME Подписания (365) -->
				<post-process class="CallOriginsProcessor" runOrder="95">
					<parameter name="backLinkAttrId" value="link: JBR_SIGN_SIGNING" />
					<parameter name="processorClassName"
						value="com.aplana.dbmi.jbr.processors.DeepGenerateName" />
					<!-- parameter name="format"
						value="Подписать документ ОРД, дата создания: {0},  исполнитель: {1}, {2}" /-->
					<parameter name="format"
						value="Подписать документ %MAINDOC.TEMPLATE.NAME%, Исполнитель: {0}, {1}" />
					<parameter name="srcAttrIds"
						value="
						backLink: JBR_SIGN_PARENT@jbr.resolutionExecutor;
						backLink: JBR_SIGN_PARENT@jbr.document.title" />
					<parameter name="dstAttrId" value="NAME" />
					<parameter name="forceSave" value="true" />
					<!-- (YNikitin, 2013/07/18) При формировании названий дочерних карточек, сохранять сами карточки не надо, достаточно обновить атрибут, 
					это позволяет ускорить процесс сохранения документа основания, а значит и создание нового поручения -->
					<parameter name="forceSaveMode" value="ATTRIBUTE" />
					<!--parameter name="async" value="true" /-->										
				</post-process>

				<!-- Обновляет поле NAME Ознакомления (524) -->
				<post-process class="CallOriginsProcessor" runOrder="100">
					<parameter name="backLinkAttrId" value="link: JBR_INFORM_LIST" />
					<parameter name="processorClassName"
						value="com.aplana.dbmi.jbr.processors.DeepGenerateName" />
					<!--
						parameter name="format" value="Ознакомиться с документом ОРД № {0}
						от {1}, {2}"/
					-->
					<!-- parameter name="format"
						value="Ознакомиться с документом ОРД № {0}, {2}" /-->
					<parameter name="format"
						value="Ознакомиться с документом {3} № {0}, {2}" />
					<parameter name="srcAttrIds"
						value="
						backLink: JBR_INFORM_DOC@regnumber; 
						backLink: JBR_INFORM_DOC@regdate;
						backLink: JBR_INFORM_DOC@jbr.document.title;
						backLink: JBR_INFORM_DOC@jbr.reg.doctype@name" />
					<parameter name="dstAttrId" value="NAME" />
					<parameter name="forceSave" value="true" />
					<!-- (YNikitin, 2013/07/18) При формировании названий дочерних карточек, сохранять сами карточки не надо, достаточно обновить атрибут, 
					это позволяет ускорить процесс сохранения документа основания, а значит и создание нового поручения -->
					<parameter name="forceSaveMode" value="ATTRIBUTE" />
					<!--parameter name="async" value="true" /-->										
				</post-process>
				<!-- Обновляет поле NAME Визирование (348) -->
				<post-process class="CallOriginsProcessor" runOrder="105">
					<parameter name="backLinkAttrId" value="link: JBR_VISA_VISA" />
					<parameter name="processorClassName"
						value="com.aplana.dbmi.jbr.processors.DeepGenerateName" />
					<!-- parameter name="format"
						value="Согласовать документ НПА № {4}, дата создания: {0}, исполнитель: {1}, {2}" /-->
					<parameter name="format"
						value="Согласовать %MAINDOC.TEMPLATE.NAME%, Исполнитель: {0}, {1}" />
					<parameter name="srcAttrIds"
						value="
						backLink: JBR_VISA_PARENT_DOC@jbr.resolutionExecutor;
						backLink: JBR_VISA_PARENT_DOC@jbr.document.title" />
					<parameter name="dstAttrId" value="NAME" />
					<parameter name="forceSave" value="true" />
					<!--parameter name="async" value="true" /-->										
				</post-process>
				<!-- Обновляем поле NAME "Отчета об исполнении" (1044) -->
				<post-process class="CallCardsLinkedToBaseProcessor" runOrder="110">
					<parameter name="processorClassName"
						value="com.aplana.dbmi.jbr.processors.DeepGenerateName" />
					<parameter name="templateId" value="jbr.report.internal" />
					<parameter name="linkId" value="link: ADMIN_702604" />
					<!--
						parameter name="format" value='Поручение ({0} №{1} от {2}) от {3}:
						"{4}", исполнитель: {5} по документу № {6} от {7}, {8}{9}'/
					-->
					<parameter name="format"
						value='Поручение по документу №{0} от {1}, {2}' />
					<parameter name="srcAttrIds"
						value="
						link: ADMIN_702604@regnumber;
						link: ADMIN_702604@regdate;
						link: ADMIN_702604@jbr.document.title;" />
					<parameter name="dstAttrId" value="NAME" />
					<parameter name="forceSave" value="true" />
					<!--parameter name="async" value="true" /-->										
				</post-process>

				<!-- Обновляем поле NAME "Ознакомления с поручением" (1144) -->
				<post-process class="CallCardsLinkedToBaseProcessor" runOrder="115">
					<parameter name="processorClassName"
						value="com.aplana.dbmi.jbr.processors.DeepGenerateName" />
					<parameter name="templateId" value="jbr.adnotamCommission" />
					<parameter name="linkId" value="link: ADMIN_726877" />
					<!--
						parameter name="format" value='Ознакомиться с поручением от {0}:
						"{1}" по документу № {2} от {3}, {4}{5}'/
					-->
					<parameter name="format"
						value='Ознакомиться с поручением  от {0}: "{1}" по документу № {2} от {3}, {5}' />
					<parameter name="srcAttrIds"
						value="
						backLink: ADMIN_726876@jbr.resolution.FioSign;
						backLink: ADMIN_726876@jbr.resolutionText;
						link: ADMIN_726877@regnumber;
						link: ADMIN_726877@regdate;
						link: ADMIN_726877@jbr.document.title;
						link: ADMIN_726877@jbr.shortcontext;" />
					<parameter name="dstAttrId" value="NAME" />
					<parameter name="forceSave" value="true" />
					<!--parameter name="async" value="true" /-->										
				</post-process>
				<!--
					Обновляем поле NAME "Отчета об исполнении внешнего исполнителя"
					(1064)
				-->
				<post-process class="CallCardsLinkedToBaseProcessor" runOrder="120">
					<parameter name="processorClassName"
						value="com.aplana.dbmi.jbr.processors.DeepGenerateName" />
					<parameter name="templateId" value="jbr.report.external" />
					<parameter name="linkId" value="link: ADMIN_702602" />
					<parameter name="format"
						value='Поручение (№ {0}) от {1}: "{2}", Вн. исполнитель: {3} {4}. {5}. ({6}) по документу {7}' />
					<parameter name="srcAttrIds"
						value="
						link: jbr.report.ext.document@regnumber;
						link: jbr.report.ext.parent@jbr.resolution.FioSign;
						link: jbr.report.ext.parent@jbr.resolutionText;
						link: jbr.report.ext.executor@jbr.person.lastName;
						link: jbr.report.ext.executor@jbr.person.firstName#1;
						link: jbr.report.ext.executor@jbr.person.middleName#1;
						link: jbr.report.ext.executor@jbr.person.organization@jbr.organization.shortName;
						link: jbr.report.ext.document@jbr.shortcontext;" />
					<parameter name="dstAttrId" value="NAME" />
					<parameter name="forceSave" value="true" />
					<!--parameter name="async" value="true" /-->										
				</post-process>

				<!-- Ответственный за ДОУ -->
				<post-process class="CopyPersonFromPaths" runOrder="125">
					<parameter name="targetAttr" value="jbr.responsible_dow.resp_dow" />
					<parameter name="paths"
						value="
						user:jbr.resolutionExecutor->link:jbr.personInternal.department->user:jbr.department.resp_dow
					" />
					<parameter name="reloadCard" value="true" />
				</post-process>

				<!-- Ответственный за ДОУ на чтение -->
				<post-process class="CopyPersonFromPaths" runOrder="130">
					<parameter name="targetAttr" value="jbr.responsible_dow.resp_dow_read" />
					<parameter name="paths"
						value="
						user:admin_473763->link:jbr.personInternal.department->user:jbr.department.resp_dow;
						user:jbr.inform.hidden->link:jbr.personInternal.department->user:jbr.department.resp_dow;
						user:jbr.incoming.addressee->link:jbr.personInternal.department->user:jbr.department.resp_dow;
						user:jbr.hidden.visa->link:jbr.personInternal.department->user:jbr.department.resp_dow;
						user:jbr.outcoming.signatory->link:jbr.personInternal.department->user:jbr.department.resp_dow;
						user:jbr.npa.curator->link:jbr.personInternal.department->user:jbr.department.resp_dow;
						link:ADMIN_6079618->user:jbr.department.resp_dow;
					" />
					<parameter name="reloadCard" value="true" />
				</post-process>

				
				<!-- Формируем атрибут NAME для запросов на резервирование -->
				<post-process class="GenerateChildrenNames" runOrder="140">
					<parameter name="childrenCardLinkAttrId" value="jbr.doc.reservationRequests" />
					<parameter name="format"
						value="Запрос на резервирование номера для документа {0}" />
					<parameter name="dstAttrId" value="string: NAME" />
					<parameter name="srcAttrIds" value="text: jbr.document.title" />
					<parameter name="forceSave" value="true" />
					<!--parameter name="async" value="true" /-->										
				</post-process>
				
				<!-- Заполнение динамической роли "Имеющие право отправлять на исполнение" (JBR_EXECUTION_SENDER)
				в связанных поручениях.-->
				<post-process class="SetExecutionSendersProcessor" runOrder="145"/>
				
				<!-- @deprecated (YNikitin, 2013/07/23, 30687) Переносим данный код в сохранение поручения -->
				<!-- post-process class="CopyCardLinkAttributeToParent" runOrder="140">
					<parameter name="parent" value="@Self"/>
					<parameter name="from" value="jbr.resolutions"/>
					<parameter name="to" value="JBR_ALL_RESOLUTIONS"/>
				</post-process>
				-->
			</specific>

			<!-- Шаблон ОГ: 864 -->
			<specific property="template" value="jbr.citizenrequest">

				<!-- проверка заполнения "На контроле"/"Срок"/"Контролер" -->
				<validator class="ChkOnCtrlInfo" runOrder="5">
					<parameter name="forceSave" value="false" />
				</validator>

				<pre-process class="GenerateName" runOrder="10">
					<!-- <parameter name="format" value="{0} {1}"/> -->
					<parameter name="format" value="{0} {1} от {2}, {3} {4} {5}, {6}"/>
					<parameter name="dstAttrId" value="NAME"/>
					<parameter name="srcAttrIds"
					           value="
					           list: jbr.reg.requestType;
					           string: regnumber;
					           date: regdate;
					           link: jbr.ReqAuthor@jbr.InfOGSecondName;
					           link: jbr.ReqAuthor@jbr.InfOGFirstName;
					           link: jbr.ReqAuthor@jbr.InfOGPatronimic;
					           text: jbr.document.title
					"/>
				</pre-process>
				<!-- Keywords for search -->
				<pre-process class="GenerateName">
					<parameter name="format"
						value="{0}; {1}; {2}; {3}; {4}; {5}; {6}; {7}; {8}; {9}; {10}; {11}; {12}; {13}; {14}; {15}; {16}; {17}; {18}; {19}; {20}; {21}; {22}; {23}; {24}; {25}; {26}; {27}; {28}" />
					<parameter name="dstAttrId" value="string: KEYWORDS" />
					<parameter name="srcAttrIds"
						value="
						user: author;
						user: jbr.hidden.notePersons;
						link: jbr.hidden.external.executor;
						link: jbr.ThemeOfQuery;
						link: jbr.QuestionOfQuery;
						tree: jbr.QueryExemptions;
						link: jbr.ConsiderDecision;
						link: jbr.InfAboutDocRegion;
						link: jbr.InfAboutDocCountry;
						link: jbr.InfAboutDocCity;
						link: jbr.OgAddressee;
						tree: jbr.SourceType;
						list: jbr.reg.requestType;
						link: regjournal;
						link: index;
						user: jbr.incoming.registrar;
						list: jbr.urgencyLevel;
						list: jbr.specialNotes;
						list: jbr.inbound.typecontrol;
						link: jbr.incoming.foiv;
						user: jbr.incoming.inspector;
						list: jbr.incoming.execkind;
						user: jbr.ext.curator.editor;
						link: jbr.ReqAuthor;
						link: jbr.previousReqAuthor;
						user: jbr.examiners;
						link: jbr.question.thematic.OG;
						user: jbr.npa.curator
					" />
					<parameter name="maxArgStrLen" value="3000" />
				</pre-process>
				<!-- Если перед нами промежуточный документ и у него по какой-то причине Зона Доу заполнена, то очищаем её -->
				<post-process class="ClearCardAttributePostProcessorEx" runOrder="12">
					<parameter name="condition" value="list:jbr.replication.replicatingDocType=jbr.replication.replicatedDocument"/>
					<parameter name="condition" value="link:jbr.zoneDOW#NULL"/>
					<parameter name="attrId" value="link:jbr.zoneDOW"/>
				</post-process>

				<!-- Если перед нами итоговый реплицированный документ. то Зону ДОУ берем один раз из Организации-рецепиента -->
				<post-process class="CopyAttributeFromParent" runOrder="13">
					<parameter name="isOnlyModel" value="false" />
					<parameter name="attr_condition_2" value="link:jbr.zoneDOW=NULL"/>
					<parameter name="attr_condition_4" value="list:jbr.replication.replicatingDocType=jbr.replication.localDocument"/>
					<parameter name="from" value="jbr.zonesDOW"/>
					<parameter name="to" value="jbr.zoneDOW"/>
					<parameter name="parent" value="jbr.replication.orgRecipient"/>
					<parameter name="parentTemplate" value="jbr.organization"/>
					<parameter name="writeOperation" value="preclear+overwrite"/>
					<parameter name="type" value="C"/>
				</post-process>
				<!-- Если автор Входящего ИЛИ ОГ Cистема и Зона ДОУ пустая, то атрибут Зона ДОУ заполняется на основе Зоны ДОУ Адресата, а если он пустой, то на основе Организации-получателя -->
				<post-process class="CopyAttributeFromParent" runOrder="14">
					<parameter name="isOnlyModel" value="false" />
					<parameter name="attr_condition_1" value="user:author=0"/>
					<parameter name="attr_condition_2" value="link:jbr.zoneDOW=NULL"/>
					<parameter name="attr_condition_3" value="list:jbr.replication.replicatingDocType#jbr.replication.replicatedDocument"/>
					<parameter name="attr_condition_4" value="list:jbr.replication.replicatingDocType#jbr.replication.localDocument"/>
					<parameter name="from" value="jbr.zoneDOW"/>
					<parameter name="to" value="jbr.zoneDOW"/>
					<parameter name="parent" value="jbr.examiners"/>
					<parameter name="parentTemplate" value="jbr.internalPerson"/>
					<parameter name="type" value="U"/>
				</post-process>
				<post-process class="CopyAttributeFromParent" runOrder="15">
					<parameter name="isOnlyModel" value="false" />
					<parameter name="attr_condition_1" value="user:author=0"/>
					<parameter name="attr_condition_2" value="link:jbr.zoneDOW=NULL"/>
					<parameter name="attr_condition_3" value="list:jbr.replication.replicatingDocType#jbr.replication.replicatedDocument"/>
					<parameter name="attr_condition_4" value="list:jbr.replication.replicatingDocType#jbr.replication.localDocument"/>
					<parameter name="from" value="jbr.zonesDOW"/>
					<parameter name="to" value="jbr.zoneDOW"/>
					<parameter name="parent" value="jbr.outcoming.receiver.single"/>
					<parameter name="parentTemplate" value="jbr.organization"/>
					<parameter name="type" value="C"/>
				</post-process>
				<!-- При сохранении входящего, ОГ в случае изменения поля Адресат обновлять атрибут Зона ДОУ на основе Зоны ДОУ Адресата документа и Автора (предыдущее значение перед изменением очищать) -->
				<post-process class="CopyAttributeFromParent" runOrder="16">
					<parameter name="isOnlyModel" value="false" />
					<parameter name="attr_condition_3" value="list:jbr.replication.replicatingDocType#jbr.replication.replicatedDocument"/>
					<parameter name="attr_condition_4" value="list:jbr.replication.replicatingDocType#jbr.replication.localDocument"/>
					<parameter name="from" value="jbr.zoneDOW"/>
					<parameter name="to" value="jbr.zoneDOW"/>
					<parameter name="parent" value="jbr.examiners"/>
					<parameter name="parentTemplate" value="jbr.internalPerson"/>
					<parameter name="writeOperation" value="preclear+overwrite"/>
					<parameter name="type" value="U"/>
					<parameter name="changeAttribute" value="user:jbr.examiners"/>
				</post-process>
				<post-process class="CopyAttributeFromParent" runOrder="17">
					<parameter name="isOnlyModel" value="false" />
					<parameter name="attr_condition_3" value="list:jbr.replication.replicatingDocType#jbr.replication.replicatedDocument"/>
					<parameter name="attr_condition_4" value="list:jbr.replication.replicatingDocType#jbr.replication.localDocument"/>
					<parameter name="from" value="jbr.zoneDOW"/>
					<parameter name="to" value="jbr.zoneDOW"/>
					<parameter name="parent" value="author"/>
					<parameter name="parentTemplate" value="jbr.internalPerson"/>
					<parameter name="type" value="C"/>
					<parameter name="writeOperation" value="append" />
					<parameter name="changeAttribute" value="user:jbr.examiners"/>
				</post-process>

				<!-- копируем Фамилию, Имя и Отчество Автора обращения из карточки соответствующего Автора обращения -->
				<post-process class="CopyAttributeFromParent" runOrder="18">
					<parameter name="attr_condition" value="link:jbr.ReqAuthor#NULL"/>
					<parameter name="parent" value="link:jbr.ReqAuthor"/>
					<parameter name="from" value="jbr.og.lastname"/>
					<parameter name="to" value="jbr.og.lastname"/>
					<parameter name="parentTemplate" value="jbr.medo_og.requestAuthor"/>
					<parameter name="type" value="S"/>
				</post-process>

				<post-process class="CopyAttributeFromParent" runOrder="20">
					<parameter name="attr_condition" value="link:jbr.ReqAuthor#NULL"/>
					<parameter name="parent" value="link:jbr.ReqAuthor"/>
					<parameter name="from" value="jbr.og.firstname"/>
					<parameter name="to" value="jbr.og.firstname"/>
					<parameter name="parentTemplate" value="jbr.medo_og.requestAuthor"/>
					<parameter name="type" value="S"/>
				</post-process>

				<post-process class="CopyAttributeFromParent" runOrder="25">
					<parameter name="attr_condition" value="link:jbr.ReqAuthor#NULL"/>
					<parameter name="parent" value="link:jbr.ReqAuthor"/>
					<parameter name="from" value="jbr.og.secondname"/>
					<parameter name="to" value="jbr.og.secondname"/>
					<parameter name="parentTemplate" value="jbr.medo_og.requestAuthor"/>
					<parameter name="type" value="S"/>
				</post-process>
				<!--
					"Скрытая срочность" заполняется из обычной срочности копирование
					происходит непосредственно в БД, так что это возможно только в
					пост-фазе, после сохранения карточки.
				-->
				<post-process class="CopyAttributeToChildren" runOrder="30">
					<parameter name="from" value="ADMIN_290575" />
					<parameter name="to" value="JBR_HOWFAST" />
				</post-process>

				<post-process class="TreeProcessor" runOrder="35">
					<parameter name="forestOriginBackLinkAttrId" value="@Self" />
					<parameter name="forestOriginLinkAttrIds"
						value="
								JBR_IMPL_ACQUAINT,
								backLink:JBR_IMPL_RESOLUT,
								JBR_INFORM_LIST,
								jbr.Distribution.DistributionList
							" />
					<parameter name="nodeLinkAttrIds"
						value="
								JBR_IMPL_ACQUAINT,
								backLink:JBR_IMPL_RESOLUT,
								JBR_INFORM_LIST,
								JBR_VISA_VISA,
								ADMIN_893724,
								JBR_SIGN_SIGNING,
								JBR_IMPL_ACQUAINT,
								backLink:JBR_IMPL_RESOLUT,
								JBR_INFORM_LIST,
								backLink:JBR_RIMP_RELASSIG,
								backLink:jbr.reports, 
								backLink:jbr.resolution.ExtReport, 
								jbr.resolution.FyiReport,
								backLink:jbr.visa.res
							" />
					<parameter name="leafLinkAttrIds" value="" />
					<parameter name="processorClassName"
						value="com.aplana.dbmi.jbr.processors.docgraph.copyAttribute" />
					<parameter name="srcAttrId" value="ADMIN_290575" />
					<parameter name="dstAttrId" value="JBR_HOWFAST" />
				</post-process>

				<!-- Обновляет поле NAME рассмотрения -->
				<post-process class="CallOriginsProcessor" runOrder="75">
					<parameter name="backLinkAttrId" value="link: JBR_IMPL_ACQUAINT" />
					<parameter name="processorClassName"
						value="com.aplana.dbmi.jbr.processors.DeepGenerateName" />
					<!--
						parameter name="format" value="Рассмотреть ОГ № {0} от {1}, {2}"/
					-->
					<!-- parameter name="format" value="Рассмотреть ОГ № {0}, {2}" /-->
					<parameter name="format" value="Рассмотреть документ %MAINDOC.TEMPLATE.NAME% № {0} от {1} {2}" />
					<parameter name="srcAttrIds"
						value="
						backLink: JBR_RASSM_PARENT_DOC@regnumber; 
						backLink: JBR_RASSM_PARENT_DOC@regdate;
						backLink: JBR_RASSM_PARENT_DOC@jbr.shortcontext" />
					<parameter name="dstAttrId" value="NAME" />
					<parameter name="forceSave" value="true" />
					<!-- (YNikitin, 2013/07/18) При формировании названий дочерних карточек, сохранять сами карточки не надо, достаточно обновить атрибут, 
					это позволяет ускорить процесс сохранения документа основания, а значит и создание нового поручения -->
					<parameter name="forceSaveMode" value="ATTRIBUTE" />
				</post-process>
				<!-- Обновляем поле NAME Отчета об исполнении -->
				<post-process class="CallCardsLinkedToBaseProcessor" runOrder="80">
					<parameter name="processorClassName"
						value="com.aplana.dbmi.jbr.processors.DeepGenerateName" />
					<parameter name="templateId" value="jbr.report.internal" />
					<parameter name="linkId" value="link: ADMIN_702604" />
					<!--
						parameter name="format" value='Поручение ({0} №{1} от {2}) от {3}:
						"{4}", исполнитель: {5} по документу № {6} от {7}, {8}{9}'/
					-->
					<parameter name="format"
						value='Поручение по документу №{0} от {1}, {2}' />
					<parameter name="srcAttrIds"
						value="
						link: ADMIN_702604@regnumber;
						link: ADMIN_702604@regdate;
						link: ADMIN_702604@jbr.document.title;" />
					<parameter name="dstAttrId" value="NAME" />
					<parameter name="forceSave" value="true" />
					<!-- (YNikitin, 2013/07/18) При формировании названий дочерних карточек, сохранять сами карточки не надо, достаточно обновить атрибут, 
					это позволяет ускорить процесс сохранения документа основания, а значит и создание нового поручения -->
					<parameter name="forceSaveMode" value="ATTRIBUTE" />
				</post-process>
				<!-- Обновляет поле NAME Ознакомления (524) -->
				<post-process class="CallOriginsProcessor" runOrder="85">
					<parameter name="backLinkAttrId" value="link: JBR_INFORM_LIST" />
					<parameter name="processorClassName"
						value="com.aplana.dbmi.jbr.processors.DeepGenerateName" />
					<parameter name="format"
						value="Ознакомиться с документом № {0} от {1}, {2}" />
					<parameter name="srcAttrIds"
						value="
						backLink: JBR_INFORM_DOC@regnumber; 
						backLink: JBR_INFORM_DOC@regdate;
						backLink: JBR_INFORM_DOC@jbr.document.title" />
					<parameter name="dstAttrId" value="NAME" />
					<parameter name="forceSave" value="true" />
					<parameter name="async" value="false" />					
					<!-- (YNikitin, 2013/07/18) При формировании названий дочерних карточек, сохранять сами карточки не надо, достаточно обновить атрибут, 
					это позволяет ускорить процесс сохранения документа основания, а значит и создание нового поручения -->
					<parameter name="forceSaveMode" value="ATTRIBUTE" />
				</post-process>
				<!-- Обновляем поле NAME Ознакомления с поручением -->
				<post-process class="CallCardsLinkedToBaseProcessor" runOrder="90">
					<parameter name="processorClassName"
						value="com.aplana.dbmi.jbr.processors.DeepGenerateName" />
					<parameter name="templateId" value="jbr.adnotamCommission" />
					<parameter name="linkId" value="link: ADMIN_726877" />
					<!--
						parameter name="format" value='Ознакомиться с поручением от {0}:
						"{1}" по документу № {2} от {3}, {4}{5}'/
					-->
					<parameter name="format"
						value='Ознакомиться с поручением  от {0}: "{1}" по документу № {2} от {3}, {5}' />
					<parameter name="srcAttrIds"
						value="
						backLink: ADMIN_726876@jbr.resolution.FioSign;
						backLink: ADMIN_726876@jbr.resolutionText;
						link: ADMIN_726877@regnumber;
						link: ADMIN_726877@regdate;
						link: ADMIN_726877@jbr.document.title;
						link: ADMIN_726877@jbr.shortcontext;" />
					<parameter name="dstAttrId" value="NAME" />
					<parameter name="forceSave" value="true" />
					<!-- (YNikitin, 2013/07/18) При формировании названий дочерних карточек, сохранять сами карточки не надо, достаточно обновить атрибут, 
					это позволяет ускорить процесс сохранения документа основания, а значит и создание нового поручения -->
					<parameter name="forceSaveMode" value="ATTRIBUTE" />
				</post-process>
				<!-- Обновляем поле NAME Отчета об исполнении внешнего исполнителя -->
				<post-process class="CallCardsLinkedToBaseProcessor" runOrder="95">
					<parameter name="processorClassName"
						value="com.aplana.dbmi.jbr.processors.DeepGenerateName" />
					<parameter name="templateId" value="jbr.report.external" />
					<parameter name="linkId" value="link: ADMIN_702602" />
					<parameter name="format"
						value='Поручение (№ {0}) от {1}: "{2}", Вн. исполнитель: {3} {4}. {5}. ({6}) по документу {7}' />
					<parameter name="srcAttrIds"
						value="
						link: jbr.report.ext.document@regnumber;
						link: jbr.report.ext.parent@jbr.resolution.FioSign;
						link: jbr.report.ext.parent@jbr.resolutionText;
						link: jbr.report.ext.executor@jbr.person.lastName;
						link: jbr.report.ext.executor@jbr.person.firstName#1;
						link: jbr.report.ext.executor@jbr.person.middleName#1;
						link: jbr.report.ext.executor@jbr.person.organization@jbr.organization.shortName;
						link: jbr.report.ext.document@jbr.shortcontext;" />
					<parameter name="dstAttrId" value="NAME" />
					<parameter name="forceSave" value="true" />
					<!-- (YNikitin, 2013/07/18) При формировании названий дочерних карточек, сохранять сами карточки не надо, достаточно обновить атрибут, 
					это позволяет ускорить процесс сохранения документа основания, а значит и создание нового поручения -->
					<parameter name="forceSaveMode" value="ATTRIBUTE" />
				</post-process>
				
				<!-- Обновляет поле NAME внешней резолюции -->
				<post-process class="CallOriginsProcessor" runOrder="100">
					<parameter name="backLinkAttrId" value="link: JBR_EXT_RESOL" />
					<parameter name="processorClassName"
						value="com.aplana.dbmi.jbr.processors.DeepGenerateName" />
					<!-- <рег номер документа остнования>, <Текст резолюции>, от <Автор резолюции> -->
					<parameter name="format" value="{0}, {1}, от {2}" />
					<parameter name="srcAttrIds"
						value="
						backLink: JBR_DMSI_ER_DOC@regnumber; 
						text: jbr.externalResolution.text; 
						string: jbr.externalResolution.author 
						" />
					<parameter name="dstAttrId" value="NAME" />
					<parameter name="forceSave" value="true" />
					<!-- (YNikitin, 2013/07/18) При формировании названий дочерних карточек, сохранять сами карточки не надо, достаточно обновить атрибут, 
					это позволяет ускорить процесс сохранения документа основания, а значит и создание нового поручения -->
					<parameter name="forceSaveMode" value="ATTRIBUTE" />
				</post-process>

				<!-- Ответственный за ДОУ -->
				<!--						user: ADMIN_473763 -> link:jbr.personInternal.department->user:jbr.department.resp_dow;
						user: ADMIN_476220 -> link:jbr.personInternal.department->user:jbr.department.resp_dow;
						link: JBR_RECEIVER ->link:jbr.personInternal.department->user:jbr.department.resp_dow-->
				<post-process class="CopyPersonFromPaths" runOrder="105">
					<parameter name="targetAttr" value="jbr.responsible_dow.resp_dow" />
					<parameter name="paths"
						value="
							user: ADMIN_473929 ->link:jbr.personInternal.department->user:jbr.department.resp_dow;
					" />
					<parameter name="reloadCard" value="true" />
				</post-process>
				<!-- Ответственный за ДОУ на чтение -->
				<post-process class="CopyPersonFromPaths" runOrder="110">
					<parameter name="targetAttr" value="jbr.responsible_dow.resp_dow_read" />
					<parameter name="paths"
						value="
						user: ADMIN_473763 ->link:jbr.personInternal.department->user:jbr.department.resp_dow;
						user: JBR_INFORMATION ->link:jbr.personInternal.department->user:jbr.department.resp_dow;
					" />
					<parameter name="reloadCard" value="true" />
				</post-process>

				<!-- Постпроцессор, проставляющий ссылки на предыдущие обращения. -->
				<!-- 
				<post-process class="FillPreviousAppealsProcessor">
					<parameter name="async" value="false"/>
					<parameter name="rewrite" value="true"/>
				</post-process>
				-->

				<!-- Пользователи, имеющие доступ к документу копируем во внешние резолюции -->
				<!-- (YNikitin, 2013/11/13, BR4J00034081) в рамках оптимизации системы, убираем лишние процессоры и донастраиваем оставшиеся, чтобы не было лишних пересчётов прав и лишних копирований атрибутов -->
				<!-- post-process class="CopyPersonsToLinkedCards" runOrder="120">
					<parameter name="linkAttrId" value="JBR_EXT_RESOL" />
					<parameter name="linkReversed" value="false" />
					<parameter name="linkedPersonAttrId" value="JBR_DMSI_ER_DOC_RDR" />
					<parameter name="personAttrIds"
						value="AUTHOR,JBR_INFD_RECEIVER,ADMIN_473763,JBR_INFD_EXECUTOR,ADMIN_476220,JBR_IMPL_INSPECTOR,ADMIN_473954,ADMIN_6075258,JBR_RESP_DOW_RESP,JBR_RESP_DOW_MAINDOC,JBR_RESP_D_RESP_READ,JBR_RESP_DOW_RESOL,EDITOR,JBR_INFD_SENDER_INT,JBR_DR_FYI_AST,JBR_DR_FIO_HELPER,ADMIN_478058,ADMIN_479194,JBR_IMPL_ACQUAINTERS,ADMIN_473929,JBR_REGD_REGISTRAR,JBR_HIDDEN_CHIEF,JBR_INFD_SIGNATORY,JBR_RD_FROM_RELDOCS,JBR_DR_READ_RESOLUT" />
					<parameter name="async" value="true" />					
				</post-process-->

				<!-- адресата документа копируем во внешние резолюции -->
				<!-- (YNikitin, 2013/11/13, BR4J00034081) в рамках оптимизации системы, убираем лишние процессоры и донастраиваем оставшиеся, чтобы не было лишних пересчётов прав и лишних копирований атрибутов -->
				<!-- post-process class="CopyPersonsToLinkedCards" runOrder="125">
					<parameter name="linkAttrId" value="JBR_EXT_RESOL" />
					<parameter name="linkReversed" value="false" />
					<parameter name="linkedPersonAttrId" value="JBR_DMSI_ER_DOC_ADR" />
					<parameter name="personAttrIds"
						value="JBR_INFD_RECEIVER" />
					<parameter name="async" value="true" />					
				</post-process-->

				<!-- @deprecated (YNikitin, 2013/07/23, 30687) Переносим данный код в сохранение поручения -->
				<!-- post-process class="CopyCardLinkAttributeToParent" runOrder="140">
					<parameter name="parent" value="@Self"/>
					<parameter name="from" value="jbr.resolutions"/>
					<parameter name="to" value="JBR_ALL_RESOLUTIONS"/>
				</post-process>
				-->
				
				<!-- Переход ОГ в статус "Создан по МЭДО", если карточка сохраняется в статусе "Черновик" и "Способ доставки" = МЭДО-->
				<specific property="state" value="draft">
					<post-process class="JumpStatePostProcessor" runOrder="5">
						<parameter name="dest_wfm" value="jbr.incoming.registration.ready"/>
	
						<!-- all theese variants works normally and are equevalent to each other: 
							parameter name="attr_test" value="jbr.incoming.oncontrol=jbr.incoming.control.no"  // comment="1433"
							parameter name="attr_test" value="jbr.incoming.oncontrol#jbr.incoming.control.yes" // comment="1432" 
							parameter name="attr_test" value="list:JBR_IMPL_ONCONT#1432"	// comment="1432 == yes"
						-->
						<parameter name="failIfStatusIsOther"  value="false"/>
						<parameter name="attr_test" value="jbr.deliveryItem.method=modeDeliveryMEDO"/>
						<parameter name="attr_test" value="jbr.original.source#null"/>
						<parameter name="card_test"
							value="com.aplana.dbmi.jbr.processors.card.runcheck.CheckSystemUserInAttr (
										attrId=author 
									)" />
						<parameter name="async" value="false"/> 
					</post-process>
					<post-process class="JumpStatePostProcessor" runOrder="10">
						<parameter name="dest_wfm" value="jbr.incoming.registration.ready"/>
						<parameter name="failIfStatusIsOther" value="false"/>
						<parameter name="attr_test" value="jbr.deliveryItem.method=jbr.deliveryItem.method.delo"/>
						<parameter name="attr_test" value="jbr.original.source#null"/>
						<parameter name="card_test"
							value="com.aplana.dbmi.jbr.processors.card.runcheck.CheckSystemUserInAttr (
										attrId=author 
									)" />
						<parameter name="async" value="false"/> 
					</post-process>
					<post-process class="JumpStatePostProcessor">
						<parameter name="dest_wfm" value="jbr.incoming.registration.ready"/>
						<parameter name="failIfStatusIsOther" value="false"/>
						<parameter name="attr_test" value="jbr.deliveryItem.method=jbr.deliveryItem.method.gost"/> 
						<parameter name="async" value="false"/> 
					</post-process>
					<!-- В статусе Черновик и Поступившие из ВС для ОГ, созданных системой, выводим в лог информацию о Зоне ДОУ и о пользователях, которые должны читать текущую карточку согласно простым профильным правам -->
					<post-process class="SpecDebugLogProcessor" runOrder="100">
						<parameter name="srcAttrIds" value="link:jbr.zoneDOW"/>
						<parameter name="sqlName" value="Список пользователей, у которых согласно простым профильным правилам есть право чтения данной карточки"/>
						<parameter name="sqlString" value="SELECT 
								distinct  
								p.person_id as personId, 
								sr.role_code as personRoleForRule,
								tv.attribute_code as sourceAttributeCode,
								tv.number_value as sourceAttributeValue/*,
								pr1.role_code as personExistsRole*/
							FROM 
								card c 
								JOIN access_rule r 
									ON (c.template_id=r.template_id OR r.template_id IS NULL) 
									AND (c.status_id=r.status_id OR r.status_id IS NULL) 
									AND c.card_id=?
								JOIN profile_access_rule pr 
									ON r.rule_id=pr.rule_id 
									AND pr.link_attr_code is NULL 
								LEFT JOIN person_role sr 
									ON pr.role_code=sr.role_code 
								JOIN attribute_value pv 
									ON pr.profile_attr_code=pv.attribute_code 
								JOIN attribute_value tv 
									ON c.card_id=tv.card_id 
									AND pr.target_attr_code=tv.attribute_code 
									and tv.number_value=pv.number_value 
								JOIN person p 
									ON p.card_id=pv.card_id 
								join access_card_rule acr 
									on acr.rule_id = r.rule_id 
									and acr.operation_code = 'R'
								/*join person_role pr1
									on pr1.person_id = p.person_id*/
							WHERE 
								(pr.role_code IS NULL OR p.person_id=sr.person_id)
							order by p.person_id"/>
						<parameter name="attr_condition_1" value="user:author=0"/>
					</post-process>
				</specific>
				<specific property="state" value="inmedo">
					<!-- В статусе Черновик и Поступившие из ВС для ОГ, созданных системой, выводим в лог информацию о Зоне ДОУ и о пользователях, которые должны читать текущую карточку согласно простым профильным правам -->
					<post-process class="SpecDebugLogProcessor" runOrder="100">
						<parameter name="srcAttrIds" value="link:jbr.zoneDOW"/>
						<parameter name="sqlName" value="Список пользователей, у которых согласно простым профильным правилам есть право чтения данной карточки"/>
						<parameter name="sqlString" value="SELECT 
								distinct  
								p.person_id as personId, 
								sr.role_code as personRoleForRule,
								tv.attribute_code as sourceAttributeCode,
								tv.number_value as sourceAttributeValue/*,
								pr1.role_code as personExistsRole*/
							FROM 
								card c 
								JOIN access_rule r 
									ON (c.template_id=r.template_id OR r.template_id IS NULL) 
									AND (c.status_id=r.status_id OR r.status_id IS NULL) 
									AND c.card_id=?
								JOIN profile_access_rule pr 
									ON r.rule_id=pr.rule_id 
									AND pr.link_attr_code is NULL 
								LEFT JOIN person_role sr 
									ON pr.role_code=sr.role_code 
								JOIN attribute_value pv 
									ON pr.profile_attr_code=pv.attribute_code 
								JOIN attribute_value tv 
									ON c.card_id=tv.card_id 
									AND pr.target_attr_code=tv.attribute_code 
									and tv.number_value=pv.number_value 
								JOIN person p 
									ON p.card_id=pv.card_id 
								join access_card_rule acr 
									on acr.rule_id = r.rule_id 
									and acr.operation_code = 'R'
								/*join person_role pr1
									on pr1.person_id = p.person_id*/
							WHERE 
								(pr.role_code IS NULL OR p.person_id=sr.person_id)
							order by p.person_id"/>
						<parameter name="attr_condition_1" value="user:author=0"/>
					</post-process>
				</specific>				
			</specific>

			<!-- Шаблон ИЗ: 865 -->
			<specific property="template" value="jbr.informationrequest">

				<!-- проверка заполнения "На контроле"/"Срок"/"Контролер" -->
				<validator class="ChkOnCtrlInfo" runOrder="5">
					<parameter name="forceSave" value="false" />
				</validator>

				<pre-process class="GenerateName" runOrder="10">
					<!--
						parameter name="format" value="Информационный запрос {0} от {1}"/
					-->
					<parameter name="format" value="Информационный запрос {0}" />
					<parameter name="dstAttrId" value="NAME" />
					<parameter name="srcAttrIds" value="string: regnumber; date: regdate" />
				</pre-process>
				<pre-process class="GenerateName" runOrder="15">
					<parameter name="format"
						value="{0}; {1}; {2}; {3}; {4}; {5}; {6}; {7}; {8}; {9}; {10}; {11}; {12}; {13}; {14}; {15}; {16}; {17}; {18}; {19}; {20}" />
					<parameter name="dstAttrId" value="string: KEYWORDS" />
					<parameter name="srcAttrIds"
						value="
						user: jbr.hidden.orderExecutors; 
						user: jbr.hidden.orderInspectors;
						user: jbr.hidden.notePersons;
						link: jbr.hidden.external.executor;
						link: jbr.ThemeOfQuery;
						link: jbr.QuestionOfQuery;
						tree: jbr.QueryExemptions;
						link: jbr.ConsiderDecision;
						link: jbr.InfAboutDocRegion;
						link: jbr.InfAboutDocCountry;
						link: jbr.InfAboutDocCity;
						datedTypedLink: jbr.og.addressee.list
						user: jbr.hidden.examinators;
						tree: jbr.SourceType;
						list: jbr.reg.requestType;
						link: regjournal;
						link: index;
						link: jbr.AuthType;
						user: jbr.incoming.registrar;
						list: jbr.inbound.typecontrol;
						user: jbr.incoming.inspector;
					" />
					<parameter name="maxArgStrLen" value="500" />
				</pre-process>

				<!--
					"Скрытая срочность" заполняется из обычной срочности копирование
					происходит непосредственно в БД, так что это возможно только в
					пост-фазе, после сохранения карточки.
				-->
				<post-process class="CopyAttributeToChildren" runOrder="20">
					<parameter name="from" value="ADMIN_290575" />
					<parameter name="to" value="JBR_HOWFAST" />
				</post-process>

				<post-process class="TreeProcessor" runOrder="25">
					<parameter name="forestOriginBackLinkAttrId" value="@Self" />
					<parameter name="forestOriginLinkAttrIds"
						value="
								JBR_IMPL_ACQUAINT,
								backLink:JBR_IMPL_RESOLUT,
								JBR_INFORM_LIST,
								jbr.Distribution.DistributionList
							" />
					<parameter name="nodeLinkAttrIds"
						value="
								JBR_IMPL_ACQUAINT,
								backLink:JBR_IMPL_RESOLUT,
								JBR_INFORM_LIST,
								JBR_VISA_VISA,
								ADMIN_893724,
								JBR_SIGN_SIGNING,
								JBR_IMPL_ACQUAINT,
								backLink:JBR_IMPL_RESOLUT,
								JBR_INFORM_LIST,
								backLink:JBR_RIMP_RELASSIG,
								backLink:jbr.reports, 
								backLink:jbr.resolution.ExtReport, 
								jbr.resolution.FyiReport,
								backLink:jbr.visa.res
							" />
					<parameter name="leafLinkAttrIds" value="" />
					<parameter name="processorClassName"
						value="com.aplana.dbmi.jbr.processors.docgraph.copyAttribute" />
					<parameter name="srcAttrId" value="ADMIN_290575" />
					<parameter name="dstAttrId" value="JBR_HOWFAST" />
				</post-process>

				<!-- (YNikitin, 2013/11/13, BR4J00034081) в рамках оптимизации системы, убираем лишние процессоры и донастраиваем оставшиеся, чтобы не было лишних пересчётов прав и лишних копирований атрибутов -->
				<!-- post-process class="CopyPersonsFromLinkedCards" runOrder="30">
					<parameter name="linkAttrId" value="jbr.examby" />
					<parameter name="linkReversed" value="false" />
					<parameter name="personAttrId" value="jbr.hidden.examinerAssistants" />
					<parameter name="linkedPersonAttrIds" value="jbr.hidden.examinerAssistants" />
					<parameter name="async" value="true" />										
				</post-process-->
				<!-- Исполнители поручений скрытые -->
				<!-- (YNikitin, 2013/11/13, BR4J00034081) в рамках оптимизации системы, убираем лишние процессоры и донастраиваем оставшиеся, чтобы не было лишних пересчётов прав и лишних копирований атрибутов -->
				<!-- post-process class="CopyPersonsFromDeepCards" runOrder="35">
					<parameter name="linkAttrId" value="backLink:jbr.resolutions" />
					<parameter name="linkChildAttrId" value="backLink:jbr.linkedResolutions" />
					<parameter name="depth" value="20" />
					<parameter name="linkReversed" value="false" />
					<parameter name="personAttrId" value="ADMIN_473763" />
					<parameter name="linkedPersonAttrIds" value="jbr.resolution.dynamic_role.hidden" />
				</post-process-->
				<!-- Контролеры поручений скрытые -->
				<!-- (YNikitin, 2013/11/13, BR4J00034081) в рамках оптимизации системы, убираем лишние процессоры и донастраиваем оставшиеся, чтобы не было лишних пересчётов прав и лишних копирований атрибутов -->
				<!-- post-process class="CopyPersonsFromLinkedCards" runOrder="40">
					<parameter name="linkAttrId" value="JBR_IMPL_RESOLUT" />
					<parameter name="linkReversed" value="false" />
					<parameter name="personAttrId" value="ADMIN_473954" />
					<parameter name="linkedPersonAttrIds" value="JBR_TCON_INSPECTOR" />
					<parameter name="async" value="true" />										
				</post-process-->
				<!-- Рассматривающие скрытые -->
				<!-- (YNikitin, 2013/11/13, BR4J00034081) в рамках оптимизации системы, убираем лишние процессоры и донастраиваем оставшиеся, чтобы не было лишних пересчётов прав и лишних копирований атрибутов -->
				<!-- post-process class="CopyPersonsFromLinkedCards" runOrder="45">
					<parameter name="linkAttrId" value="JBR_IMPL_ACQUAINT" />
					<parameter name="linkReversed" value="false" />
					<parameter name="personAttrId" value="ADMIN_473929" />
					<parameter name="linkedPersonAttrIds" value="JBR_RASSM_PERSON" />
					<parameter name="async" value="true" />										
				</post-process-->
				<!--
					Пользователи, имеющие доступ к поручениям "Читающие из поручений"
				-->
				<!-- (YNikitin, 2013/11/13, BR4J00034081) в рамках оптимизации системы, убираем лишние процессоры и донастраиваем оставшиеся, чтобы не было лишних пересчётов прав и лишних копирований атрибутов -->
				<!-- post-process class="SetAssistantCard" runOrder="50">
					<parameter name="chiefAttrId1" value="[С+][A-]jbr.examiners" />
					<parameter name="chiefAttrId2" value="[С+][A-]jbr.hidden.examinerAssistants" />
					<parameter name="chiefAttrId3" value="[С+][A+]jbr.hidden.visa" />
					<parameter name="chiefAttrId4" value="[С+][A-]ADMIN_478059" />
					<parameter name="chiefAttrId5" value="[С+][A+]jbr.signext" />
					<parameter name="chiefAttrId6" value="[С+][A-]jbr.incoming.inspector" />
					<parameter name="chiefAttrId7" value="[С+][A+]jbr.inform.hidden" />
					<parameter name="chiefAttrId8" value="[С+][A-]jbr.outgoing.registrar" />
					<parameter name="assistantsAttrId"
						value="jbr.resolutions.dynamic_role.toread.hidden" />
					<parameter name="assistantsPreclear" value="false" />
					<parameter name="forceSave" value="true" />
				</post-process-->
				<!-- Обновляет поле NAME рассмотрения -->
				<post-process class="CallOriginsProcessor" runOrder="55">
					<parameter name="backLinkAttrId" value="link: JBR_IMPL_ACQUAINT" />
					<parameter name="processorClassName"
						value="com.aplana.dbmi.jbr.processors.GenerateName" />
					<!--
						parameter name="format" value="Рассмотреть ИЗ № {0} от {1}, {2}"/
					-->
					<!-- parameter name="format" value="Рассмотреть ИЗ № {0}, {2}" /-->
					<parameter name="format" value="Рассмотреть документ %MAINDOC.TEMPLATE.NAME% № {0} от {1} {2}" />
					<parameter name="srcAttrIds"
						value="
						backLink: JBR_RASSM_PARENT_DOC@regnumber; 
						backLink: JBR_RASSM_PARENT_DOC@regdate;
						backLink: JBR_RASSM_PARENT_DOC@jbr.shortcontext" />
					<parameter name="dstAttrId" value="NAME" />
					<parameter name="forceSave" value="true" />
				</post-process>
				<!-- Обновляем поле NAME Отчета об исполнении -->
				<post-process class="CallCardsLinkedToBaseProcessor" runOrder="60">
					<parameter name="processorClassName"
						value="com.aplana.dbmi.jbr.processors.DeepGenerateName" />
					<parameter name="templateId" value="jbr.report.internal" />
					<parameter name="linkId" value="link: ADMIN_702604" />
					<!--
						parameter name="format" value='Поручение ({0} №{1} от {2}) от {3}:
						"{4}", исполнитель: {5} по документу № {6} от {7}, {8}{9}'/
					-->
					<parameter name="format"
						value='Поручение по документу №{0} от {1}, {2}' />
					<parameter name="srcAttrIds"
						value="
						link: ADMIN_702604@regnumber;
						link: ADMIN_702604@regdate;
						link: ADMIN_702604@jbr.document.title;" />
					<parameter name="dstAttrId" value="NAME" />
					<parameter name="forceSave" value="true" />
				</post-process>
				<!-- Обновляем поле NAME Ознакомления с поручением -->
				<post-process class="CallCardsLinkedToBaseProcessor" runOrder="65">
					<parameter name="processorClassName"
						value="com.aplana.dbmi.jbr.processors.DeepGenerateName" />
					<parameter name="templateId" value="jbr.adnotamCommission" />
					<parameter name="linkId" value="link: ADMIN_726877" />
					<!--
						parameter name="format" value='Ознакомиться с поручением от {0}:
						"{1}" по документу № {2} от {3}, {4}{5}'/
					-->
					<parameter name="format"
						value='Ознакомиться с поручением  от {0}: "{1}" по документу № {2} от {3}, {5}' />
					<parameter name="srcAttrIds"
						value="
						backLink: ADMIN_726876@jbr.resolution.FioSign;
						backLink: ADMIN_726876@jbr.resolutionText;
						link: ADMIN_726877@regnumber;
						link: ADMIN_726877@regdate;
						link: ADMIN_726877@jbr.document.title;
						link: ADMIN_726877@jbr.shortcontext;" />
					<parameter name="dstAttrId" value="NAME" />
					<parameter name="forceSave" value="true" />
				</post-process>
				<!-- Обновляем поле NAME Отчета об исполнении внешнего исполнителя -->
				<post-process class="CallCardsLinkedToBaseProcessor" runOrder="70">
					<parameter name="processorClassName"
						value="com.aplana.dbmi.jbr.processors.DeepGenerateName" />
					<parameter name="templateId" value="jbr.report.external" />
					<parameter name="linkId" value="link: ADMIN_702602" />
					<parameter name="format"
						value='Поручение (№ {0}) от {1}: "{2}", Вн. исполнитель: {3} {4}. {5}. ({6}) по документу {7}' />
					<parameter name="srcAttrIds"
						value="
						link: jbr.report.ext.document@regnumber;
						link: jbr.report.ext.parent@jbr.resolution.FioSign;
						link: jbr.report.ext.parent@jbr.resolutionText;
						link: jbr.report.ext.executor@jbr.person.lastName;
						link: jbr.report.ext.executor@jbr.person.firstName#1;
						link: jbr.report.ext.executor@jbr.person.middleName#1;
						link: jbr.report.ext.executor@jbr.person.organization@jbr.organization.shortName;
						link: jbr.report.ext.document@jbr.shortcontext;" />
					<parameter name="dstAttrId" value="NAME" />
					<parameter name="forceSave" value="true" />
				</post-process>

				<!-- @deprecated (YNikitin, 2013/07/23, 30687) Переносим данный код в сохранение поручения -->
				<!-- post-process class="CopyCardLinkAttributeToParent" runOrder="140">
					<parameter name="parent" value="@Self"/>
					<parameter name="from" value="jbr.resolutions"/>
					<parameter name="to" value="JBR_ALL_RESOLUTIONS"/>
				</post-process>
				-->
				
			</specific>

			<!-- Шаблон Внутренний:784 -->
			<specific property="template" value="jbr.interndoc">
				<!-- проверка заполнения "На контроле"/"Срок"/"Контролер" -->
				<validator class="ChkOnCtrlInfo" runOrder="5">
					<parameter name="forceSave" value="false" />
				</validator>

				<pre-process class="GenerateName" runOrder="10">
					<parameter name="format" value="{0} {1} от {2}, {3}"/>
					<!-- <parameter name="format" value="{0} {1}, {3}" />  -->
					<parameter name="dstAttrId" value="string: NAME" />
					<parameter name="srcAttrIds"
						value="
						link: JBR_INFD_TYPEDOC; 
						string: regnumber; 
						date: regdate; 
						text: JBR_INFD_SHORTDESC
					" />
				</pre-process>
				<!-- Keywords for search -->
				<pre-process class="GenerateName" runOrder="15">
					<parameter name="format"
						value="{0}; {1}; {2}; {3}; {4}; {5}; {6}; {7}; {8}; {9}; {10}; {11}; {12}" />
					<parameter name="dstAttrId" value="string: KEYWORDS" />
					<parameter name="srcAttrIds"
						value="
						user: author;
						user: jbr.ext.curator.editor;
						link: jbr.hidden.external.executor;
						link: jbr.visa.ext.set;
						user: jbr.outcoming.signatory;	
						user: jbr.incoming.addressee;	
						user: jbr.resolutionExecutor;			
						link: jbr.reg.doctype;
						link: regjournal;
						link: index;
						user: jbr.incoming.registrar;
						user: jbr.incoming.inspector;
						user: jbr.npa.curator
					" />
					<parameter name="maxArgStrLen" value="3000" />
				</pre-process>
				<!-- При сохранении Внутр в случае изменения поля ФИО Подписанта, Адресата или Исполнителя обновлять атрибут Зона ДОУ на основе Зоны ДОУ ФИО Подписанта документа, Исполнителя, Адресата и Автора (предыдущее значение перед изменением очищать) -->
				<!-- (BR4J00037127, YNikitin, 2014/08/18) Адресат используется только в статусах Зарегистрирован, Рассмотрение, Исполнение, Исполнен, Готов к списанию в дело, В дело (совместно с Исполнителем, Подписантом и Автором), во всех остальных статусах используются остальные три поля -->
				<pre-process class="CopyAttributeFromParent" runOrder="18">
					<parameter name="affectedStates" value="registration, consideration, execution, done, ready-to-write-off, delo" />
					<parameter name="isOnlyModel" value="true" />
					<parameter name="from" value="jbr.zoneDOW"/>
					<parameter name="to" value="jbr.zoneDOW"/>
					<parameter name="parent" value="jbr.outcoming.signatory"/>
					<parameter name="parentTemplate" value="jbr.internalPerson"/>
					<parameter name="type" value="C"/>
					<parameter name="writeOperation" value="preclear+overwrite"/>
					<parameter name="changeAttribute" value="user:jbr.outcoming.signatory;user:jbr.incoming.addressee;user:jbr.document.executor"/>
					<parameter name="changeAttributeOption" value="OR"/>
				</pre-process>
				<pre-process class="CopyAttributeFromParent" runOrder="19">
					<parameter name="affectedStates" value="registration, consideration, execution, done, ready-to-write-off, delo" />
					<parameter name="isOnlyModel" value="true" />
					<parameter name="from" value="jbr.zoneDOW"/>
					<parameter name="to" value="jbr.zoneDOW"/>
					<parameter name="parent" value="author"/>
					<parameter name="parentTemplate" value="jbr.internalPerson"/>
					<parameter name="type" value="C"/>
					<parameter name="writeOperation" value="append" />
					<parameter name="changeAttribute" value="user:jbr.outcoming.signatory;user:jbr.incoming.addressee;user:jbr.document.executor"/>
					<parameter name="changeAttributeOption" value="OR"/>
				</pre-process>
				<pre-process class="CopyAttributeFromParent" runOrder="20">
					<parameter name="affectedStates" value="registration, consideration, execution, done, ready-to-write-off, delo" />
					<parameter name="isOnlyModel" value="true" />
					<parameter name="from" value="jbr.zoneDOW"/>
					<parameter name="to" value="jbr.zoneDOW"/>
					<parameter name="parent" value="jbr.incoming.addressee"/>
					<parameter name="parentTemplate" value="jbr.internalPerson"/>
					<parameter name="type" value="C"/>
					<parameter name="writeOperation" value="append" />
					<parameter name="changeAttribute" value="user:jbr.outcoming.signatory;user:jbr.incoming.addressee;user:jbr.document.executor"/>
					<parameter name="changeAttributeOption" value="OR"/>
				</pre-process>
				<pre-process class="CopyAttributeFromParent" runOrder="21">
					<parameter name="affectedStates" value="registration, consideration, execution, done, ready-to-write-off, delo" />
					<parameter name="isOnlyModel" value="true" />
					<parameter name="from" value="jbr.zoneDOW"/>
					<parameter name="to" value="jbr.zoneDOW"/>
					<parameter name="parent" value="jbr.document.executor"/>
					<parameter name="parentTemplate" value="jbr.internalPerson"/>
					<parameter name="type" value="C"/>
					<parameter name="writeOperation" value="append" />
					<parameter name="changeAttribute" value="user:jbr.outcoming.signatory;user:jbr.incoming.addressee;user:jbr.document.executor"/>
					<parameter name="changeAttributeOption" value="OR"/>
				</pre-process>

				<pre-process class="CopyAttributeFromParent" runOrder="22">
					<parameter name="affectedStates" value="preparation, agreement, sign, before-registration, trash, rejected" />
					<parameter name="isOnlyModel" value="true" />
					<parameter name="from" value="jbr.zoneDOW"/>
					<parameter name="to" value="jbr.zoneDOW"/>
					<parameter name="parent" value="jbr.outcoming.signatory"/>
					<parameter name="parentTemplate" value="jbr.internalPerson"/>
					<parameter name="type" value="C"/>
					<parameter name="writeOperation" value="preclear+overwrite"/>
					<parameter name="changeAttribute" value="user:jbr.outcoming.signatory;user:jbr.document.executor"/>
					<parameter name="changeAttributeOption" value="OR"/>
				</pre-process>
				<pre-process class="CopyAttributeFromParent" runOrder="23">
					<parameter name="affectedStates" value="preparation, agreement, sign, before-registration, trash, rejected" />
					<parameter name="isOnlyModel" value="true" />
					<parameter name="from" value="jbr.zoneDOW"/>
					<parameter name="to" value="jbr.zoneDOW"/>
					<parameter name="parent" value="author"/>
					<parameter name="parentTemplate" value="jbr.internalPerson"/>
					<parameter name="type" value="C"/>
					<parameter name="writeOperation" value="append" />
					<parameter name="changeAttribute" value="user:jbr.outcoming.signatory;user:jbr.document.executor"/>
					<parameter name="changeAttributeOption" value="OR"/>
				</pre-process>
				<pre-process class="CopyAttributeFromParent" runOrder="24">
					<parameter name="affectedStates" value="preparation, agreement, sign, before-registration, trash, rejected" />
					<parameter name="isOnlyModel" value="true" />
					<parameter name="from" value="jbr.zoneDOW"/>
					<parameter name="to" value="jbr.zoneDOW"/>
					<parameter name="parent" value="jbr.document.executor"/>
					<parameter name="parentTemplate" value="jbr.internalPerson"/>
					<parameter name="type" value="C"/>
					<parameter name="writeOperation" value="append" />
					<parameter name="changeAttribute" value="user:jbr.outcoming.signatory;user:jbr.document.executor"/>
					<parameter name="changeAttributeOption" value="OR"/>
				</pre-process>
				
				<!-- Добавление версии в файлы вложений при сохранении документа -->
				<post-process class="IterationNumberAdditionToFiles" runOrder="26">
					<parameter name="IterationNumber" value="jbr.visa.round" />					
				</post-process>
				<!--
					"Скрытая срочность" заполняется из обычной срочности копирование
					происходит непосредственно в БД, так что это возможно только в
					пост-фазе, после сохранения карточки.
				-->
				<post-process class="CopyAttributeToChildren" runOrder="27">
					<parameter name="from" value="ADMIN_290575" />
					<parameter name="to" value="JBR_HOWFAST" />
				</post-process>

				<!--  "Скрытая срочность" для вложенных документов -->
				<post-process class="TreeProcessor" runOrder="30">
					<parameter name="forestOriginBackLinkAttrId" value="@Self" />
					<parameter name="forestOriginLinkAttrIds"
						value="
								JBR_VISA_VISA,
								JBR_SIGN_SIGNING
								JBR_IMPL_ACQUAINT,
								backLink:JBR_IMPL_RESOLUT,
								jbr.Distribution.DistributionList
							" />
					<parameter name="nodeLinkAttrIds"
						value="
								JBR_IMPL_ACQUAINT,
								backLink:JBR_IMPL_RESOLUT,
								JBR_INFORM_LIST,
								JBR_VISA_VISA,
								ADMIN_893724,
								JBR_SIGN_SIGNING,
								JBR_IMPL_ACQUAINT,
								backLink:JBR_IMPL_RESOLUT,
								JBR_INFORM_LIST,
								backLink:JBR_RIMP_RELASSIG,
								backLink:jbr.reports, 
								backLink:jbr.resolution.ExtReport, 
								jbr.resolution.FyiReport,
								backLink:jbr.visa.res
							" />
					<parameter name="leafLinkAttrIds" value="" />
					<parameter name="processorClassName"
						value="com.aplana.dbmi.jbr.processors.docgraph.copyAttribute" />
					<parameter name="srcAttrId" value="ADMIN_290575" />
					<parameter name="dstAttrId" value="JBR_HOWFAST" />
				</post-process>

				<!-- Обновляет поле NAME рассмотрения -->
				<post-process class="CallOriginsProcessor" runOrder="100">
					<parameter name="backLinkAttrId" value="link: JBR_IMPL_ACQUAINT" />
					<parameter name="processorClassName"
						value="com.aplana.dbmi.jbr.processors.DeepGenerateName" />
					<!--
						parameter name="format" value="Рассмотреть Внутренний № {0} от
						{1}, {2}"/
					-->
					<!-- parameter name="format" value="Рассмотреть Внутренний № {0}, {2}" /-->
					<parameter name="format" value="Рассмотреть документ %MAINDOC.TEMPLATE.NAME% № {0} от {1} {2}" />
					<parameter name="srcAttrIds"
						value="
						backLink: JBR_RASSM_PARENT_DOC@regnumber; 
						backLink: JBR_RASSM_PARENT_DOC@regdate;
						backLink: JBR_RASSM_PARENT_DOC@jbr.document.title" />
					<parameter name="dstAttrId" value="NAME" />
					<parameter name="forceSave" value="true" />
					<!-- (YNikitin, 2013/07/18) При формировании названий дочерних карточек, сохранять сами карточки не надо, достаточно обновить атрибут, 
					это позволяет ускорить процесс сохранения документа основания, а значит и создание нового поручения -->
					<parameter name="forceSaveMode" value="ATTRIBUTE" />
				</post-process>
				<!-- Обновляет поле NAME подписания -->
				<post-process class="CallOriginsProcessor" runOrder="105">
					<parameter name="backLinkAttrId" value="link: JBR_SIGN_SIGNING" />
					<parameter name="processorClassName"
						value="com.aplana.dbmi.jbr.processors.DeepGenerateName" />
					<!-- parameter name="format"
						value="Подписать документ Внутрений, дата создания: {0},  исполнитель: {1}, {2}" /-->
					<parameter name="format"
						value="Подписать документ %MAINDOC.TEMPLATE.NAME%, Исполнитель: {0}, {1}" />
					<parameter name="srcAttrIds"
						value="
						backLink: JBR_SIGN_PARENT@jbr.resolutionExecutor;
						backLink: JBR_SIGN_PARENT@jbr.document.title" />
					<parameter name="dstAttrId" value="NAME" />
					<parameter name="forceSave" value="true" />
					<!-- (YNikitin, 2013/07/18) При формировании названий дочерних карточек, сохранять сами карточки не надо, достаточно обновить атрибут, 
					это позволяет ускорить процесс сохранения документа основания, а значит и создание нового поручения -->
					<parameter name="forceSaveMode" value="ATTRIBUTE" />
				</post-process>
				<!-- Обновляет поле NAME Ознакомления -->
				<post-process class="CallOriginsProcessor" runOrder="110">
					<parameter name="backLinkAttrId" value="link: JBR_INFORM_LIST" />
					<parameter name="processorClassName"
						value="com.aplana.dbmi.jbr.processors.DeepGenerateName" />
					<!--
						parameter name="format" value="Ознакомиться с документом Внутрений
						№ {0} от {1}, {2}"/
					-->
					<!-- parameter name="format"
						value="Ознакомиться с документом Внутрений № {0}, {2}" /-->
					<parameter name="format"
						value="Ознакомиться с документом {3} № {0} от {1}, {2}" />
					<parameter name="srcAttrIds"
						value="
						backLink: JBR_INFORM_DOC@regnumber; 
						backLink: JBR_INFORM_DOC@regdate;
						backLink: JBR_INFORM_DOC@jbr.document.title;
						backLink: JBR_INFORM_DOC@jbr.reg.doctype@name" />
					<parameter name="dstAttrId" value="NAME" />
					<parameter name="forceSave" value="true" />
					<!-- (YNikitin, 2013/07/18) При формировании названий дочерних карточек, сохранять сами карточки не надо, достаточно обновить атрибут, 
					это позволяет ускорить процесс сохранения документа основания, а значит и создание нового поручения -->
					<parameter name="forceSaveMode" value="ATTRIBUTE" />
				</post-process>
				<!-- Обновляет поле NAME Визирование -->
				<post-process class="CallOriginsProcessor" runOrder="115">
					<parameter name="backLinkAttrId" value="link: JBR_VISA_VISA" />
					<parameter name="processorClassName"
						value="com.aplana.dbmi.jbr.processors.DeepGenerateName" />
					<!-- parameter name="format"
						value="Согласовать документ Внутрений, дата создания: {0},  исполнитель: {1}, {2}" /-->
					<parameter name="format"
						value="Согласовать %MAINDOC.TEMPLATE.NAME%, Исполнитель: {0}, {1}" />
					<parameter name="srcAttrIds"
						value="
						backLink: JBR_VISA_PARENT_DOC@jbr.resolutionExecutor;
						backLink: JBR_VISA_PARENT_DOC@jbr.document.title" />
					<parameter name="dstAttrId" value="NAME" />
					<parameter name="forceSave" value="true" />
					<!-- (YNikitin, 2013/07/18) При формировании названий дочерних карточек, сохранять сами карточки не надо, достаточно обновить атрибут, 
					это позволяет ускорить процесс сохранения документа основания, а значит и создание нового поручения -->
					<parameter name="forceSaveMode" value="ATTRIBUTE" />
				</post-process>
				<!-- Обновляем поле NAME Отчета об исполнении -->
				<post-process class="CallCardsLinkedToBaseProcessor" runOrder="120">
					<parameter name="processorClassName"
						value="com.aplana.dbmi.jbr.processors.DeepGenerateName" />
					<parameter name="templateId" value="jbr.report.internal" />
					<parameter name="linkId" value="link: ADMIN_702604" />
					<!--
						parameter name="format" value='Поручение ({0} №{1} от {2}) от {3}:
						"{4}", исполнитель: {5} по документу № {6} от {7}, {8}{9}'/
					-->
					<parameter name="format"
						value='Поручение по документу №{0} от {1}, {2}' />
					<parameter name="srcAttrIds"
						value="
						link: ADMIN_702604@regnumber;
						link: ADMIN_702604@regdate;
						link: ADMIN_702604@jbr.document.title;" />
					<parameter name="dstAttrId" value="NAME" />
					<parameter name="forceSave" value="true" />
					<!-- (YNikitin, 2013/07/18) При формировании названий дочерних карточек, сохранять сами карточки не надо, достаточно обновить атрибут, 
					это позволяет ускорить процесс сохранения документа основания, а значит и создание нового поручения -->
					<parameter name="forceSaveMode" value="ATTRIBUTE" />
				</post-process>
				<!-- Обновляем поле NAME Ознакомления с поручением -->
				<post-process class="CallCardsLinkedToBaseProcessor" runOrder="125">
					<parameter name="processorClassName"
						value="com.aplana.dbmi.jbr.processors.DeepGenerateName" />
					<parameter name="templateId" value="jbr.adnotamCommission" />
					<parameter name="linkId" value="link: ADMIN_726877" />
					<!--
						parameter name="format" value='Ознакомиться с поручением от {0}:
						"{1}" по документу № {2} от {3}, {4}{5}'/
					-->
					<parameter name="format"
						value='Ознакомиться с поручением  от {0}: "{1}" по документу № {2} от {3}, {5}' />
					<parameter name="srcAttrIds"
						value="
						backLink: ADMIN_726876@jbr.resolution.FioSign;
						backLink: ADMIN_726876@jbr.resolutionText;
						link: ADMIN_726877@regnumber;
						link: ADMIN_726877@regdate;
						link: ADMIN_726877@jbr.document.title;
						link: ADMIN_726877@jbr.shortcontext;" />
					<parameter name="dstAttrId" value="NAME" />
					<parameter name="forceSave" value="true" />
					<!-- (YNikitin, 2013/07/18) При формировании названий дочерних карточек, сохранять сами карточки не надо, достаточно обновить атрибут, 
					это позволяет ускорить процесс сохранения документа основания, а значит и создание нового поручения -->
					<parameter name="forceSaveMode" value="ATTRIBUTE" />
				</post-process>
				<!-- Обновляем поле NAME Отчета об исполнении внешнего исполнителя -->
				<post-process class="CallCardsLinkedToBaseProcessor" runOrder="130">
					<parameter name="processorClassName"
						value="com.aplana.dbmi.jbr.processors.DeepGenerateName" />
					<parameter name="templateId" value="jbr.report.external" />
					<parameter name="linkId" value="link: ADMIN_702602" />
					<parameter name="format"
						value='Поручение (№ {0}) от {1}: "{2}", Вн. исполнитель: {3} {4}. {5}. ({6}) по документу {7}' />
					<parameter name="srcAttrIds"
						value="
						link: jbr.report.ext.document@regnumber;
						link: jbr.report.ext.parent@jbr.resolution.FioSign;
						link: jbr.report.ext.parent@jbr.resolutionText;
						link: jbr.report.ext.executor@jbr.person.lastName;
						link: jbr.report.ext.executor@jbr.person.firstName#1;
						link: jbr.report.ext.executor@jbr.person.middleName#1;
						link: jbr.report.ext.executor@jbr.person.organization@jbr.organization.shortName;
						link: jbr.report.ext.document@jbr.shortcontext;" />
					<parameter name="dstAttrId" value="NAME" />
					<parameter name="forceSave" value="true" />
					<!-- (YNikitin, 2013/07/18) При формировании названий дочерних карточек, сохранять сами карточки не надо, достаточно обновить атрибут, 
					это позволяет ускорить процесс сохранения документа основания, а значит и создание нового поручения -->
					<parameter name="forceSaveMode" value="ATTRIBUTE" />
				</post-process>

				<!-- Ответственный за ДОУ -->
				<post-process class="CopyPersonFromPaths" runOrder="135">
					<parameter name="targetAttr" value="jbr.responsible_dow.resp_dow" />
					<parameter name="paths"
						value="
						user:jbr.resolutionExecutor->link:jbr.personInternal.department->user:jbr.department.resp_dow
					" />
					<parameter name="reloadCard" value="true" />
				</post-process>

				<!-- Ответственный за ДОУ на чтение -->
				<post-process class="CopyPersonFromPaths" runOrder="140">
					<parameter name="targetAttr" value="jbr.responsible_dow.resp_dow_read" />
					<parameter name="paths"
						value="
						user:admin_473763->link:jbr.personInternal.department->user:jbr.department.resp_dow;
						user:jbr.inform.hidden->link:jbr.personInternal.department->user:jbr.department.resp_dow;
						user:jbr.incoming.addressee->link:jbr.personInternal.department->user:jbr.department.resp_dow;
						user:jbr.hidden.visa->link:jbr.personInternal.department->user:jbr.department.resp_dow;
						user:jbr.outcoming.signatory->link:jbr.personInternal.department->user:jbr.department.resp_dow;
						user:jbr.npa.curator->link:jbr.personInternal.department->user:jbr.department.resp_dow;
						link:ADMIN_6079618->user:jbr.department.resp_dow;
					" />
					<parameter name="reloadCard" value="true" />
				</post-process>
				<!-- Формируем атрибут NAME для запросов на резервирование -->
				<post-process class="GenerateChildrenNames" runOrder="150">
					<parameter name="childrenCardLinkAttrId" value="jbr.doc.reservationRequests" />
					<parameter name="format"
						value="Запрос на резервирование номера для документа {0}" />
					<parameter name="dstAttrId" value="string: NAME" />
					<parameter name="srcAttrIds" value="text: jbr.document.title" />
					<parameter name="forceSave" value="true" />
				</post-process>

				<!-- @deprecated (YNikitin, 2013/07/23) Переносим данный код в сохранение поручения -->
				<!-- post-process class="CopyCardLinkAttributeToParent" runOrder="140">
					<parameter name="parent" value="@Self"/>
					<parameter name="from" value="jbr.resolutions"/>
					<parameter name="to" value="JBR_ALL_RESOLUTIONS"/>
				</post-process>
				-->
				
			</specific>

			<!-- Шаблон Входящий (224) -->
			<specific property="template" value="jbr.incoming" async="false">

				<!-- проверка заполнения "На контроле"/"Срок"/"Контролер" -->
				<validator class="ChkOnCtrlInfo" runOrder="5">
					<parameter name="forceSave" value="false" />
				</validator>

				<pre-process class="GenerateName" runOrder="10">
					<!--  <parameter name="format" value="{0} {1}, (номер исходящего {3}), {4}" />  -->
					<parameter name="format" value="{0} {1} от {2}, (номер исходящего {3}), {4}"/>
					<parameter name="dstAttrId" value="string: NAME" />
					<parameter name="srcAttrIds"
						value="
							link: JBR_INFD_TYPEDOC; 
							string: regnumber; 
							date: regdate; 
							string: JBR_REGD_NUMOUT;
							text: JBR_INFD_SHORTDESC" />
				</pre-process>
				<!-- Keywords for search -->
				<pre-process class="GenerateName" runOrder="11">
					<parameter name="format"
						value="{0}; {1}; {2}; {3}; {4}; {5}; {6}; {7}; {8}; {9}; {10}; {11}; {12}; {13}" />
					<parameter name="dstAttrId" value="string: KEYWORDS" />
					<parameter name="srcAttrIds"
						value="
							user: author;
							link: jbr.hidden.external.executor;
							link: jbr.incoming.sender;
							link: jbr.signext;
							user: jbr.incoming.addressee;
							link: jbr.incoming.foiv;
							user: jbr.incoming.inspector;
							link: jbr.reg.doctype;
							link: regjournal;
							link: index;
							link: jbr.incoming.sender.actual;
							user: jbr.ext.curator.editor;
							user: jbr.incoming.registrar;
							user: jbr.npa.curator
					" />
					<parameter name="maxArgStrLen" value="3000" />
				</pre-process>
				<!-- Если перед нами промежуточный документ и у него по какой-то причине Зона Доу заполнена, то очищаем её -->
				<post-process class="ClearCardAttributePostProcessorEx" runOrder="12">
					<parameter name="condition" value="list:jbr.replication.replicatingDocType=jbr.replication.replicatedDocument"/>
					<parameter name="condition" value="link:jbr.zoneDOW#NULL"/>
					<parameter name="attrId" value="link:jbr.zoneDOW"/>
				</post-process>

				<!-- Если перед нами итоговый реплицированный документ. то Зону ДОУ берем один раз из Организации-рецепиента -->
				<post-process class="CopyAttributeFromParent" runOrder="13">
					<parameter name="isOnlyModel" value="false" />
					<parameter name="attr_condition_2" value="link:jbr.zoneDOW=NULL"/>
					<parameter name="attr_condition_4" value="list:jbr.replication.replicatingDocType=jbr.replication.localDocument"/>
					<parameter name="from" value="jbr.zonesDOW"/>
					<parameter name="to" value="jbr.zoneDOW"/>
					<parameter name="parent" value="jbr.replication.orgRecipient"/>
					<parameter name="parentTemplate" value="jbr.organization"/>
					<parameter name="writeOperation" value="preclear+overwrite"/>
					<parameter name="type" value="C"/>
				</post-process>
				<!-- Если же у нас не реплицированный документ, а исходный (локальный), то логика старая -->
				<!-- При сохранении входящего, ОГ в случае изменения поля Адресат обновлять атрибут Зона ДОУ на основе Зоны ДОУ Адресата документа и Автора (предыдущее значение перед изменением очищать) -->
				<post-process class="CopyAttributeFromParent" runOrder="14">
					<parameter name="attr_condition_3" value="list:jbr.replication.replicatingDocType#jbr.replication.replicatedDocument"/>
					<parameter name="attr_condition_4" value="list:jbr.replication.replicatingDocType#jbr.replication.localDocument"/>
					<parameter name="isOnlyModel" value="false" />
					<parameter name="from" value="jbr.zoneDOW"/>
					<parameter name="to" value="jbr.zoneDOW"/>
					<parameter name="parent" value="jbr.incoming.addressee"/>
					<parameter name="parentTemplate" value="jbr.internalPerson"/>
					<parameter name="writeOperation" value="preclear+overwrite"/>
					<parameter name="type" value="C"/>
					<parameter name="changeAttribute" value="user:jbr.incoming.addressee"/>
				</post-process>				
				<!-- Если автор Входящего ИЛИ ОГ Cистема и Зона ДОУ пустая, то атрибут Зона ДОУ заполняется на основе Зоны ДОУ Адресата, а если он пустой, то на основе Организации-получателя -->
				<post-process class="CopyAttributeFromParent" runOrder="15">
					<parameter name="isOnlyModel" value="false" />
					<parameter name="attr_condition_1" value="user:author=0"/>
					<parameter name="attr_condition_2" value="link:jbr.zoneDOW=NULL"/>
					<parameter name="attr_condition_3" value="list:jbr.replication.replicatingDocType#jbr.replication.replicatedDocument"/>
					<parameter name="attr_condition_4" value="list:jbr.replication.replicatingDocType#jbr.replication.localDocument"/>
					<parameter name="from" value="jbr.zoneDOW"/>
					<parameter name="to" value="jbr.zoneDOW"/>
					<parameter name="parent" value="jbr.incoming.addressee"/>
					<parameter name="parentTemplate" value="jbr.internalPerson"/>
					<parameter name="type" value="C"/>
				</post-process>
				<post-process class="CopyAttributeFromParent" runOrder="17">
					<parameter name="isOnlyModel" value="false" />
					<parameter name="attr_condition_1" value="user:author=0"/>
					<parameter name="attr_condition_2" value="link:jbr.zoneDOW=NULL"/>
					<parameter name="attr_condition_3" value="list:jbr.replication.replicatingDocType#jbr.replication.replicatedDocument"/>
					<parameter name="attr_condition_4" value="list:jbr.replication.replicatingDocType#jbr.replication.localDocument"/>
					<parameter name="from" value="jbr.zonesDOW"/>
					<parameter name="to" value="jbr.zoneDOW"/>
					<parameter name="parent" value="jbr.outcoming.receiver.single"/>
					<parameter name="parentTemplate" value="jbr.organization"/>
					<parameter name="type" value="C"/>
				</post-process>
				<!-- При сохранении входящего, ОГ в случае изменения поля Адресат обновлять атрибут Зона ДОУ на основе Зоны ДОУ Адресата документа и Автора (предыдущее значение перед изменением очищать) -->
				<post-process class="CopyAttributeFromParent" runOrder="18">
					<parameter name="attr_condition_3" value="list:jbr.replication.replicatingDocType#jbr.replication.replicatedDocument"/>
					<parameter name="attr_condition_4" value="list:jbr.replication.replicatingDocType#jbr.replication.localDocument"/>
					<parameter name="isOnlyModel" value="false" />
					<parameter name="from" value="jbr.zoneDOW"/>
					<parameter name="to" value="jbr.zoneDOW"/>
					<parameter name="parent" value="jbr.incoming.addressee"/>
					<parameter name="parentTemplate" value="jbr.internalPerson"/>
					<parameter name="writeOperation" value="preclear+overwrite"/>
					<parameter name="type" value="C"/>
					<parameter name="changeAttribute" value="user:jbr.incoming.addressee"/>
				</post-process>
				<post-process class="CopyAttributeFromParent" runOrder="19">
					<parameter name="attr_condition_3" value="list:jbr.replication.replicatingDocType#jbr.replication.replicatedDocument"/>
					<parameter name="attr_condition_4" value="list:jbr.replication.replicatingDocType#jbr.replication.localDocument"/>
					<parameter name="isOnlyModel" value="false" />
					<parameter name="from" value="jbr.zoneDOW"/>
					<parameter name="to" value="jbr.zoneDOW"/>
					<parameter name="parent" value="author"/>
					<parameter name="parentTemplate" value="jbr.internalPerson"/>
					<parameter name="type" value="C"/>
					<parameter name="writeOperation" value="append" />
					<parameter name="changeAttribute" value="user:jbr.incoming.addressee"/>
				</post-process>
				<!--
					"Скрытая срочность" заполняется из обычной срочности копирование
					происходит непосредственно в БД, так что это возможно только в
					пост-фазе, после сохранения карточки.
				-->
				<post-process class="CopyAttributeToChildren" runOrder="20">
					<parameter name="from" value="ADMIN_290575" />
					<parameter name="to" value="JBR_HOWFAST" />
				</post-process>

				<post-process class="TreeProcessor" runOrder="25">
					<parameter name="forestOriginBackLinkAttrId" value="@Self" />
					<parameter name="forestOriginLinkAttrIds"
						value="
								JBR_IMPL_ACQUAINT,
								backLink:JBR_IMPL_RESOLUT,
								JBR_INFORM_LIST,
								jbr.Distribution.DistributionList
							" />
					<parameter name="nodeLinkAttrIds"
						value="
								JBR_IMPL_ACQUAINT,
								backLink:JBR_IMPL_RESOLUT,
								JBR_INFORM_LIST,
								JBR_VISA_VISA,
								ADMIN_893724,
								JBR_SIGN_SIGNING,
								JBR_IMPL_ACQUAINT,
								backLink:JBR_IMPL_RESOLUT,
								JBR_INFORM_LIST,
								backLink:JBR_RIMP_RELASSIG,
								backLink:jbr.reports, 
								backLink:jbr.resolution.ExtReport, 
								jbr.resolution.FyiReport,
								backLink:jbr.visa.res
							" />
					<parameter name="leafLinkAttrIds" value="" />
					<parameter name="processorClassName"
						value="com.aplana.dbmi.jbr.processors.docgraph.copyAttribute" />
					<parameter name="srcAttrId" value="ADMIN_290575" />
					<parameter name="dstAttrId" value="JBR_HOWFAST" />
				</post-process>
				
				<!-- Для АРМ руководителя -->
				<post-process class="CopyAttributeToChildren" runOrder="100">
					<parameter name="from" value="JBR_IMPL_KIND" />
					<parameter name="to" value="JBR_C_IMPL_KIND" />
					<parameter name="children" value="JBR_IMPL_ACQUAINT" />
					<!--parameter name="async" value="true" /-->					
				</post-process>
				<!-- Обновляет поле NAME Рассмотрения (504) -->
				<post-process class="CallOriginsProcessor" runOrder="105">
					<parameter name="backLinkAttrId" value="link: JBR_IMPL_ACQUAINT" />
					<parameter name="processorClassName"
						value="com.aplana.dbmi.jbr.processors.DeepGenerateName" />
					<!--
						parameter name="format" value="Рассмотреть Входящий № {0} от {1},
						{2}"/
					-->
					<!-- parameter name="format" value="Рассмотреть Входящий № {0}, {2}" /-->
					<parameter name="format" value="Рассмотреть документ %MAINDOC.TEMPLATE.NAME% № {0} от {1} {2}" />
					<parameter name="srcAttrIds"
						value="
						backLink: JBR_RASSM_PARENT_DOC@regnumber; 
						backLink: JBR_RASSM_PARENT_DOC@regdate;
						backLink: JBR_RASSM_PARENT_DOC@jbr.document.title" />
					<parameter name="dstAttrId" value="NAME" />
					<parameter name="forceSave" value="true" />
					<!-- (YNikitin, 2013/07/18) При формировании названий дочерних карточек, сохранять сами карточки не надо, достаточно обновить атрибут, 
					это позволяет ускорить процесс сохранения документа основания, а значит и создание нового поручения -->
					<parameter name="forceSaveMode" value="ATTRIBUTE" />
					<!--parameter name="async" value="true" /-->					
				</post-process>
				<!-- Обновляет поле NAME Ознакомления (524) -->
				<post-process class="CallOriginsProcessor" runOrder="110">
					<parameter name="backLinkAttrId" value="link: JBR_INFORM_LIST" />
					<parameter name="processorClassName"
						value="com.aplana.dbmi.jbr.processors.DeepGenerateName" />
					<!--
						parameter name="format" value="Ознакомиться с документом Входящий
						№ {0} от {1}, {2}"/
					-->
					<!-- parameter name="format"
						value="Ознакомиться с документом Входящий № {0}, {2}" /-->
					<parameter name="format"
						value="Ознакомиться с документом {3} № {0}, {2}" />
					<parameter name="srcAttrIds"
						value="
						backLink: JBR_INFORM_DOC@regnumber; 
						backLink: JBR_INFORM_DOC@regdate;
						backLink: JBR_INFORM_DOC@jbr.document.title;
						backLink: JBR_INFORM_DOC@jbr.reg.doctype@name" />
					<parameter name="dstAttrId" value="NAME" />
					<parameter name="forceSave" value="true" />
					<!-- (YNikitin, 2013/07/18) При формировании названий дочерних карточек, сохранять сами карточки не надо, достаточно обновить атрибут, 
					это позволяет ускорить процесс сохранения документа основания, а значит и создание нового поручения -->
					<parameter name="forceSaveMode" value="ATTRIBUTE" />
					<!--parameter name="async" value="true" /-->					
				</post-process>
				<!-- Обновляем поле NAME "Отчета об исполнении" (1044) -->
				<post-process class="CallCardsLinkedToBaseProcessor" runOrder="115">
					<parameter name="processorClassName"
						value="com.aplana.dbmi.jbr.processors.DeepGenerateName" />
					<parameter name="templateId" value="jbr.report.internal" />
					<parameter name="linkId" value="link: ADMIN_702604" />
					<!--
						parameter name="format" value='Поручение ({0} №{1} от {2}) от {3}:
						"{4}", исполнитель: {5} по документу № {6} от {7}, {8}{9}'/
					-->
					<parameter name="format"
						value='Поручение по документу №{0} от {1}, {2}' />
					<parameter name="srcAttrIds"
						value="
						link: ADMIN_702604@regnumber;
						link: ADMIN_702604@regdate;
						link: ADMIN_702604@jbr.document.title;" />
					<parameter name="dstAttrId" value="NAME" />
					<!-- (YNikitin, 2013/07/18) При формировании названий дочерних карточек, сохранять сами карточки не надо, достаточно обновить атрибут, 
					это позволяет ускорить процесс сохранения документа основания, а значит и создание нового поручения -->
					<parameter name="forceSaveMode" value="ATTRIBUTE" />
					<parameter name="forceSave" value="true" />
					<!--parameter name="async" value="true" /-->					
				</post-process>
				<!-- Обновляем поле NAME "Ознакомления с поручением" (1144)  -->
				<post-process class="CallCardsLinkedToBaseProcessor" runOrder="120">
					<parameter name="processorClassName"
						value="com.aplana.dbmi.jbr.processors.DeepGenerateName" />
					<parameter name="templateId" value="jbr.adnotamCommission" />
					<parameter name="linkId" value="link: ADMIN_726877" />
					<!--
						parameter name="format" value='Ознакомиться с поручением от {0}:
						"{1}" по документу № {2} от {3}, {4}{5}'/
					-->
					<parameter name="format"
						value='Ознакомиться с поручением  от {0}: "{1}" по документу № {2} от {3}, {5}' />
					<parameter name="srcAttrIds"
						value="
						backLink: ADMIN_726876@jbr.resolution.FioSign;
						backLink: ADMIN_726876@jbr.resolutionText;
						link: ADMIN_726877@regnumber;
						link: ADMIN_726877@regdate;
						link: ADMIN_726877@jbr.document.title;
						link: ADMIN_726877@jbr.shortcontext;" />
					<parameter name="dstAttrId" value="NAME" />
					<parameter name="forceSave" value="true" />
					<!-- (YNikitin, 2013/07/18) При формировании названий дочерних карточек, сохранять сами карточки не надо, достаточно обновить атрибут, 
					это позволяет ускорить процесс сохранения документа основания, а значит и создание нового поручения -->
					<parameter name="forceSaveMode" value="ATTRIBUTE" />
					<!--parameter name="async" value="true" /-->					
				</post-process>
				<!--
					Обновляем поле NAME "Отчета об исполнении внешнего исполнителя"
					(1064)
				-->
				<post-process class="CallCardsLinkedToBaseProcessor" runOrder="125">
					<parameter name="processorClassName"
						value="com.aplana.dbmi.jbr.processors.DeepGenerateName" />
					<parameter name="templateId" value="jbr.report.external" />
					<parameter name="linkId" value="link: ADMIN_702602" />
					<parameter name="format"
						value='Поручение (№ {0}) от {1}: "{2}", Вн. исполнитель: {3} {4}. {5}. ({6}) по документу {7}' />
					<parameter name="srcAttrIds"
						value="
						link: jbr.report.ext.document@regnumber;
						link: jbr.report.ext.parent@jbr.resolution.FioSign;
						link: jbr.report.ext.parent@jbr.resolutionText;
						link: jbr.report.ext.executor@jbr.person.lastName;
						link: jbr.report.ext.executor@jbr.person.firstName#1;
						link: jbr.report.ext.executor@jbr.person.middleName#1;
						link: jbr.report.ext.executor@jbr.person.organization@jbr.organization.shortName;
						link: jbr.report.ext.document@jbr.shortcontext;" />
					<parameter name="dstAttrId" value="NAME" />
					<parameter name="forceSave" value="true" />
					<!-- (YNikitin, 2013/07/18) При формировании названий дочерних карточек, сохранять сами карточки не надо, достаточно обновить атрибут, 
					это позволяет ускорить процесс сохранения документа основания, а значит и создание нового поручения -->
					<parameter name="forceSaveMode" value="ATTRIBUTE" />
					<!--parameter name="async" value="true" /-->					
				</post-process>

				<!-- Ответственный за ДОУ -->
				<post-process class="CopyPersonFromPaths" runOrder="130">
					<parameter name="targetAttr" value="jbr.responsible_dow.resp_dow" />
					<parameter name="paths"
						value="
						user:jbr.incoming.addressee->link:jbr.personInternal.department->user:jbr.department.resp_dow
					" />
					<parameter name="reloadCard" value="true" />
					<!-- Переводим в синхроннику, т.к. могут проблемы с дедлоками-->
					<parameter name="async" value="false" />
				</post-process>

				<!-- Ответственный за ДОУ на чтение -->
				<!--user:jbr.hidden.notePersons->link:jbr.personInternal.department->user:jbr.department.resp_dow;-->
				<post-process class="CopyPersonFromPaths" runOrder="140">
					<parameter name="targetAttr" value="jbr.responsible_dow.resp_dow_read" />
					<parameter name="paths"
						value="
						user: ADMIN_473929 ->link:jbr.personInternal.department->user:jbr.department.resp_dow;
						user: ADMIN_473763 ->link:jbr.personInternal.department->user:jbr.department.resp_dow;
						user: JBR_INFORMATION ->link:jbr.personInternal.department->user:jbr.department.resp_dow;
					" />
					<parameter name="reloadCard" value="true" />
				</post-process>
				
				<!-- @deprecated (YNikitin, 2013/07/23, 30687) Переносим данный код в сохранение поручения -->
				<!-- post-process class="CopyCardLinkAttributeToParent" runOrder="140">
					<parameter name="parent" value="@Self"/>
					<parameter name="from" value="jbr.resolutions"/>
					<parameter name="to" value="JBR_ALL_RESOLUTIONS"/>
				</post-process>
				-->
				
				<post-process class="SetAttributeValueWithConditionProcessor" runOrder="155">
					<parameter name="attr_condition_1" value="link:jbr.reg.doctype=jbr.medo_og.informationRequestDocType"/>
					<parameter name="attr_condition_2" value="list:jbr.medo_og.reqType=jbr.medo_og.reqType.short"/>
					<parameter name="attributeId" value="list:jbr.urgencyLevel"/>
					<parameter name="value" value="jbr.boss.urgency.max" />
					<parameter name="saveKind" value="SAVE_ATTR"/>
				</post-process>
				<specific property="state" value="draft">
					<post-process class="SetAttributeValueWithConditionProcessor" runOrder="5">
						<parameter name="attr_condition_1" value="link:jbr.incoming.sender=jbr.state_service.SOZ_Poltava"/>
						<parameter name="attributeId" value="link:jbr.reg.doctype"/>
						<parameter name="value" value="jbr.state_service.serviceRequest" />
						<parameter name="saveKind" value="SAVE_ATTR"/>
					</post-process>
					<post-process class="JumpStatePostProcessor" runOrder="10">
						<parameter name="dest_wfm" value="jbr.incoming.registration.ready"/>
	
						<!-- all theese variants works normally and are equevalent to each other: 
							parameter name="attr_test" value="jbr.incoming.oncontrol=jbr.incoming.control.no"  // comment="1433"
							parameter name="attr_test" value="jbr.incoming.oncontrol#jbr.incoming.control.yes" // comment="1432" 
							parameter name="attr_test" value="list:JBR_IMPL_ONCONT#1432"	// comment="1432 == yes"
						-->
						<parameter name="failIfStatusIsOther"  value="false"/>
						<parameter name="attr_test" value="jbr.deliveryItem.method=modeDeliveryMEDO"/>
						<parameter name="card_test"
							value="com.aplana.dbmi.jbr.processors.card.runcheck.CheckSystemUserInAttr (
										attrId=author 
									)" /> 
					</post-process>
					<post-process class="JumpStatePostProcessor" runOrder="15">
						<parameter name="dest_wfm" value="jbr.incoming.registration.ready"/>
						<parameter name="failIfStatusIsOther" value="false"/>
						<parameter name="attr_test" value="jbr.deliveryItem.method=jbr.deliveryItem.method.delo"/>
						<parameter name="card_test"
							value="com.aplana.dbmi.jbr.processors.card.runcheck.CheckSystemUserInAttr (
										attrId=author 
									)" />
					</post-process>
					<post-process class="JumpStatePostProcessor">
						<parameter name="dest_wfm" value="jbr.incoming.registration.ready"/>
						<parameter name="failIfStatusIsOther" value="false"/>
						<parameter name="attr_test" value="jbr.deliveryItem.method=jbr.deliveryItem.method.gost"/> 
						<parameter name="async" value="false"/> 
					</post-process>
					<!-- В статусе Черновик и Поступившие из ВС для ОГ, созданных системой, выводим в лог информацию о Зоне ДОУ и о пользователях, которые должны читать текущую карточку согласно простым профильным правам -->
					<post-process class="SpecDebugLogProcessor" runOrder="100">
						<parameter name="srcAttrIds" value="link:jbr.zoneDOW"/>
						<parameter name="sqlName" value="Список пользователей, у которых согласно простым профильным правилам есть право чтения данной карточки"/>
						<parameter name="sqlString" value="SELECT 
								distinct  
								p.person_id as personId, 
								sr.role_code as personRoleForRule,
								tv.attribute_code as sourceAttributeCode,
								tv.number_value as sourceAttributeValue/*,
								pr1.role_code as personExistsRole*/
							FROM 
								card c 
								JOIN access_rule r 
									ON (c.template_id=r.template_id OR r.template_id IS NULL) 
									AND (c.status_id=r.status_id OR r.status_id IS NULL) 
									AND c.card_id=?
								JOIN profile_access_rule pr 
									ON r.rule_id=pr.rule_id 
									AND pr.link_attr_code is NULL 
								LEFT JOIN person_role sr 
									ON pr.role_code=sr.role_code 
								JOIN attribute_value pv 
									ON pr.profile_attr_code=pv.attribute_code 
								JOIN attribute_value tv 
									ON c.card_id=tv.card_id 
									AND pr.target_attr_code=tv.attribute_code 
									and tv.number_value=pv.number_value 
								JOIN person p 
									ON p.card_id=pv.card_id 
								join access_card_rule acr 
									on acr.rule_id = r.rule_id 
									and acr.operation_code = 'R'
								/*join person_role pr1
									on pr1.person_id = p.person_id*/
							WHERE 
								(pr.role_code IS NULL OR p.person_id=sr.person_id)
							order by p.person_id"/>
						<parameter name="attr_condition_1" value="user:author=0"/>
					</post-process>
				</specific>
				<specific property="state" value="inmedo">
					<!-- В статусе Черновик и Поступившие из ВС для ОГ, созданных системой, выводим в лог информацию о Зоне ДОУ и о пользователях, которые должны читать текущую карточку согласно простым профильным правам -->
					<post-process class="SpecDebugLogProcessor" runOrder="100">
						<parameter name="srcAttrIds" value="link:jbr.zoneDOW"/>
						<parameter name="sqlName" value="Список пользователей, у которых согласно простым профильным правилам есть право чтения данной карточки"/>
						<parameter name="sqlString" value="SELECT 
								distinct  
								p.person_id as personId, 
								sr.role_code as personRoleForRule,
								tv.attribute_code as sourceAttributeCode,
								tv.number_value as sourceAttributeValue/*,
								pr1.role_code as personExistsRole*/
							FROM 
								card c 
								JOIN access_rule r 
									ON (c.template_id=r.template_id OR r.template_id IS NULL) 
									AND (c.status_id=r.status_id OR r.status_id IS NULL) 
									AND c.card_id=?
								JOIN profile_access_rule pr 
									ON r.rule_id=pr.rule_id 
									AND pr.link_attr_code is NULL 
								LEFT JOIN person_role sr 
									ON pr.role_code=sr.role_code 
								JOIN attribute_value pv 
									ON pr.profile_attr_code=pv.attribute_code 
								JOIN attribute_value tv 
									ON c.card_id=tv.card_id 
									AND pr.target_attr_code=tv.attribute_code 
									and tv.number_value=pv.number_value 
								JOIN person p 
									ON p.card_id=pv.card_id 
								join access_card_rule acr 
									on acr.rule_id = r.rule_id 
									and acr.operation_code = 'R'
								/*join person_role pr1
									on pr1.person_id = p.person_id*/
							WHERE 
								(pr.role_code IS NULL OR p.person_id=sr.person_id)
							order by p.person_id"/>
						<parameter name="attr_condition_1" value="user:author=0"/>
					</post-process>
				</specific>		
			</specific>


			<!--  Шаблон Исходящий 364 -->
			<specific property="template" value="jbr.outcoming">
				<pre-process class="GenerateName" runOrder="5">
					<parameter name="format" value="{0} {1} от {2}, {3}"/>
					<!--  <parameter name="format" value="{0} {1}, {3}" />  -->
					<parameter name="dstAttrId" value="string: NAME" />
					<parameter name="srcAttrIds"
						value="
						link: JBR_INFD_TYPEDOC; 
						string: regnumber; 
						date: regdate; 
						text: JBR_INFD_SHORTDESC
					" />
				</pre-process>
				<!-- Keywords for search -->
				<pre-process class="GenerateName" runOrder="10">
					<parameter name="format"
						value="{0}; {1}; {2}; {3}; {4}; {5}; {6}; {7}; {8}; {9}; {10}; {11}; {12}; {13}" />
					<parameter name="dstAttrId" value="string: KEYWORDS" />
					<parameter name="srcAttrIds"
						value="
						user: author;
						link: jbr.distributionItem.recipient;
						link: jbr.visa.ext.set;
						user: jbr.outcoming.signatory;
						user: jbr.resolutionExecutor;
						link: jbr.outcoming.receiver;
						link: jbr.reg.doctype;
						link: regjournal;
						link: index;
						user: jbr.incoming.registrar;
						user: jbr.npa.curator;
						user: jbr.ext.curator.editor;
						link: jbr.outcoming.executor;
						link: jbr.outcoming.receiver.user;
					" />
					<parameter name="maxArgStrLen" value="3000" />
				</pre-process>

				<!-- После сохранения исходящего в случае изменения Подписанта обновляем атрибут Зона ДОУ на основе Зоны ДОУ Автора , ФИО Подписанта и Исполнителя (старое значение предварительно очищаем) -->
				<!-- (YNikitin, 2013/11/13, BR4J00034081) в рамках оптимизации системы, убираем лишние процессоры и донастраиваем оставшиеся, чтобы не было лишних пересчётов прав и лишних копирований атрибутов -->
				<pre-process class="CopyAttributeFromParent" runOrder="16">
					<parameter name="isOnlyModel" value="true" />
					<parameter name="from" value="jbr.zoneDOW"/>
					<parameter name="to" value="jbr.zoneDOW"/>
					<parameter name="parent" value="author"/>
					<parameter name="parentTemplate" value="jbr.internalPerson"/>
					<parameter name="type" value="C"/>
					<parameter name="writeOperation" value="preclear+overwrite"/>
					<parameter name="changeAttribute" value="user:jbr.outcoming.signatory;user:jbr.document.executor"/>
					<parameter name="changeAttributeOption" value="OR"/>
				</pre-process>
				<pre-process class="CopyAttributeFromParent" runOrder="17">
					<parameter name="isOnlyModel" value="true" />
					<parameter name="from" value="jbr.zoneDOW"/>
					<parameter name="to" value="jbr.zoneDOW"/>
					<parameter name="parent" value="jbr.document.executor"/>
					<parameter name="parentTemplate" value="jbr.internalPerson"/>
					<parameter name="type" value="C"/>
					<parameter name="writeOperation" value="append" />
					<parameter name="changeAttribute" value="user:jbr.outcoming.signatory;user:jbr.document.executor"/>
					<parameter name="changeAttributeOption" value="OR"/>
				</pre-process>
				<pre-process class="CopyAttributeFromParent" runOrder="18">
					<parameter name="isOnlyModel" value="true" />
					<parameter name="from" value="jbr.zoneDOW"/>
					<parameter name="to" value="jbr.zoneDOW"/>
					<parameter name="parent" value="jbr.outcoming.signatory"/>
					<parameter name="parentTemplate" value="jbr.internalPerson"/>
					<parameter name="type" value="C"/>
					<parameter name="writeOperation" value="append" />
					<parameter name="changeAttribute" value="user:jbr.outcoming.signatory;user:jbr.document.executor"/>
					<parameter name="changeAttributeOption" value="OR"/>
				</pre-process>

				<!-- Дата регистрации должна быть не позже текущей -->
				<!-- Проверка не нужна, атрибут все равно заполняется системой.
				<pre-process class="ChkDateProcessor" runOrder="18">
					<parameter name="checkdate1" value="regdate;;+0" />
					<parameter name="dateFormat" value="dd.MM.yyyy HH:mm:ss" />
					<parameter name="dateNullIsOk" value="true" />
				</pre-process>
				-->
				<!-- Добавление версии в файлы вложений при сохранении документа -->
				<post-process class="IterationNumberAdditionToFiles" runOrder="20">
					<parameter name="IterationNumber" value="jbr.visa.round" />					
				</post-process>
				<!--
					"Скрытая срочность" заполняется из обычной срочности копирование
					происходит непосредственно в БД, так что это возможно только в
					пост-фазе, после сохранения карточки.
				-->
				<post-process class="CopyAttributeToChildren" runOrder="25">
					<parameter name="from" value="ADMIN_290575" />
					<parameter name="to" value="JBR_HOWFAST" />
				</post-process>

				<post-process class="TreeProcessor" runOrder="30">
					<parameter name="forestOriginBackLinkAttrId" value="@Self" />
					<parameter name="forestOriginLinkAttrIds"
						value="
								ADMIN_893724,
								JBR_SIGN_SIGNING,
								JBR_VISA_VISA,
								jbr.Distribution.DistributionList
							" />
					<parameter name="nodeLinkAttrIds"
						value="
								JBR_IMPL_ACQUAINT,
								backLink:JBR_IMPL_RESOLUT,
								JBR_INFORM_LIST,
								JBR_VISA_VISA,
								ADMIN_893724,
								JBR_SIGN_SIGNING,
								JBR_IMPL_ACQUAINT,
								backLink:JBR_IMPL_RESOLUT,
								JBR_INFORM_LIST,
								backLink:JBR_RIMP_RELASSIG,
								backLink:jbr.reports, 
								backLink:jbr.resolution.ExtReport, 
								jbr.resolution.FyiReport,
								backLink:jbr.visa.res
							" />
					<parameter name="leafLinkAttrIds" value="" />
					<parameter name="processorClassName"
						value="com.aplana.dbmi.jbr.processors.docgraph.copyAttribute" />
					<parameter name="srcAttrId" value="ADMIN_290575" />
					<parameter name="dstAttrId" value="JBR_HOWFAST" />
				</post-process>


				<!-- Для АРМ руководителя -->
				<post-process class="CopyAttributeToChildren" runOrder="85">
					<parameter name="from" value="JBR_INFD_TYPEDOC" />
					<parameter name="to" value="JBR_C_INFD_TYPEDOC" />
					<parameter name="children" value="JBR_SIGN_SIGNING" />
				</post-process>
				<!-- Обновляет поле NAME подписания -->
				<post-process class="CallOriginsProcessor" runOrder="110">
					<parameter name="backLinkAttrId" value="link: JBR_SIGN_SIGNING" />
					<parameter name="processorClassName"
						value="com.aplana.dbmi.jbr.processors.DeepGenerateName" />
					<!-- parameter name="format"
						value="Подписать документ Исходящий, дата создания: {0},  исполнитель: {1}, {2}" /-->
					<parameter name="format"
						value="Подписать документ %MAINDOC.TEMPLATE.NAME%, Исполнитель: {0}, {1}" />
					<parameter name="srcAttrIds"
						value="
						backLink: JBR_SIGN_PARENT@jbr.resolutionExecutor;
						backLink: JBR_SIGN_PARENT@jbr.document.title;" />
					<parameter name="dstAttrId" value="NAME" />
					<parameter name="forceSave" value="true" />
				</post-process>
				<!-- Обновляет поле NAME Визирование -->
				<post-process class="CallOriginsProcessor" runOrder="115">
					<parameter name="backLinkAttrId" value="link: JBR_VISA_VISA" />
					<parameter name="processorClassName"
						value="com.aplana.dbmi.jbr.processors.DeepGenerateName" />
					<!-- parameter name="format"
						value="Согласовать документ Исходящий, дата создания: {0},  исполнитель: {1}, {2}" /-->
					<parameter name="format"
						value="Согласовать %MAINDOC.TEMPLATE.NAME%, Исполнитель: {0}, {1}" />
					<parameter name="srcAttrIds"
						value="
						backLink: JBR_VISA_PARENT_DOC@jbr.resolutionExecutor;
						backLink: JBR_VISA_PARENT_DOC@jbr.document.title" />
					<parameter name="dstAttrId" value="NAME" />
					<parameter name="forceSave" value="true" />
				</post-process>

				<!-- Ответственный за ДОУ -->
				<post-process class="CopyPersonFromPaths" runOrder="120">
					<parameter name="targetAttr" value="jbr.responsible_dow.resp_dow" />
					<parameter name="paths"
						value="
						user: jbr.resolutionExecutor ->link:jbr.personInternal.department->user:jbr.department.resp_dow
					" />
					<parameter name="reloadCard" value="true" />
				</post-process>

				<!-- Ответственный за ДОУ на чтение -->
				<post-process class="CopyPersonFromPaths" runOrder="125">
					<parameter name="targetAttr" value="jbr.responsible_dow.resp_dow_read" />
					<parameter name="paths"
						value="
						user:jbr.incoming.addressee->link:jbr.personInternal.department->user:jbr.department.resp_dow;
						user: jbr.outcoming.signatory -> link:jbr.personInternal.department->user:jbr.department.resp_dow;
						user: jbr.hidden.visa ->link:jbr.personInternal.department->user:jbr.department.resp_dow;
					" />
					<parameter name="reloadCard" value="true" />
				</post-process>

				<!-- Формируем атрибут NAME для запросов на резервирование -->
				<post-process class="GenerateChildrenNames" runOrder="135">
					<parameter name="childrenCardLinkAttrId" value="jbr.doc.reservationRequests" />
					<parameter name="format"
						value="Запрос на резервирование номера для документа {0}" />
					<parameter name="dstAttrId" value="string: NAME" />
					<parameter name="srcAttrIds" value="text: jbr.document.title" />
					<parameter name="forceSave" value="true" />
				</post-process>

				<!-- (YNikitin, 2013/11/13, BR4J00034081) в рамках оптимизации системы, убираем лишние процессоры и донастраиваем оставшиеся, чтобы не было лишних пересчётов прав и лишних копирований атрибутов -->
				<post-process class="CopyAttributeToChildren" runOrder="140">
					<parameter name="updateAccessList" value="true" />
					<parameter name="from" value="AUTHOR" />
					<parameter name="to" value="jbr.distributionItem.docAuthor" />
					<parameter name="children" value="jbr.Distribution.DistributionList" />
				</post-process>
				<!-- Создание карточек "Уведомление: документ направлен" (1065) -->
				<post-process class="PopulateChildrenWithConditions" runOrder="145">
					<parameter name="template" value="med.reportSent"/>
					<parameter name="attach" value="jbr.incoming.notification"/>
					<parameter name="specialFlag" value="MEDO"/>
					<parameter name="attach_dest_card_index" value="1"/>
					<parameter name="copy" value="
								date:jbr.incoming.outdate->date:medo.incoming.outdate;
								string:jbr.incoming.outnumber->string:medo.incoming.outnumber;
								string:JBR_REGD_REGNUM->string:MED_REGD_REGNUM;
								date:regdate->date:medo.regdate;
								#0@string:JBR_REGD_REGNUM->text:MED_OUTNUM_FOIV;
								#0@date:regdate->date:MED_DATE_OUTNUM_FOIV;
								#0@number:_ID->link:medo.outcomeLink
							"/>
					<!-- найти связанные входящие документы с определенным типом связи, в определенном статусе-->
					<parameter name="attr_link_path" value="_STATE;
															jbr.relatdocs@_CARDTYPE;
															_TEMPLATE;
															list: jbr.deliveryItem.method;
															~
															#1@jbr.incoming.notification@_TEMPLATE;
															link:medo.outcomeLink@number:_ID"/>
					<!-- тип связи «В ответ на», «Ответ», «Исполнение», «Связан с», «Во исполнение», «В связи с»
						шаблон - входящий
						статус - «зарегистрирован», «в дело»
						id = id исходящего документа в связанных с текущей карточкой уведомлениях-->
					<parameter name="attr_link_values" value="	=101,104;
																=1502,1503,1504,1600,1601,2134;
																=224,864;
																=1592;
																~
																=1065;
																#number:_ID"/>
					<parameter name="forceSaveChilds" value="true"/>
					<!-- Переводим в синхроннику, т.к. могут проблемы с дедлоками-->
					<parameter name="async" value="false" />
				</post-process>
				
				<post-process class="SetAttributeValueWithConditionProcessor" runOrder="150">
					<parameter name="attr_condition_1" value="link:jbr.reg.doctype=jbr.medo_og.informationRequestDocType"/>
					<parameter name="attr_condition_2" value="list:jbr.medo_og.reqType=jbr.medo_og.reqType.short"/>
					<parameter name="attributeId" value="list:jbr.urgencyLevel"/>
					<parameter name="value" value="jbr.boss.urgency.max" />
					<parameter name="saveKind" value="SAVE_ATTR"/>
				</post-process>
				<specific property="state" value="registration">
					<!-- Содержимое в конфигурациях -->
				</specific>
				<specific property="state" value="106">
					<post-process class="CopyAttributeFromParent" runOrder="5">
						<parameter name="attr_condition" value="link:jbr.reg.doctype=jbr.medo_og.informationResponseDocType"/>
						<parameter name="parent" value="jbr.relatdocs"/>
						<parameter name="from" value="jbr.medo_og.reqId"/>
						<parameter name="to" value="jbr.medo_og.reqId"/>
						<parameter name="type" value="S"/>
						<parameter name="linkTypes" value="jbr.medo_og.responseLinkType"/>
					</post-process>
					<post-process class="CopyAttributeFromParent" runOrder="10">
						<parameter name="attr_condition" value="link:jbr.reg.doctype=jbr.medo_og.informationResponseDocType"/>
						<parameter name="parent" value="jbr.relatdocs"/>
						<parameter name="from" value="jbr.medo_og.reqType"/>
						<parameter name="to" value="jbr.medo_og.reqType"/>
						<parameter name="type" value="L"/>
						<parameter name="linkTypes" value="jbr.medo_og.responseLinkType"/>
					</post-process>
					<post-process class="CopyAttributeFromParent" runOrder="15">
						<parameter name="attr_condition" value="link:jbr.reg.doctype=jbr.medo_og.informationResponseDocType"/>
						<parameter name="parent" value="jbr.relatdocs"/>
						<parameter name="from" value="jbr.medo_og.reqObject"/>
						<parameter name="to" value="jbr.medo_og.reqObject"/>
						<parameter name="type" value="C"/>
						<parameter name="linkTypes" value="jbr.medo_og.responseLinkType"/>
					</post-process>
				</specific>
			</specific>


			<!--  Шаблон Исходящие на информационный запрос 775 -->
			<specific property="template" value="jbr.infreq.answer">
				<pre-process class="GenerateName" runOrder="5">
					<!-- parameter name="format" value="{0} {1} от {2}, {3}"/ -->
					<parameter name="format" value="{0} {1}, {3}" />
					<parameter name="dstAttrId" value="string: NAME" />
					<parameter name="srcAttrIds"
						value="
						link: JBR_INFD_TYPEDOC; 
						string: regnumber; 
						date: regdate; 
						text: JBR_INFD_SHORTDESC
					" />
				</pre-process>
				<!-- Keywords for search -->
				<pre-process class="GenerateName" runOrder="10">
					<parameter name="format"
						value="{0}; {1}; {2}; {3}; {4}; {5}; {6}; {7}; {8}" />
					<parameter name="dstAttrId" value="string: KEYWORDS" />
					<parameter name="srcAttrIds"
						value="
						link: jbr.visa.ext.set;
						user: jbr.hidden.visa;
						link: jbr.reg.doctype;
						link: regjournal;
						link: index;
						user: jbr.incoming.registrar;
						user: jbr.outcoming.signatory;
						user: jbr.resolutionExecutor;
						link: jbr.outcoming.receiver
					" />
					<parameter name="maxArgStrLen" value="500" />
				</pre-process>

				<!--
					"Скрытая срочность" заполняется из обычной срочности копирование
					происходит непосредственно в БД, так что это возможно только в
					пост-фазе, после сохранения карточки.
				-->
				<post-process class="CopyAttributeToChildren" runOrder="20">
					<parameter name="from" value="ADMIN_290575" />
					<parameter name="to" value="JBR_HOWFAST" />
				</post-process>

				<post-process class="TreeProcessor" runOrder="25">
					<parameter name="forestOriginBackLinkAttrId" value="@Self" />
					<parameter name="forestOriginLinkAttrIds"
						value="
								JBR_VISA_VISA,
								JBR_SIGN_SIGNING,
								jbr.Distribution.DistributionList
							" />
					<parameter name="nodeLinkAttrIds"
						value="
								JBR_IMPL_ACQUAINT,
								backLink:JBR_IMPL_RESOLUT,
								JBR_INFORM_LIST,
								JBR_VISA_VISA,
								ADMIN_893724,
								JBR_SIGN_SIGNING,
								JBR_IMPL_ACQUAINT,
								backLink:JBR_IMPL_RESOLUT,
								JBR_INFORM_LIST,
								backLink:JBR_RIMP_RELASSIG,
								backLink:jbr.reports, 
								backLink:jbr.resolution.ExtReport, 
								jbr.resolution.FyiReport,
								backLink:jbr.visa.res
							" />
					<parameter name="leafLinkAttrIds" value="" />
					<parameter name="processorClassName"
						value="com.aplana.dbmi.jbr.processors.docgraph.copyAttribute" />
					<parameter name="srcAttrId" value="ADMIN_290575" />
					<parameter name="dstAttrId" value="JBR_HOWFAST" />
				</post-process>


				<!-- Для АРМ руководителя -->
				<post-process class="CopyAttributeToChildren" runOrder="80">
					<parameter name="from" value="JBR_INFD_TYPEDOC" />
					<parameter name="to" value="JBR_C_INFD_TYPEDOC" />
					<parameter name="children" value="JBR_SIGN_SIGNING" />
				</post-process>
			</specific>

			<!--  Шаблон Исходящий на обращения граждан 777 -->
			<specific property="template" value="jbr.incomingpeople.answer">
				<pre-process class="GenerateName" runOrder="5">
					<!-- parameter name="format" value="{0} {1} от {2}, {3}"/ -->
					<parameter name="format" value="{0} {1}, {3}" />
					<parameter name="dstAttrId" value="string: NAME" />
					<parameter name="srcAttrIds"
						value="
						link: JBR_INFD_TYPEDOC; 
						string: regnumber; 
						date: regdate; 
						text: JBR_INFD_SHORTDESC
					" />
				</pre-process>
				<!-- Keywords for search -->
				<pre-process class="GenerateName" runOrder="10">
					<parameter name="format"
						value="{0}; {1}; {2}; {3}; {4}; {5}; {6}; {7}" />
					<parameter name="dstAttrId" value="string: KEYWORDS" />
					<parameter name="srcAttrIds"
						value="
						link: jbr.distributionItem.recipient;
						link: jbr.visa.ext.set;
						link: jbr.reg.doctype;
						link: regjournal;
						link: index;
						user: jbr.outcoming.signatory;
						user: jbr.resolutionExecutor;
						link: jbr.outcoming.receiver
					" />
					<parameter name="maxArgStrLen" value="500" />
				</pre-process>

				<!--
					"Скрытая срочность" заполняется из обычной срочности копирование
					происходит непосредственно в БД, так что это возможно только в
					пост-фазе, после сохранения карточки.
				-->
				<post-process class="CopyAttributeToChildren" runOrder="20">
					<parameter name="from" value="ADMIN_290575" />
					<parameter name="to" value="JBR_HOWFAST" />
				</post-process>

				<post-process class="TreeProcessor" runOrder="25">
					<parameter name="forestOriginBackLinkAttrId" value="@Self" />
					<parameter name="forestOriginLinkAttrIds"
						value="
								JBR_VISA_VISA,
								JBR_SIGN_SIGNING,
								jbr.Distribution.DistributionList
							" />
					<parameter name="nodeLinkAttrIds"
						value="
								JBR_IMPL_ACQUAINT,
								backLink:JBR_IMPL_RESOLUT,
								JBR_INFORM_LIST,
								JBR_VISA_VISA,
								ADMIN_893724,
								JBR_SIGN_SIGNING,
								JBR_IMPL_ACQUAINT,
								backLink:JBR_IMPL_RESOLUT,
								JBR_INFORM_LIST,
								backLink:JBR_RIMP_RELASSIG,
								backLink:jbr.reports, 
								backLink:jbr.resolution.ExtReport, 
								jbr.resolution.FyiReport,
								backLink:jbr.visa.res
							" />
					<parameter name="leafLinkAttrIds" value="" />
					<parameter name="processorClassName"
						value="com.aplana.dbmi.jbr.processors.docgraph.copyAttribute" />
					<parameter name="srcAttrId" value="ADMIN_290575" />
					<parameter name="dstAttrId" value="JBR_HOWFAST" />
				</post-process>

			</specific>

			<!--
				<specific property="template" value="jbr.DistributionListElement">
				<post-process class="CopyAttributeFromParent"> <parameter
				name="from" value="NAME"/> <parameter name="to" value="NAME"/>
				<parameter name="parent" value="jbr.distributionItem.recipient"/>
				</post-process> </specific>
			-->
			<!-- Шаблон Персона (Внутрений)  -->
			<specific property="template" value="jbr.internalPerson">
				<validator class="TestEmptyAttrProcessor">
					<parameter name="test_attr" value="string:jbr.person.lastName"/>
					<parameter name="empty_message" value="Не заполнена обязательная характеристика Фамилия."/>
				</validator>
				<validator class="TestEmptyAttrProcessor">
					<parameter name="test_attr" value="string:jbr.person.firstName"/>
					<parameter name="empty_message" value="Не заполнена обязательная характеристика Имя."/>
				</validator>
				<validator class="TestEmptyAttrProcessor">
					<parameter name="test_attr" value="string:jbr.person.middleName"/>
					<parameter name="empty_message" value="Не заполнена обязательная характеристика Отчество."/>
				</validator>
				<validator class="TestEmptyAttrProcessor">
					<parameter name="test_attr" value="link:jbr.incoming.organization"/>
					<parameter name="empty_message" value="Не заполнена обязательная характеристика Организация."/>
				</validator>
				<validator class="TestEmptyAttrProcessor">
					<parameter name="test_attr" value="link:jbr.personInternal.department"/>
					<parameter name="empty_message" value="Не заполнена обязательная характеристика Подразделение."/>
				</validator>
				<validator class="TestEmptyAttrProcessor">
					<parameter name="test_attr" value="link:jbr.person.pos"/>
					<parameter name="empty_message" value="Не заполнена обязательная характеристика Должность."/>
				</validator>
				<pre-process class="SetPersonActualCertificate" runOrder="15" />
				<!-- После сохранения обновляем атрибут Зона ДОУ на основе Зоны ДОУ департамента (старое значение предварительно очищаем) только в том случае, когда старое значение поменялось -->
				<!-- pre-process class="ClearCardAttributePostProcessor" runOrder="16">
					<parameter name="attrId" value="link:jbr.zoneDOW"/>
					<parameter name="changeAttribute" value="link:jbr.personInternal.department"/>
				</pre-process-->
				<!-- (YNikitin, 2013/11/13, BR4J00034081) в рамках оптимизации системы, убираем лишние процессоры и донастраиваем оставшиеся, чтобы не было лишних пересчётов прав и лишних копирований атрибутов -->
				<post-process class="CopyAttributeFromParent" runOrder="1">
					<parameter name="from" value="jbr.zoneDOW"/>
					<parameter name="to" value="jbr.zoneDOW"/>
					<parameter name="parent" value="jbr.personInternal.department"/>
					<parameter name="parentTemplate" value="jbr.department"/>
					<parameter name="type" value="C"/>
					<parameter name="attr_condition" value="link:jbr.zoneDOW=NULL"/>
				</post-process>
				<post-process class="CopyAttributeFromParent" runOrder="2">
					<parameter name="from" value="jbr.zoneDOW"/>
					<parameter name="to" value="jbr.zoneDOW"/>
					<parameter name="parent" value="jbr.personInternal.department"/>
					<parameter name="parentTemplate" value="jbr.department"/>
					<parameter name="type" value="C"/>
					<parameter name="changeAttribute" value="link:jbr.personInternal.department"/>
				</post-process>
				<post-process class="DeepGenerateName" runOrder="10">
					<parameter name="dstAttrId" value="JBR_PERS_SNAME_NM" />
					<!--  Фамилия И. О.  -->
					<parameter name="format" value="{0} {1}. {2}." />
					<parameter name="srcAttrIds"
						value="
						string: jbr.person.lastName; 
						string: jbr.person.firstName#1; 
						string: jbr.person.middleName#1 
					" />
					<parameter name="forceSave" value="true" />
     				<parameter name="forceSaveMode" value="attribute" />
				</post-process>
				<post-process class="DeepGenerateName" runOrder="11">
					<parameter name="dstAttrId" value="JBR_PERS_FULL_NAME" />
					<!--  Фамилия Имя Отчество  -->
					<parameter name="format" value="{0} {1} {2}" />
					<parameter name="srcAttrIds"
						value="
						string: jbr.person.lastName;
						string: jbr.person.firstName;
						string: jbr.person.middleName
					" />
					<parameter name="forceSave" value="true" />
     				<parameter name="forceSaveMode" value="attribute" />
				</post-process>
				<post-process class="DeepGenerateName" runOrder="12">
					<parameter name="dstAttrId" value="JBR_PERS_DEPARTMENT" />
					<parameter name="format" value="{0}" />
					<parameter name="srcAttrIds"
						value="link: jbr.person.dept@jbr.department.shortName" />
					<parameter name="forceSave" value="true" />
     				<parameter name="forceSaveMode" value="attribute" />
				</post-process>
				<post-process class="DeepGenerateName" runOrder="13">
					<parameter name="dstAttrId" value="JBR_PERS_POSITION" />
					<parameter name="format" value="{0}" />
					<parameter name="srcAttrIds"
						value="link: jbr.person.pos" />
					<parameter name="forceSave" value="true" />
     				<parameter name="forceSaveMode" value="attribute" />
				</post-process>
				<post-process class="CopyAttributeFromParent" runOrder="14">
					<parameter name="to" value="jbr.person.organization"/>
					<parameter name="from" value="jbr.department.Organization"/>
					<parameter name="parent" value="jbr.personInternal.department"/>
					<parameter name="type" value="C"/>
				</post-process>

				<!-- При сохранении заполняем атрибут Владелец карточки (скрытый), если он до сих пор пустой -->
				<post-process class="SetAttributeValueProcessor" runOrder="20">
					<parameter name="attributeId" value="user: jbr.person.owner"/>
					<parameter name="value" value="_ID"/>
					<parameter name="saveKind" value="SAVE_ATTR"/>
					<parameter name="attr_condition" value="user: jbr.person.owner=NULL"/>
				</post-process>

				<!-- (BR4J00034819) Обновляем Зоны ДОУ в Документах, в которых текущий пользователь является Автором, Подписантом или Адресатом в зависимости от шаблона:-->
				<!-- (BR4J00035162) делаем это с помощью спецпроцессора-->
				<post-process class="RecalculateZoneDOWProcessor" runOrder="30">
					<parameter name="attr_condition" value="list: jbr.zoneDOW.recalculate=jbr.incoming.control.yes"/>
					<parameter name="changeAttribute" value="link:jbr.zoneDOW"/>
				</post-process>
				<post-process class="RecalculateZoneDOWProcessor" runOrder="30">
					<parameter name="changeAttribute" value="link:jbr.zoneDOWAccess"/>
					<parameter name="isZoneAccess" value="true"/>
				</post-process>
				<post-process class="CallOriginsProcessor" runOrder="105">
					<parameter name="processorClassName"
						value="com.aplana.dbmi.jbr.processors.DeepGenerateName" />
					<parameter name="backLinkAttrId" value="link: jbr.settings.card" />
					<parameter name="dstAttrId" value="name"/>
					<parameter name="format" value="Настройки персоны внутренней: {0}"/>
					<parameter name="srcAttrIds" value="backLink:jbr.person.card@jbr.person.lastnameNM"/>
					<!-- изменения сразу сохранить в самом процессоре -->
                    <parameter name="forceSave" value="true"/>
                    <!-- сохранить только изменённый атрибут, а не полную карточку  -->
                    <parameter name="forceSaveMode" value="attribute"/>				
				</post-process>
				<specific property="state" value="draft">
					<validator class="TestEmptyAttrProcessor">
						<parameter name="test_attr" value="userLogin:jbr.portal.userlogin"/>
						<parameter name="must_empty" value="false"/>
					</validator>
					<!-- Cоздание новой карточки «Настройки пользователя» -->
					<post-process class="PopulateChildren" runOrder="40">
						<parameter name="template" value="jbr.user.settings" />
						<parameter name="attach" value="jbr.settings.card" />
						 <!-- сохранить только изменённый атрибут, а не полную карточку  -->
                    	<parameter name="forceSaveMode" value="attribute"/>			
						<parameter name="forceSaveChilds" value="true"/>
					</post-process>
					<!-- Сразу переводим в статус Активный -->
					<post-process class="JumpStatePostProcessor" runOrder="110">
						<parameter name="dest_wfm" value="user.makeActiveFromDraft"/>
					</post-process>
					<post-process class="SyncPortalUserProcessor" runOrder="120" />
				</specific>
				<specific property="state" value="user.active">
					<post-process class="SyncPortalUserProcessor" runOrder="120" />
				</specific>
			</specific>

			<!--  (Сохранение) Шаблон Независимое поручние (1255) -->
			<specific property="template" value="jbr.independent.resolution">
				<validator class="ChkOnCtrlInfo" runOrder="5">
					<parameter name="forceSave" value="false" />
				</validator>
				<!-- Генерируем имя независимого поручения -->
				<pre-process class="GenerateName" runOrder="5">
					<parameter name="format" value="Поручение №{0} от {1}, Исполнитель: {3}, {2}" />
					<parameter name="dstAttrId" value="string: NAME" />
					<parameter name="srcAttrIds"
						value="	string: regnumber; 
								date: regdate;
								text: jbr.resolutionText;
								user: jbr.AssignmentExecutor" />
				</pre-process>
				<!-- Keywords for search -->
				<pre-process class="GenerateName" runOrder="10">
					<parameter name="format" value="{0}; {1}; {2}; {3}; {4}; {5}" />
					<parameter name="dstAttrId" value="string: KEYWORDS" />
					<parameter name="srcAttrIds"
						value="
						user: jbr.commission.inspector;
						user: jbr.AssignmentExecutor;
						user: jbr.CoExecutor;
						user: jbr.Fyi;
						link: jbr.ExtExecutor;
						user: jbr.resolution.FioSign
					" />
					<parameter name="maxArgStrLen" value="500" />
				</pre-process>
				<!-- Пытаемся установить атрибут 'Журнал регистрации' во время каждого сохранения,
				     потому что нужно учитывать следующие требования:
				      1) ЖЦ для шаблона НП могут быть разными и на момент регистрации журнал
				         регистрации должен быть заполнен
				      2) Изначально в справочнике СЭД может отсутствовать журнал 'Журнал регистрации НП',
				         о чем и будет сообщено пользователю, который попытается зарегистрировать НП.
				         После того как журнал будет добавлен в систему, у пользователя должна быть
				         возможность зарегистрировать ранее созданное НП-->
				<pre-process class="SetAttributeValueForCardlinkProcessor" runOrder="15">
					<parameter name="attributeId" value="link:regjournal" />
					<parameter name="templateId" value="jbr.journal" />
					<parameter name="value" value="Журнал регистрации НП" />
				</pre-process>

				<!-- Обновляем поле NAME "Отчета об исполнении" (1044) -->
				<post-process class="CallCardsLinkedToBaseProcessor" runOrder="30">
					<parameter name="processorClassName"
						value="com.aplana.dbmi.jbr.processors.DeepGenerateName" />
					<parameter name="templateId" value="jbr.report.internal" />
					<parameter name="linkId" value="link: ADMIN_702604" />
					<parameter name="format"
						value='Поручение по документу №{0} от {1}, {2}' />
					<parameter name="srcAttrIds"
						value="
						link: jbr.report.int.document@regnumber;
						link: jbr.report.int.document@regdate;
						link: jbr.report.int.document@jbr.resolutionText" />
					<parameter name="dstAttrId" value="NAME" />
					<parameter name="forceSave" value="true" />
					<parameter name="forceSaveMode" value="ATTRIBUTE" />
				</post-process>

				<!--
					Обновляем поле NAME "Отчета об исполнении внешнего исполнителя"
					(1064)
				-->
				<post-process class="CallCardsLinkedToBaseProcessor" runOrder="40">
					<parameter name="processorClassName"
						value="com.aplana.dbmi.jbr.processors.DeepGenerateName" />
					<parameter name="templateId" value="jbr.report.external" />
					<parameter name="linkId" value="link: ADMIN_702602" />
					<parameter name="format"
						value='Поручение (№ {0}) от {1}: "{2}", Вн. исполнитель: {3} {4}. {5}. ({6}) по документу {7}' />
					<parameter name="srcAttrIds"
						value="
						link: jbr.report.ext.document@regnumber;
						link: jbr.report.ext.parent@jbr.resolution.FioSign;
						link: jbr.report.ext.parent@jbr.resolutionText;
						link: jbr.report.ext.executor@jbr.person.lastName;
						link: jbr.report.ext.executor@jbr.person.firstName#1;
						link: jbr.report.ext.executor@jbr.person.middleName#1;
						link: jbr.report.ext.executor@jbr.person.organization@jbr.organization.shortName;
						link: jbr.report.ext.document@jbr.resolutionText;" />
					<parameter name="dstAttrId" value="NAME" />
					<parameter name="forceSave" value="true" />
					<parameter name="forceSaveMode" value="ATTRIBUTE" />
				</post-process>
				
				<!--
					Обновляем поле NAME "Ознакомление с поручением"
					(1144)
				-->
				<post-process class="CallCardsLinkedToBaseProcessor" runOrder="50">
					<parameter name="processorClassName"
						value="com.aplana.dbmi.jbr.processors.DeepGenerateName" />
					<parameter name="templateId" value="jbr.adnotamCommission"	/>
					<parameter name="linkId" value="link: ADMIN_726877" />
					<parameter name="format"
						value='Ознакомиться с поручением  от {0}: "{1}" по документу № {2} от {3}' />
					<parameter name="srcAttrIds"
						value="
						backLink: ADMIN_726876@jbr.resolution.FioSign;
						backLink: ADMIN_726876@jbr.resolutionText;
						link: ADMIN_726877@regnumber;
						link: ADMIN_726877@regdate;" />
					<parameter name="dstAttrId" value="NAME" />
					<parameter name="forceSave" value="true" />
					<parameter name="forceSaveMode" value="ATTRIBUTE" />
				</post-process>	
				<!-- Формируем атрибут NAME для Ознакомлений с поручением -->
<!--				<post-process class="GenerateChildrenNames" runOrder="65">
					<parameter name="childrenCardLinkAttrId" value="jbr.resolution.FyiReport" />
					<parameter name="format" value="Ознакомиться с поручением №{0} от {1}, {2}" />
					<parameter name="dstAttrId"  value="string: NAME" />
					<parameter name="srcAttrIds" value="string: regnumber; 
														date: regdate;
														text: jbr.resolutionText" />
					&lt;!&ndash;parameter name="forceSave" value="true" /&ndash;&gt;
				</post-process>-->
				
				<!-- @deprecated (YNikitin, 2013/07/23, 30687) Переносим данный код в сохранение поручения -->
				<!-- post-process class="CopyCardLinkAttributeToParent" runOrder="140">
					<parameter name="parent" value="@Self"/>
					<parameter name="from" value="jbr.resolutions"/>
					<parameter name="to" value="JBR_ALL_RESOLUTIONS"/>
				</post-process>
				-->
				<!--
					Устанавливаем ссылку на документ основание для Отчета об исполнении
				-->
				<post-process class="CallOriginsProcessor" runOrder="75">
					<parameter name="processorClassName"
						value="com.aplana.dbmi.jbr.processors.CopyBLtoCL" />
					<parameter name="backLinkAttrId" value="JBR_RIMP_REPORT" />
					<parameter name="toParent" value="link:ADMIN_702311" />
					<parameter name="toBase" value="link: ADMIN_702604" />
					<!--parameter name="parentToBase" value="link: JBR_DOCB_BYDOC" /-->
					<parameter name="async" value="true" />					
				</post-process>

				<!--
					Устанавливаем ссылку на документ основание для Ознакомление с
					поручением
				-->
				<post-process class="CallOriginsProcessor" runOrder="80">
					<parameter name="processorClassName"
						value="com.aplana.dbmi.jbr.processors.CopyBLtoCL" />
					<parameter name="backLinkAttrId" value="link: ADMIN_713517" />
					<parameter name="toParent" value="ADMIN_726876" />
					<parameter name="toBase" value="link: ADMIN_726877" />
					<!--parameter name="parentToBase" value="link: JBR_DOCB_BYDOC" /-->
					<!-- Переводим в синхроннику, т.к. могут проблемы с дедлоками-->
					<parameter name="async" value="false" />
				</post-process>

				<!--
					Устанавливаем ссылку на документ основание для Отчета об исполнении
					внешним исполнителем
				-->
				<post-process class="CallOriginsProcessor" runOrder="85">
					<parameter name="processorClassName"
						value="com.aplana.dbmi.jbr.processors.CopyBLtoCL" />
					<parameter name="backLinkAttrId" value="ADMIN_713514" />
					<parameter name="toParent" value="link: ADMIN_702600" />
					<parameter name="toBase" value="link: ADMIN_702602" />
					<!--parameter name="parentToBase" value="link: JBR_DOCB_BYDOC" /-->
					<!-- Переводим в синхроннику, т.к. могут проблемы с дедлоками-->
					<parameter name="async" value="false" />
				</post-process>

			</specific>

			<!--  Шаблон Поручение (324) -->
			<specific property="template" value="jbr.resolution">

				<!-- проверка заполнения "На контроле"/"Срок"/"Контролер" -->
				<validator class="ChkOnCtrlInfo" runOrder="5">
					<parameter name="forceSave" value="false" />

					<parameter name="attr_OnCtrl" value="jbr.oncontrol" />
					<parameter name="refId.ctrlIsYes" value="jbr.commission.control.yes" />

					<parameter name="attr_TermDate" value="jbr.resolutionTerm" />
					<parameter name="attr_CtrlBy" value="JBR_TCON_INSPECTOR" />
				</validator>

				<pre-process class="GenerateName" runOrder="10">
					<parameter name="dstAttrId" value="NAME" />
					<!--
						<parameter name="format" value="Резолюция: {0}, Автор {1}:{2}"/>
						<parameter name="srcAttrIds" value="string: JBR_INFD_ITEM; user:
						JBR_INFD_SIGNATORY; text: JBR_GIPA_RESOLUT"/>
					-->
					<!--
						parameter name="format" value="Поручение по документу {0} № {1} от
						{2}, автор {3}: {4}"/
					-->
					<parameter name="format"
						value="Поручение по документу {0} № {1} от {2}: {4}" />
					<parameter name="maxArgStrLen" value="60" />
					<!--
						(B) jbr.main.doc = Документ-основание (B) JBR_MAINDOC =
						Родителькое поручение номер регистрации (jbr.maindoc.regnum) Дата
						регистрации (jbr.incoming.regdate)
						stringattribute.jbr.maindoc.regnum=JBR_REGD_REGNUM
						stringattribute.jbr.incoming.outnumber=JBR_REGD_NUMOUT
						personattribute.jbr.resolution.FioSign.hidden=JBR_INFD_SGNEX_LINK
					-->
					<parameter name="srcAttrIds"
						value="
									link:jbr.main.doc@template.name; 
									link:jbr.main.doc@jbr.maindoc.regnum; 
									link:jbr.main.doc@jbr.maindoc.regdate; 
									user: jbr.resolution.FioSign;
									text: JBR_GIPA_RESOLUT
								" />
				</pre-process>

				<pre-process class="GenerateName" runOrder="15">
					<parameter name="format" value="{0}" />
					<parameter name="dstAttrId" value="text: DESCR" />
					<parameter name="srcAttrIds" value="date: JBR_TCON_TERM" />
				</pre-process>

				<!-- Keywords for search -->
				<pre-process class="GenerateName" runOrder="20">
					<parameter name="format" value="{0}; {1}; {2}; {3}; {4}; {5}" />
					<parameter name="dstAttrId" value="string: KEYWORDS" />
					<parameter name="srcAttrIds"
						value="
						user: jbr.commission.inspector;
						user: jbr.AssignmentExecutor;
						user: jbr.CoExecutor;
						user: jbr.Fyi;
						link: jbr.ExtExecutor;
						user: jbr.resolution.FioSign
					" />
					<parameter name="maxArgStrLen" value="500" />
				</pre-process>

				<!--  Срочность из документа-основания -->
				<pre-process class="CopyAttributeFromParent" runOrder="25">
					<parameter name="parent" value="jbr.main.doc" />
					<parameter name="from" value="ADMIN_290575" />
					<parameter name="to" value="JBR_HOWFAST" />
					<parameter name="type" value="L" />
				</pre-process>
				

				<!--
					Проверка Срока исполнения в статусе "черновик" 324 Поручение:
					'JBR_TCON_TERM'=Срок/D
					dateattribute.jbr.resolutionTerm=JBR_TCON_TERM
					Текущее время не учитывается
				-->
				<specific property="state" value="draft">
					<validator class="ChkDateProcessor">
						<parameter name="checkdate1" value="jbr.resolutionTerm;+0" />
						<parameter name="dateFormat" value="dd.MM.yyyy HH:mm:ss" />
						<parameter name="dateNullIsOk" value="true" />
					</validator>
				</specific>

				<!--
					АВТО постановка на КОНТРОЛЬ статуc "Рассмотрение":
					cardstate.consideration=102 статуc "Зарегистрирован":
					cardstate.registration=101 <parameter
					name="attrId.curcard.linkToMainDoc" value="jbr.main.doc"/>
					<parameter name="attrId.mainDoc.resolutions"
					value="jbr.resolutions"/> <parameter name="attrId.curcard.signer"
					value="jbr.outcoming.signatory"/> <parameter name="roles.signer"
					value="JBR_MINISTER;JBR_DEPUTY_MINISTER"/> <parameter
					name="attrId.curcard.onControl" value="jbr.oncontrol"/> <parameter
					name="refId.curcard.CtrlIsYes" value="jbr.commission.control.yes"/>
					<parameter name="refId.curcard.CtrlIsNo"
					value="jbr.commission.control.no"/> <parameter
					name="attrId.curcard.termDate" value="jbr.resolutionTerm"/>
					<parameter name="attrId.curcard.inspector"
					value="jbr.commission.inspector"/> <parameter
					name="attrId.mainDoc.termDate" value="date: JBR_IMPL_DEADLINE"/>
					<parameter name="attrId.mainDoc.inspector"
					value="jbr.incoming.inspector"/> <parameter
					name="attrId.mainDoc.onControl" value="jbr.incoming.oncontrol"/>
					<parameter name="refId.mainDoc.CtrlIsYes"
					value="jbr.incoming.control.yes"/> <parameter
					name="refId.mainDoc.CtrlIsNo" value="jbr.incoming.control.no"/>
				-->

				<!--
					Устанавливаем ссылку на документ основание для Отчета об исполнении
				-->
				<post-process class="CallOriginsProcessor" runOrder="100">
					<parameter name="processorClassName"
						value="com.aplana.dbmi.jbr.processors.CopyBLtoCL" />
					<parameter name="backLinkAttrId" value="JBR_RIMP_REPORT" />
					<parameter name="toParent" value="link:ADMIN_702311" />
					<parameter name="toBase" value="link: ADMIN_702604" />
					<parameter name="parentToBase" value="link:jbr.main.doc" />
					<!-- Переводим в синхроннику, т.к. могут проблемы с дедлоками-->
					<parameter name="async" value="false" />
				</post-process>
				<!-- Обновляем поле NAME Отчета об исполнении -->
				<post-process class="CallOriginsProcessor" runOrder="105">
					<parameter name="processorClassName"
						value="com.aplana.dbmi.jbr.processors.DeepGenerateName" />
					<parameter name="backLinkAttrId" value="JBR_RIMP_REPORT" />
					<!--
						parameter name="format" value='Поручение ({0} №{1} от {2}) от {3}:
						"{4}", исполнитель: {5} по документу № {6} от {7}, {8}{9}'/
					-->
					<parameter name="format"
						value='Поручение по документу №{0} от {1}, {2}{3}' />
					<parameter name="srcAttrIds"
						value="
						link: ADMIN_702604@regnumber;
						link: ADMIN_702604@regdate;
						link: ADMIN_702604@jbr.document.title;
						link: ADMIN_702604@jbr.resolutionText" />
					<parameter name="dstAttrId" value="NAME" />
					<parameter name="forceSave" value="true" />
					<parameter name="forceSaveMode" value="attribute" />
					<parameter name="async" value="false" />					
				</post-process>
				<!-- Обновляем поле NAME Ознакомление с поручением -->
				<post-process class="CallOriginsProcessor" runOrder="130">
					<parameter name="processorClassName"
						value="com.aplana.dbmi.jbr.processors.DeepGenerateName" />
					<parameter name="backLinkAttrId" value="link: ADMIN_713517" />
					<!--
						parameter name="format" value='Ознакомиться с поручением от {0}:
						"{1}" по документу № {2} от {3}, {4}{5}'/
					-->
					<parameter name="format"
						value='Ознакомиться с поручением  от {0}: "{1}" по документу № {2} от {3}, {5}' />
					<parameter name="srcAttrIds"
						value="
						backLink: ADMIN_726876@jbr.resolution.FioSign;
						backLink: ADMIN_726876@jbr.resolutionText;
						link: ADMIN_726877@regnumber;
						link: ADMIN_726877@regdate;
						link: ADMIN_726877@jbr.document.title;
						link: ADMIN_726877@jbr.shortcontext;" />
					<parameter name="dstAttrId" value="NAME" />
					<parameter name="forceSave" value="true" />
					<parameter name="forceSaveMode" value="attribute" />
					<parameter name="async" value="false" />					
				</post-process>
				<!--
					Устанавливаем ссылку на документ основание для Отчета об исполнении
					внешним исполнителем
				-->
				<post-process class="CallOriginsProcessor" runOrder="135">
					<parameter name="processorClassName"
						value="com.aplana.dbmi.jbr.processors.CopyBLtoCL" />
					<parameter name="backLinkAttrId" value="ADMIN_713514" />
					<parameter name="toParent" value="link: ADMIN_702600" />
					<parameter name="toBase" value="link: ADMIN_702602" />
					<parameter name="parentToBase" value="link:jbr.main.doc" />
					<!-- Переводим в синхроннику, т.к. могут проблемы с дедлоками-->
					<parameter name="async" value="false" />
				</post-process>
				<!-- Обновляем поле NAME Отчета об исполнении внешнего исполнителя -->
				<post-process class="CallOriginsProcessor" runOrder="140">
					<parameter name="processorClassName"
						value="com.aplana.dbmi.jbr.processors.DeepGenerateName" />
					<parameter name="backLinkAttrId" value="ADMIN_713514" />
					<parameter name="format"
						value='Поручение (№ {0}) от {1}: "{2}", Вн. исполнитель: {3} {4}. {5}. ({6}) по документу {7}{8}' />
					<parameter name="srcAttrIds"
						value="
						link: jbr.report.ext.document@regnumber;
						link: jbr.report.ext.parent@jbr.resolution.FioSign;
						link: jbr.report.ext.parent@jbr.resolutionText;
						link: jbr.report.ext.executor@jbr.person.lastName;
						link: jbr.report.ext.executor@jbr.person.firstName#1;
						link: jbr.report.ext.executor@jbr.person.middleName#1;
						link: jbr.report.ext.executor@jbr.person.organization@jbr.organization.shortName;
						link: jbr.report.ext.document@jbr.shortcontext;
						link: jbr.report.ext.document@jbr.resolutionText;" />
					<parameter name="dstAttrId" value="NAME" />
					<parameter name="forceSave" value="true" />
					<parameter name="forceSaveMode" value="attribute" />
					<parameter name="async" value="false" />
				</post-process>

				<!-- Ответственный за ДОУ -->
				<post-process class="CopyPersonFromPaths" runOrder="145">
					<parameter name="targetAttr" value="jbr.responsible_dow.resp_dow" />
					<parameter name="paths"
						value="
						user: jbr.AssignmentExecutor->link:jbr.personInternal.department->user:jbr.department.resp_dow;
						user: jbr.resolution.FioSign ->link:jbr.personInternal.department->user:jbr.department.resp_dow;
						user: jbr.CoExecutor->link:jbr.personInternal.department->user:jbr.department.resp_dow
					" />
					<parameter name="reloadCard" value="true" />
					<parameter name="async" value="true" />					
				</post-process>

				<!-- Ответственный за ДОУ документа-основания -->
				<post-process class="CopyPersonFromPaths" runOrder="150">
					<parameter name="targetAttr" value="jbr.responsible_dow.resp_dow.maindoc" />
					<parameter name="paths"
						value="
						link: jbr.main.doc ->user:jbr.responsible_dow.resp_dow;
						link: jbr.main.doc ->user:jbr.responsible_dow.resp_dow_read;
					" />
					<parameter name="reloadCard" value="true" />
					<parameter name="async" value="true" />					
				</post-process>
				
				<post-process class="CallOriginsProcessor" runOrder="155">
					<parameter name="backLinkAttrId" value="jbr.visa.res" />
					<parameter name="async" value="true" />
					<parameter name="processorClassName"
						value="com.aplana.dbmi.jbr.processors.CopyPersonFromPaths"/>					
					<parameter name="targetAttr" value="jbr.responsible_dow.resp_dow.maindoc" />
					<parameter name="paths"
						value="link:jbr.taskVisa.task->user:jbr.responsible_dow.resp_dow.maindoc" />
				</post-process>
				
				<!-- Ответственный за ДОУ поручения -->
				<post-process class="CallOriginsProcessor" runOrder="160">
					<parameter name="backLinkAttrId" value="jbr.visa.res" />
					<parameter name="async" value="true" />
					<parameter name="processorClassName"
						value="com.aplana.dbmi.jbr.processors.CopyPersonFromPaths"/>
					<parameter name="targetAttr" value="jbr.responsible_dow.resp_dow.resolution" />
					<parameter name="paths"
						value="link:jbr.taskVisa.task->user:jbr.responsible_dow.resp_dow" />
				</post-process>

				<!-- @deprecated (YNikitin, 2013/07/23, 30687) Теперь id любого поручения при сохранении запихивается в атрибут Поручения всех уровней ДО -->
				<!-- post-process class="CopyCardLinkAttributeToParent" runOrder="165">
					<parameter name="parent" value="jbr.main.doc"/>
					<parameter name="from" value="jbr.linkedResolutions"/>
					<parameter name="to" value="JBR_ALL_RESOLUTIONS"/>
				</post-process-->
				
				<post-process class="CallOriginsProcessor" runOrder="170">
					<parameter name="backLinkAttrId" value="jbr.visa.res" />
					<parameter name="processorClassName"
						value="com.aplana.dbmi.jbr.processors.DeepGenerateName" />
					<parameter name="format"
						value="Согласование проекта поручения по документу {0}, от {1}, Подписант {2}" />
					<parameter name="srcAttrIds"
						value="
						link:jbr.taskVisa.task@link:jbr.main.doc@string:regnumber;
						link:jbr.taskVisa.task@link:jbr.main.doc@date:regdate;
						link:jbr.taskVisa.task@user:jbr.resolution.FioSign" />
					<parameter name="dstAttrId" value="NAME" />
					<parameter name="forceSave" value="true" />
					<parameter name="forceSaveMode" value="attribute" />
				</post-process>
				
				<!--  Согласующие = "Визирующие скрытые"/U 'JBR_VISA_VPERSON' -->
				<!-- (YNikitin, 2013/11/13, BR4J00034081) в рамках оптимизации системы, убираем лишние процессоры и донастраиваем оставшиеся, чтобы не было лишних пересчётов прав и лишних копирований атрибутов -->
				<!-- post-process class="CopyPersonsFromLinkedCards" runOrder="175">
					<parameter name="linkAttrId" value="jbr.visa.set" />
					<parameter name="linkReversed" value="false" />
					<parameter name="personAttrId" value="jbr.hidden.visa" />
					<parameter name="linkedPersonAttrIds" value="jbr.visa.person" />
					<parameter name="async" value="true" />					
				</post-process-->
				<!-- Помощники согласующих скрытые 'JBR_VISA_DR_RESP_AST'/U -->
				<!-- (YNikitin, 2013/11/13, BR4J00034081) в рамках оптимизации системы, убираем лишние процессоры и донастраиваем оставшиеся, чтобы не было лишних пересчётов прав и лишних копирований атрибутов -->
				<!-- post-process class="CopyPersonsFromLinkedCards" runOrder="180">
					<parameter name="linkAttrId" value="jbr.visa.set" />
					<parameter name="linkReversed" value="false" />
					<parameter name="personAttrId" value="jbr.hidden.visa.assistant" />
					<parameter name="linkedPersonAttrIds" value="jbr.visa.hidden.assistent.response" />
					<parameter name="async" value="true" />					
				</post-process-->
				<!-- (YNikitin, 2013/11/13, BR4J00034081) в рамках оптимизации системы, убираем лишние процессоры и донастраиваем оставшиеся, чтобы не было лишних пересчётов прав и лишних копирований атрибутов -->
				<post-process class="CallOriginsProcessor" runOrder="185">
					<parameter name="backLinkAttrId" value="jbr.visa.res" />
					<parameter name="async" value="true" />
					<parameter name="processorClassName"
						value="com.aplana.dbmi.jbr.processors.CopyPersonFromPaths"/>
					<parameter name="targetAttr" value="jbr.taskVisa.taskUsers" />
					<parameter name="paths"
						value="
							link:jbr.taskVisa.task->user:jbr.AssignmentExecutor;
							link:jbr.taskVisa.task->user:jbr.CoExecutor;
							link:jbr.taskVisa.task->user:jbr.commission.inspector;
							link:jbr.taskVisa.task->user:jbr.resolution.FioSign;
							link:jbr.taskVisa.task->user:jbr.hidden.visa;
							" />
				</post-process>

				<!--
					Устанавливаем ссылку на документ основание для Согласования для поручения
				-->
				<post-process class="CallOriginsProcessor" runOrder="195">
					<parameter name="processorClassName"
						value="com.aplana.dbmi.jbr.processors.CopyBLtoCL" />
					<parameter name="backLinkAttrId" value="jbr.visa.res" />
					<parameter name="toParent" value="link: jbr.taskVisa.task" />
					<parameter name="toBase" value="link: jbr.ado.docbase" />
					<parameter name="parentToBase" value="link:jbr.main.doc" />
					<!-- Переводим в синхроннику, т.к. могут проблемы с дедлоками-->
					<parameter name="async" value="false" />
				</post-process>
				<!-- прописываем во всех связанных с документом основанием поручениях и проектов согласования поручений Категорию срочности из документа основания -->
				<!--post-process class="TreeProcessor" runOrder="200">
					<parameter name="forestOriginBackLinkAttrId" value="jbr.main.doc" />
					<parameter name="forestOriginLinkAttrIds"
						value="
								backLink:JBR_IMPL_RESOLUT
							" />
					<parameter name="nodeLinkAttrIds"
						value="
								backLink:JBR_VISA_RES_B,
								JBR_VISA_VISA_HIDDEN,
								backLink:JBR_IMPL_RESOLUT,
								backLink:JBR_RIMP_RELASSIG,
							" />
					<parameter name="leafLinkAttrIds" value="" />
					<parameter name="processorClassName"
						value="com.aplana.dbmi.jbr.processors.docgraph.copyAttribute" />
					<parameter name="srcAttrId" value="ADMIN_290575" />
					<parameter name="dstAttrId" value="JBR_HOWFAST" />
				</post-process-->
			</specific>

			<!-- Отчёт об исполнении (внутр.) (1044) -->
			<specific property="template" value="jbr.report.internal">
				<!-- теперь в атрибут jbr.report.hidden.text пишется при переходе WF -->
				<!-- post-process class="XSLTCopyTextAttribute">
					<parameter name="attrFrom" value="html:jbr.report.text" />
					<parameter name="attrTo" value="text:jbr.report.hidden.text" />
					<parameter name="xsltLocation"
						value="dbmi/xslt/ExtractLastReportFragment.xslt" />
				</post-process-->
				<!-- Keywords for search -->
				<pre-process class="GenerateName" runOrder="5">
					<parameter name="format" value="{0}; {1}" />
					<parameter name="dstAttrId" value="string: KEYWORDS" />
					<parameter name="srcAttrIds"
						value="
						user: jbr.report.int.author;
						user: jbr.report.int.executor
					" />
					<parameter name="maxArgStrLen" value="500" />
				</pre-process>
				
				<!--  Срочность из документа-основания -->
				<pre-process class="CopyAttributeFromParent" runOrder="15">
					<parameter name="parent" value="jbr.report.int.document" />
					<parameter name="from" value="ADMIN_290575" />
					<parameter name="to" value="JBR_HOWFAST" />
					<parameter name="type" value="L" />
				</pre-process>

				<!-- Ответственный за ДОУ поручения -->
				<pre-process class="CopyPersonFromPaths" runOrder="20">
					<parameter name="targetAttr" value="jbr.responsible_dow.resp_dow.resolution" />
					<parameter name="paths"
						value="
							link: jbr.report.int.parent -> user:jbr.responsible_dow.resp_dow
						" />
				</pre-process>

				<!-- Ответственный за ДОУ документа-основания -->
				<pre-process class="CopyPersonFromPaths" runOrder="25">
					<parameter name="targetAttr" value="jbr.responsible_dow.resp_dow.maindoc" />
					<parameter name="paths"
						value="
						link: jbr.report.int.document ->user:jbr.responsible_dow.resp_dow;
						link: jbr.report.int.document ->user:jbr.responsible_dow.resp_dow_read
					" />
				</pre-process>
			</specific>

			<!-- Отчёт об исполнении внешним исполнителем (1064) -->
			<specific property="template" value="jbr.report.external">
				<!-- теперь в атрибут jbr.report.hidden.text пишется при переходе WF -->
				<!--post-process class="XSLTCopyTextAttribute">
					<parameter name="attrFrom" value="html:jbr.report.text" />
					<parameter name="attrTo" value="text:jbr.report.hidden.text" />
					<parameter name="xsltLocation"
						value="dbmi/xslt/ExtractLastReportFragment.xslt" />
				</post-process-->
				<!-- Keywords for search -->
				<pre-process class="GenerateName" runOrder="5">
					<parameter name="format" value="{0}; {1}" />
					<parameter name="dstAttrId" value="string: KEYWORDS" />
					<parameter name="srcAttrIds"
						value="
						user: jbr.report.ext.author;
						user: jbr.report.ext.executor
					" />
					<parameter name="maxArgStrLen" value="500" />
				</pre-process>

				<!--  Срочность из документа-основания -->
				<pre-process class="CopyAttributeFromParent" runOrder="10">
					<parameter name="parent" value="jbr.report.ext.document" />
					<parameter name="from" value="ADMIN_290575" />
					<parameter name="to" value="JBR_HOWFAST" />
					<parameter name="type" value="L" />
				</pre-process>

				<!-- Ответственный за ДОУ поручения -->
				<pre-process class="CopyPersonFromPaths" runOrder="15">
					<parameter name="targetAttr" value="jbr.responsible_dow.resp_dow.resolution" />
					<parameter name="paths"
						value="
							link: jbr.report.ext.parent -> user: jbr.responsible_dow.resp_dow
						" />
				</pre-process>

				<!-- Ответственный за ДОУ документа-основания -->
				<pre-process class="CopyPersonFromPaths" runOrder="20">
					<parameter name="targetAttr" value="jbr.responsible_dow.resp_dow.maindoc" />
					<parameter name="paths"
						value="
						link: jbr.report.ext.document ->user:jbr.responsible_dow.resp_dow;
						link: jbr.report.ext.document ->user:jbr.responsible_dow.resp_dow_read
					" />
				</pre-process>

				<!-- Заполнить Ответственного за ДОУ для внешнего исполнения документа-основания -->
				<post-process class="CallOriginsProcessor" runOrder="40">
					<parameter name="backLinkAttrId" value="jbr.report.ext.document"/>
					<parameter name="processorClassName" value="com.aplana.dbmi.jbr.processors.CopyPersonsFromLinkedCards"/>
					<parameter name="linkAttrId" value="jbr.report.ext.document"/>
					<parameter name="linkReversed" value="true"/>
					<parameter name="personAttrId" value="jbr.responsible_dow.resp_dow.externalExecution"/>
					<parameter name="linkedPersonAttrIds" value="jbr.responsible_dow.resp_dow"/>
					<parameter name="async" value="true"/>
				</post-process>
			</specific>

			<!--
				Шаблон "Ознакомление с поручением": 1144 "Ознакомиться до"
				('ADMIN_726875' = jbr.adnotamCommission.term) "На документ"
				('ADMIN_726877' = cardlinkattribute.jbr.adnotamCommission.document)
			-->
			<specific property="template" value="jbr.adnotamCommission">
				<!-- Keywords for search -->
				<pre-process class="GenerateName" runOrder="5">
					<parameter name="format" value="{0}; {1}" />
					<parameter name="dstAttrId" value="string: KEYWORDS" />
					<parameter name="srcAttrIds"
						value="
						user: jbr.adnotamCommission.person; 
						user: jbr.adnotamCommission.author
					" />
					<parameter name="maxArgStrLen" value="500" />
				</pre-process>

				<!--  Срочность из документа-основания -->
				<pre-process class="CopyAttributeFromParent" runOrder="10">
					<parameter name="parent" value="jbr.adnotamCommission.document" />
					<parameter name="from" value="ADMIN_290575" />
					<parameter name="to" value="JBR_HOWFAST" />
					<parameter name="type" value="L" />
				</pre-process>

				<!-- Ответственный за ДОУ поручения -->
				<pre-process class="CopyPersonFromPaths" runOrder="15">
					<parameter name="targetAttr" value="jbr.responsible_dow.resp_dow.resolution" />
					<parameter name="paths"
						value="
							backLink: jbr.adnotamCommission.parent -> user: jbr.responsible_dow.resp_dow
						" />
				</pre-process>

				<!-- Ответственный за ДОУ документа-основания -->
				<pre-process class="CopyPersonFromPaths" runOrder="20">
					<parameter name="targetAttr" value="jbr.responsible_dow.resp_dow.maindoc" />
					<parameter name="paths"
						value="
						link: jbr.adnotamCommission.document -> user:jbr.responsible_dow.resp_dow;
						link: jbr.adnotamCommission.document -> user:jbr.responsible_dow.resp_dow_read
					" />
				</pre-process>
			</specific>

			<!-- Шаблон Персона(Внешний) 464 -->
			<specific property="template" value="jbr.externalPerson">
				<validator class="TestEmptyAttrProcessor" runOrder="1">
					<parameter name="test_attr" value="string:jbr.person.lastName"/>
					<parameter name="must_empty" value="false"/>
				</validator>
				<validator class="TestEmptyAttrProcessor" runOrder="2">
					<parameter name="test_attr" value="string:jbr.person.firstName"/>
					<parameter name="must_empty" value="false"/>
				</validator>
				<!-- Фикс по BR4J00038492 , BR4J00037669
				<validator class="TestEmptyAttrProcessor" runOrder="3">
					<parameter name="test_attr" value="string:jbr.person.middleName"/>
					<parameter name="must_empty" value="false"/>
				</validator>

				<validator class="TestEmptyAttrProcessor" runOrder="4">
					<parameter name="test_attr" value="link:jbr.person.organization"/>
					<parameter name="must_empty" value="false"/>
				</validator>
				 -->
				<!-- фикс по BR4J00037669 -->
				<!--validator class="TestEmptyAttrProcessor">
					<parameter name="test_attr" value="link:jbr.incoming.organization"/>
					<parameter name="must_empty" value="false"/>
				</validator-->
				<specific property="state" value="doublet">
					<validator class="TestEmptyAttrProcessor">
						<parameter name="test_attr" value="link:jbr.externalPerson.originalValue"/>
						<parameter name="must_empty" value="false"/>
						<parameter name="empty_message" value="Атрибут Оригинальное значение должен быть заполнен."/>
					</validator>
				</specific>
				<validator class="CheckAttributeUniquenessProcessor" runOrder="6">
					<parameter name="attrIds" value="string:jbr.person.lastName,string:jbr.person.firstName,string:jbr.person.middleName,link:jbr.person.organization"/>
					<parameter name="statusIds" value="4,7"/>
					<parameter name="error_message" value="Значения атрибутов Фамилия, Имя, Отчество и Организация должны быть уникальным среди карточек текущего шаблона"/>
				</validator>
				<pre-process class="DeepGenerateName" runOrder="10">
					<parameter name="dstAttrId" value="JBR_PERS_SNAME_NM" />
					<!--  Фамилия И. О.  -->
					<parameter name="format" value="{0} {1}. {2}." />
					<parameter name="srcAttrIds"
						value="
						string: jbr.person.lastName; 
						string: jbr.person.firstName#1; 
						string: jbr.person.middleName#1 
					" />
				</pre-process>
				<specific property="state" value="published">
					<pre-process class="ClearCardAttributePostProcessorEx">
						<parameter name="attrId" value="link:jbr.externalPerson.originalValue"/>
					</pre-process>
				</specific>
				<specific property="state" value="dictionaryNew">
					<pre-process class="ClearCardAttributePostProcessorEx">
						<parameter name="attrId" value="link:jbr.externalPerson.originalValue"/>
					</pre-process>
				</specific>
				<post-process class="DeepGenerateName" runOrder="5">
					<parameter name="dstAttrId" value="NAME" />
					<!-- Организация ФИО -->
					<!--
						<parameter name="format" value="{0}, {1}, {2} {3} {4}"/>
						<parameter name="srcAttrIds" value="link: jbr.person.organization;
						string: jbr.person.position; string: jbr.person.lastName; string:
						jbr.person.firstName; jbr.person.middleName"/>
					-->
					<!-- ФИО Организация -->
					<parameter name="format" value="{0} {1} {2}, {3} ({4})" />
					<parameter name="srcAttrIds"
						value="	string: jbr.person.lastName;  
								string: jbr.person.firstName;  
								jbr.person.middleName; 
								link: jbr.person.organization@name; 
								string: jbr.person.position" />
					<parameter name="forceSave" value="true" />
					<parameter name="forceSaveMode" value="ATTRIBUTE" />
					<parameter name="maxArgStrLen" value="500" />
				</post-process>
			</specific>
				<!-- Шаблон Организация: 222 -->
			<specific property="template" value="jbr.organization">
				<validator class="TestEmptyAttrProcessor" runOrder="1">
					<parameter name="test_attr" value="text:jbr.organization.fullName"/>
					<parameter name="must_empty" value="false"/>
				</validator>
				<specific property="state" value="doublet">
					<validator class="TestEmptyAttrProcessor" runOrder="2">
						<parameter name="test_attr" value="link:jbr.organization.originalOrganization"/>
						<parameter name="must_empty" value="false"/>
						<parameter name="empty_message" value="Атрибут Оригинальное значение организации должен быть заполнен."/>
					</validator>
				</specific>
				<validator class="CheckAttributeUniquenessProcessor" runOrder="3">
					<parameter name="attrIds" value="text:jbr.organization.fullName"/>
					<parameter name="statusIds" value="4,7"/>
					<parameter name="error_message" value="Значение атрибута Полное наименование должно быть уникальным среди карточек текущего шаблона"/>
				</validator>
				<pre-process class="GenerateName" runOrder="5">
					<parameter name="format" value="{0}({1})" />
					<parameter name="dstAttrId" value="NAME" />
					<parameter name="srcAttrIds" value="string: jbr.organization.shortName;
														text: jbr.organization.fullName" />
					<parameter name="maxArgStrLen" value="500" />
				</pre-process>
				<specific property="state" value="published">
					<pre-process class="ClearCardAttributePostProcessorEx">
						<parameter name="attrId" value="link:jbr.organization.originalOrganization"/>
					</pre-process>
				</specific>
				<specific property="state" value="dictionaryNew">
					<pre-process class="ClearCardAttributePostProcessorEx">
						<parameter name="attrId" value="link:jbr.organization.originalOrganization"/>
					</pre-process>
				</specific>
				<!-- Ручная очистка кэша поиска карточек -->
				<post-process class="CardFilteringCacheUpdate" runOrder="10">
				</post-process>
				<!-- (YNikitin, 2014/06/02, BR4J00035045) При каждом сохранении Организации копируем атрибут Зона ДОУ в атрибут Зоны ДОУ --> 
				<post-process class="CopyAttributeToChildren" runOrder="11">
					<parameter name="updateAccessList" value="false"/>
					<parameter name="from" value="link: jbr.zoneDOW"/>
					<parameter name="to" value="link: jbr.zonesDOW"/>
					<parameter name="changeAttribute" value="link: jbr.zoneDOW"/>
				</post-process>
				<post-process class="ClearCardAttributePostProcessor" runOrder="12">
					<parameter name="attrId" value="link:jbr.zoneDOW"/>
					<parameter name="changeAttribute" value="link: jbr.zoneDOW"/>
				</post-process>
			</specific>
			
			<!-- 1206 Должность -->
			<specific property="template" value="jbr.position">
				<validator class="TestEmptyAttrProcessor" runOrder="1">
					<parameter name="test_attr" value="text: descr"/>
					<parameter name="must_empty" value="false"/>
				</validator>
				<validator class="CheckAttributeUniquenessProcessor" runOrder="3">
					<parameter name="attrIds" value="text: descr"/>
					<parameter name="statusIds" value="4"/>
					<parameter name="error_message" value="Значение атрибута Описание должно быть уникальным среди карточек текущего шаблона"/>
				</validator>
				<pre-process class="GenerateName">
					<parameter name="format" value="{0}" />
					<parameter name="dstAttrId" value="NAME" />
					<parameter name="srcAttrIds" value="text: descr" />
					<parameter name="maxArgStrLen" value="500" />
				</pre-process>
			</specific>
			
			
			<!-- 544 Настройки для АРМ руководителя -->
			<specific property="template" value="boss.settings">
				<validator class="TestEmptyAttrProcessor" runOrder="1">
					<parameter name="test_attr" value="user: boss.owner"/>
					<parameter name="must_empty" value="false"/>
				</validator>
				<validator class="CheckAttributeUniquenessProcessor" runOrder="2">
					<parameter name="attrIds" value="user: boss.owner"/>
					<parameter name="statusIds" value="4"/>
					<parameter name="error_message" value="Значение атрибута Владелец АРМа должно быть уникальным среди карточек текущего шаблона"/>
				</validator>
				<post-process class="DeepGenerateName">
					<parameter name="format" value="{0} {1} {2}" />
					<parameter name="dstAttrId" value="NAME" />
					<parameter name="srcAttrIds" value="user: jbr.arm.manager@jbr.person.lastName;
														user: jbr.arm.manager@jbr.person.firstName;
														user: jbr.arm.manager@jbr.person.middleName" />
					<parameter name="maxArgStrLen" value="200" />
					<parameter name="forceSave" value="true" />
					<parameter name="forceSaveMode" value="ATTRIBUTE" />
				</post-process>
			</specific>
			
			<specific property="template" value="jbr.department">
				<validator class="TestEmptyAttrProcessor" runOrder="1">
					<parameter name="test_attr" value="text: jbr.department.fullName"/>
					<parameter name="must_empty" value="false"/>
				</validator>
				<validator class="CheckAttributeUniquenessProcessor" runOrder="3">
					<parameter name="attrIds" value="text:jbr.department.fullName"/>
					<parameter name="statusIds" value="4"/>
					<parameter name="error_message" value="Значение атрибута Полное название должно быть уникальным среди карточек текущего шаблона"/>
				</validator>
				<pre-process class="GenerateName">
					<parameter name="format" value="{0} ({1})" />
					<parameter name="dstAttrId" value="NAME" />
					<parameter name="srcAttrIds" value="text: jbr.department.shortName; text: jbr.department.fullName" />
					<parameter name="maxArgStrLen" value="500" />
				</pre-process>
				<!-- (BR4J00034894 ) После сохранения Департамента пересохраняем пользователей данного департамента, чтобы у них и в их карточках ДО прописалась корректная Зона ДОУ из департамента (а перед этим у всех пользователей подчищаем Зону, чтобы она при сохранении подкачалась из Департамента)-->
				<post-process class="CallCardsLinkedToBaseProcessor" runOrder="25">
					<parameter name="templateId" value="jbr.internalPerson" />
					<parameter name="linkId" value="link: JBR_PERS_DEPT_LINK" />
					<parameter name="processorClassName"
						value="com.aplana.dbmi.jbr.processors.ClearCardAttributePostProcessor" />
					<parameter name="attrId" value="link:jbr.zoneDOW"/>
					<parameter name="changeAttribute" value="link:jbr.zoneDOW"/>
					<parameter name="performFromSystem" value="true"/>
				</post-process>
				<!-- post-process class="CopyAttributeToChildren" runOrder="17">
					<parameter name="updateAccessList" value="true"/>
					<parameter name="from" value="jbr.zoneDOW"/>
					<parameter name="to" value="jbr.zoneDOW"/>
					<parameter name="writeOperation" value="overwrite" />
					<parameter name="children" value="jbr.byPerson"/>
					<parameter name="type" value="C"/>
					<parameter name="changeAttribute" value="link:jbr.zoneDOW"/>
				</post-process-->
				<post-process class="CallCardsLinkedToBaseProcessor" runOrder="30">
					<parameter name="processorClassName"
						value="com.aplana.dbmi.jbr.processors.ForceSaveCardProcessor" />
					<parameter name="templateId" value="jbr.internalPerson" />
					<parameter name="linkId" value="link: JBR_PERS_DEPT_LINK" />
					<parameter name="changeAttribute" value="link:jbr.zoneDOW"/>
					<parameter name="performFromSystem" value="true"/>
				</post-process>
			</specific>
			<specific property="template" value="jbr.file">
				<pre-process class="GenerateName">
					<parameter name="format" value="Автор: {0}, файл: {1} материал: {2}{3}" />
					<parameter name="dstAttrId" value="NAME" />
					<parameter name="srcAttrIds" 
						value="
						user: AUTHOR;
						material: MATERIAL;
						string: jbr.materialName;
						[ Отправитель: ]link:jbr.file.sender@jbr.organization.shortName" />
				</pre-process>
			</specific>
			<specific property="template" value="jbr.ProcessingDistribution">
				<pre-process class="GenerateName">
					<parameter name="format" value="Обработка рассылки, № итерации: {0}" />
					<parameter name="dstAttrId" value="NAME" />
					<parameter name="srcAttrIds" value="number:ADMIN_1149822" />
				</pre-process>
			</specific>
			<!--Этап согласования 985 -->
			
			<specific property="template" value="jbr.negotiationlist.stage">
					<validator class="TestEmptyAttrProcessor" runOrder="4">
						<parameter name="test_attr" value="string:name"/>
						<parameter name="must_empty" value="false"/>
						<parameter name="empty_message" value="Поле 'Название' не заполнено."/>
					</validator>
					<validator class="TestEmptyAttrProcessor" runOrder="5">
						<parameter name="test_attr" value="list:jbr.stage.type"/>
						<parameter name="must_empty" value="false"/>
						<parameter name="empty_message" value="Поле 'Тип этапа' не заполнено."/>
					</validator>
			</specific>
			<specific property="template" value="jbr.SendInfo">
				<specific property="state" value="jbr.sendInfo.delivered">
					<!-- 
						Заполняем "Статус рассылки" в карточке "Элемент списка рассылки"
						в соответствии со статусом карточки информация о доставке:
					-->
					<!-- Доставлено -->		
					<post-process class="SetAttributeValueProcessor">
						<parameter name="attributeId" value="list:jbr.sendStatus"/>
						<parameter name="value" value="jbr.sendStatus.landed" />
						<parameter name="linkId" value="jbr.distributionItem.sendInfo" />
						<parameter name="isReversedLink" value="true" />
					</post-process>
				</specific>
			</specific>
<!-- Шаблон 990 ('Уведомление: Поручение принят к исполнению') -->
			<specific property="template" value="med.resolutionAccept">
				<!-- Заполняем UID -->
				<pre-process class="DeepGenerateName" runOrder="5">      
					<parameter name="dstAttrId" value="medo.importedDoc.UID"/>
					<parameter name="format" value="{0}"/>
					<parameter name="srcAttrIds" value="link: medo.doc.parent@jbr.original.source@jbr.importedDoc.UID"/>
				</pre-process>
				<!-- Заполняем ID -->
				<pre-process class="DeepGenerateName" runOrder="10">
					<parameter name="dstAttrId" value="medo.importedDoc.ID"/>
					<parameter name="format" value="{0}"/>
					<parameter name="srcAttrIds" value="link: medo.doc.parent@jbr.original.source@jbr.importedDoc.ID"/>
				</pre-process>
				<!-- Записать руководителя департамента 'Ответственный исполнитель фоив' в атрибут 'Руководитель подразделения исполнителя фоив' -->
				<post-process class="SetCurrentPersonTo" runOrder="15">
					<parameter name="cardlinkAttribute" value="medo.foiv.subDirector"/>
					<parameter name="checkIsLinked" value="false"/>
					<parameter name="forceSaveCard" value="false"/>
					<parameter name="userSubordinate" value="BY_RULE"/>
					<parameter name="calcUserPostRule" value="
							link:medo.foiv.executor
							-> link: jbr.personInternal.department
							-> link: jbr.department.chief
						" />
					<parameter name="addUserIfEmptySubordinate" value="false"/>
				</post-process>

				<!-- Записать департамент 'Ответственный исполнитель фоив' в атрибут 'Наименование подразделения исполнителя фоив' -->
				<!-- Явно задано правило получения пользователя относительно текущей карточки -->
				<!--  Если руководителя не будет - ничего не подставлять -->
				<post-process class="SetCurrentPersonTo" runOrder="20">
					<parameter name="cardlinkAttribute" value="medo.foiv.department"/>
					<parameter name="checkIsLinked" value="false"/>
					<parameter name="forceSaveCard" value="false"/>
					<parameter name="userSubordinate" value="BY_RULE"/>
					<parameter name="calcUserPostRule" value="
							link:medo.foiv.executor
							-> link:jbr.personInternal.department" />
					<parameter name="addUserIfEmptySubordinate" value="false"/>
				</post-process>
				<!-- скопировать Номер документа из родительского входящего-->
				<post-process class="CopyAttributeFromParent" runOrder="25">
					<parameter name="from" value="jbr.incoming.outnumber"/>
					<parameter name="to" value="medo.incoming.outnumber"/>
					<parameter name="parent" value="medo.doc.parent"/>
				</post-process>
				<!-- скопировать Дата документа из родительского входящего-->
				<post-process class="CopyAttributeFromParent" runOrder="30">
					<parameter name="from" value="jbr.incoming.outdate"/>
					<parameter name="to" value="medo.incoming.outdate"/>
					<parameter name="parent" value="medo.doc.parent"/>
				</post-process>
				<!-- скопировать Регистрационный номер из родительского входящего-->
				<post-process class="CopyAttributeFromParent" runOrder="35">
					<parameter name="from" value="JBR_REGD_REGNUM"/>
					<parameter name="to" value="MED_REGD_REGNUM"/>
					<parameter name="parent" value="medo.doc.parent"/>
				</post-process>
				<!-- скопировать Дата регистрации из родительского входящего-->
				<post-process class="CopyAttributeFromParent" runOrder="40">
					<parameter name="from" value="regdate"/>
					<parameter name="to" value="medo.regdate"/>
					<parameter name="parent" value="medo.doc.parent"/>
				</post-process>
				<post-process class="GenerateUIDProcessor" runOrder="45">
					<parameter name="attrId" value="string: medo.notification.UID"/>
					<parameter name="setIfEmptyOnly" value ="true"/>
				</post-process>
				<!-- записываем Отправитель -->
				<!-- поменяли тип атрибута medo.sender с "T" на "C" -->
				<post-process class="CopyAttributeFromParent" runOrder="50">
					<parameter name="to" value="medo.sender"/>
					<parameter name="from" value="jbr.incoming.sender"/>
					<parameter name="parent" value="medo.doc.parent"/>
					<parameter name="type" value="C"/>
				</post-process>
				<!-- Копируем из уведомления атрибут "Автор" в атрибут уведомления "Ответственный исполнитель ФОИВ" -->
				<post-process class="SetCurrentPersonTo" runOrder="55">
					<parameter name="cardlinkAttribute" value="medo.foiv.executor"/>
					<parameter name="checkIsLinked" value="false"/>
					<parameter name="forceSaveCard" value="true"/>
					<parameter name="userSubordinate" value="BY_RULE"/>
					<parameter name="calcUserPostRule" value="author" />
					<parameter name="addUserIfEmptySubordinate" value="false"/>
					<parameter name="addOnlyIfDestIsEmpty" value="true"/>
				</post-process>
				<!-- Копируем из док-основания Входящий атрибут "Отправитель" в шаблон "уведомление:поручение принят к исполнению" в атрибут "Получатель"  -->
				<post-process class="CopyAttributeFromParent" runOrder="60">
					<parameter name="parent" value="medo.doc.parent"/> 
					<parameter name="from" value="jbr.incoming.sender"/>
					<parameter name="to" value="jbr.distributionItem.recipient"/>
					<parameter name="type" value="C"/> 
				</post-process>
			</specific> 
			
<!-- Шаблон 1025 ('Уведомление: Документ зарегистрирован') -->
			<specific property="template" value="med.documentRegister">
				<!-- Заполняем UID -->
				<pre-process class="DeepGenerateName" runOrder="5">      
					<parameter name="dstAttrId" value="medo.importedDoc.UID"/>
					<parameter name="format" value="{0}"/>
					<parameter name="srcAttrIds" value="link: medo.doc.parent@jbr.original.source@jbr.importedDoc.UID"/>
				</pre-process>
				<!-- Заполняем ID -->
				<pre-process class="DeepGenerateName" runOrder="10">
					<parameter name="dstAttrId" value="medo.importedDoc.ID"/>
					<parameter name="format" value="{0}"/>
					<parameter name="srcAttrIds" value="link: medo.doc.parent@jbr.original.source@jbr.importedDoc.ID"/>
				</pre-process>
				<!-- скопировать Номер документа из родительского входящего-->
				<post-process class="CopyAttributeFromParent" runOrder="15">
					<parameter name="from" value="jbr.incoming.outnumber"/>
					<parameter name="to" value="medo.incoming.outnumber"/>
					<parameter name="parent" value="medo.doc.parent"/>
				</post-process>
				<!-- скопировать Дата документа из родительского входящего-->
				<post-process class="CopyAttributeFromParent" runOrder="20">
					<parameter name="from" value="jbr.incoming.outdate"/>
					<parameter name="to" value="medo.incoming.outdate"/>
					<parameter name="parent" value="medo.doc.parent"/>
				</post-process>
				<!-- скопировать Регистрационный номер из родительского входящего-->
				<post-process class="CopyAttributeFromParent" runOrder="25">
					<parameter name="from" value="JBR_REGD_REGNUM"/>
					<parameter name="to" value="MED_REGD_REGNUM"/>
					<parameter name="parent" value="medo.doc.parent"/>
				</post-process>
				<!-- скопировать Дата регистрации из родительского входящего-->
				<post-process class="CopyAttributeFromParent" runOrder="30">
					<parameter name="from" value="regdate"/>
					<parameter name="to" value="medo.regdate"/>
					<parameter name="parent" value="medo.doc.parent"/>
				</post-process>
				<post-process class="GenerateUIDProcessor" runOrder="35">
					<parameter name="attrId" value="string: medo.notification.UID"/>
					<parameter name="setIfEmptyOnly" value ="true"/>
				</post-process>
				<!-- записываем Отправитель -->
				<!-- поменяли тип атрибута medo.sender с "T" на "C" -->
				<post-process class="CopyAttributeFromParent" runOrder="40">
					<parameter name="to" value="medo.sender"/>
					<parameter name="from" value="jbr.incoming.sender"/>
					<parameter name="parent" value="medo.doc.parent"/>
					<parameter name="type" value="C"/>
				</post-process>
				<!-- Сразу "прыгаем" на Готов к отправке 
					(отключил ввиду обязательности некоторых полей в шаблоне при переходе) -->
				<specific property="state" value="draft">
					<post-process class="JumpStatePostProcessor">
						<parameter name="dest_wfm" value="jbr.draft.readytosend"/>
					</post-process>
				</specific>

			</specific>
<!-- 1065 -->
			<specific property="template" value="med.reportSent">
				<!-- Заполняем UID -->
				<pre-process class="DeepGenerateName" runOrder="5">
 					<parameter name="dstAttrId" value="medo.importedDoc.UID"/>
 					<parameter name="format" value="{0}"/>
 					<parameter name="srcAttrIds" value="link: medo.doc.parent@jbr.original.source@jbr.importedDoc.UID"/>
				</pre-process>
				<!-- Заполняем ID -->
				<pre-process class="DeepGenerateName" runOrder="10">
 					<parameter name="dstAttrId" value="medo.importedDoc.ID"/>
 					<parameter name="format" value="{0}"/>
 					<parameter name="srcAttrIds" value="link: medo.doc.parent@jbr.original.source@jbr.importedDoc.ID"/>
				</pre-process>
				<!-- Заполняем UID значением из  java.util.UUID.randomUUID() -->	
				<post-process class="GenerateUIDProcessor" runOrder="15">
					<parameter name="attrId" value="string: medo.notification.UID"/>
					<parameter name="setIfEmptyOnly" value ="true"/>
				</post-process>
				<!-- Заполняем Дату доставки из тикетов (берём самую позднюю дату доставки из них) -->
				<post-process class="TreeProcessor" runOrder="20">
					<parameter name="nodeLinkAttrIds" value="jbr.incoming.notification.ticket"/>
					<parameter name="leafLinkAttrIds" value=""/>
					<parameter name="processorClassName" 
							value="com.aplana.dbmi.jbr.processors.docgraph.TreeChooseDateFromChild"/>
					<parameter name="srcAttrId" value="ticket.deliveryDate"/>
					<parameter name="dstAttrId" value="medo.deliveryDate"/>
				</post-process>
				<!-- записываем Отправитель -->
				<!-- поменяли тип атрибута medo.sender с "T" на "C" -->
				<post-process class="CopyAttributeFromParent" runOrder="25">
					<parameter name="to" value="medo.sender"/>
					<parameter name="from" value="jbr.incoming.sender"/>
					<parameter name="parent" value="medo.doc.parent"/>
					<parameter name="type" value="C"/>
				</post-process>

				<!--  Сразу "прыгаем" на Готов к отправке -->
				<specific property="state" value="draft">
					<post-process class="JumpStatePostProcessor">
						<parameter name="dest_wfm" value="jbr.draft.readytosend"/>
					</post-process>
				</specific>
			</specific>

			<!--  2290  Уведомление о делегировании -->
			<specific property="template" value="jbr.delegate_notice">
				<pre-process class="GenerateName">
					<parameter name="format" value="Кому: {0}    От кого: {1},    Дата начала: {2}    Дата окончания: {3}" />
					<parameter name="dstAttrId" value="string: DLGT_MSG" />
					<parameter name="srcAttrIds"
						value="
						user: jbr.delegation.to;
						user: jbr.delegation.from;
						date: jbr.delegation.date.start;
						date: jbr.delegation.date.end" />
				</pre-process>

				<specific property="state" value="draft">
					<post-process class="JumpStatePostProcessor">
						<!-- Отправляем сразу на ознакомление -->
						<parameter name="dest_wfm" value="jbr.info.send.assistant"/>
					</post-process>
				</specific>

			</specific>

			<!-- 1066 -->
			<specific property="template" value="med.registrDenied">
				<!-- Заполняем UID -->
				<pre-process class="DeepGenerateName" runOrder="5">
 					<parameter name="dstAttrId" value="medo.importedDoc.UID"/>
 					<parameter name="format" value="{0}"/>
 					<parameter name="srcAttrIds" value="link: medo.doc.parent@jbr.original.source@jbr.importedDoc.UID"/>
				</pre-process>
				<!-- Заполняем ID -->
				<pre-process class="DeepGenerateName" runOrder="10">
 					<parameter name="dstAttrId" value="medo.importedDoc.ID"/>
 					<parameter name="format" value="{0}"/>
 					<parameter name="srcAttrIds" value="link: medo.doc.parent@jbr.original.source@jbr.importedDoc.ID"/>
				</pre-process>
				<!-- Заполняем причину отказа в регистрации -->
				<pre-process class="DeepGenerateName" runOrder="15">
					<parameter name="dstAttrId" value="text: medo.refuse.reason"/>
					<parameter name="format" value="{0}"/>
					<parameter name="srcAttrIds" value="
							link: medo.doc.parent@string: medo.registration.refuse.reason"/>
					<parameter name="maxArgStrLen"  value="127"/>
				</pre-process>
				<!-- Заполняем UID значением из  java.util.UUID.randomUUID() -->	
				<post-process class="GenerateUIDProcessor" runOrder="20">
					<parameter name="attrId" value="string: medo.notification.UID"/>
					<parameter name="setIfEmptyOnly" value ="true"/>
				</post-process>
				<!-- скопировать Дата создания из родительского входящего-->
			    <post-process class="CopyAttributeFromParent" runOrder="25">
			    	<parameter name="from" value="created"/>
			    	<parameter name="to" value="medo.doc.created"/>
			    	<parameter name="parent" value="medo.doc.parent"/>
			    	<parameter name="type" value="D"/>
			    </post-process>
			    <!-- скопировать Дата документа из родительского входящего-->
			    <post-process class="CopyAttributeFromParent" runOrder="30">
			    	<parameter name="from" value="jbr.incoming.outdate"/>
			    	<parameter name="to" value="medo.incoming.outdate"/>
			    	<parameter name="parent" value="medo.doc.parent"/>
			    	<parameter name="type" value="D"/>
			    </post-process>
				<!-- скопировать Номер документа из родительского входящего-->
			    <post-process class="CopyAttributeFromParent" runOrder="35">
			    	<parameter name="from" value="jbr.incoming.outnumber"/>
			    	<parameter name="to" value="medo.incoming.outnumber"/>
			    	<parameter name="parent" value="medo.doc.parent"/>
			    	<parameter name="type" value="S"/>
			    </post-process>
				<!-- записываем Отправитель -->
				<!-- поменяли тип атрибута medo.sender с "T" на "C" -->
				<post-process class="CopyAttributeFromParent" runOrder="40">
					<parameter name="to" value="medo.sender"/>
					<parameter name="from" value="jbr.incoming.sender"/>
					<parameter name="parent" value="medo.doc.parent"/>
					<parameter name="type" value="C"/>
				</post-process>
				<!--  Сразу "прыгаем" на Готов к отправке -->
				<specific property="state" value="draft">
					<post-process class="JumpStatePostProcessor">
						<parameter name="dest_wfm" value="jbr.draft.readytosend"/>
					</post-process>
				</specific>
			</specific>

<!-- Шаблон 995 ('Уведомление: уведомление заявителю') -->
			<specific property="template" value="med.notifyForApplicant">
				<!-- Заполняем UID -->
				<pre-process class="DeepGenerateName" runOrder="5">
 					<parameter name="dstAttrId" value="medo.importedDoc.UID"/>
 					<parameter name="format" value="{0}"/>
 					<parameter name="srcAttrIds" value="link: medo.doc.parent@jbr.original.source@jbr.importedDoc.UID"/>
				</pre-process>
				
				<!-- Заполняем ID -->
				<pre-process class="DeepGenerateName" runOrder="10">
 					<parameter name="dstAttrId" value="medo.importedDoc.ID"/>
 					<parameter name="format" value="{0}"/>
 					<parameter name="srcAttrIds" value="link: medo.doc.parent@jbr.original.source@jbr.importedDoc.ID"/>
				</pre-process>
				<!-- Заполняем UID -->
				<post-process class="GenerateUIDProcessor" runOrder="15">
					<parameter name="attrId" value="string: jbr.distributionItem.uuid"/>
					<parameter name="setIfEmptyOnly" value ="true"/>
				</post-process>
				
				<!-- Заполняем UID нотификации-->
				<post-process class="GenerateUIDProcessor" runOrder="20">
					<parameter name="attrId" value="string: medo.notification.UID"/>
					<parameter name="setIfEmptyOnly" value ="true"/>
				</post-process>
				
				<!-- Копируем из док-основания атрибут "Отправитель" -->
				<post-process class="CopyAttributeFromParent" runOrder="25">
					<parameter name="parent" value="medo.doc.parent"/> 
					<parameter name="from" value="jbr.incoming.sender"/>
					<parameter name="to" value="medo.sender"/>
					<parameter name="type" value="C"/> 
				</post-process>
				
				<!-- Копируем из док-основания атрибут "Регистрационный номер" -->
				<post-process class="CopyAttributeFromParent" runOrder="30">
					<parameter name="parent" value="medo.doc.parent"/> 
					<parameter name="from" value="regnumber"/>
					<parameter name="to" value="medo.incoming.outnumber"/>
					<parameter name="type" value="S"/> 
				</post-process>
				
				<!-- Копируем из док-основания атрибут "Дата регистрации" -->
				<post-process class="CopyAttributeFromParent" runOrder="35">
					<parameter name="parent" value="medo.doc.parent"/> 
					<parameter name="from" value="regdate"/>
					<parameter name="to" value="medo.incoming.outdate"/>
					<parameter name="type" value="D"/> 
				</post-process>
				
				<!-- Задаём справочное значение "Система обработки запросов Полтава" атрибуту "Получатель"  -->
				<post-process class="SetAttributeValueWithConditionProcessor" runOrder="40">
					<parameter name="attr_condition_1" value="link:jbr.distributionItem.recipient=null"/>
					<parameter name="attributeId" value="link:jbr.distributionItem.recipient"/>
					<parameter name="value" value="424644" /> <!-- Система обработки запросов Полтава -->
					<parameter name="saveKind" value="SAVE_ATTR"/>
					<parameter name="onlyCurrentCard" value="true" />
				</post-process>
			</specific> 

<!--  Шаблон "Уведомление: Документ зарегистрирован (исх.док)" (1067) -->
			<specific property="template" value="med.out.documentRegister">
				<!-- Пишем 'Зарегистрирован' в L-атрибут 'NOTI_STATE_AT_ADDRSR' 
					"Элемента списка рассылки"/704, в списке "Информация о доставке"/'JBR_DIST_SEND_INFO'
					хранится данный Тикет (но не документа-основания 'MED_DOCBASE'/B) -->
				<post-process class="SetAttributeValueProcessor">
					<parameter name="linkId" value="link: JBR_DIST_SEND_INFO"/>
					<parameter name="isReversedLink" value="true"/>
					<parameter name="attributeId" value="list: NOTI_STATE_AT_ADDRSR"/>
					<parameter name="value" value="jbr.state.at_addressor.registered"/>
					<parameter name="saveKind" value="SAVE_ATTR"/>
				</post-process>
			</specific>

<!--  Шаблон "Уведомление: Поручение принят к исполнению (исх.док)" (1068) -->
			<specific property="template" value="med.out.resolutionAccept">
				<!-- Пишем 'Исполнение' в L-атрибут 'NOTI_STATE_AT_ADDRSR' 
					"Элемента списка рассылки"/704, в списке "Информация о доставке"/'JBR_DIST_SEND_INFO'
					хранится данный Тикет. -->
				<post-process class="SetAttributeValueProcessor">
					<parameter name="linkId" value="link: JBR_DIST_SEND_INFO"/>
					<parameter name="isReversedLink" value="true"/>
					<parameter name="attributeId" value="list: NOTI_STATE_AT_ADDRSR"/>
					<parameter name="value" value="jbr.state.at_addressor.execution"/>
					<parameter name="saveKind" value="SAVE_ATTR"/>
				</post-process>
			</specific>

<!--  Шаблон "Уведомление: Доклад по поручению направлен (исх.док)" (1069) -->
			<specific property="template" value="med.out.reportSent">
				<!-- Пишем 'Доклад направлен' в L-атрибут 'NOTI_STATE_AT_ADDRSR' 
					"Элемента списка рассылки"/704, в списке "Информация о доставке"/'JBR_DIST_SEND_INFO'
					хранится данный Тикет. -->
				<post-process class="SetAttributeValueProcessor">
					<parameter name="linkId" value="link: JBR_DIST_SEND_INFO"/>
					<parameter name="isReversedLink" value="true"/>
					<parameter name="attributeId" value="list: NOTI_STATE_AT_ADDRSR"/>
					<parameter name="value" value="jbr.state.at_addressor.speesn.sent"/>
					<parameter name="saveKind" value="SAVE_ATTR"/>
				</post-process>
			</specific>

<!--  Шаблон "Уведомление: в регистрации документа отказано (исх.док)" (1070) -->
			<specific property="template" value="med.out.registrDenied">
				<!-- Пишем 'Отказано в регистрации' в L-атрибут 'NOTI_STATE_AT_ADDRSR' 
					"Элемента списка рассылки"/704, в списке "Информация о доставке"/'JBR_DIST_SEND_INFO'
					хранится данный Тикет. -->
				<post-process class="SetAttributeValueProcessor">
					<parameter name="linkId" value="link: JBR_DIST_SEND_INFO"/>
					<parameter name="isReversedLink" value="true"/>
					<parameter name="attributeId" value="list: NOTI_STATE_AT_ADDRSR"/>
					<parameter name="value" value="jbr.state.at_addressor.reg.refused"/>
					<parameter name="saveKind" value="SAVE_ATTR"/>
				</post-process>
			</specific>

<!--  Шаблон "Тикет" (1071) -->
			<specific property="template" value="ticket">
				<!-- Пишем 'Отправлен в МЭДО' в L-атрибут 'NOTI_STATE_AT_ADDRSR' 
					"Элемента списка рассылки"/704, в списке "Информация о доставке"/'JBR_DIST_SEND_INFO'
					хранится данный Тикет. -->
				<post-process class="SetAttributeValueProcessor">
					<parameter name="linkId" value="link: JBR_DIST_SEND_INFO"/>
					<parameter name="isReversedLink" value="true"/>
					<parameter name="attributeId" value="list: NOTI_STATE_AT_ADDRSR"/>
					<parameter name="value" value="jbr.state.at_addressor.sent.by_medo"/>
					<parameter name="saveKind" value="SAVE_ATTR"/>
				</post-process>
			</specific>

			<specific property="template" value="jbr.medo_og.requestAuthor">
				<specific property="state" value="doublet">
					<validator class="TestEmptyAttrProcessor">
						<parameter name="test_attr" value="link:jbr.requestAuthor.originalValue"/>
						<parameter name="must_empty" value="false"/>
						<parameter name="empty_message" value="Атрибут Оригинальное значение должен быть заполнен."/>
					</validator>
				</specific>
				<post-process class="DeepGenerateName">
					<parameter name="format" value="{0} {1} {2} (г.{3}, ул.{4}, д.{5}, {6}, {7})" />
					<parameter name="dstAttrId" value="string: NAME" />
					<parameter name="srcAttrIds"
						value="	string: ADMIN_274992; 
								string: ADMIN_281034; 
								string: ADMIN_281035;
								link: jbr.InfAboutDocCity@NAME;
								text: jbr.InfAboutDocStreet;
								string: JBR_APP_HOUSE;
								text: jbr.reqAuthorAddress;
								string: jbr.reqAuthorEmail
								" />
					<parameter name="forceSave" value="true" />
					<parameter name="forceSaveMode" value="attribute" />
				</post-process>
				<specific property="state" value="published">
					<pre-process class="ClearCardAttributePostProcessorEx">
						<parameter name="attrId" value="link:jbr.requestAuthor.originalValue"/>
					</pre-process>
				</specific>
				<specific property="state" value="dictionaryNew">
					<pre-process class="ClearCardAttributePostProcessorEx">
						<parameter name="attrId" value="link:jbr.requestAuthor.originalValue"/>
					</pre-process>
				</specific>
			</specific>
			<specific property="template" value="typeOfDoc">
				<validator class="TestEmptyAttrProcessor" runOrder="1">
					<parameter name="test_attr" value="text:descr"/>
					<parameter name="must_empty" value="false"/>
				</validator>
				<specific property="state" value="doublet">
					<validator class="TestEmptyAttrProcessor" runOrder="2">
						<parameter name="test_attr" value="link:jbr.typeOfDoc.originalValue"/>
						<parameter name="must_empty" value="false"/>
						<parameter name="empty_message" value="Атрибут Оригинальное значение должен быть заполнен."/>
					</validator>
				</specific>
				<validator class="CheckAttributeUniquenessProcessor" runOrder="3">
					<parameter name="attrIds" value="text:descr"/>
					<parameter name="statusIds" value="4,7"/>
					<parameter name="error_message" value="Значение атрибута Описание должно быть уникальным среди карточек текущего шаблона"/>
				</validator>
				<specific property="state" value="published">
					<pre-process class="ClearCardAttributePostProcessorEx">
						<parameter name="attrId" value="link:jbr.typeOfDoc.originalValue"/>
					</pre-process>
				</specific>
				<specific property="state" value="dictionaryNew">
					<pre-process class="ClearCardAttributePostProcessorEx">
						<parameter name="attrId" value="link:jbr.typeOfDoc.originalValue"/>
					</pre-process>
				</specific>
				<pre-process class="GenerateName" runOrder="10">
					<parameter name="format" value="{0}" />
					<parameter name="dstAttrId" value="NAME" />
					<parameter name="srcAttrIds" value="text:descr" />
					<parameter name="maxArgStrLen"  value="500" />
				</pre-process>
			</specific>
			<specific property="template" value="jbr.medo_og.requestObject">
				<pre-process class="GenerateName">
					<parameter name="format" value="{0} {1} {2}" />
					<parameter name="dstAttrId" value="string: NAME" />
					<parameter name="srcAttrIds"
						value="string: JBR_DT_OBJ_SNAME; string: JBR_DT_OBJ_FNAME; string: JBR_DT_OBJ_MNAME" />
				</pre-process>
			</specific>

			<specific property="template" value="jbr.RefQuestionOfAddress">
				<specific property="state" value="doublet">
					<validator class="TestEmptyAttrProcessor">
						<parameter name="test_attr" value="link:jbr.originalQuestionValue"/>
						<parameter name="must_empty" value="false"/>
						<parameter name="empty_message" value="Атрибут 'Оригинальное значение вопроса' должен быть заполнен"/>
					</validator>
				</specific>
				<specific property="state" value="published">
					<pre-process class="ClearCardAttributePostProcessorEx">
						<parameter name="attrId" value="link:jbr.originalQuestionValue"/>
					</pre-process>
				</specific>
				<specific property="state" value="dictionaryNew">
					<pre-process class="ClearCardAttributePostProcessorEx">
						<parameter name="attrId" value="link:jbr.originalQuestionValue"/>
					</pre-process>
				</specific>
			</specific>

			<specific property="template" value="jbr.medo_og.response">
				<pre-process class="GenerateName">
					<parameter name="format" value="{0} {1} {2}" />
					<parameter name="dstAttrId" value="string: NAME" />
					<parameter name="srcAttrIds"
						value="string: JBR_DT_OBJ_SNAME; string: JBR_DT_OBJ_FNAME; string: JBR_DT_OBJ_MNAME" />
				</pre-process>
			</specific>
			<specific property="template" value="med.out.execution">
				<pre-process class="GenerateName" runOrder="5">
					<parameter name="format" value="{0}: {1}" />
					<parameter name="dstAttrId" value="string: NAME" />
					<parameter name="srcAttrIds"
						value="list: template.name; text: jbr.medo.courseChanged.text" />
				</pre-process>
				<post-process class="SetCurrentPersonTo" runOrder="10">
					<parameter name="cardlinkAttribute" value="medo.foiv.executor"/>
					<parameter name="checkIsLinked" value="false"/>
					<parameter name="forceSaveCard" value="true"/>
					<parameter name="userSubordinate" value="BY_RULE"/>
					<parameter name="calcUserPostRule" value="
							link:medo.doc.parentForIn
							-> backLink:jbr.incoming.notification
							-> link:medo.foiv.executor" />
					<parameter name="filterPostRule" value="
							jbr.incoming.notification>_TEMPLATE=med.resolutionAccept;
					 								  _STATE=556656;" />
					<parameter name="addUserIfEmptySubordinate" value="false"/>
				</post-process>
			</specific>
			<specific property="template" value="jbr.state_service.dictionary">
				<pre-process class="GenerateName">
					<parameter name="format" value="{0}" />
					<parameter name="dstAttrId" value="string: NAME" />
					<parameter name="srcAttrIds"
						value="string: jbr.state_service.dictionaryShortName" />
				</pre-process>
			</specific>
			

			<!--
				specific property="template" value="jbr.reservationRequest">
				<pre-process class="GenerateName"> <parameter name="format"
				value="Запрос на резервирование номера для документа {0}"/>
				<parameter name="dstAttrId" value="string: NAME"/> <parameter
				name="srcAttrIds" value="backLink:
				jbr.reservationRequest.document@jbr.document.title"/> </pre-process>
				</specific
			-->

			<!-- specific property="card.template" value="jbr.ord">
				<post-process class="GenerateChildrenNames">
					<parameter name="childrenCardLinkAttrId" value="jbr.doc.reservationRequests" />
					<parameter name="format"
						value="Запрос на резервирование номера для документа {0}" />
					<parameter name="dstAttrId" value="string: NAME" />
					<parameter name="srcAttrIds" value="text: jbr.document.title" />
					<parameter name="forceSave" value="true" />
				</post-process>
			</specific>
			<specific property="card.template" value="jbr.npa">
				<post-process class="GenerateChildrenNames">
					<parameter name="childrenCardLinkAttrId" value="jbr.doc.reservationRequests" />
					<parameter name="format"
						value="Запрос на резервирование номера для документа {0}" />
					<parameter name="dstAttrId" value="string: NAME" />
					<parameter name="srcAttrIds" value="text: jbr.document.title" />
					<parameter name="forceSave" value="true" />
				</post-process>
			</specific>
			<specific property="card.template" value="jbr.interndoc">
				<post-process class="GenerateChildrenNames">
					<parameter name="childrenCardLinkAttrId" value="jbr.doc.reservationRequests" />
					<parameter name="format"
						value="Запрос на резервирование номера для документа {0}" />
					<parameter name="dstAttrId" value="string: NAME" />
					<parameter name="srcAttrIds" value="text: jbr.document.title" />
					<parameter name="forceSave" value="true" />
				</post-process>
			</specific>
			<specific property="card.template" value="jbr.outcoming">
				<post-process class="GenerateChildrenNames">
					<parameter name="childrenCardLinkAttrId" value="jbr.doc.reservationRequests" />
					<parameter name="format"
						value="Запрос на резервирование номера для документа {0}" />
					<parameter name="dstAttrId" value="string: NAME" />
					<parameter name="srcAttrIds" value="text: jbr.document.title" />
					<parameter name="forceSave" value="true" />
				</post-process>
			</specific-->
			
			<specific property="template" value="jbr.DistributionListElement">
				<specific property="state" value="draft">
					<!-- Ответственный за ДОУ документа-основания -->
					<pre-process class="CopyPersonFromPaths" runOrder="5">
						<parameter name="targetAttr" value="jbr.responsible_dow.resp_dow.maindoc" />
						<parameter name="paths"
							value="
							backLink: jbr.distributionItem.foundationDoc ->user:jbr.responsible_dow.resp_dow;
							backLink: jbr.distributionItem.foundationDoc ->user:jbr.responsible_dow.resp_dow_read;
						" />
						<parameter name="reloadCard" value="true" />
						<parameter name="async" value="true" />	
					</pre-process>
					<post-process class="CopyAttributeFromParent" runOrder="10">
						<parameter name="attr_condition" value="list:jbr.distributionItem.method=NULL"/>
						<parameter name="parent" value="link: jbr.distributionItem.recipient"/>
						<parameter name="parentTemplate" value="jbr.organization"/>
						<parameter name="from" value="jbr.sending.method"/>
						<parameter name="to" value="jbr.distributionItem.method"/>
						<parameter name="type" value="L"/>
					</post-process>
					<post-process class="CopyAttributeFromParent" runOrder="15">
						<parameter name="attr_condition" value="list:jbr.distributionItem.method=NULL"/>
						<parameter name="parent" value="link: jbr.distributionItem.recipient"/>
						<parameter name="parentTemplate" value="jbr.externalPerson"/>
						<parameter name="subParentLink" value="link: jbr.person.organization"/>
						<parameter name="from" value="jbr.sending.method"/>
						<parameter name="to" value="jbr.distributionItem.method"/>
						<parameter name="type" value="L"/>
					</post-process>
					<!--  -->					
					<post-process class="GenerateUIDProcessor" runOrder="20">
						<parameter name="attrId" value="string:jbr.distributionItem.uuid"/>
						<parameter name="setIfEmptyOnly" value ="true"/>
					</post-process>		
				</specific>
				<post-process class="CopyBackLink">
					<parameter name="from" value="@backLink:jbr.DistributionListElement.ParentDoc"/>
					<parameter name="to" value="->jbr.distributionItem.sendInfo@"/>
					<parameter name="toByTemplate_1" value="med.out.execution?medo.doc.parentForIn"/>
					<parameter name="toByTemplate_2" value="jbr.gost.ack?jbr.gost.ack.parentDoc"/>
					<parameter name="toByTemplate_3" value="med.out.documentRegister?medo.doc.parent"/>
					<parameter name="toByTemplate_4" value="med.out.registrDenied?medo.doc.parent"/>
					<parameter name="toByTemplate_5" value="med.out.resolutionAccept?medo.doc.parent"/>
					<parameter name="toByTemplate_6" value="med.out.reportSent?medo.doc.parent"/>
					<parameter name="merge" value="false"/>
				</post-process>
			</specific>
			
			<!-- Автор обращения - 1250 -->
            <specific property="template" value="jbr.appealauthor">
                <pre-process class="GenerateName">
                    <parameter name="format" value="{0} {1} {2}, {3}, {4}, {5}, {6}"/>
                    <parameter name="dstAttrId" value="NAME"/>
                    <parameter name="srcAttrIds" value="
                                string: jbr.og.lastname;
                                string: jbr.appauthor.name;
                                string: jbr.appauthor.patronymic;
                                link:   jbr.InfAboutDocRegion;
                                link:   jbr.InfAboutDocCountry;
                                link:   jbr.InfAboutDocCity;
                                text:   jbr.appauthor.address;
                    "/>
                    <!-- <parameter name="maxArgStrLen" value="500"/> -->
                </pre-process>
            </specific>
            
			<!-- Уведомление ГОСТ (1501) -->
			<specific property="template" value="jbr.gost.ack">
				<!--  При создании инициализируется UUID  -->
				<specific property="state" value="published">
					<pre-process class="GenerateUIDProcessor" runOrder="5">
						<parameter name="attrId" value="text:uid"/>
						<parameter name="setIfEmptyOnly" value ="true"/>
					</pre-process>
					<pre-process class="GenerateName" runOrder="10">
                    	<parameter name="format" value="{0}"/>
                    	<parameter name="dstAttrId" value="NAME"/>
                    	<parameter name="srcAttrIds" value="text:uid"/>
                	</pre-process>
                	<!-- Создание Элементов Списка Рассылки (704), если способ доставки ДЕЛО -->
					<post-process class="PopulateChildrenWithConditions" runOrder="15" >
						<parameter name="template" value="jbr.DistributionListElement" />
						<parameter name="attach" value="jbr.Distribution.DistributionList" />
						<parameter name="attach_dest_card_index" value="2"/>
						<parameter name="copy" value="
							link:jbr.incoming.sender->link:jbr.distributionItem.recipient;
							#0@text:uid->jbr.distributionItem.uuid
						" />
						<parameter name="set" value="
							list:jbr.distributionItem.method=jbr.distributionItem.method.delo
						" />
						<parameter name="attr_link_path" value="text:uid
																~
																link:jbr.gost.ack.parentDoc@_TEMPLATE;
																list:jbr.deliveryItem.method"/>
    					<parameter name="attr_link_values" value="
    															#NULL
    															~
    															=224,864;
                            									=1521"/>
						<parameter name="forceSaveChilds" value="true"/>
						<parameter name="attach_unique" value="string:jbr.distributionItem.uuid"/>
					</post-process>
					<post-process class="PopulateChildrenWithConditions" runOrder="20" >
						<parameter name="template" value="jbr.DistributionListElement" />
						<parameter name="attach" value="jbr.Distribution.DistributionList" />
						<parameter name="attach_dest_card_index" value="2"/>
						<parameter name="copy" value="
							link:jbr.dmsi.sender->link:jbr.distributionItem.recipient;
							#0@text:uid->jbr.distributionItem.uuid
						" />
						<parameter name="set" value="
							list:jbr.distributionItem.method=jbr.distributionItem.method.delo
						" />
						<parameter name="attr_link_path" value="text:uid
																~
																link:jbr.gost.ack.parentDoc@_TEMPLATE;
																list:jbr.dmsi.deliveryType"/>
    					<parameter name="attr_link_values" value="
    															#NULL
    															~
    															=2264;
                            									=1521"/>
						<parameter name="forceSaveChilds" value="true"/>
						<parameter name="attach_unique" value="string:jbr.distributionItem.uuid"/>
					</post-process>
				</specific>
			</specific>

			<!-- Внешняя резолюция -->
			<specific property="template" value="jbr.externalResolution">
				<!-- Формирование имени -->
				<pre-process class="DeepGenerateName">
					<parameter name="dstAttrId" value="NAME" />
					<!-- <рег номер документа остнования>, <Текст резолюции>, от <Автор резолюции> -->
					<parameter name="format" value="{0}, {1}, от {2}" />
					<parameter name="srcAttrIds"
						value="
						backLink: JBR_DMSI_ER_DOC@regnumber; 
						text: jbr.externalResolution.text; 
						string: jbr.externalResolution.author 
						"/>
				</pre-process>
			</specific>
			
			<specific property="template" value="jbr.taskVisa">
				<!-- Заполнение поля "Помощник согласующего - скрытый" -->
				<post-process class="SetAssistantCard">
					<parameter name="chiefAttrId" value="[C-][A+]jbr.visa.person" />
					<parameter name="assistantsAttrId" value="jbr.visa.hidden.assistent.response" />
					<parameter name="forceSave" value="true" />
					<parameter name="async" value="true" />					
				</post-process>
			</specific>
			
			<!-- Шаблон 346 Журнал регистрации -->
			<specific property="template" value="jbr.journal">
				<validator class="TestEmptyAttrProcessor" runOrder="1">
					<parameter name="test_attr" value="text:descr"/>
					<parameter name="must_empty" value="false"/>
				</validator>
				<validator class="TestEmptyAttrProcessor" runOrder="2">
					<parameter name="test_attr" value="list:journal.type"/>
					<parameter name="must_empty" value="false"/>
				</validator>
				<validator class="TestEmptyAttrProcessor" runOrder="3">
					<parameter name="test_attr" value="link:jbr.journal.department"/>
					<parameter name="must_empty" value="false"/>
				</validator>
				<validator class="TestEmptyAttrProcessor" runOrder="4">
					<parameter name="test_attr" value="link:numeratorformat"/>
					<parameter name="must_empty" value="false"/>
				</validator>
				<validator class="CheckAttributeUniquenessProcessor" runOrder="5">
					<parameter name="attrIds" value="text:descr,list:journal.type,link:numeratorformat"/>
					<parameter name="statusIds" value="4"/>
					<parameter name="error_message" value="Значения атрибутов Описание, Тип журнала регистрации и Формат номера должны быть уникальным среди карточек текущего шаблона"/>
				</validator>
				<pre-process class="GenerateName" runOrder="5">
					<parameter name="format" value="{0}" />
					<parameter name="dstAttrId" value="string: NAME"/>
					<parameter name="srcAttrIds" value="text: descr"/>
					<parameter name="maxArgStrLen" value="500"/>
				</pre-process>
				<post-process class="RegJournalSaveProcessor">
					<parameter name="owner_regjournal_attr_id" value="JBR_OWNER_REGJOURNAL" />
					<parameter name="indexes_attr_id"          value="JBR_REGD_INDEXES" />
					<parameter name="index_template_id"        value="jbr.index" />
				</post-process>
			</specific>
			
			<!-- Шаблон 384 Нумератор -->
			<specific property="template" value="jbr.numerator">
				<validator class="TestEmptyAttrProcessor" runOrder="1">
					<parameter name="test_attr" value="string: numerator.name"/>
					<parameter name="must_empty" value="false"/>
				</validator>
				<validator class="TestEmptyAttrProcessor" runOrder="3">
					<parameter name="test_attr" value="number:numerator.digits"/>
					<parameter name="must_empty" value="false"/>
				</validator>
				<validator class="TestEmptyAttrProcessor" runOrder="4">
					<parameter name="test_attr" value="number:numerator.count"/>
					<parameter name="must_empty" value="false"/>
				</validator>
				<validator class="TestEmptyAttrProcessor" runOrder="5">
					<parameter name="test_attr" value="date:numerator.resetdate"/>
					<parameter name="must_empty" value="false"/>
				</validator>
				<validator class="CheckAttributeUniquenessProcessor" runOrder="6">
					<parameter name="attrIds" value="string: numerator.name"/>
					<parameter name="statusIds" value="4"/>
					<parameter name="error_message" value="Значение атрибута Название должно быть уникальным среди карточек текущего шаблона"/>
				</validator>
				<pre-process class="GenerateName" runOrder="5">
					<parameter name="format" value="{0}" />
					<parameter name="dstAttrId" value="string: NAME"/>
					<parameter name="srcAttrIds" value="string: numerator.name"/>
					<parameter name="maxArgStrLen" value="500"/>
				</pre-process>
			</specific>
			
			<!-- Шаблон 385 Формат номера -->
			<specific property="template" value="jbr.formatNum">
				<validator class="TestEmptyAttrProcessor" runOrder="1">
					<parameter name="test_attr" value="text:descr"/>
					<parameter name="must_empty" value="false"/>
				</validator>
				<validator class="TestEmptyAttrProcessor" runOrder="2">
					<parameter name="test_attr" value="link:numerator"/>
					<parameter name="must_empty" value="false"/>
				</validator>
				<validator class="TestEmptyAttrProcessor" runOrder="3">
					<parameter name="test_attr" value="list:jbr.evaluate.element1"/>
					<parameter name="must_empty" value="false"/>
				</validator>
				<validator class="CheckAttributeUniquenessProcessor" runOrder="4">
					<parameter name="attrIds" value="text:descr,link:numerator"/>
					<parameter name="statusIds" value="4,7"/>
					<parameter name="error_message" value="Значения атрибутов Описание и Нумератор должны быть уникальным среди карточек текущего шаблона"/>
				</validator>
				<pre-process class="GenerateName" runOrder="5">
					<parameter name="format" value="{0}" />
					<parameter name="dstAttrId" value="string: NAME"/>
					<parameter name="srcAttrIds" value="text: descr"/>
					<parameter name="maxArgStrLen" value="500"/>
				</pre-process>
			</specific>

			<!-- Шаблон 347 Номенклатура дел -->
			<specific property="template" value="jbr.index">
				<validator class="TestEmptyAttrProcessor" runOrder="1">
					<parameter name="test_attr" value="text:jbr.full.name.delo"/>
					<parameter name="must_empty" value="false"/>
				</validator>
				<validator class="TestEmptyAttrProcessor" runOrder="2">
					<parameter name="test_attr" value="string:jbr.delo"/>
					<parameter name="must_empty" value="false"/>
				</validator>
				<validator class="TestEmptyAttrProcessor" runOrder="3">
					<parameter name="test_attr" value="link:jbr.Index.Department"/>
					<parameter name="must_empty" value="false"/>
				</validator>
				<validator class="CheckAttributeUniquenessProcessor" runOrder="4">
					<parameter name="attrIds" value="text:jbr.full.name.delo,string:jbr.delo"/>
					<parameter name="statusIds" value="4"/>
					<parameter name="error_message" value="Значения атрибутов Полное наименование дела и Индекс дела должны быть уникальным среди карточек текущего шаблона"/>
				</validator>
				<pre-process class="GenerateName" runOrder="5">
					<parameter name="format" value="{0} {1}" />
					<parameter name="dstAttrId" value="string: NAME"/>
					<parameter name="srcAttrIds" value="string: jbr.delo;
														text: jbr.full.name.delo"/>
					<parameter name="maxArgStrLen" value="500"/>
				</pre-process>
			</specific>
			<specific property="template" value="jbr.RefSubQuestionOfAddress">
				<pre-process class="GenerateName" runOrder="5">
					<parameter name="format" value="{0}" />
					<parameter name="dstAttrId" value="string: NAME"/>
					<parameter name="srcAttrIds" value="text: jbr.refSubQuestionName"/>
					<parameter name="maxArgStrLen" value="200"/>
				</pre-process>
				<post-process class="DeepGenerateName" runOrder="10">
    				<parameter name="format" value="{0} - {1}"/>
    				<!-- изменения сразу сохранить в самом процессоре -->
    				<parameter name="forceSave" value="true"/>
    				<!-- сохранить только изменённый атрибут, а не полную карточку  -->
    				<parameter name="forceSaveMode" value="attribute"/>
    				<parameter name="maxArgStrLen" value="200"/>
    				<parameter name="dstAttrId" value="text: jbr.refSubQuestionQue"/>
    				<parameter name="srcAttrIds" value="text: jbr.refSubQuestionName;
            											link: jbr.RefQuestion4.parentRegion@NAME;
            		"/>
				</post-process>
			</specific>
			
			<!-- 333 Зона ДОУ -->
			<specific property="template" value="jbr.zoneDOW" async="true">
				<validator class="TestEmptyAttrProcessor" runOrder="1">
					<parameter name="test_attr" value="string: jbr.zoneDOW.name"/>
					<parameter name="must_empty" value="false"/>
				</validator>
				<validator class="TestEmptyAttrProcessor" runOrder="3">
					<parameter name="test_attr" value="link:jbr.zoneDOW.DepList"/>
					<parameter name="must_empty" value="false"/>
				</validator>
				<validator class="CheckAttributeUniquenessProcessor" runOrder="4">
					<parameter name="attrIds" value="string: jbr.zoneDOW.name"/>
					<parameter name="statusIds" value="4,7"/>
					<parameter name="error_message" value="Значение атрибута Название Зоны ДОУ должно быть уникальным среди карточек текущего шаблона"/>
				</validator>
				<pre-process class="GenerateName" runOrder="1">
					<parameter name="format" value="{0}" />
					<parameter name="dstAttrId" value="string: NAME" />
					<parameter name="srcAttrIds" value="string: jbr.zoneDOW.name" />
				</pre-process>
				<!-- При сохранении карточек Зона ДОУ заполняем атрибут Зона ДОУ ID текущей карточки -->
				<post-process class="SetAttributeValueProcessor" runOrder="1">
					<parameter name="attributeId" value="link: jbr.zoneDOW"/>
					<parameter name="value" value="_ID"/>
					<parameter name="saveKind" value="SAVE_ATTR"/>
				</post-process>
				<!-- Удаляем ссылки на данную Зону ДОУ из всех карточек департаментов и Пользователей, чтобы потом прописать только в тех, которые на самом деле относятся -->
				<post-process class="RemoveLinkUniversalProcessor" runOrder="2">
					<parameter name="listLinkedAttrIds"
						value="jbr.zoneDOW, jbr.zonesDOW" />
					<parameter name="selectTemplates"
						value="jbr.internalPerson, jbr.department, jbr.organization" />
				</post-process>
				<!-- После этого копируем данный Id в атрибут Зона ДОУ всех департаментов из Списка департаментов -->
				<!-- (YNikitin, 2013/11/13, BR4J00034081) в рамках оптимизации системы, убираем лишние процессоры и донастраиваем оставшиеся, чтобы не было лишних пересчётов прав и лишних копирований атрибутов -->
				<post-process class="CopyAttributeToChildren" runOrder="3">
					<parameter name="updateAccessList" value="true"/>
					<parameter name="from" value="link: jbr.zoneDOW"/>
					<parameter name="to" value="link: jbr.zoneDOW"/>
					<parameter name="children" value="jbr.zoneDOW.DepList" />
					<parameter name="writeOperation" value="append" />
					<parameter name="async" value="false" />					
				</post-process>
				<!-- После обновления Департаментов запускаем обновление через CallOriginsProcessor для связанных с департаментами сотрудников -->
				<!-- (YNikitin, 2013/11/13, BR4J00034081) в рамках оптимизации системы, убираем лишние процессоры и донастраиваем оставшиеся, чтобы не было лишних пересчётов прав и лишних копирований атрибутов -->
				<post-process class="CallOriginsProcessor" runOrder="4">
					<parameter name="backLinkAttrId" value="link: jbr.zoneDOW.DepList" />
					<parameter name="processorClassName"
						value="com.aplana.dbmi.jbr.processors.CopyAttributeToChildren" />
					<parameter name="updateAccessList" value="true"/>
					<parameter name="from" value="link: jbr.zoneDOW"/>
					<parameter name="to" value="link: jbr.zoneDOW"/>
					<parameter name="linkAttrId" value="jbr.byPerson"/>
					<parameter name="writeOperation" value="append" />
					<parameter name="async" value="false" />					
				</post-process>
				<!-- (YNikitin, 2014/05/214, BR4J00035162) После обновления Департаментов запускаем обновление Зон ДОУ в Документах, в которых прописаны пользователи обновленных департаментов -->
				<post-process class="CallOriginsProcessor" runOrder="4">
					<parameter name="backLinkAttrId" value="link: jbr.zoneDOW.DepList" />
					<parameter name="processorClassName"
						value="com.aplana.dbmi.jbr.processors.RecalculateZoneDOWProcessor" />
					<parameter name="isDepartment" value="true" />
					<parameter name="changeAttribute" value="link:jbr.zoneDOW"/>
				</post-process>
				<!-- После обновления Департаментов запускаем обновление через CallOriginsProcessor для Организаций департаментов -->
				<!-- (YNikitin, 2013/11/13, BR4J00034081) в рамках оптимизации системы, убираем лишние процессоры и донастраиваем оставшиеся, чтобы не было лишних пересчётов прав и лишних копирований атрибутов -->
				<post-process class="CallOriginsProcessor" runOrder="5">
					<parameter name="backLinkAttrId" value="link: jbr.zoneDOW.DepList" />
					<parameter name="processorClassName"
						value="com.aplana.dbmi.jbr.processors.CopyAttributeToChildren" />
					<parameter name="updateAccessList" value="true"/>
					<parameter name="from" value="link: jbr.zoneDOW"/>
					<parameter name="to" value="link: jbr.zonesDOW"/>
					<parameter name="children" value="jbr.department.Organization" />
					<parameter name="writeOperation" value="append" />
					<parameter name="async" value="false" />					
				</post-process>
			</specific>
			<specific property="template" value="jbr.RefSourceComeFrom">
				<pre-process class="GenerateName" runOrder="1">
					<parameter name="dstAttrId" value="NAME" />
					<parameter name="format" value="{0} {1}, {2} от {3}" />
					<parameter name="srcAttrIds"
						value="link: jbr.ComeFromOrg;
							   string: jbr.fio.signer;
							   string: jbr.reg.number;
							   date: jbr.reg.date
							   " />
				</pre-process>
			</specific>
			<specific property="template" value="jbr.redirection.og">
				<post-process class="DeepGenerateName" runOrder="10">
    				<parameter name="format" value="Перенаправлено {0} в {1}"/>
    				<!-- изменения сразу сохранить в самом процессоре -->
    				<parameter name="forceSave" value="true"/>
    				<!-- сохранить только изменённый атрибут, а не полную карточку  -->
    				<parameter name="forceSaveMode" value="attribute"/>
    				<parameter name="maxArgStrLen" value="200"/>
    				<parameter name="dstAttrId" value="string: NAME"/>
    				<parameter name="srcAttrIds" value="date: jbr.redirection.date;
            											link: jbr.treatment.recipient@text: JBR_DORG_FULLNAME;
            		"/>
				</post-process>
			</specific>
			<specific property="template" value="jbr.RefResultOfConsuder">
				<specific property="state" value="published">
					<validator class="TestEmptyAttrProcessor" runOrder="1">
	                    <parameter name="test_attr" value="list:jbr.decision.result"/>
	                    <parameter name="condition" value="list:jbr.acc_decision=acq_result.decision.explained"/>
	                    <parameter name="must_empty" value="false"/>
	                    <parameter name="empty_message" value="Обязательная характеристика 'Результат рассмотрения' не заполнена."/>
	                </validator>
	                <validator class="TestEmptyAttrProcessor" runOrder="2">
	                    <parameter name="test_attr" value="list:jbr.solution"/>
	                    <parameter name="condition" value="list:jbr.acc_decision=acq_result.decision.explained" />
	                    <parameter name="must_empty" value="false"/>
	                    <parameter name="empty_message" value="Обязательная характеристика 'Решение' не заполнена."/>
	                </validator>
	                <validator class="TestEmptyAttrProcessor" runOrder="3">
	                    <parameter name="test_attr" value="list:jbr.redirect"/>
	                    <parameter name="condition" value="list:jbr.acc_decision#acq_result.decision.explained" />
	                    <parameter name="must_empty" value="false"/>
	                    <parameter name="empty_message" value="Обязательная характеристика 'Перенаправление' не заполнена."/>
	                </validator>
	                <validator class="TestEmptyAttrProcessor" runOrder="4">
	                    <parameter name="test_attr" value="link:jbr.treatment.recipient"/>
	                    <parameter name="condition" value="list:jbr.acc_decision#acq_result.decision.explained" />
	                    <parameter name="must_empty" value="false"/>
	                    <parameter name="empty_message" value="Обязательная характеристика 'Получатель обращения' не заполнена."/>
	                </validator>
					<validator class="TestEmptyAttrProcessor" runOrder="5">
						<parameter name="test_attr" value="link:jbr.result.questions"/>
						<!--parameter name="condition" value="list:jbr.acc_decision=acq_result.decision.explained" /-->
						<parameter name="must_empty" value="false"/>
						<parameter name="empty_message" value="Обязательная характеристика 'Вопросы' не заполнена."/>
					</validator>
	            </specific>
				<pre-process class="GenerateName" runOrder="10">
					<parameter name="dstAttrId" value="NAME" />
					<parameter name="format" value="{0}, {1} {2}, {3} {4}" />
					<parameter name="srcAttrIds"
						value="list: jbr.acc_decision;
								list: jbr.decision.result;
								list: jbr.redirect;
								link: jbr.question.result;
								link: jbr.treatment.recipient
							   " />
				</pre-process>
			</specific>
			<specific property="template" value="jbr.theme">
				<post-process class="CopyAttributeToChildren" runOrder="16">
					<parameter name="from" value="name" />
					<parameter name="to" value="jbr.theme.id" />
					<parameter name="writeOperation" value="overwrite" />
					<parameter name="updateAccessList" value="false" />
					<parameter name="attr_condition_1" value="string:jbr.theme.id=NULL"/>
				</post-process>
			</specific>
			<specific property="template" value="jbr.thematic">
				<post-process class="CopyAttributeToChildren" runOrder="16">
					<parameter name="from" value="name" />
					<parameter name="to" value="jbr.thematic.id" />
					<parameter name="writeOperation" value="overwrite" />
					<parameter name="updateAccessList" value="false" />
					<parameter name="attr_condition_1" value="string:jbr.thematic.id=NULL"/>
				</post-process>
			</specific>
			<specific property="template" value="jbr.infomaterials" async="false">
                <validator class="TestEmptyAttrProcessor" runOrder="1">
                    <parameter name="test_attr" value="text: DESCR"/>
                    <parameter name="must_empty" value="false"/>
                    <parameter name="empty_message" value="Атрибут Описание должен быть заполнен."/>
                </validator>
                <validator class="TestEmptyAttrProcessor" runOrder="3">
                    <parameter name="test_attr" value="link:jbr.files"/>
                    <parameter name="must_empty" value="false"/>
                    <parameter name="hidden_status" value="outofdate"/>
                    <parameter name="empty_message" value="Обязательная характеристика 'Вложения' не заполнена"/>
                </validator>

                <post-process class="DeepGenerateName" runOrder="10">
                    <parameter name="format" value="{0}" />
                    <!-- изменения сразу сохранить в самом процессоре -->
                    <parameter name="forceSave" value="true"/>
                    <!-- сохранить только изменённый атрибут, а не полную карточку  -->
                    <parameter name="forceSaveMode" value="attribute"/>
                    <parameter name="dstAttrId" value="NAME" />
                    <parameter name="srcAttrIds" value="text: DESCR" />
                </post-process>
            </specific>
			
			<specific property="template" value="jbr.blank.type" async="false">
				<validator class="TestEmptyAttrProcessor" runOrder="1">
                    <parameter name="test_attr" value="string: jbr.blank.type.name"/>
                    <parameter name="must_empty" value="false"/>
                    <parameter name="empty_message" value="Обязательная характеристика 'Вид бланка' не заполнена."/>
                </validator>
				<validator class="CheckAttributeUniquenessProcessor" runOrder="3">
					<parameter name="attrIds" value="string:jbr.blank.type.name"/>
					<parameter name="statusIds" value="4"/>
					<parameter name="error_message" value="Значение атрибута Вид бланка должно быть уникальным среди карточек текущего шаблона"/>
				</validator>

                <post-process class="DeepGenerateName" runOrder="10">
                    <parameter name="format" value="{0}" />
                    <!-- изменения сразу сохранить в самом процессоре -->
                    <parameter name="forceSave" value="true"/>
                    <!-- сохранить только изменённый атрибут, а не полную карточку  -->
                    <parameter name="forceSaveMode" value="attribute"/>
                    <parameter name="dstAttrId" value="NAME" />
                    <parameter name="srcAttrIds" value="string: JBR_BLANK_TYPE_NAME" />
                </post-process>
            </specific>
			<specific property="template" value="jbr.user.settings" equals="true">
				<post-process class="DeepGenerateName" runOrder="5">      
					<parameter name="dstAttrId" value="name"/>
					<parameter name="format" value="Настройки персоны внутренней: {0}"/>
					<parameter name="srcAttrIds" value="backLink:jbr.person.card@jbr.person.lastnameNM"/>
					<!-- изменения сразу сохранить в самом процессоре -->
                    <parameter name="forceSave" value="true"/>
                    <!-- сохранить только изменённый атрибут, а не полную карточку  -->
                    <parameter name="forceSaveMode" value="attribute"/>
				</post-process>
			</specific>
			
			<specific property="template" value="jbr.importResult" equals="true">
				<pre-process class="GenerateName" runOrder="10">
					<parameter name="dstAttrId" value="NAME" />
					<parameter name="format" value="{0} {1} {2}" />
					<parameter name="srcAttrIds"
						value="string: jbr.import.dictionary;
								date: jbr.import.date;
								user: author
							   " />
				</pre-process>
			</specific>
		</store>
	</object>

	<!--
		===================================================== 
		CARDSTATE CHANGE
		=====================================================
	-->

	<action type="ChangeState">
	
	<!-- Возврат на доработку карточек соглосования и визирования. Нужно вложения сделать устаревшими так как они относятся к предыдущей итерации -->
		<specific property="workflowMove.id" value="jbr.document.visa.return.for.revision">
			<post-process class="ChangingOfFilesStatusToOutdated" runOrder="-5" />			
		</specific>
		<specific property="workflowMove.id" value="jbr.document.visa.weiting.to.draft">
			<post-process class="ChangingOfFilesStatusToOutdated" runOrder="-5" />			
		</specific>
		<specific property="workflowMove.id" value="jbr.document.visa.processing.assistent.to.draft">
			<post-process class="ChangingOfFilesStatusToOutdated" runOrder="-5" />			
		</specific>
		<specific property="workflowMove.id" value="jbr.document.visa.agreed.to.draft">
			<post-process class="ChangingOfFilesStatusToOutdated" runOrder="-5" />			
		</specific>
		<specific property="workflowMove.id" value="jbr.document.visa.agreed.with.comments.to.draft">
			<post-process class="ChangingOfFilesStatusToOutdated" runOrder="-5" />			
		</specific>
		<specific property="workflowMove.id" value="jbr.sign.return.for.revision">
			<post-process class="ChangingOfFilesStatusToOutdated" runOrder="-5" >
				<parameter name="filelink" value="jbr.sign.attachments" />
			</post-process>
		</specific>
		<specific property="workflowMove.id" value="jbr.sign.return.for.revision.assistant">
			<post-process class="ChangingOfFilesStatusToOutdated" runOrder="-5" >
				<parameter name="filelink" value="jbr.sign.attachments" />
			</post-process>
		</specific>
		<specific property="workflowMove.id" value="jbr.sign.signed.draft">
			<post-process class="ChangingOfFilesStatusToOutdated" runOrder="-5" >
				<parameter name="filelink" value="jbr.sign.attachments" />
			</post-process>
		</specific>
		<!-- Конец -->
	
		<specific property="workflowMove.fromState" value="delo">
			<pre-process class="RefreshDateAttribute" runOrder="1">
				<parameter name="dateAttributeId" value="jbr.doc.ret" />
			</pre-process>
			<post-process class="RefreshCurrentPersonAttribute" runOrder="2">
				<parameter name="personAttributeId" value="jbr.doc.ret.pers" />
			</post-process>
		</specific>	
	
		<pre-process class="RefreshDateAttribute">
			<parameter name="dateAttributeId" value="CHANGED" />
		</pre-process>

		<!-- Сбрасываем признак Скрыть в АРМ у шаблонов Независимое поручение, Рассмотрение, НПА, Внутренний документ, Исходящий и ОРД-->
		<specific property="card.template" value="jbr.rassm" load="true">
			<pre-process class="SetAttributeValueProcessor">
				<parameter name="attributeId" value="list:jbr.arm.hide"/>
				<parameter name="value" value="jbr.commission.control.no" />
			</pre-process>
		</specific>
		<specific property="card.template" value="jbr.npa" load="true">
			<pre-process class="SetAttributeValueProcessor">
				<parameter name="attributeId" value="list:jbr.arm.hide"/>
				<parameter name="value" value="jbr.commission.control.no" />
			</pre-process>
		</specific>
		<specific property="card.template" value="jbr.interndoc" load="true">
			<pre-process class="SetAttributeValueProcessor">
				<parameter name="attributeId" value="list:jbr.arm.hide"/>
				<parameter name="value" value="jbr.commission.control.no" />
			</pre-process>
		</specific>
		<specific property="card.template" value="jbr.outcoming" load="true">
			<pre-process class="SetAttributeValueProcessor">
				<parameter name="attributeId" value="list:jbr.arm.hide"/>
				<parameter name="value" value="jbr.commission.control.no" />
			</pre-process>
		</specific>
		<specific property="card.template" value="jbr.ord" load="true">
			<pre-process class="SetAttributeValueProcessor">
				<parameter name="attributeId" value="list:jbr.arm.hide"/>
				<parameter name="value" value="jbr.commission.control.no" />
			</pre-process>
		</specific>
		<!--
			Для переходов:
			
			Рассмотрение
			90420 (jbr.exam.send.assistant) - "Отправить помощнику"
			52088 (jbr.exam.send) - "Рассмотреть"
			
			Подписание
			41468 (jbr.sign.send) - "Отправить подписанту"
			73994 (jbr.sign.send.assistant) - "Отправить помощнику"
			
			Согласование
			41467 (jbr.visa.send) - "Отослать согласующему"
			825533 (jbr.visa.send.assistent) - "Помощнику на обработку"
			
			Отчет об исполнении
			702238 (jbr.report.int.send) - "Отправить"
			
			Ознакомление
			556660 (jbr.info.send.assistant) - "Отправить на ознакомление"
			825575 (jbr.info.send) - "Отправить по маршруту"
			
			На ознакомлении у руководителя
			15000120 (jbr.ord.preparation.manager) - "Руководителю"
			  
			выставляем дату поступления jbr.visa.income_date = 'JBR_INCOMEDATE'
		-->
		<specific property="workflowMove.id" value="jbr.exam.send.assistant">
			<pre-process class="RefreshDateAttribute">
				<parameter name="dateAttributeId" value="jbr.visa.income_date" />
				<parameter name="updateIfNullOnly" value="false" />
			</pre-process>
		</specific>
		<specific property="workflowMove.id" value="jbr.exam.send">
			<pre-process class="RefreshDateAttribute">
				<parameter name="dateAttributeId" value="jbr.visa.income_date" />
				<parameter name="updateIfNullOnly" value="false" />
			</pre-process>
		</specific>
		<specific property="workflowMove.id" value="jbr.sign.send">
			<pre-process class="RefreshDateAttribute">
				<parameter name="dateAttributeId" value="jbr.visa.income_date" />
				<parameter name="updateIfNullOnly" value="false" />
			</pre-process>
			<!-- Сбрасываем признак Скрыть в АРМ у шаблонов Подпись-->
			<specific property="card.template" value="jbr.sign" load="true">
				<pre-process class="SetAttributeValueProcessor">
					<parameter name="attributeId" value="list:jbr.arm.hide"/>
					<parameter name="value" value="jbr.commission.control.no" />
				</pre-process>
			</specific>
		</specific>
		<specific property="workflowMove.id" value="jbr.sign.send.assistant">
			<pre-process class="RefreshDateAttribute">
				<parameter name="dateAttributeId" value="jbr.visa.income_date" />
				<parameter name="updateIfNullOnly" value="false" />
			</pre-process>
			<!-- Сбрасываем признак Скрыть в АРМ у шаблонов Подпись-->
			<specific property="card.template" value="jbr.sign" load="true">
				<pre-process class="SetAttributeValueProcessor">
					<parameter name="attributeId" value="list:jbr.arm.hide"/>
					<parameter name="value" value="jbr.commission.control.no" />
				</pre-process>
			</specific>
		</specific>
		<specific property="workflowMove.id" value="jbr.visa.send">
			<pre-process class="RefreshDateAttribute">
				<parameter name="dateAttributeId" value="jbr.visa.income_date" />
				<parameter name="updateIfNullOnly" value="false" />
			</pre-process>
			<!-- Сбрасываем признак Скрыть в АРМ у шаблонов Визирование-->
			<specific property="card.template" value="jbr.visa" load="true">
				<pre-process class="SetAttributeValueProcessor">
					<parameter name="attributeId" value="list:jbr.arm.hide"/>
					<parameter name="value" value="jbr.commission.control.no" />
				</pre-process>
			</specific>
		</specific>
		<specific property="workflowMove.id" value="jbr.visa.send.assistent">
			<pre-process class="RefreshDateAttribute">
				<parameter name="dateAttributeId" value="jbr.visa.income_date" />
				<parameter name="updateIfNullOnly" value="false" />
			</pre-process>
			<!-- Сбрасываем признак Скрыть в АРМ у шаблонов Визирование-->
			<specific property="card.template" value="jbr.visa" load="true">
				<pre-process class="SetAttributeValueProcessor">
					<parameter name="attributeId" value="list:jbr.arm.hide"/>
					<parameter name="value" value="jbr.commission.control.no" />
				</pre-process>
			</specific>
		</specific>
		<specific property="workflowMove.id" value="jbr.document.visa.return.for.revision" load="true">
			<pre-process class="SetAttributeValueWithConditionProcessor">
				<parameter name="attributeId" value="jbr.visa.current.resolution"/>
				<parameter name="value" value="Доработать"/>
				<parameter name="attr_condition" value="jbr.visa.current.resolution=null"/>
				<paramter name="saveKind" value="no_save"/>
			</pre-process>			
		</specific>
		<specific property="workflowMove.id" value="jbr.report.int.send">
			<pre-process class="RefreshDateAttribute">
				<parameter name="dateAttributeId" value="jbr.visa.income_date" />
				<parameter name="updateIfNullOnly" value="false" />
			</pre-process>
			<!-- Сбрасываем признак Скрыть в АРМ у шаблонов Ознакомление с поручением-->
			<specific property="card.template" value="jbr.adnotamCommission" load="true">
				<pre-process class="SetAttributeValueProcessor">
					<parameter name="attributeId" value="list:jbr.arm.hide"/>
					<parameter name="value" value="jbr.commission.control.no" />
				</pre-process>
			</specific>
		</specific>
		<specific property="workflowMove.id" value="jbr.info.send.assistant">
			<pre-process class="RefreshDateAttribute">
				<parameter name="dateAttributeId" value="jbr.visa.income_date" />
				<parameter name="updateIfNullOnly" value="false" />
			</pre-process>
			<!-- Сбрасываем признак Скрыть в АРМ у шаблонов Ознакомление с поручением-->
			<specific property="card.template" value="jbr.adnotamCommission" load="true">
				<pre-process class="SetAttributeValueProcessor">
					<parameter name="attributeId" value="list:jbr.arm.hide"/>
					<parameter name="value" value="jbr.commission.control.no" />
				</pre-process>
			</specific>
		</specific>
		<specific property="workflowMove.id" value="jbr.ord.preparation.manager">
			<pre-process class="RefreshDateAttribute">
				<parameter name="dateAttributeId" value="jbr.visa.income_date" />
				<parameter name="updateIfNullOnly" value="false" />
			</pre-process>
			<!-- Сбрасываем признак Скрыть в АРМ у шаблонов Ознакомление с поручением-->
			<specific property="card.template" value="jbr.adnotamCommission" load="true">
				<pre-process class="SetAttributeValueProcessor">
					<parameter name="attributeId" value="list:jbr.arm.hide"/>
					<parameter name="value" value="jbr.commission.control.no" />
				</pre-process>
			</specific>
		</specific>
		
		<!-- Переход из Ознакомления руководителем в Подготовку (переход На доработку)
			 для ОРД и НПА
		 -->
		<specific property="workflowMove.id" value="jbr.ord.manager.preparation">
			<!-- Заполнить атрибут «Дата возврата с ознакомления руководителем» -->
			<pre-process class="RefreshDateAttribute">
				<parameter name="dateAttributeId" value="jbr.date.return.chf_acq" />
				<parameter name="updateIfNullOnly" value="false" />
			</pre-process>
		</specific>

		<!--
			Устанавливаем пользователя (в Фактический согласующий ) и текущую
			дату (в Дата фактического согласования) который изменил статус
			Согласование(107) -> Согласован(201) - 35269 или Обработка
			помощником(73992) -> Согласован(201)- 825574
		-->
		<specific property="workflowMove.id" value="jbr.visa.agree">
			<pre-process class="SetCurrentPersonTo" runOrder="5">
				<parameter name="personAttribute" value="jbr.visa.actual_consent" />
				<parameter name="userSubordinate" value="REAL_USER"/>
			</pre-process>
			<pre-process class="RefreshDateAttribute" runOrder="10">
				<parameter name="dateAttributeId" value="jbr.visa.date_actual_consent" />
			</pre-process>
			<!--
				Устанавливаем дату исполнения в карточке Визирование при переходе
				"Согласен"
			-->
			<post-process class="RefreshDateAttribute" runOrder="15">
				<parameter name="dateAttributeId" value="jbr.visa.executeDate" />
			</post-process>
			<post-process class="ClearCardAttributePostProcessorEx" runOrder="20">
				<parameter name="attrId" value="text:jbr.visa.current.resolution" />
			</post-process>
		</specific>

		<specific property="workflowMove.id" value="jbr.visa.cancel">
			<pre-process class="SetCurrentPersonTo" runOrder="5">
		 	    <parameter name="personAttribute" value="jbr.visa.actual_consent"/>
		 	    <parameter name="userSubordinate" value="REAL_USER"/>
			</pre-process>
			<pre-process class="RefreshDateAttribute" runOrder="10">
					<parameter name="dateAttributeId" value="jbr.visa.date_actual_consent"/>
			</pre-process>
			<post-process class="RefreshDateAttribute" runOrder="15">
				<parameter name="dateAttributeId" value="jbr.visa.executeDate"/>
			</post-process>
		</specific>	

		<specific property="workflowMove.id" value="jbr.visa.agree.from_boss">
			<pre-process class="SetCurrentPersonTo" runOrder="5">
				<parameter name="personAttribute" value="jbr.visa.actual_consent" />
				<parameter name="userSubordinate" value="REAL_USER"/>
			</pre-process>
			<pre-process class="RefreshDateAttribute" runOrder="10">
				<parameter name="dateAttributeId" value="jbr.visa.date_actual_consent" />
			</pre-process>
			<post-process class="RefreshDateAttribute" runOrder="15">
				<parameter name="dateAttributeId" value="jbr.visa.executeDate"/>
			</post-process>
		</specific>

		<specific property="workflowMove.id" value="jbr.visa.agree.from_assist">
			<pre-process class="SetCurrentPersonTo" runOrder="5">
				<parameter name="personAttribute" value="jbr.visa.actual_consent" />
				<parameter name="userSubordinate" value="REAL_USER"/>
			</pre-process>
			<pre-process class="RefreshDateAttribute" runOrder="10">
				<parameter name="dateAttributeId" value="jbr.visa.date_actual_consent" />
			</pre-process>
			<post-process class="RefreshDateAttribute" runOrder="15">
				<parameter name="dateAttributeId" value="jbr.visa.executeDate"/>
			</post-process>
		</specific>
		
		<specific property="workflowMove.id" value="jbr.visa.cancel.from_assist">
			<pre-process class="SetCurrentPersonTo" runOrder="5">
				<parameter name="personAttribute" value="jbr.visa.actual_consent" />
				<parameter name="userSubordinate" value="REAL_USER"/>
			</pre-process>
			<pre-process class="RefreshDateAttribute" runOrder="10">
				<parameter name="dateAttributeId" value="jbr.visa.date_actual_consent" />
			</pre-process>
			<post-process class="RefreshDateAttribute" runOrder="15">
				<parameter name="dateAttributeId" value="jbr.visa.executeDate"/>
			</post-process>
		</specific>
		
		<specific property="workflowMove.id" value="jbr.visa.end.agreed">
			<pre-process class="SetCurrentPersonTo" runOrder="5">
				<parameter name="personAttribute" value="jbr.visa.actual_consent" />
				<parameter name="userSubordinate" value="REAL_USER"/>
			</pre-process>
			<pre-process class="RefreshDateAttribute" runOrder="10">
				<parameter name="dateAttributeId" value="jbr.visa.date_actual_consent" />
			</pre-process>
			<post-process class="RefreshDateAttribute" runOrder="15">
				<parameter name="dateAttributeId" value="jbr.visa.executeDate"/>
			</post-process>
		</specific>
		
		<specific property="workflowMove.toState" value="jbr.visa.waiting">
			<specific property="card.template" value="jbr.visa"
				load="true">
				<post-process class="CopyPersonsCheckParentTemplate" runOrder="5">
					<parameter name="parentLink" value="jbr.visa.parent"/>
					<parameter name="srcAttr" value="jbr.visa.person"/>
					<parameter name="associationsList" 
						value=
							"jbr.outcoming -> jbr.visa.person.outbound;
							jbr.interndoc -> jbr.visa.person.internal"
						/>
				</post-process>
	<!-- В рамках BR4J00034080 - копирование согласующего в атрибут 'Основной согласующий (скрытый)' -->			
				<post-process class="CopyPersonFromPathsWithCondition" runOrder="10">
					<parameter name="condition" value="backLink:jbr.visa.parentVisa=NULL"/>
					<parameter name="paths" value="user:jbr.visa.person"/>
					<parameter name="targetAttr" value="jbr.visa.person.main"/>
					<parameter name="reloadCard" value="true"/>
				</post-process>
			</specific>
		</specific>

		<!--
			Устанавливаем пользователя который изменил статус на Подписано
			Руководителем или Подписано (из Отклонено руководителем или Подписано
			(из Обработка помошником) в качестве Фактического подписанта в
			карточки Подпись
		-->
		<specific property="workflowMove.id" value="jbr.sign.sign.boss">
			<pre-process class="SetCurrentPersonTo" runOrder="5">
				<parameter name="personAttribute" value="jbr.sign.actual_signer" />
				<parameter name="userSubordinate" value="REAL_USER"/>
			</pre-process>
			<pre-process class="RefreshDateAttribute" runOrder="10">
				<parameter name="dateAttributeId" value="jbr.sign.actual_date_sign" />
			</pre-process>
		</specific>	
		<specific property="workflowMove.id" value="jbr.sign.sign.signed">
			<pre-process class="SetCurrentPersonTo" runOrder="5">
				<parameter name="personAttribute" value="jbr.sign.actual_signer" />
				<parameter name="userSubordinate" value="REAL_USER"/>
			</pre-process>
			<pre-process class="RefreshDateAttribute" runOrder="10">
				<parameter name="dateAttributeId" value="jbr.sign.actual_date_sign" />
			</pre-process>
		</specific>
		<specific property="workflowMove.id" value="jbr.sign.sign.assistant">
			<pre-process class="SetCurrentPersonTo" runOrder="5">
				<parameter name="personAttribute" value="jbr.sign.actual_signer" />
				<parameter name="userSubordinate" value="REAL_USER"/>
			</pre-process>
			<pre-process class="RefreshDateAttribute" runOrder="10">
				<parameter name="dateAttributeId" value="jbr.sign.actual_date_sign" />
			</pre-process>
		</specific>
		
		<!-- BR4J00034856 -->
		<specific property="workflowMove.id" value="jbr.sign.sign">
			<pre-process class="SetCurrentPersonTo" runOrder="5">
				<parameter name="personAttribute" value="jbr.sign.actual_signer" />
				<parameter name="userSubordinate" value="REAL_USER"/>
			</pre-process>
			<pre-process class="RefreshDateAttribute" runOrder="10">
				<parameter name="dateAttributeId" value="jbr.sign.actual_date_sign" />
			</pre-process>
		</specific>

		<!--
			Устанавливаем дату ознакомления в карточке Ознакомления при переходе
			в статус Ознакомился
		-->
		<specific property="workflowMove.id" value="jbr.acquaint">
			<specific property="card.template" value="jbr.inform" load="true">
				<post-process class="RefreshDateAttribute">
					<parameter name="dateAttributeId" value="jbr.acquaintance" />
				</post-process>
			</specific>
			<specific property="card.template" value="jbr.adnotamCommission"
				load="true">
				<post-process class="RefreshDateAttribute">
					<parameter name="dateAttributeId" value="jbr.adnotamCommission.date" />
				</post-process>
			</specific>
			<specific property="card.template" value="jbr.delegate_notice" load="true">
				<post-process class="RefreshDateAttribute">
					<parameter name="dateAttributeId" value="jbr.acquaintance" />
				</post-process>
			</specific>
		</specific>

		<!-- Регистрация "Входящего" / "ОГ" -->
		<!-- все 3 проверяемых поля могут быть пустыми, проверка будет выполняться только при заполнении всех 3-х полей (хардкод в action DoCheckCardNumber) -->
		<specific property="workflowMove.id" value="jbr.incoming.draft.registration">
			<specific property="card.template" value="jbr.incoming" load="true">
				<validator class="CheckCardNumber" runOrder="200">
					<parameter name="attr_test" value="jbr.income.repeatChkEnable=jbr.commission.control.yes"/>
					<parameter name="numberCanBeNullOrEmpty" value="false" />
					<parameter name="dateCanBeNull" value="true" />
					<parameter name="organizationCanBeNull" value="true" />
				</validator>
			</specific>
			<!-- Проверяем заполнение столбцов "Информация о заявителе. Фамилия", "Информация о заявителе. Имя" при регистрации ОГ у автора обращения -->
			<specific property="card.template" value="jbr.citizenrequest" load="true">
				<!-- Проверяем тип сообщения и если = без подписи, выставляем Автор обращения = Аноним -->
				<validator class="SetAttributeValueWithConditionProcessor" runOrder="1">
					<parameter name="attr_condition_1" value="link:jbr.AuthType=15921"/>
					<parameter name="attributeId" value="link:jbr.ReqAuthor"/>
					<parameter name="value" value="10" />
					<parameter name="saveKind" value="SAVE_ATTR"/>
				</validator>
				<validator class="TestEmptyAttrProcessor"  runOrder="3">
					<parameter name="test_attr" value="string:jbr.og.firstname"/>
					<parameter name="linked_attr" value="link:jbr.ReqAuthor"/>
					<parameter name="linked_attr_test" value=".template=jbr.medo_og.requestAuthor"/>
					<parameter name="condition" value="link:jbr.ReqAuthor=NULL" />
					<parameter name="must_empty" value="false"/>
					<parameter name="empty_message" value="Обязательная характеристика 'Информация о заявителе. Имя' не заполнена."/>
				</validator>
				<validator class="TestEmptyAttrProcessor"  runOrder="5">
					<parameter name="test_attr" value="string:jbr.og.lastname"/>
					<parameter name="linked_attr" value="link:jbr.ReqAuthor"/>
					<parameter name="linked_attr_test" value=".template=jbr.medo_og.requestAuthor"/>
					<parameter name="condition" value="link:jbr.ReqAuthor=NULL" />
					<parameter name="must_empty" value="false"/>
					<parameter name="empty_message" value="Обязательная характеристика 'Информация о заявителе. Фамилия' не заполнена."/>
				</validator>
			</specific>
			<post-process class="RefreshDateAttribute" runOrder="6">
				<parameter name="dateAttributeId" value="jbr.visa.income_date" />
				<parameter name="updateIfNullOnly" value="false" />
			</post-process>
		</specific>

		<!--107(Согласование)-108(Подписание)-->
		<!--
			
			boruroev: проверка и переход перенесены в DocumentOnStartSignTrigger
			
			FillSignCommentAndMoveSingnToSignedState нужно в будущем перенести туда же
			
		 -->
		<!--specific property="workflowMove.id" value="jbr.interndoc.agreement.sign">
			<specific property="card.template" value="jbr.interndoc"
				load="true">
				<post-process class="JumpStatePostProcessor">
					<parameter name="dest_wfm" value="jbr.interndoc.sign.before-registration" />
					<parameter name="attr_test"	value="jbr.outcoming.signatory=author" />
				</post-process>
			</specific>
		</specific-->
		<!--108(Подписание)-200(Регистрация)-->
		<specific property="workflowMove.id" value="jbr.interndoc.sign.before-registration">
			<specific property="card.template" value="jbr.interndoc"
				load="true">
				<post-process package="com.aplana.dbmi.module.docflow" class="FillSignCommentAndMoveSingnToSignedState">
				</post-process>
			</specific>
		</specific>
		<!--204(Подписан)-200(На регистрацию)
		<specific property="workflowMove.id" value="jbr.interndoc.signed.registration">
			<specific property="card.template" value="jbr.interndoc"
				load="true">
				<pre-process class="DoDependentChangeState">
					<parameter name="linkAttr" value="jbr.sign" />
					<parameter name="affectedStates" value="jbr.sign.assigned" />
					<parameter name="targetState" value="jbr.sign.signed" />
					<parameter name="ifEmpty" value="nothing" />
					<parameter name="parentAttr" value="jbr.sign.parent" />
					<parameter name="stateCondition" value="jbr.sign.signed" />
				</pre-process>
			</specific>
		</specific>-->

<!--
		
			Авто-перевод "Входящего" в "готов к списанию в дело" во время
			перехода в "Исполнен" (cardstate.done=206), если документ не на
			контроле.
		-->
		<specific property="workflowMove.id" value="jbr.incoming.execution.done">
			<specific property="card.template" value="jbr.incoming"
				load="true">
				<post-process class="JumpStatePostProcessor">
					<parameter name="dest_wfm" value="jbr.incoming.execution.ready_for_delo" />

					<!--
						all theese variants works normally and are equevalent to each
						other: parameter name="attr_test"
						value="jbr.incoming.oncontrol=jbr.incoming.control.no" //
						comment="1433" parameter name="attr_test"
						value="jbr.incoming.oncontrol#jbr.incoming.control.yes" //
						comment="1432" parameter name="attr_test"
						value="list:JBR_IMPL_ONCONT#1432" // comment="1432 == yes"
					-->
					<parameter name="attr_test"
						value="jbr.incoming.oncontrol#jbr.incoming.control.yes" />
				</post-process>
			</specific>
			<specific property="card.template" value="jbr.citizenrequest"
				load="true">
				<post-process class="JumpStatePostProcessor">
					<parameter name="dest_wfm" value="jbr.incoming.execution.ready_for_delo" />

					<!--
						all theese variants works normally and are equevalent to each
						other: parameter name="attr_test"
						value="jbr.incoming.oncontrol=jbr.incoming.control.no" //
						comment="1433" parameter name="attr_test"
						value="jbr.incoming.oncontrol#jbr.incoming.control.yes" //
						comment="1432" parameter name="attr_test"
						value="list:JBR_IMPL_ONCONT#1432" // comment="1432 == yes"
					-->
					<parameter name="attr_test"
						value="jbr.incoming.oncontrol#jbr.incoming.control.yes" />
					<parameter name="children_attr_test" value=".state#consideration" />
					<parameter name="link_attr_toChildren" value="jbr.exam.set" />	
				</post-process>
			</specific>
		</specific>

		<specific property="workflowMove.toState" value="done">
			<specific property="card.template" value="jbr.incoming">
				<post-process package="com.aplana.dbmi.jbr.processors" class="DoDependentChangeState">
					<parameter name="linkAttr" value="backLink:jbr.incoming.incomeNotification" />
					<parameter name="affectedStates" value="jbr.state_service.notificationCreated" />
					<parameter name="targetState" value="jbr.state_service.notificationAccepted" />
				</post-process>
			</specific>
			<!--
				Установить "Дата снятия документа с контроля" при переводе в
				"Исполнен"(206) текущей <post-process class="RefreshDateAttribute">
				<parameter name="dateAttributeId"
				value="jbr.boss.control.pulloff.date"/> </post-process>
			-->
			<!--
				Авто-перевод "ОРД" в "готов к списанию в дело" во время перехода в
				"Исполнен" (cardstate.done=206), если документ не на контроле.
			-->
			<specific property="card.template" value="jbr.ord" load="true">
				<post-process class="JumpStatePostProcessor">
					<parameter name="dest_wfm" value="jbr.ord.done.ready-to-write-off" />
					<parameter name="attr_test"
						value="jbr.incoming.oncontrol#jbr.incoming.control.yes" />
					<parameter name="attr_test" value="jbr.incoming.inspector=NULL" />
				</post-process>
			</specific>
			<!--
				Авто-перевод "НПА" в "готов к списанию в дело" во время перехода в
				"Исполнен" (cardstate.done=206), если документ не на контроле.
			-->
			<specific property="card.template" value="jbr.npa" load="true">
				<post-process class="JumpStatePostProcessor">
					<parameter name="dest_wfm" value="jbr.ord.done.ready-to-write-off" />
					<parameter name="attr_test"
						value="jbr.incoming.oncontrol#jbr.incoming.control.yes" />
					<parameter name="attr_test" value="jbr.incoming.inspector=NULL" />
				</post-process>
			</specific>
		</specific>
		
		<specific property="workflowMove.toState" value="registration">
			<specific property="card.template" value="jbr.npa" load="true">
				<specific property="workflowMove.fromState" value="done" equals="false">
					<!-- При регистрации  если начальный статус не В Дело и Регистратор еще не заполнен, то заполнить его текущим пользователем -->
					<pre-process class="SetCurrentPersonTo" runOrder="10">
						<parameter name="personAttribute" value="jbr.incoming.registrar" />
						<parameter name="userSubordinate" value="REAL_USER"/>
						<parameter name="addOnlyIfDestIsEmpty" value="true"/>
					</pre-process>
					<!-- Генерируем имя во время регистрации используя дату регистрации и другие параметры -->
					<pre-process class="GenerateName" runOrder="20">
						<!-- <parameter name="format" value="{0} {1}, {3}" /> -->
						<parameter name="forceSave" value="true" />
						<parameter name="format" value="{0} {1} от {2}, {3}"/> 
						<parameter name="dstAttrId" value="string: NAME" />
						<parameter name="srcAttrIds"
								   value="link: JBR_INFD_TYPEDOC;
									      string: regnumber; 
										  date: regdate; 
								   		  text: JBR_INFD_SHORTDESC" />
					</pre-process>
				</specific>
				<!-- 
					Автопереход НПА из статуса "Зарегистрирован" 
					в статус "Готов к списанию в дело"
				-->
				<!-- BR4J00012133 - автопереход убран -->
				<!-- post-process class="JumpStatePostProcessor">
					<parameter name="dest_wfm" value="jbr.ord.registration.ready-to-write-off" />
				</post-process -->
			</specific>
		</specific>
		
		<!-- Состояние Визирование: переход "На согласование" (35267) -->
		<specific property="workflowMove.id" value="jbr.visa.assign">
			<validator class="DenyActionForOrphan" runOrder="5">
				<parameter name="linkAttr" value="jbr.visa.parent" />
			</validator>
			<!--
				Запрет перевода, если документ-основание находится не в статусе
				"Согласование" (107)
			-->
			<validator class="DenyActionByLinkedCardStates" runOrder="10">
				<parameter name="linkAttr" value="jbr.visa.parent" />
				<parameter name="allowedStates" value="agreement" />
				<parameter name="messageKey" value="jbr.visa.assign.parent" />
			</validator>
			
			<!-- Очистка поля текущее решение  -->
			<post-process class="ClearCardAttributePostProcessorEx" runOrder="15">
				<parameter name="attrId" value="text:jbr.visa.current.resolution" />
			</post-process>
			
			<post-process class="AttributeIncrementProcessor" runOrder="29">
					<parameter name="AttrId" value="jbr.visa.mark.process" />
			</post-process>
			<post-process class="ForceSaveCardProcessor" runOrder="30">
			</post-process>
		</specific>

		<!-- Состояние Подписание: переход "На подписание" (35247) -->
		<specific property="workflowMove.id" value="jbr.sign.assign">
			<validator class="DenyActionForOrphan" runOrder="5">
				<parameter name="linkAttr" value="jbr.sign.parent" />
			</validator>
			<!--
				Запрет перевода, если документ-основание находится не в статусе
				"Подписание" (108)
			-->
			<validator class="DenyActionByLinkedCardStates" runOrder="10">
				<parameter name="linkAttr" value="jbr.sign.parent" />
				<parameter name="allowedStates" value="sign" />
				<parameter name="messageKey" value="jbr.sign.assign.parent" />
			</validator>

				
			<post-process class="ForceSaveCardProcessor" runOrder="20">
			</post-process>
		</specific>
		
		<!-- Для карточки Расмотрение(504): во время перехода "Передать другому руководителю"(677294)  
		 заменяем список помощников новым-->
		<specific property="workflowMove.id" value="jbr.exam.goto-another.boss">
			<post-process class="CallOriginsProcessor" runOrder="25">
	    		<parameter name="backLinkAttrId" value="jbr.exam.parent@jbr.examby"/>
	    		<parameter name="processorClassName" value="com.aplana.dbmi.jbr.processors.ForceSaveCardProcessor"/>
			</post-process>
			<post-process class="DoDependentLinkCardChangeState" runOrder="30">
				<parameter name="linkAttr" value="backLink:jbr.resolutions"/>
				<parameter name="affectedStates" value="jbr.commission.draft"/>
				<parameter name="targetState" value="trash"/>	
				<parameter name="ifEmpty" value="nothing" />
				<parameter name="parentAttr" value="jbr.exam.parent" />
			</post-process>
		</specific>

		<!-- Состояние Рассмотрение: переход "На рассмотрение" (52087) -->
		<specific property="workflowMove.id" value="jbr.exam.assign">


			<validator class="DenyActionForOrphan" runOrder="5">
				<parameter name="linkAttr" value="jbr.exam.parent" />
			</validator>
			<!--
				Запрет перевода, если документ-основание находится не в статусе
				"Рассмотрение" (102)
			-->
			<validator class="DenyActionByLinkedCardStates" runOrder="10">
				<parameter name="linkAttr" value="jbr.exam.parent" />
				<parameter name="allowedStates" value="consideration,execution" />
				<parameter name="messageKey" value="jbr.exam.assign.parent" />
			</validator>

			<!-- Обновляет поле NAME рассмотрения -->
			<post-process class="DeepGenerateName" runOrder="13">
				<parameter name="format" value="Рассмотреть документ %MAINDOC.TEMPLATE.NAME% № {0} от {1} {2}" />
				<parameter name="srcAttrIds"
					value="
					backLink: JBR_RASSM_PARENT_DOC@regnumber; 
					backLink: JBR_RASSM_PARENT_DOC@regdate;
					backLink: JBR_RASSM_PARENT_DOC@jbr.shortcontext" />
				<parameter name="dstAttrId" value="NAME" />
				<parameter name="forceSave" value="true" />
				<!-- (YNikitin, 2013/07/18) При формировании названий дочерних карточек, сохранять сами карточки не надо, достаточно обновить атрибут, 
				это позволяет ускорить процесс сохранения документа основания, а значит и создание нового поручения -->
				<parameter name="forceSaveMode" value="ATTRIBUTE" />
			</post-process>

			<post-process class="ForceSaveCardProcessor" runOrder="15">
			</post-process>
		</specific>

		<!--
			/Ознакомление (template:524): переход "Помощнику на обработку"
			(825529) workflowmove.jbr.info.execute.assistant=825529/
			Ознакомление: переход "В АРМ руководителю"(825528): из "Обработка
			помощником"(73992) в "Ознакомление"(67424)
			workflowmove.jbr.info.boss.arm=825528
		-->
		<specific property="workflowMove.id" value="jbr.info.boss.arm">
			<specific property="card.template" value="jbr.inform" load="true">
				<validator class="DenyActionForOrphan">
					<parameter name="linkAttr" value="jbr.info.parent" />
				</validator>
			</specific>
			<specific property="card.template" value="jbr.adnotamCommission"
				load="true">
				<validator class="DenyActionForOrphan">
					<parameter name="linkAttr" value="jbr.adnotamCommission.parent" />
				</validator>
			</specific>
			<!--
				Запрет перевода, если документ-основание находится в статусе
				"Черновик" (1) "Подготовка" (106) "Согласование/Визирование" (107)
				"Подписание" (108) "Готов к регистрации" (200) "Заполнение индекса
				дела" (355554) "Проверка помощником министра" (355555)
			-->
			<validator class="DenyActionByLinkedCardStates">
				<parameter name="linkAttr" value="jbr.info.parent" />
				<parameter name="deniedStates"
					value="draft,preparation,agreement,sign,before-registration,filling-in-file-index,assistent-checking" />
				<parameter name="messageKey" value="jbr.info.assign.parent" />
			</validator>

			<!--
				ForceSaveCardProcessor постпроцессор не требуется, т.к. сохранение
				выполняется корректно и без него.
			-->
		</specific>

		<!--Проверяем заполненность хотя бы одного из атрибутов: 
				Адресат ОГ (jbr.outcoming.citizenAppealAddressee) и Получатель исходящего (jbr.outcoming.receiver)
			Переход исходящего из Регистрация в Зарегистрирован (395895) 
		-->
		<specific property="workflowMove.id" value="jbr.outcoming.before-registration.registration">
			<validator class="CheckAttribute" runOrder="5">
				<parameter name="attr_test" value="jbr.outcoming.citizenAppealAddressee#NULL;jbr.outcoming.receiver#NULL"/>
				<parameter name="nls_err_msgid_arg3" value="jbr.card.check.attribute.performer.1"/>
				<!--parameter name="checkIfUserHasRole" value="jbr.minister;jbr.minister.helper;jbr.deputyMinister;jbr.deputyMinister.helper"/-->
			</validator>
			<post-process class="AddRegStamp" runOrder="4">
			</post-process>
			<post-process class="ForceSaveCardProcessor" runOrder="10">
			</post-process>
		</specific>
		
		<!--Проверяем заполненность хотя бы одного из атрибутов: 
				Адресат ОГ (jbr.outcoming.citizenAppealAddressee) и Получатель исходящего (jbr.outcoming.receiver)
			Переход исходящего из Подготовка в Регистрация (473554) 
		-->
		<specific property="workflowMove.id" value="jbr.outcoming.preparation.register">
			<validator class="CheckAttribute" runOrder="5">
				<parameter name="attr_test" value="jbr.outcoming.citizenAppealAddressee#NULL;jbr.outcoming.receiver#NULL"/>
				<parameter name="nls_err_msgid_arg3" value="jbr.card.check.attribute.performer.1"/>
				<!--parameter name="checkIfUserHasRole" value="jbr.minister;jbr.minister.helper;jbr.deputyMinister;jbr.deputyMinister.helper"/-->
			</validator>
			<post-process class="ForceSaveCardProcessor" runOrder="10">
			</post-process>
		</specific>
		
		<!--
			Ознакомление (template:524): переход "Отправить на ознакомление"
			(556660)
		-->
		<specific property="workflowMove.id" value="jbr.info.send">
			<specific property="card.template" value="jbr.inform" load="true">
                <validator class="ChkDateProcessor">
                    <parameter name="checkdate1" value="jbr.information.term;-0" />
                    <parameter name="dateFormat" value="dd.MM.yyyy" />
                    <parameter name="dateNullIsOk" value="true"/>
                </validator>
				<validator class="DenyActionForOrphan">
					<parameter name="linkAttr" value="jbr.info.parent" />
				</validator>
			</specific>
			<specific property="card.template" value="jbr.adnotamCommission"
				load="true">
				<validator class="DenyActionForOrphan">
					<parameter name="linkAttr" value="jbr.adnotamCommission.parent" />
				</validator>
			</specific>
			<!--
				Запрет перевода, если документ-основание находится в статусе
				"Черновик" (1) "Подготовка" (106) "Согласование/Визирование" (107)
				"Подписание" (108) "Готов к регистрации" (200) "Заполнение индекса
				дела" (355554) "Проверка помощником министра" (355555)
			-->
			<validator class="DenyActionByLinkedCardStates">
				<parameter name="linkAttr" value="jbr.info.parent" />
				<parameter name="deniedStates"
					value="draft,preparation,agreement,sign,before-registration,filling-in-file-index,assistent-checking" />
				<parameter name="messageKey" value="jbr.info.assign.parent" />
			</validator>

			<!--
				ForceSaveCardProcessor постпроцессор не требуется, т.к. сохранение
				выполняется корректно и без него.
			-->
			
			<specific property="card.template" value="jbr.inform_incoming" load="true">
			    <!-- post-process class="CopyAttributeFromParent">
					<parameter name="parent" value="jbr.info.parent"/> 
					<parameter name="from" value="jbr.doc.comment"/>
					<parameter name="to" value="jbr.inf.comment"/>
					<parameter name="attr_condition" value="text:jbr.inf.comment=NULL" />
				</post-process -->
			</specific>
		</specific>
		
		<!-- Отправка ознакомления (524,1144) из 'Ожидание рассмотрения'(52086) в 'Обработка помощником'(73992) -->
		<specific property="workflowMove.id" value="jbr.info.execute.assistant">
			<post-process class="RefreshDateAttribute">
				<parameter name="dateAttributeId" value="jbr.visa.income_date" />
				<parameter name="updateIfNullOnly" value="false" />
			</post-process>
		</specific>

		<!-- Состояние Ознакомление: переход "Ознакомился" (67427) -->
		<specific property="workflowMove.id" value="jbr.asure.assign">
			<post-process class="ForceSaveCardProcessor">
			</post-process>
		</specific>

		<!--
			При переводе Рассмотрения из состояния "Рассмотрение" в состояние
			"Отправлен на исполнение руководителем":
		-->
		<specific property="workflowMove.id" value="jbr.exam.send_execute" policy="IterationPolicy">
			<validator class="CheckResolutionExists" runOrder="5">
				<parameter name="empty_message" value="Для того чтобы документ был отправлен на исполнение, необходимо наличие хотя бы одного поручения в статусе Черновик, Исполнение или Исполнен, подписантом которого должен являться текущий рассматривающий."/>
			</validator>
			<post-process class="ExamSendExecuteProcessor" runOrder="10">
			</post-process>
			<post-process class="CallOriginsProcessor" runOrder="15">
			    <parameter name="backLinkAttrId" value="jbr.exam.parent@jbr.resolutions"/>
			    <parameter name="processorClassName"
			            value="com.aplana.dbmi.jbr.processors.JumpStatePostProcessor"/>
			    <parameter name="dest_wfm" value="jbr.commission.execute1"/>
			    <parameter name="failIfStatusIsOther" value="false"/>
			    <parameter name="currentUser" value="true"/>
			   <!-- дополнительные параметры проверки на равенство атриубтов текущей и связанных карточек-->
			    <parameter name="eqAttrInLinkCard" value="user:jbr.resolution.FioSign"/>
			    <parameter name="eqAttrInCurCard" value="user:jbr.exam.person"/>
			    <parameter name="async" value="false"/>
			</post-process>
			<post-process class="RefreshDateAttribute" runOrder="20">
				<parameter name="dateAttributeId" value="jbr.visa.income_date" />
				<parameter name="updateIfNullOnly" value="false" />
			</post-process>
		</specific>

		<!-- Переход 409000: "Черновик" (1) -> "Согласование" (107) для РК "Поручение" (324) -->
		<specific property="workflowMove.id" value="jbr.task.preparation.agreement">
			<validator class="TestEmptyAttrProcessor" runOrder="1">
				<parameter name="test_attr" value="user:jbr.resolution.FioSign"/>
				<parameter name="empty_message" value="Атрибут &apos;Должность фамилия и инициалы лица подписавшего резолюцию&apos; должен быть заполнен."/>
			</validator>
		</specific>

		<!-- 
			Переход 1160791: "Черновик" (1) -> "Исполнение" (103) для РК "Поручение" (324)
		-->
		<specific property="workflowMove.id" value="jbr.commission.execute1" async="true" policy="IterationPolicy">
			<validator class="TestEmptyAttrProcessor" runOrder="1">
				<parameter name="test_attr" value="user:jbr.resolution.FioSign"/>
				<parameter name="empty_message" value="Атрибут &apos;Должность фамилия и инициалы лица подписавшего резолюцию&apos; должен быть заполнен."/>
			</validator>		
			<validator class="DenyActionForOrphan" runOrder="5">
				<parameter name="linkAttr" value="link:jbr.main.doc" />
			</validator>
			<validator class="DenyActionByLinkedCardStates" runOrder="6">
				<parameter name="linkAttr" value="jbr.main.doc"/>
				<parameter name="deniedStates" value="draft, preparation, sign, agreement, before-registration"/>				
				<parameter name="messageKey" value="jbr.execution.assign.parent"/>				
			</validator>
			
			<!-- Проверяем у ДО (ВХ, ВН, ОГ) в статусе Рассмотрение обязательность атрибута 
					Вложения, учитывая настройки в БД.
				Если атрибут указан как обязательный, то проверяем его заполненность.
				Если указан, что должен быть пустой, то проверяем его на пустоту.
				Если указан как необязательный или совсем не указан в таблице, 
				  то не проверяем его обязательность.
			-->
			<validator class="CallOriginsProcessor" runOrder="10">
				<parameter name="backLinkAttrId" value="link:jbr.main.doc" />
				<parameter name="processorClassName" value="com.aplana.dbmi.jbr.processors.TestEmptyAttrProcessor" />
				<parameter name="test_attr" value="link:jbr.files"/>
				<parameter name="checkWfmRequiredFields" value="true"/>
				<parameter name="wfm" value="jbr.incoming.consideration.execution"/>
				<parameter name="empty_message" value="Обязательная характеристика 'Вложения в документе-основании' не заполнена"/>
				<parameter name="condition" value="list:jbr.dsp=jbr.noDsp"/>
				<parameter name="local@attr_test1" value=".template=jbr.incoming"/>
				<parameter name="local@attr_test2" value=".state=consideration"/>
			</validator>
			<validator class="CallOriginsProcessor" runOrder="15">
				<parameter name="backLinkAttrId" value="link:jbr.main.doc" />
				<parameter name="processorClassName" value="com.aplana.dbmi.jbr.processors.TestEmptyAttrProcessor" />
				<parameter name="test_attr" value="link:jbr.files"/>
				<parameter name="checkWfmRequiredFields" value="true"/>
				<parameter name="wfm" value="jbr.incoming.consideration.execution"/>
				<parameter name="empty_message" value="Обязательная характеристика Вложения в документе-основании не заполнена"/>
				<parameter name="condition" value="list:jbr.dsp=jbr.noDsp"/>
				<parameter name="local@attr_test1" value=".template=jbr.incomingpeople"/>
				<parameter name="local@attr_test2" value=".state=consideration"/>
			</validator>
			<validator class="CallOriginsProcessor" runOrder="20">
				<parameter name="backLinkAttrId" value="link:jbr.main.doc" />
				<parameter name="processorClassName" value="com.aplana.dbmi.jbr.processors.TestEmptyAttrProcessor" />
				<parameter name="test_attr" value="link:jbr.files"/>
				<parameter name="checkWfmRequiredFields" value="true"/>
				<parameter name="wfm" value="jbr.interndoc.consideration.execution"/>
				<parameter name="empty_message" value="Обязательная характеристика Вложения в документе-основании не заполнена"/>
				<parameter name="condition" value="list:jbr.dsp=jbr.noDsp"/>
				<parameter name="local@attr_test1" value=".template=jbr.interndoc"/>
				<parameter name="local@attr_test2" value=".state=consideration"/>
			</validator>
			
			<!--
				Запрет перевода, если документ-основание находится не в статусе
				"Исполнение"
			-->
			<!--pre-process class="DenyActionByLinkedCardStates">
				<parameter name="linkAttr" value="jbr.main.doc" />
				<parameter name="allowedStates" value="execution" />
				<parameter name="messageKey" value="jbr.commission.execute.parent" />
			</pre-process-->
			<!--
				Если в качесве подписанта поручения стоит помощник, то заменяем его
				на руководителя
			-->
			<pre-process class="GenerateUIDProcessor" runOrder="4">
				<parameter name="attrId" value="text:uid"/>
				<parameter name="setIfEmptyOnly" value ="true"/>
			</pre-process>
			<pre-process class="ReplaceAssistentToHead" runOrder="100">
				<parameter name="attr" value="user:jbr.resolution.FioSign" />
			</pre-process>
			
			<!-- Если есть родительского поручения -->
			<pre-process class="PopulateChildrenWithConditions" runOrder="200">
				<parameter name="template" value="jbr.report.internal" />
				<parameter name="attach" value="jbr.reports" />
				<parameter name="split"
					value="user:jbr.AssignmentExecutor->jbr.report.int.executor" />
				<parameter name="attr_link_path" value="link:jbr.rimp.byrimp@user:jbr.commission.inspector;"/>
				<parameter name="attr_link_values" value="#NULL"/>
				<parameter name="copy"
					value="
							user:jbr.resolution.FioSign->user:jbr.report.int.author;
							link:jbr.main.doc->link:jbr.report.int.document;
							user:jbr.commission.inspector->jbr.report.role.supervise;
							user:jbr.resolution.FioSign->jbr.report.int.dynamic_role.approver.hidden;
							user:jbr.commission.inspector->jbr.report.int.dynamic_role.approver.hidden;							
							list:jbr.category.howfast->jbr.category.howfast;
							date:jbr.resolutionTerm->jbr.resolutionTerm
						" />
			</pre-process>
			<!-- Если нет родительского поручения -->
			<pre-process class="PopulateChildrenWithConditions" runOrder="300">
				<parameter name="template" value="jbr.report.internal" />
				<parameter name="attach" value="jbr.reports" />
				<parameter name="split"
					value="user:jbr.AssignmentExecutor->jbr.report.int.executor" />
				<parameter name="attr_link_path" value="link:jbr.rimp.byrimp@user:jbr.commission.inspector;"/>
				<parameter name="attr_link_values" value="=NULL"/>
				<parameter name="copy"
					value="
							user:jbr.resolution.FioSign->user:jbr.report.int.author;
							link:jbr.main.doc->link:jbr.report.int.document;
							user:jbr.commission.inspector->jbr.report.role.supervise;
							user:jbr.resolution.FioSign->jbr.report.int.dynamic_role.approver.hidden;
							user:jbr.commission.inspector->jbr.report.int.dynamic_role.approver.hidden;
							list:jbr.category.howfast->jbr.category.howfast;
							date:jbr.resolutionTerm->jbr.resolutionTerm
						" />
			</pre-process>
			
			<pre-process class="PopulateChildrenWithConditions" runOrder="400">
				<parameter name="template" value="jbr.report.internal" />
				<parameter name="attach" value="jbr.reports" />
				<parameter name="split"
					value="user:jbr.CoExecutor->jbr.report.int.executor" />
				<parameter name="attr_link_path" value="link:jbr.rimp.byrimp@user:jbr.commission.inspector;"/>
				<parameter name="attr_link_values" value="=NULL;"/>
				<parameter name="copy"
					value="
							user:jbr.resolution.FioSign->user:jbr.report.int.author;
							link:jbr.main.doc->link:jbr.report.int.document;
							user:jbr.AssignmentExecutor->jbr.report.role.supervise;
							user:jbr.commission.inspector->jbr.report.role.supervise;
							user:jbr.AssignmentExecutor->jbr.report.int.dynamic_role.approver.hidden;
							user:jbr.commission.inspector->jbr.report.int.dynamic_role.approver.hidden;
							list:jbr.category.howfast->jbr.category.howfast;
							date:jbr.resolutionTerm->jbr.resolutionTerm
						" />
			</pre-process>
			<pre-process class="PopulateChildrenWithConditions" runOrder="500">
				<parameter name="template" value="jbr.report.internal" />
				<parameter name="attach" value="jbr.reports" />
				<parameter name="split"
					value="user:jbr.CoExecutor->jbr.report.int.executor" />
				<parameter name="attr_link_path" value="link:jbr.rimp.byrimp@user:jbr.commission.inspector;"/>
				<parameter name="attr_link_values" value="#NULL;"/>
				<parameter name="copy"
					value="
							user:jbr.resolution.FioSign->user:jbr.report.int.author;
							link:jbr.main.doc->link:jbr.report.int.document;
							user:jbr.AssignmentExecutor->jbr.report.role.supervise;
							user:jbr.commission.inspector->jbr.report.role.supervise;
							user:jbr.AssignmentExecutor->jbr.report.int.dynamic_role.approver.hidden;
							user:jbr.commission.inspector->jbr.report.int.dynamic_role.approver.hidden;
							list:jbr.category.howfast->jbr.category.howfast;
							date:jbr.resolutionTerm->jbr.resolutionTerm
						" />
			</pre-process>
			<!--
				Создание карточек согласования для людей из "К сведению" Шаблон 1144
				"Ознакомление с поручением"
			-->
			<pre-process class="PopulateChildren" runOrder="600">
				<parameter name="template" value="jbr.adnotamCommission" />
				<parameter name="attach" value="jbr.resolution.FyiReport" />
				<parameter name="split"
					value="user:jbr.Fyi->user:jbr.adnotamCommission.person" />
				<parameter name="copy"
					value="
							user:AUTHOR->user:jbr.adnotamCommission.author; 
							link:jbr.main.doc->link:jbr.adnotamCommission.document;
							date:jbr.resolutionTerm->jbr.adnotamCommission.term;
							list:jbr.category.howfast->jbr.category.howfast
						" />
			</pre-process>
			<!-- Создание карточек отчетов для внешних исполнителей (1064) -->
			<pre-process class="PopulateChildren" runOrder="700">
				<parameter name="template" value="jbr.report.external" />
				<parameter name="attach" value="jbr.resolution.ExtReport" />
				<parameter name="split"
					value="link:jbr.ExtExecutor->jbr.report.ext.executor" />
				<parameter name="copy"
					value="
							user:jbr.resolution.FioSign->user:jbr.report.ext.author;
							link:jbr.main.doc->link:jbr.report.ext.document;
							user:jbr.AssignmentExecutor->jbr.report.role.execute;
							user:jbr.commission.inspector->jbr.report.role.execute;
							list:jbr.category.howfast->jbr.category.howfast;
							date:jbr.resolutionTerm->jbr.resolutionTerm
						" />
			</pre-process>
			<pre-process class="SetCurrentPersonTo" runOrder="800">
				<parameter name="personAttribute" value="jbr.report.sent.execute"/>
			</pre-process>
			<!-- Перевод зависимых поручений в состояние "Исполнение" -->
			<post-process class="DoDependentChangeState" runOrder="900">
				<parameter name="linkAttr" value="backLink:jbr.linkedResolutions" />
				<parameter name="affectedStates" value="jbr.commission.draft" />
				<parameter name="targetState" value="jbr.commission.executing" />
			</post-process>

			<!-- Родительские Входящие, ОГ, Внутренние, ОРД, НПА в статусе Зарегистрирован переводим в Исполнение -->
			<!-- Входящие, ОГ -->
			<post-process class="CallOriginsProcessor" runOrder="905">
				<parameter name="backLinkAttrId" value="link: jbr.main.doc" />
				<parameter name="processorClassName"
						value="com.aplana.dbmi.jbr.processors.JumpStatePostProcessor"/>
				<parameter name="dest_wfm" value="jbr.incoming.registration.execution"/>
				<parameter name="failIfStatusIsOther" value="false"/>
				<parameter name="local@attr_test" value=".template=jbr.incoming,jbr.incomingpeople"/>
				<parameter name="calling@attr_test" value=".state=registration"/>
			</post-process>
			<!-- Внутренние -->
			<post-process class="CallOriginsProcessor" runOrder="906">
				<parameter name="backLinkAttrId" value="link: jbr.main.doc" />
				<parameter name="processorClassName"
						value="com.aplana.dbmi.jbr.processors.JumpStatePostProcessor"/>
				<parameter name="dest_wfm" value="jbr.interndoc.execution.go"/>
				<parameter name="failIfStatusIsOther" value="false"/>
				<parameter name="local@attr_test" value=".template=jbr.interndoc"/>
				<parameter name="calling@attr_test" value=".state=registration"/>
			</post-process>
			<!-- ОРД, НПА -->
			<post-process class="CallOriginsProcessor" runOrder="907">
				<parameter name="backLinkAttrId" value="link: jbr.main.doc" />
				<parameter name="processorClassName"
						value="com.aplana.dbmi.jbr.processors.JumpStatePostProcessor"/>
				<parameter name="dest_wfm" value="jbr.ord.registration.execution"/>
				<parameter name="failIfStatusIsOther" value="false"/>
				<parameter name="local@attr_test" value=".template=jbr.ord,jbr.npa"/>
				<parameter name="calling@attr_test" value=".state=registration"/>
			</post-process>

			<!-- Родительские Входящие, ОГ и Внутренний в статусе Рассмотрение переводим в Исполнение -->
			<!-- Входящие, ОГ -->
			<post-process class="CallOriginsProcessor" runOrder="910">
				<parameter name="backLinkAttrId" value="link: jbr.main.doc" />
				<parameter name="processorClassName"
						value="com.aplana.dbmi.jbr.processors.JumpStatePostProcessor"/>
				<parameter name="dest_wfm" value="jbr.incoming.consideration.execution"/>
				<parameter name="failIfStatusIsOther" value="false"/>
				<parameter name="local@attr_test" value=".template=jbr.incoming,jbr.incomingpeople"/>
				<parameter name="calling@attr_test" value=".state=consideration"/>
			</post-process>
			<!-- Внутренние -->
			<post-process class="CallOriginsProcessor" runOrder="915">
				<parameter name="backLinkAttrId" value="link: jbr.main.doc" />
				<parameter name="processorClassName"
						value="com.aplana.dbmi.jbr.processors.JumpStatePostProcessor"/>
				<parameter name="dest_wfm" value="jbr.interndoc.consideration.execution"/>
				<parameter name="failIfStatusIsOther" value="false"/>
				<parameter name="local@attr_test" value=".template=jbr.interndoc"/>
				<parameter name="calling@attr_test" value=".state=consideration"/>
			</post-process>

			<!-- связанный с родительским Входящим, ОГ или Внутренним документ Рассмотрение в статусе Рассмотрение, у которого Рассматривающий совпадает с Подписантом текущего Поручения, переводим в Исполнение -->
			<post-process class="CallOriginsProcessor" runOrder="920">
				<parameter name="backLinkAttrId" value="link: jbr.main.doc@jbr.examby"/>
				<parameter name="processorClassName"
						value="com.aplana.dbmi.jbr.processors.JumpStatePostProcessor"/>
				<parameter name="dest_wfm" value="jbr.exam.execute"/>
				<parameter name="failIfStatusIsOther" value="false"/>
				<parameter name="calling@link_attr_fromParent" value="jbr.exam.set"/>
				<parameter name="eqAttrInCurCard" value="user:jbr.resolution.FioSign"/>
				<parameter name="eqAttrInLinkCard" value="user:jbr.exam.person"/>
				<parameter name="calling@attr_test" value=".state=consideration"/>
				<!--parameter name="async" value="true"/-->
				<!--parameter name="calling@parent_attr_test" value=".state=consideration"/-->
				<!--parameter name="local@attr_test" value=".template=jbr.incoming"/-->
			</post-process>

			<!-- связанный с родительским Входящим, ОГ или Внутренним документ Рассмотрение в статусе Обработка помощником, у которого Рассматривающий совпадает с Подписантом текущего Поручения, переводим в Исполнение -->
			<post-process class="CallOriginsProcessor" runOrder="925">
				<parameter name="backLinkAttrId" value="link: jbr.main.doc@jbr.examby"/>
				<parameter name="processorClassName"
						value="com.aplana.dbmi.jbr.processors.JumpStatePostProcessor"/>
				<parameter name="dest_wfm" value="jbr.exam.execute.assistant"/>
				<parameter name="failIfStatusIsOther" value="false"/>
				<parameter name="calling@link_attr_fromParent" value="jbr.exam.set"/>
				<parameter name="eqAttrInCurCard" value="user:jbr.resolution.FioSign"/>
				<parameter name="eqAttrInLinkCard" value="user:jbr.exam.person"/>
				<parameter name="calling@attr_test" value=".state=jbr.visa.assistent"/>
				<!--parameter name="async" value="true"/-->
				<!--parameter name="calling@parent_attr_test" value=".state=consideration"/-->
				<!--parameter name="local@attr_test" value=".template=jbr.incomingpeople"/-->
			</post-process>
			<!--post-process class="SetCurrentPersonTo">
				<parameter name="personAttribute" value="jbr.report.sent.execute"/>
			</post-process-->
			<post-process class="SetAttributeToMyParentReportProcessor" runOrder="928">
				<parameter name="attributeId" value="jbr.arm_flag"/>
				<parameter name="value" value="1"/>
			</post-process>
			<post-process class="ForceSaveCardProcessor" runOrder="930">
			</post-process>
		</specific>

		<!--
			При переводе поручения из состояния "Черновик" в состояние "Отправлен
			на исполнение":
		-->
		<specific property="workflowMove.id" value="jbr.commission.execute">
			<validator class="DenyActionForOrphan" runOrder="5">
				<parameter name="linkAttr" value="link:jbr.main.doc" />
			</validator>
			<!--
				Запрет перевода, если документ-основание находится не в статусе
				"Исполнение"
			-->
			<validator class="DenyActionByLinkedCardStates" runOrder="10">
				<parameter name="linkAttr" value="jbr.main.doc" />
				<parameter name="allowedStates" value="execution" />
				<parameter name="messageKey" value="jbr.commission.execute.parent" />
			</validator>
			<!--
				Если в качесве подписанта поручения стоит помощник, то заменяем его
				на руководителя
			-->
			<pre-process class="ReplaceAssistentToHead">
				<parameter name="attr" value="user:jbr.resolution.FioSign" />
			</pre-process>

			<!-- Создание карточек отчетов (1044) для ответственного исполнителя -->
			<pre-process class="PopulateChildren" runOrder="20">
				<parameter name="template" value="jbr.report.internal" />
				<parameter name="attach" value="jbr.reports" />
				<parameter name="split"
					value="user:jbr.AssignmentExecutor->jbr.report.int.executor" />
				<parameter name="copy"
					value="
							user:jbr.resolution.FioSign->user:jbr.report.int.author;
							link:jbr.main.doc->link:jbr.report.int.document;
							user:jbr.commission.inspector->jbr.report.role.supervise;
							user:jbr.commission.inspector->jbr.report.int.dynamic_role.approver.hidden;
							list:jbr.category.howfast->jbr.category.howfast;
							date:jbr.resolutionTerm->jbr.resolutionTerm
						" />
			</pre-process>
			<!-- Создание карточек отчетов (1044) для соисполнителей -->
			<pre-process class="PopulateChildren" runOrder="25">
				<parameter name="template" value="jbr.report.internal" />
				<parameter name="attach" value="jbr.reports" />
				<parameter name="split"
					value="user:jbr.CoExecutor->jbr.report.int.executor" />
				<parameter name="copy"
					value="
							user:jbr.resolution.FioSign->user:jbr.report.int.author;
							link:jbr.main.doc->link:jbr.report.int.document;
							user:jbr.AssignmentExecutor->jbr.report.role.supervise;
							user:jbr.commission.inspector->jbr.report.role.supervise;
							user:jbr.AssignmentExecutor->jbr.report.int.dynamic_role.approver.hidden;
							list:jbr.category.howfast->jbr.category.howfast;
							date:jbr.resolutionTerm->jbr.resolutionTerm
						" />
			</pre-process>
			<!--
				Создание карточек согласования для людей из "К сведению" Шаблон 1144
				"Ознакомление с поручением"
			-->
			<pre-process class="PopulateChildren" runOrder="30">
				<parameter name="template" value="jbr.adnotamCommission" />
				<parameter name="attach" value="jbr.resolution.FyiReport" />
				<parameter name="split"
					value="user:jbr.Fyi->user:jbr.adnotamCommission.person" />
				<parameter name="copy"
					value="
							user:AUTHOR->user:jbr.adnotamCommission.author; 
							link:jbr.main.doc->link:jbr.adnotamCommission.document;
							date:jbr.resolutionTerm->jbr.adnotamCommission.term;
							list:jbr.category.howfast->jbr.category.howfast
						" />
			</pre-process>
			<!-- Создание карточек отчетов для внешних исполнителей (1064) -->
			<pre-process class="PopulateChildren" runOrder="35">
				<parameter name="template" value="jbr.report.external" />
				<parameter name="attach" value="jbr.resolution.ExtReport" />
				<parameter name="split"
					value="link:jbr.ExtExecutor->jbr.report.ext.executor" />
				<parameter name="copy"
					value="
							user:jbr.resolution.FioSign->user:jbr.report.ext.author;
							link:jbr.main.doc->link:jbr.report.ext.document;
							user:jbr.AssignmentExecutor->jbr.report.role.execute;
							user:jbr.commission.inspector->jbr.report.role.execute;
							list:jbr.category.howfast->jbr.category.howfast;
							date:jbr.resolutionTerm->jbr.resolutionTerm
						" />
			</pre-process>
			<!-- Перевод зависимых поручений в состояние "Исполнение" -->
			<post-process class="DoDependentChangeState" runOrder="40">
				<parameter name="linkAttr" value="backLink:jbr.linkedResolutions" />
				<parameter name="affectedStates" value="jbr.commission.draft" />
				<parameter name="targetState" value="jbr.commission.executing" />
			</post-process>
			<post-process class="ForceSaveCardProcessor" runOrder="45">
			</post-process>
		</specific>

		<!--
			При переводе поручения из состояния "Исполнение" в состояние
			"Исполнено":
		-->
		<specific property="workflowMove.id" value="jbr.commission.finished">
			<!-- Проверка что нет запросов на смену рассматривающего в статусе Рассмотрение -->
			<validator class="CheckResolutions" runOrder="1"> 
				<parameter name="ATTR_NAME_4_LIST" value="jbr.main.doc->jbr.request.to.change.consid"/>
				<parameter name="LIST_OK" value="draft,poruchcancelled,cancelled,jbr.importedDoc.processed"/>
				<parameter name="INFO_CARD_FMT_4" value="Не обработано запросов на смену рассматривающего: {0}"/>
			</validator>
			<!--  Отметка "Дата исполнения" -->
			<pre-process class="RefreshDateAttribute" runOrder="5">
				<parameter name="dateAttributeId" value="JBR_INFD_DT_DONE" />
			</pre-process>
			<!-- Проверка наличия ровно одного финального отчета об исполнении -->
			<!-- <pre-process>CommissionReportCheck</pre-process> -->
			
			<specific property="flag:autoApproveNonControlReports" value="true">
				<post-process class="ProcessParentReport"/>
			</specific>
			
			<!--
				Перевод зависимых поручений в состояние "Отменено"
			-->
			<post-process class="DoDependentChangeState" runOrder="10"> 
				<parameter name="linkAttr" value="backLink:jbr.linkedResolutions"/> 
				<parameter name="affectedStates" value="jbr.commission.executing,jbr.commission.draft"/> 
				<parameter name="targetState" value="poruchcancelled"/> 
			</post-process>
			<!--
				Перевод отчетов состояние "Отменено"
			-->
			<post-process class="DoDependentChangeState" runOrder="15"> 
				<parameter name="linkAttr" value="backLink:jbr.reports"/>
				<parameter name="affectedStates" value="sent,jbr.report.inprogress,boss.assistant,consideration,done"/> 
				<parameter name="targetState" value="poruchcancelled"/> 
			</post-process>
			<!--
				Перевод поручения в состояние "Утверждено", если не установлен срок
				исполнения
			-->
			<!-- <post-process>CommissionApprovalPassthrough</post-process> -->
			<!-- Перевод зависимых карточек «Уведомление: ход исполнения (исх. Док)» в статус «В дубликаты» -->
			<post-process class="DoDependentChangeState" runOrder="20">
				<parameter name="linkAttr" value="backLink:jbr.incoming.incomeNotification"/> <!-- JBR_MEDO_IN_NOTIFY - Пришедшие уведомления -->
				<parameter name="targetState" value="doublet"/> <!-- 6 - Дубликат -->
			</post-process>
		</specific>

		<!--
			При переводе поручения из состояния "Исполнение" в состояние "Отменено":
		-->
		<specific property="workflowMove.id" value="jbr.commission.cancel.execution">
			<!--
				Перевод зависимых поручений в состояние "Отменено"
			-->
			<post-process class="DoDependentChangeState" runOrder="5"> 
				<parameter name="linkAttr" value="backLink:jbr.linkedResolutions"/> 
				<parameter name="affectedStates" value="jbr.commission.executing,jbr.commission.draft"/> 
				<parameter name="targetState" value="poruchcancelled"/> 
			</post-process>
			<!--
				Перевод отчетов состояние "Отменено"
			-->
			<post-process class="DoDependentChangeState" runOrder="10"> 
				<parameter name="linkAttr" value="backLink:jbr.reports"/> 
				<parameter name="affectedStates" value="sent,jbr.report.inprogress,boss.assistant,consideration,done"/> 
				<parameter name="targetState" value="poruchcancelled"/> 
			</post-process>
		</specific>

		<!--
			При переводе поручения из состояния "Черновик" в состояние "Закрыто в
			связи с завершением родительского":
		-->
		<specific property="workflowMove.id" value="jbr.commission.close.draft">
			<!--
				Перевод зависимых поручений в состояние "Закрыто в связи с
				завершением родительского"
			-->
			<post-process class="DoDependentChangeState" runOrder="5">
				<parameter name="linkAttr" value="backLink:jbr.linkedResolutions" />
				<parameter name="affectedStates"
					value="jbr.commission.draft,jbr.commission.executing" />
				<parameter name="targetState" value="jbr.commission.closed" />
			</post-process>
			<post-process class="ForceSaveCardProcessor" runOrder="10">
			</post-process>
		</specific>

		<!--
			*************************************************************************
			При переводе документа на исполнение, переводим все резолюции на
			исполнение.
			Для всех, кроме ОРД и НПА, переход на исполнение происходит через рассмотрение
			****************************************************************************
		-->
		<!-- ОРД -->
		<specific property="workflowMove.id" value="jbr.ord.registration.execution" async="true" policy="IterationPolicy">
			<!-- Перевод резолюций (поручений) в состояние "Исполнение" -->
			<post-process class="DoDependentResolutionChangeState" runOrder="5">
				<parameter name="linkAttr" value="backLink:jbr.resolutions" />
				<parameter name="affectedStates" value="jbr.commission.draft" />
				<parameter name="targetState" value="jbr.commission.executing" />
				<parameter name="ifEmpty" value="nothing" />
				<parameter name="moveId" value="jbr.ord.execution.done" />
			</post-process>
			<post-process class="ForceSaveCardProcessor" runOrder="10">
			</post-process>
		</specific>

		<!--
			****************************************************************************
			При переводе ОРД или НПА из исполнение в исполнен, переводим все резолюции в 
			статусе Исполнение в статус Исполнен
			****************************************************************************
		-->
		<!-- ОРД, НПА -->
		<specific property="workflowMove.id" value="jbr.ord.execution.done">
			<!-- Перевод резолюций (поручений) в состояние "Исполнен" -->
			<post-process class="DoDependentChangeState" runOrder="5">
				<parameter name="linkAttr" value="backLink:jbr.resolutions" />
				<parameter name="affectedStates" value="jbr.commission.executing" />
				<parameter name="targetState" value="jbr.commission.executed" />
				<parameter name="ifEmpty" value="nothing" />
			</post-process>
			<post-process class="ForceSaveCardProcessor" runOrder="10">
			</post-process>
		</specific>
		<!--
			*************************************************************************
		-->

		<!-- Переводим поручения входящего на исполнение при исполнении самого входящего -->		
		<specific property="workflowMove.id" value="jbr.incoming.registration.execution"  async="true" policy="IterationPolicy">
			<validator class="TestEmptyAttrProcessor" runOrder="1">
				<parameter name="test_attr" value="backLink:jbr.resolutions"/>
				<parameter name="must_empty" value="false"/>
				<parameter name="empty_message" value="Необходимо создать резолюцию "/>
			</validator>
			<validator class="CallOriginsProcessor" runOrder="2">
				<parameter name="backLinkAttrId" value="backLink:jbr.resolutions" />
				<parameter name="processorClassName" value="com.aplana.dbmi.jbr.processors.ChkDateProcessor" />
				<parameter name="checkdate1" value="jbr.resolutionTerm;+0" />
				<parameter name="dateFormat" value="dd.MM.yyyy HH:mm:ss" />
				<parameter name="dateNullIsOk" value="true" />
				<parameter name="attr_test" value=".state=draft"/>
			</validator>
			<validator class="CallOriginsProcessor" runOrder="3">
				<parameter name="backLinkAttrId" value="backLink:jbr.resolutions" />
				<parameter name="processorClassName" value="com.aplana.dbmi.jbr.processors.CheckMandatoryAttributes" />
				<parameter name="attr_test" value=".state=draft"/>
			</validator>

			<!-- Перевод резолюций (поручений) в состояние "Исполнение" -->
			<post-process class="DoDependentResolutionChangeState" runOrder="5">
				<parameter name="linkAttr" value="backLink:jbr.resolutions" />
				<parameter name="affectedStates" value="jbr.commission.draft" />
				<parameter name="targetState" value="jbr.commission.executing" />
				<parameter name="ifEmpty" value="nothing" />
			</post-process>
			<post-process class="CallOriginsProcessor" runOrder="10">
				<parameter name="backLinkAttrId" value="backLink:jbr.resolutions" />
				<parameter name="processorClassName" value="com.aplana.dbmi.jbr.processors.SetCurrentPersonTo" />
				<parameter name="personAttribute" value="jbr.report.sent.execute"/>
			</post-process>
			<post-process class="ForceSaveCardProcessor" runOrder="15">
			</post-process>
		</specific>
		
		
		<!-- Переход Независимого поручения (1255) из Черновик (1) в Подписание (108), переход "Отправить по маршруту" -->
		<specific property="workflowMove.id" value="jbr.independent.resolution.draft.sign" async="true" policy="IterationPolicy">
			<!-- Первым делом проверяем, что в системе имеется 'Журнал регистрации НП', иначе без него не получится
			автоматически присвоить его в качестве атрибута Журнал регистрации и зарегистрировать НП -->
			<validator class="CheckCardExistence" runOrder="3">
				<parameter name="templateId" value="jbr.journal" />
				<parameter name="value" value="Журнал регистрации НП" />
				<parameter name="errorMsg" value="В системе отсутствует необходимый журнал регистрации 'Журнал регистрации НП'. Обратитесь к администратору."/>
			</validator>
			<validator class="ChkOnCtrlInfo" runOrder="5">
				<parameter name="forceSave" value="false" />
			</validator>
			<!-- Срок исполнения не может быть раньше текущей даты -->
            <validator class="ChkDateProcessor" runOrder="10">
                <parameter name="checkdate1" value="jbr.incoming.deadline;-0" />
                <parameter name="dateFormat" value="dd.MM.yyyy" />
                <parameter name="dateNullIsOk" value="true" />
            </validator>
			<!-- Заполняем дату поступления JBR_INCOMEDATE -->
			<pre-process class="RefreshDateAttribute" runOrder="10">
				<parameter name="dateAttributeId" value="jbr.visa.income_date" />
				<parameter name="updateIfNullOnly" value="false" />
			</pre-process>
			<post-process class="JumpStatePostProcessor" runOrder="15">
				<parameter name="dest_wfm" value="jbr.independent.resolution.sign.on_execution" />
				<parameter name="card_test"
						value="com.aplana.dbmi.jbr.processors.card.runcheck.CheckCurrentUserInAttr (
								attrId=jbr.resolution.FioSign 
						)" />
			</post-process>
			<post-process class="RefreshDateAttribute" runOrder="10">
				<parameter name="dateAttributeId" value="jbr.visa.income_date" />
				<parameter name="updateIfNullOnly" value="false" />
			</post-process>
		</specific>
		
		<!-- Переход Независимого поручения (1255) из Подписание (108) в На исполнение (505050) -->
		<specific property="workflowMove.id" value="jbr.independent.resolution.sign.on_execution">
			<!-- Срок исполнения не может быть раньше текущей даты -->
            <validator class="ChkDateProcessor" runOrder="5">
                <parameter name="checkdate1" value="jbr.incoming.deadline;-0" />
                <parameter name="dateFormat" value="dd.MM.yyyy" />
                <parameter name="dateNullIsOk" value="true" />
            </validator>
			<!-- Обновляем дату поступления JBR_INCOMEDATE -->
			<pre-process class="RefreshDateAttribute" runOrder="5">
				<parameter name="dateAttributeId" value="jbr.visa.income_date" />
				<parameter name="updateIfNullOnly" value="false" />
			</pre-process>
			
			<pre-process class="RefreshDateAttribute" runOrder="10">
				<parameter name="dateAttributeId" value="jbr.maindoc.regdate" />
				<parameter name="updateIfNullOnly" value="true" />
			</pre-process>
			
			<pre-process class="RefreshDateAttribute" runOrder="15">
				<parameter name="dateAttributeId" value="jbr.resolution.SignDate" />
				<parameter name="updateIfNullOnly" value="true" />
			</pre-process>
			
			<!-- Генерируем имя независимого поручения -->
			<pre-process class="GenerateName" runOrder="20">
				<parameter name="format" value="Поручение №{0} от {1}, {2}" />
				<parameter name="dstAttrId" value="string: NAME" />
				<parameter name="srcAttrIds"
					value="	string: regnumber; 
							date: regdate;
							text: jbr.resolutionText" />
				<parameter name="forceSave" value="true" />
			</pre-process>
			
			<!-- Создание карточек отчетов (1044) для ответственных исполнителей -->
			<pre-process class="PopulateChildren" runOrder="25">
				<parameter name="template" value="jbr.report.internal" />
				<parameter name="attach" value="jbr.reports" />
				<parameter name="split"
					value="user:jbr.AssignmentExecutor->jbr.report.int.executor" />
				<parameter name="copy"
					value="
							user:jbr.resolution.FioSign->user:jbr.report.int.author;
							user:jbr.incoming.inspector->jbr.report.role.supervise;
							user:jbr.incoming.inspector->jbr.report.int.dynamic_role.approver.hidden;
							list:jbr.urgencyLevel->jbr.category.howfast;
							date:jbr.incoming.deadline->jbr.resolutionTerm
						" />
			</pre-process>

			<!-- Создание карточек отчетов (1044) для соисполнителей -->
			<pre-process class="PopulateChildren" runOrder="30">
				<parameter name="template" value="jbr.report.internal" />
				<parameter name="attach" value="jbr.reports" />
				<parameter name="split"
					value="user:jbr.CoExecutor->jbr.report.int.executor" />
				<parameter name="copy"
					value="
							user:jbr.resolution.FioSign->user:jbr.report.int.author;
							user:jbr.AssignmentExecutor->jbr.report.role.supervise;
							user:jbr.incoming.inspector->jbr.report.role.supervise;
							user:jbr.AssignmentExecutor->jbr.report.int.dynamic_role.approver.hidden;
							list:jbr.urgencyLevel->jbr.category.howfast;
							date:jbr.incoming.deadline->jbr.resolutionTerm
						" />
			</pre-process>
			
			<pre-process class="PopulateChildren" runOrder="35">
				<parameter name="template" value="jbr.adnotamCommission" />
				<parameter name="attach" value="jbr.resolution.FyiReport" />
				<parameter name="split"
					value="user:jbr.Fyi->user:jbr.adnotamCommission.person" />
				<parameter name="copy"
					value="
							user:AUTHOR->user:jbr.adnotamCommission.author; 
							date:jbr.incoming.deadline->jbr.adnotamCommission.term;
							list:jbr.urgencyLevel->jbr.category.howfast
						" />
			</pre-process>
			
			<!-- Переводим карточки ознакомлений в статус Отправлен на ознакомление -->
			<post-process class="DoDependentChangeState" runOrder="40">
				<parameter name="linkAttr" value="jbr.resolution.FyiReport"/>
				<parameter name="targetState" value="jbr.exam.assigned"/>
			</post-process>
			
			<!-- Переводим карточки Отчетов об исполнении в статус Отправлен -->
			<post-process class="DoDependentChangeState" runOrder="45">
				<parameter name="linkAttr" value="backLink:jbr.reports"/>
				<parameter name="targetState" value="sent"/>
			</post-process>

			<!-- Формируем атрибут NAME для Отчетов об исполнении -->
			<post-process class="GenerateChildrenNames" runOrder="50">
				<parameter name="childrenCardLinkAttrId" value="backLink:jbr.reports" />
				<parameter name="format" value="Поручение по документу №{0} от {1}, {2}" />
				<parameter name="dstAttrId"  value="string: NAME" />
				<parameter name="srcAttrIds" value="string: regnumber; 
													date: regdate;
													text: jbr.resolutionText" />
				<!--parameter name="forceSave" value="true" /-->
			</post-process>
			<!-- Формируем атрибут NAME для Ознакомлений с поручением -->
			<post-process class="GenerateChildrenNames" runOrder="55">
				<parameter name="childrenCardLinkAttrId" value="jbr.resolution.FyiReport" />
				<!-- parameter name="format" value="Ознакомиться с поручением №{0} от {1}, {2}" />
				
				<parameter name="srcAttrIds" value="string: regnumber; 
													date: regdate;
													text: jbr.resolutionText" />
				<parameter name="dstAttrId"  value="string: NAME" /-->
				<parameter name="format"
						value='Ознакомиться с поручением  от {0}: "{1}" по документу № {2} от {3}' />
					<parameter name="srcAttrIds"
						value="
						backLink: ADMIN_726876@jbr.resolution.FioSign;
						backLink: ADMIN_726876@jbr.resolutionText;
						link: ADMIN_726877@regnumber;
						link: ADMIN_726877@regdate;" />
				<!--parameter name="forceSave" value="true" /-->
			</post-process>
			
			<!-- Переводим Независимое поручение в статус Исполнение -->
			<post-process class="JumpStatePostProcessor" runOrder="60">
				<parameter name="dest_wfm" value="jbr.independent.resolution.on_execution.execution" />
			</post-process>
			
		</specific>
		
		<!-- Переход Независимого поручения (1255) из На исполнение (505050) в Исполнение (103) -->
		<specific property="workflowMove.id" value="jbr.independent.resolution.on_execution.execution">
			<!-- Обновляем дату регистрации (если она еще не заполнена) -->
			<pre-process class="RefreshDateAttribute" runOrder="5">
				<parameter name="dateAttributeId" value="jbr.maindoc.regdate" />
				<parameter name="updateIfNullOnly" value="true" />
			</pre-process>
			<!-- Сохраняем чтобы обновить имена дочерних карточек -->
			<post-process class="ForceSaveCardProcessor" runOrder="10"/>
		</specific>
		
		<!-- Переход Независимого поручения (1255) из Исполнение (103) в Исполнен (206)-->
		<specific property="workflowMove.id" value="jbr.independent.resolution.execution.done">
			<!-- Заполняем дату исполнения -->
			<pre-process class="RefreshDateAttribute">
				<parameter name="dateAttributeId" value="jbr.resolution.DoneDate" />
				<parameter name="updateIfNullOnly" value="false" />
			</pre-process>
		</specific>
		
		<!--
			*************************************************************************
		-->
	
		<!--
			Проверка списка Резолюций при переходе в состояние "В дело":
			допустимые состояния (на 16.11.2009): "Утверждены" (207) | "Закрыты в
			связи с завершением родительского" (43697) | "Отменены" (34145).
			@see: .\Portal\conf\dbmi\objectids.properties: "cardstate.delo"
			'JBR_IMPL_RESOLUT'
		-->
		<!--
			Проверка списка Ознакомление при переходе в состояние "В дело":
			допустимые состояния (на 16.11.2009): "Исполнение"(103) | "В дело"
			(104) // не надо уже (17:14 (ufa), 16/11/2009) "Отменены"
			'JBR_IMPL_ACQUAINT'
		-->
		<!--
			specific property="workflowMove.toState" value="delo" load="true">
			<pre-process class="CheckResolutions"> <parameter
			name="ATTR_NAME_4_LIST" value="jbr.examby"/> <parameter
			name="LIST_OK" value="execution,delo"/> < ! - - parameter
			name="INFO_CARD_FMT_4" value="[{0}] не расммотрел ''{2}'' ({3}),
			сейчас в стадии ''{1}''."/ - - > <parameter name="INFO_CARD_FMT_4"
			value=" в списке рассмотрений."/> </pre-process> </specific
		-->

		<!-- Устанавливаем дату перевода на исполнение во входящем -->
		<specific property="workflowMove.toState" value="execution"
			load="true">
			<post-process class="RefreshDateAttribute">
				<parameter name="dateAttributeId" value="jbr.incomingDates.executionDate" />
			</post-process>
			<specific property="card.template" value="jbr.ord" load="true"> 
				<post-process class="RefreshDateAttribute">
        			<parameter name="dateAttributeId" value="jbr.resolution.SendToExecuteDate"/>
    			</post-process>
			</specific>
			<specific property="card.template" value="jbr.resolution" load="true"> 
				<!-- При отправке на исполнение поручений, атрибут Зона ДОУ на основе Зоны ДОУ Исполнителя, Соисполнителей и Контроллера (предыдущее значение перед изменением очищать) -->
				<pre-process class="CopyAttributeFromParent" runOrder="18">
					<parameter name="isOnlyModel" value="false" />
					<parameter name="from" value="jbr.zoneDOW"/>
					<parameter name="to" value="jbr.zoneDOW"/>
					<parameter name="parent" value="jbr.AssignmentExecutor"/>
					<parameter name="parentTemplate" value="jbr.internalPerson"/>
					<parameter name="writeOperation" value="preclear+overwrite"/>
					<parameter name="type" value="C"/>
				</pre-process>
				<pre-process class="CopyAttributeFromParent" runOrder="19">
					<parameter name="isOnlyModel" value="false" />
					<parameter name="from" value="jbr.zoneDOW"/>
					<parameter name="to" value="jbr.zoneDOW"/>
					<parameter name="parent" value="jbr.CoExecutor"/>
					<parameter name="parentTemplate" value="jbr.internalPerson"/>
					<parameter name="type" value="C"/>
					<parameter name="writeOperation" value="append" />
				</pre-process>
				<pre-process class="CopyAttributeFromParent" runOrder="19">
					<parameter name="isOnlyModel" value="false" />
					<parameter name="from" value="jbr.zoneDOW"/>
					<parameter name="to" value="jbr.zoneDOW"/>
					<parameter name="parent" value="jbr.commission.inspector"/>
					<parameter name="parentTemplate" value="jbr.internalPerson"/>
					<parameter name="type" value="C"/>
					<parameter name="writeOperation" value="append" />
				</pre-process>
			</specific>
		</specific>

		<specific property="workflowMove.toState" value="jbr.sign.assigned"
			load="true">
			<specific property="card.template" value="jbr.visa" load="true"> 
				<!-- При отправке согласований в статус Ожидание согласования, атрибут Зона ДОУ заполняем на основе Зоны ДОУ Согласующего (предыдущее значение перед изменением очищать) -->
				<pre-process class="CopyAttributeFromParent" runOrder="18">
					<parameter name="updateAccessList" value="true"/>
					<parameter name="isOnlyModel" value="false" />
					<parameter name="from" value="jbr.zoneDOW"/>
					<parameter name="to" value="jbr.zoneDOW"/>
					<parameter name="parent" value="jbr.visa.person"/>
					<parameter name="parentTemplate" value="jbr.internalPerson"/>
					<parameter name="writeOperation" value="preclear+overwrite"/>
					<parameter name="type" value="C"/>
				</pre-process>
			</specific>
			<specific property="card.template" value="jbr.sign" load="true"> 
				<!-- При отправке подписаний в статус Ожидание согласования, атрибут Зона ДОУ заполняем на основе Зоны ДОУ Подписанта (предыдущее значение перед изменением очищать) -->
				<pre-process class="CopyAttributeFromParent" runOrder="18">
					<parameter name="updateAccessList" value="true"/>
					<parameter name="isOnlyModel" value="false" />
					<parameter name="from" value="jbr.zoneDOW"/>
					<parameter name="to" value="jbr.zoneDOW"/>
					<parameter name="parent" value="jbr.sign.person"/>
					<parameter name="parentTemplate" value="jbr.internalPerson"/>
					<parameter name="writeOperation" value="preclear+overwrite"/>
					<parameter name="type" value="C"/>
				</pre-process>
			</specific>
		</specific>		
		<specific property="workflowMove.toState" value="jbr.exam.assigned"
			load="true">
			<specific property="card.template" value="jbr.inform" load="true">
				<!-- При отправке ознакомлений в статус Ожидание согласования, атрибут Зона ДОУ заполняем на основе Зоны ДОУ Ознакамливающегося (предыдущее значение перед изменением очищать) -->
				<pre-process class="CopyAttributeFromParent" runOrder="18">
					<parameter name="updateAccessList" value="true"/>
					<parameter name="isOnlyModel" value="false" />
					<parameter name="from" value="jbr.zoneDOW"/>
					<parameter name="to" value="jbr.zoneDOW"/>
					<parameter name="parent" value="jbr.information.person"/>
					<parameter name="parentTemplate" value="jbr.internalPerson"/>
					<parameter name="writeOperation" value="preclear+overwrite"/>
					<parameter name="type" value="C"/>
				</pre-process>
			</specific> 
		</specific>	
		<!-- Устанавливаем дату перевода в дело во входящем и исходящем-->
		<specific property="workflowMove.toState" value="delo" load="true" async="true" priority="0">
			<post-process class="RefreshDateAttribute" runOrder="5">
				<parameter name="dateAttributeId" value="jbr.incomingDates.deloDate" />
			</post-process>

			<post-process class="RefreshDateAttribute" runOrder="10">
				<parameter name="dateAttributeId" value="jbr.outcomingDates.deloDate" />
			</post-process>
			<post-process>SetStoragePlace</post-process>
		</specific>
		<!-- Устанавливаем дату подписания в карточке подписания -->
		<specific property="workflowMove.toState" value="jbr.sign.signed"
			load="true">
			<post-process class="RefreshDateAttribute">
				<parameter name="dateAttributeId" value="jbr.sign.signdate" />
			</post-process>
		</specific>
		<!-- Поручение при переходе "Утвердить" -->
		<specific property="workflowMove.id" value="jbr.commission.confirm">
			<!-- Устанавливаем дату исполнения в карточке -->
			<post-process class="RefreshDateAttribute" runOrder="5">
				<parameter name="dateAttributeId" value="jbr.resolution.executeDate" />
			</post-process>
			<!--
				Переводим документ-основание в состояние "исполнен" если необходимо
			-->
			<post-process class="ExecuteCommissionParentDoc" runOrder="10" />
		</specific>
		<!-- Поручение при переходе "Отменить" -->
		<specific property="workflowMove.id" value="jbr.commission.cancel.execution">
			<!--
				Переводим документ-основание в состояние "исполнен" если необходимо
			-->
			<post-process class="ExecuteCommissionParentDoc" />
		</specific>

		<!--
			Устанавливаем дату исполнения в карточке Поручение при переходе
			"Закрыть"
		-->
		<specific property="workflowMove.id" value="jbr.commission.close">
			<post-process class="RefreshDateAttribute">
				<parameter name="dateAttributeId" value="jbr.resolution.executeDate" />
			</post-process>
		</specific>
		<!--
			Устанавливаем дату исполнения в карточке Поручение при переходе
			"Завершить зависимые"
		-->
		<specific property="workflowMove.id" value="jbr.commission.close.draft">
			<post-process class="RefreshDateAttribute" runOrder="5">
				<parameter name="dateAttributeId" value="jbr.resolution.executeDate" />
			</post-process>
			<post-process class="ForceSaveCardProcessor" runOrder="10">
			</post-process>
		</specific>

		<!--
			Убираем ссылки во внешних документах для перехода Черновик-Корзина:
			workflowmove.jbr.commission.drop=408275 Документ-основание:
			cardlinkattribute.jbr.rimp.byrimp=JBR_RIMP_PARASSIG Зависимости:
			backlinkattribute.jbr.linkedResolutions=JBR_RIMP_RELASSIG
			(backlinkattribute.jbr.linkedResolutions=JBR_RIMP_RELASSIG)
		-->
		<specific property="workflowMove.id" value="jbr.commission.drop">
			<post-process class="RemoveLinkProcessor">
				<parameter name="linkAttrId" value="jbr.rimp.byrimp" />
				<parameter name="listLinkedAttrIds"
					value="jbr.linkedResolutions , JBR_IMPL_RESOLUT" />
			</post-process>
		</specific>

		<!--
			Устанавливаем дату исполнения в карточке Визирование при переходе
			"Согласен"
		-->
		<specific property="workflowMove.id" value="jbr.visa.agree">
			<post-process class="RefreshDateAttribute">
				<parameter name="dateAttributeId" value="jbr.visa.executeDate" />
			</post-process>
		</specific>

		<!--
			Устанавливаем дату исполнения в карточке Ознакомление при переходе
			"Ознакомился"
		-->
		<specific property="workflowMove.id" value="jbr.acquaint">
			<post-process class="RefreshDateAttribute">
				<parameter name="dateAttributeId" value="jbr.inform_incoming.executeDate" />
			</post-process>
		</specific>

		<!--
			Устанавливаем дату исполнения в карточке Рассмотрение при переходе "В
			дело"
		-->
		<specific property="workflowMove.id" value="jbr.exam.archive">
			<post-process class="RefreshDateAttribute">
				<parameter name="dateAttributeId" value="jbr.rassm.executeDate" />
			</post-process>
		</specific>

		<!--
			Устанавливаем дату исполнения в карточке Рассмотрение при переходе
			"Пропустить"
		-->
		<specific property="workflowMove.id" value="jbr.exam.skip">
			<post-process class="RefreshDateAttribute">
				<parameter name="dateAttributeId" value="jbr.rassm.executeDate" />
			</post-process>
		</specific>

		<!--
			Устанавливаем дату исполнения в карточке Рассмотрение при переходе
			"Отправить на исполнение"
		-->
		<specific property="workflowMove.id" value="jbr.exam.execute">
			<post-process class="RefreshDateAttribute">
				<parameter name="dateAttributeId" value="jbr.rassm.executeDate" />
			</post-process>
		</specific>

		<!-- Перевод организации в состояние "Дубликат" -->
		<!-- (YNikitin, 2012/08/08) отключаем данную логику, так как вместо полной замены, будет замена при отображении
		<specific property="workflowMove.toState" value="doublet"
			load="true">
			<post-process class="CardDoubletPostProcessor">
				<parameter name="config" value="dbmi/carddoubletpostprocessor.xml" />
			</post-process>
		</specific>
		-->
		<!--
			Отправка карточек Подписания (365) помощнику, если он есть
			workflowmove.jbr.sign.send=41468 365 Подпись wf=35244 wfm=41468
			"Отправить подписанту": из "Ожидание согласования" (41466) в
			"Подписание"(108)
		-->
		<specific property="workflowMove.id" value="jbr.sign.send">
			<pre-process class="AssistantRedirector" />
		</specific>

		<!--
			Отправка карточек Рассмотрения (504) помощнику, если он есть
			workflowmove.jbr.exam.send=52088 504 Рассмотрение wf=47254 wfm=52088
			"Рассмотреть": из "Ожидание рассмотрения" (52086) в
			"Рассмотрение"(102)
		-->
		<specific property="workflowMove.id" value="jbr.exam.send">
			<pre-process class="AssistantRedirector" />
		</specific>

		<!--
			Отправка карточек Визирования (348) помощнику, если он есть
			workflowmove.jbr.visa.send=41467 348 Визирование wf=35265 wfm=41467
			"Отослать согласующему": из "Ожидание согласования"(41466) в
			"Согласование"(107)
		-->
		<specific property="workflowMove.id" value="jbr.visa.send">
			<pre-process class="AssistantPassthrough">
				<parameter name="personAttr" value="jbr.visa.person" />
				<parameter name="moveYes" value="jbr.visa.send.assistent" />
				<parameter name="calcMoveOnly" value="true" />
			</pre-process>
		</specific>
		
		<!--
			Пропуск статусов "Согласован/несогласован руководителем" для карточек
			Визирования (348)
		-->
		<specific property="workflowMove.id" value="jbr.visa.agree">
			<post-process class="AssistantPassthrough">
				<parameter name="personAttr" value="jbr.visa.person" />
				<parameter name="moveNo" value="jbr.visa.end.agreed" />
				<!--
					для пред-обработки: parameter name="calcMoveOnly" value="true"/
				-->
			</post-process>
		</specific>
		<specific property="workflowMove.id" value="jbr.visa.disagree">
			<post-process class="AssistantPassthrough">
				<parameter name="personAttr" value="jbr.visa.person" />
				<parameter name="moveNo" value="jbr.visa.end.disagreed" />
				<!--
					для пред-обработки: parameter name="calcMoveOnly" value="true"/
				-->
			</post-process>
		</specific>
		<!--
			Пропуск статусов "* руководителем" для карточек Подписания и
			Рассмотрения
		-->
		<specific property="workflowMove.id" value="jbr.sign.sign.boss">
			<post-process class="AssistantPassthrough">
				<parameter name="personAttr" value="jbr.sign.person" />
				<parameter name="moveNo" value="jbr.sign.sign.boss.assistant" />
			</post-process>
		</specific>
		<specific property="workflowMove.id" value="jbr.sign.reject.boss">
			<pre-process package="com.aplana.dbmi.module.docflow" class="NegotiationHistory" runOrder="5"/>
			<post-process package="com.aplana.dbmi.jbr.processors" class="DoDependentChangeState" runOrder="10">
				<parameter name="linkAttr" value="backLink:jbr.sign.parent" />
				<parameter name="affectedStates" value="sign" />
				<parameter name="targetState" value="rejected" />
			</post-process>		
		</specific>
		<specific property="workflowMove.id" value="jbr.exam.execute.boss" policy="IterationPolicy">
			<post-process class="AssistantPassthrough" runOrder="5">
				<parameter name="personAttr" value="jbr.exam.person" />
				<parameter name="moveNo" value="jbr.exam.execute.boss.assistant" />
			</post-process>
			<!--
				При переходе из статуса "Рассмотрение" => "Отправлен на исполнение
				руководителем" смотрим по всем связанным поручениям, есть ли в
				качестве подписанта Помощник и если есть, то ставим текущего
				пользователя (Руководителя)
			-->
			<post-process class="ReplaceAssistentToHeadForReview" runOrder="10">
				<parameter name="attr" value="user:jbr.resolution.FioSign" />
			</post-process>
		</specific>
		<specific property="workflowMove.id" value="jbr.exam.archive.boss">
			<post-process class="AssistantPassthrough" runOrder="20">
				<parameter name="personAttr" value="jbr.exam.person" />
				<parameter name="moveNo" value="jbr.exam.archive.boss.assistant" />
			</post-process>
			<post-process class="RefreshDateAttribute" runOrder="26">
				<parameter name="dateAttributeId" value="jbr.visa.income_date" />
				<parameter name="updateIfNullOnly" value="false" />
			</post-process>
		</specific>
		<specific property="workflowMove.id" value="jbr.exam.skip.boss">
			<post-process class="AssistantPassthrough">
				<parameter name="personAttr" value="jbr.exam.person" />
				<parameter name="moveNo" value="jbr.exam.skip.boss.assistant" />
			</post-process>
		</specific>

		<!--
			При псевдо-переводе поручения из состояния "Исполнение" в себя же":
		-->
		<specific property="workflowMove.id" value="jbr.income.collectexecthread">
			<!-- Сбор хода исполнения -->
			<pre-process class="CollectExecutionThread" runOrder="5">
			</pre-process>
			<post-process class="ForceSaveCardProcessor" runOrder="10">
			</post-process>
		</specific>

		<!--
			Передача карточки "Подпись" (365) другому руководителю: сразу ставим
			на подпись, заодно сработает автоматизация для передачи помошнику.
			workflowmove.jbr.sign.send=41468 // Отправить подписанту
			workflowmove.jbr.sign.reassign.waiting=42091 // Передать другому
			руководителю
		-->
		<specific property="workflowMove.id" value="jbr.sign.reassign.waiting">

			<!-- Перетряхиваем помощников подписанта при отправке Подписи другому рук-у. (18195) -->
			
			<pre-process class="SetAssistantCard" runOrder="5">
				<parameter name="chiefAttrId" value="[C-][A+]jbr.sign.person" />
				<parameter name="assistantsAttrId" value="jbr.hidden.signerAssistants" />
				<parameter name="assistantsPreclear" value="true" />
				<parameter name="forceSave" value="true" />
			</pre-process>
			
			<!--
				Копирование подписанта из текущей карточки / шаблона Подписи (365):
				"Подписант"/'JBR_SIGN_RESPONSIBLE'/U в документ-основание
				'JBR_SIGN_PARENT' в атрибут: "ФИО подписанта"/'JBR_INFD_SIGNATORY'/U
				только если порядок подписания = 0 365 Подпись: "Порядок
				подписания"/I/'JBR_SIGN'
			-->
			<!-- (YNikitin, 2013/11/13, BR4J00034081) в рамках оптимизации системы, убираем лишние процессоры и донастраиваем оставшиеся, чтобы не было лишних пересчётов прав и лишних копирований атрибутов -->
			<post-process class="CopyAttributeToChildren" runOrder="10">
				<parameter name="updateAccessList" value="true"/>
				<parameter name="from" value="JBR_SIGN_RESPONSIBLE" />
				<parameter name="linkAttrId" value="backLink:JBR_SIGN_PARENT" />
				<parameter name="to" value="JBR_INFD_SIGNATORY" />
				<parameter name="attr_condition" value="number:JBR_SIGN_NUMBER=0" />
			</post-process>

			<!--
				Вызываем сохранение доки-основания, чтобы в нем отработали его
				автоматы : генераторы имен и пр
			-->
			<post-process class="ForceSaveCardProcessor" runOrder="15">
				<parameter name="linkAttrId" value="backLink:JBR_SIGN_PARENT" />
			</post-process>

			<post-process class="JumpStatePostProcessor" runOrder="20">
				<parameter name="dest_wfm" value="jbr.sign.send" />
			</post-process>

		</specific>

        <!-- НПА Если нет помощника, сразу пробрасываем на ознакомление руководителю -->
        <specific property="workflowMove.id" value="jbr.ord.preparation.manager">
            <post-process class="AssistantPassthrough">
                <parameter name="personAttr" value="jbr.manager" />
                <parameter name="moveNo" value="jbr.ord.manager.toArm" />
            </post-process>
        </specific>


		<!--
			*************************************************************************
			При регистрации документа, заполняем поле "Регистратор" текущим
			пользователем. Условие срабатывания - такое же как у Нумератора
			(вообще, считаю, что регистратора нужно тоже проставлять в
			нумераторе)
			****************************************************************************
		-->
		<!--
			22.03.2011 boruroev: перенесено в DoSetRegistrationNumber, так как он вызывается не только при переходе в state=registration 
		 -->
		<!-- specific property="workflowMove.toState" value="registration"
			load="true">
			<pre-process class="SetCurrentPersonTo">
				<parameter name="personAttribute" value="jbr.outgoing.registrar" />
			</pre-process>
		</specific-->
		<!--
			*************************************************************************
		-->

		<!-- Автоматическое создание карточки рассмотрения для адресата -->
		<specific property="workflowMove.id" value="jbr.interndoc.registration.consideration">
			<pre-process class="SendToAddresseeForConsideration">
					<parameter name="ignoredStates" value="poruchcancelled"/>
				</pre-process>
		</specific>

		<specific property="workflowMove.id" value="jbr.incoming.registration.consideration">

			<!-- Шаблон Входящий (224) -->
			<specific property="card.template" value="jbr.incoming"
				load="true">
				<pre-process class="SendToAddresseeForConsideration">
					<parameter name="addressAttr" value="jbr.incoming.addressee" />
					<parameter name="ignoredStates" value="poruchcancelled"/>
				</pre-process>
			</specific>

			<!--  Шаблон Информационный Запрос (ИЗ) (865)-->
			<specific property="card.template" value="jbr.infreq" load="true">
				<pre-process class="SendToAddresseeForConsideration">
					<!--
						Атрибут "Адресат": cardlinkattribute.jbr.OgAddressee=JBR_RECEIVER
					-->
					<parameter name="addressAttr" value="jbr.OgAddressee" />
					<parameter name="ignoredStates" value="poruchcancelled"/>
				</pre-process>
			</specific>

			<!-- Шаблон Обращение граждан (ОГ) (864) -->
			<specific property="card.template" value="jbr.citizenrequest"
				load="true">
				<!--Проверка Срока рассмотрения в атрибуте "Список адресатов"-->
				<validator class="ChkDateProcessor">
					<parameter name="checkdate1" value="datedTypedLink:jbr.og.addressee.list%Срок в Списке Адресатов;+0" />
					<parameter name="dateFormat" value="dd.MM.yyyy" />
					<parameter name="dateNullIsOk" value="true" />
				</validator>
				<pre-process class="OgSendToAddresseeForConsideration" runOrder="5">
					<!--
						Атрибут "Список адресатов": datedtypedcardlinkattribute.jbr.og.addressee.list=JBR_ADDRESSEE_LIST
					-->
					<parameter name="addressAttr" value="jbr.og.addressee.list"/>
					<parameter name="ignoredStates" value="poruchcancelled"/>
				</pre-process>
				<pre-process class="CopyPersonFromPaths" runOrder="10">
					<parameter name="targetAttr" value="jbr.examiners"/>
					<parameter name="paths" value="datedTypedLink:jbr.og.addressee.list"/>
				</pre-process>
				<post-process class="ClearCardAttributePostProcessor" runOrder="15">
					<parameter name="attrId" value="datedTypedLink:jbr.og.addressee.list" />
				</post-process>
			</specific>

		</specific>

		<!-- Шаблон Обращение граждан (ОГ) (864) -->
		<!-- Для обращений граждан заполняем рассматривающего при регистрации -->
		<specific property="workflowMove.toState" value="registration">
			<specific property="card.template" value="jbr.citizenrequest" load="true">
				<!-- Проверяем заполненость атрибутов заявителя, если Автор обращени я пустой -->
				<validator class="TestEmptyAttrProcessor" runOrder="5">
					<parameter name="test_attr" value="string:jbr.InfOGSecondName"/>
					<parameter name="must_empty" value="false"/>
					<parameter name="empty_message" value="Атрибут Информация о заявителе. Фамилия не может быть пустым, заполните его, либо выберите существующего Автора обращения."/>
					<parameter name="condition" value="link:jbr.AuthType#15921"/>
				</validator>
				<validator class="TestEmptyAttrProcessor" runOrder="10">
					<parameter name="test_attr" value="string:jbr.InfOGFirstName"/>
					<parameter name="must_empty" value="false"/>
					<parameter name="empty_message" value="Атрибут Информация о заявителе. Имя не может быть пустым, заполните его, либо выберите существующего Автора обращения."/>
					<parameter name="condition" value="link:jbr.AuthType#15921"/>
				</validator>
				<!-- <validator class="TestEmptyAttrProcessor" runOrder="15">
					<parameter name="test_attr" value="string:jbr.InfOGPatronimic"/>
					<parameter name="must_empty" value="false"/>
					<parameter name="empty_message" value="Атрибут Информация о заявителе. Отчество не может быть пустым, заполните его, либо выберите существующего Автора обращения."/>
					<parameter name="condition" value="link:jbr.AuthType#15921"/>
				</validator>  -->
				<!--validator class="TestEmptyAttrProcessor" runOrder="20">
					<parameter name="test_attr" value="link:jbr.InfAboutDocRegion"/>
					<parameter name="must_empty" value="false"/>
					<parameter name="empty_message" value="Атрибут Регион (РФ или другое) не может быть пустым, заполните его, либо выберите существующего Автора обращения."/>
					<parameter name="condition" value="link:jbr.ReqAuthor=NULL"/>
				</validator-->
				<!--validator class="TestEmptyAttrProcessor" runOrder="25">
					<parameter name="test_attr" value="link:jbr.InfAboutDocDistrict"/>
					<parameter name="must_empty" value="false"/>
					<parameter name="empty_message" value="Атрибут Район не может быть пустым, заполните его, либо выберите существующего Автора обращения."/>
					<parameter name="condition" value="link:jbr.ReqAuthor=NULL"/>
				</validator-->
				<!--validator class="TestEmptyAttrProcessor" runOrder="30">
					<parameter name="test_attr" value="link:jbr.InfAboutDocCity"/>
					<parameter name="must_empty" value="false"/>
					<parameter name="empty_message" value="Атрибут Город (населенный пункт) не может быть пустым, заполните его, либо выберите существующего Автора обращения."/>
					<parameter name="condition" value="link:jbr.ReqAuthor=NULL"/>
				</validator-->
				<pre-process package="com.aplana.dbmi.module.docflow" class="FillOgAuthorProcessor" runOrder="-15"/>
				<!-- Если тип обращения Без подписи (анонимное), то в атрибуте Автор обращения делаем ссылку на карточку Анонимного автора обращения-->
				<pre-process class="SetAttributeValueWithConditionProcessor" runOrder="-10">
					<parameter name="attr_condition_1" value="link:jbr.AuthType=15921"/>
					<parameter name="attributeId" value="link:jbr.ReqAuthor"/>
					<parameter name="value" value="10" />
					<parameter name="saveKind" value="SAVE_ATTR"/>
				</pre-process>
				
				<!-- validator class="TestEmptyAttrProcessor">
					<parameter name="test_attr" value="text:ADMIN_277248"/>
					<parameter name="must_empty" value="false"/>
					<parameter name="empty_message" value="Атрибут Адрес для предоставления ответа не может быть пустым, заполните его, либо выберите существующего Автора обращения."/>
					<parameter name="condition" value="link:jbr.ReqAuthor=NULL"/>
				</validator-->
				<pre-process class="BindAuthorOfAppeal" runOrder="5"/>
				
				
				<!-- specific property="flag:authorOfAppealMatchingMode" value="name">
					<pre-process class="FillPreviousAppealsProcessor">
						<parameter name="authorAttributes" value="jbr.InfOGFirstName,jbr.InfOGPatronimic,jbr.InfOGSecondName"/>
					</pre-process>
					<post-process class="GenerateUIDProcessor">
						<parameter name="attrId" value="text:uid"/>
						<parameter name="setIfEmptyOnly" value ="true"/>
					</post-process>
				</specific>
				<specific property="flag:authorOfAppealMatchingMode" value="name" equals="false">
					<pre-process class="FillPreviousAppealsProcessor">
						<parameter name="appealAttributes" value="jbr.QuestionOfQuery"/>
					</pre-process>
				</specific-->
				<!-- pre-process class="SetAttributeValueProcessor" runOrder="15">
					<parameter name="attributeId" value="list:jbr.incoming.oncontrol"/>
					<parameter name="value" value="jbr.incoming.control.yes" />
					<parameter name="saveKind" value="SAVE_ATTR"/>
				</pre-process>
				<pre-process class="RefreshDateAttribute" runOrder="20">
					<parameter name="dateAttributeId" value="jbr.incoming.deadline"/>
					<parameter name="dateOffset" value="+30d"/>
					<parameter name="updateIfLessCurDate" value="true"/>
				</pre-process>
				<pre-process class="SetCurrentPersonTo" runOrder="25">
					<parameter name="personAttribute" value="jbr.incoming.inspector"/>
					<parameter name="addOnlyIfDestIsEmpty" value="true"/>
				</pre-process -->
				<!--pre-process class="RefreshDateAttribute">
					<parameter name="dateAttributeId" value="jbr.boss.control.pulloff.date"/>
					<parameter name="dateOffset" value="+30d"/>
				</pre-process-->
				<post-process class="GenerateUIDProcessor" runOrder="30">
					<parameter name="attrId" value="text:uid"/>
					<parameter name="setIfEmptyOnly" value ="true"/>
				</post-process>
				<!-- При регистрации определенных шаблонов должно меняться и название карточки -->
				<post-process class="DeepGenerateName" runOrder="40">
					<!-- <parameter name="format" value="{0} {1}"/> -->
					<parameter name="format" value="{0} {1} от {2}, {3} {4} {5}, {6}"/>
					<parameter name="dstAttrId" value="NAME"/>
					<parameter name="srcAttrIds" value="
						list: jbr.reg.requestType;
						string: regnumber;
						date: regdate;
						link: jbr.ReqAuthor@jbr.InfOGSecondName;
						link: jbr.ReqAuthor@jbr.InfOGFirstName;
						link: jbr.ReqAuthor@jbr.InfOGPatronimic;
						text: jbr.document.title"/>
					<parameter name="forceSave" value="true" />
					<parameter name="forceSaveMode" value="ATTRIBUTE" />
				</post-process>
				<post-process class="DeepGenerateName" runOrder="42">
					<parameter name="format"
					           value="{0}; {1}; {2}; {3}; {4}; {5}; {6}; {7}; {8}; {9}; {10}; {11}; {12}; {13}; {14}; {15}; {16}; {17}; {18}; {19}; {20}; {21}; {22}; {23}; {24}; {25}; {26}; {27}; {28}" />
					<parameter name="dstAttrId" value="string: KEYWORDS" />
					<parameter name="srcAttrIds"
					           value="
						user: author;
						user: jbr.hidden.notePersons;
						link: jbr.hidden.external.executor;
						link: jbr.ThemeOfQuery;
						link: jbr.QuestionOfQuery;
						tree: jbr.QueryExemptions;
						link: jbr.ConsiderDecision;
						link: jbr.InfAboutDocRegion;
						link: jbr.InfAboutDocCountry;
						link: jbr.InfAboutDocCity;
						link: jbr.OgAddressee;
						tree: jbr.SourceType;
						list: jbr.reg.requestType;
						link: regjournal;
						link: index;
						user: jbr.incoming.registrar;
						list: jbr.urgencyLevel;
						list: jbr.specialNotes;
						list: jbr.inbound.typecontrol;
						link: jbr.incoming.foiv;
						user: jbr.incoming.inspector;
						list: jbr.incoming.execkind;
						user: jbr.ext.curator.editor;
						link: jbr.ReqAuthor;
						link: jbr.previousReqAuthor;
						user: jbr.examiners;
						link: jbr.question.thematic.OG;
						user: jbr.npa.curator
					" />
					<parameter name="maxArgStrLen" value="3000" />
					<parameter name="forceSave" value="true" />
					<parameter name="forceSaveMode" value="ATTRIBUTE" />
				</post-process>
			</specific>
			
			<!-- При регистрации исходящего документа, содержащиеся в нем "Элементы списка рассылки" 
			переводим в состояние "Готов к регистрации"-->
			<specific property="card.template" value="jbr.outcoming" load="true">
				<validator class="TestEmptyAttrProcessor" runOrder="1">
					<parameter name="test_attr" value="link:jbr.files"/>
					<parameter name="must_empty" value="false"/>
					<parameter name="hidden_status" value="outofdate"/>
					<parameter name="empty_message" value="Вы не добавили вложения для текущей итерации. Для корректной маршрутизации документа необходимо добавить все необходимые вложения."/>
					<parameter name="condition" value="list:jbr.dsp=jbr.noDsp"/>
				</validator>
				<!--post-process package="com.aplana.dbmi.jbr.processors" class="CheckAndDoDependentChangeState" runOrder="5">
					<parameter name="filters" value="jbr.distributionItem.method#jbr.distributionItem.method.delo"/>
					<parameter name="linkAttr" value="jbr.Distribution.DistributionList" />
					<parameter name="affectedStates" value="draft" />
					<parameter name="targetState" value="jbr.distributionItem.readyForSend" />
				</post-process-->
				<!-- Заполнить идентификатор запроса, если он пустой (МЭДО ОГ) -->
				<post-process class="CopyAttributeToChildren" runOrder="10">
					<parameter name="from" value="regnumber"/>
					<parameter name="to" value="jbr.medo_og.reqId"/>
					<parameter name="type" value="S"/>
					<parameter name="attr_condition_1" value="link:jbr.reg.doctype=jbr.medo_og.informationRequestDocType"/>
					<parameter name="attr_condition_2" value="string:jbr.medo_og.reqId=null"/>
				</post-process>
				<post-process class="GenerateUIDProcessor" runOrder="15">
					<parameter name="attrId" value="text:uid"/>
					<parameter name="setIfEmptyOnly" value ="true"/>
				</post-process>
				<!-- При регистрации определенных шаблонов должно меняться и название карточки -->
				<post-process class="DeepGenerateName" runOrder="40">
					<!-- <parameter name="format" value="{0} {1}"/> -->
					<parameter name="format" value="{0} {1} от {2}, {3}"/>
					<!--  <parameter name="format" value="{0} {1}, {3}" />  -->
					<parameter name="dstAttrId" value="string: NAME" />
					<parameter name="srcAttrIds"
						value="
						link: JBR_INFD_TYPEDOC;
						string: regnumber;
						date: regdate;
						text: JBR_INFD_SHORTDESC
					" />
					<parameter name="forceSave" value="true" />
					<parameter name="forceSaveMode" value="ATTRIBUTE" />
				</post-process>

				<!-- Keywords for search -->
				<post-process class="DeepGenerateName" runOrder="42">
					<parameter name="format"
					           value="{0}; {1}; {2}; {3}; {4}; {5}; {6}; {7}; {8}; {9}; {10}; {11}; {12}; {13}" />
					<parameter name="dstAttrId" value="string: KEYWORDS" />
					<parameter name="srcAttrIds"
					           value="
						user: author;
						link: jbr.distributionItem.recipient;
						link: jbr.visa.ext.set;
						user: jbr.outcoming.signatory;
						user: jbr.resolutionExecutor;
						link: jbr.outcoming.receiver;
						link: jbr.reg.doctype;
						link: regjournal;
						link: index;
						user: jbr.incoming.registrar;
						user: jbr.npa.curator;
						user: jbr.ext.curator.editor;
						link: jbr.outcoming.executor;
						link: jbr.outcoming.receiver.user;
					" />
					<parameter name="maxArgStrLen" value="3000" />
					<parameter name="forceSave" value="true" />
					<parameter name="forceSaveMode" value="ATTRIBUTE" />
				</post-process>

				<!-- Создание карточек "Уведомление: документ направлен" (1065) -->
				<post-process class="PopulateChildrenWithConditions" runOrder="145">
					<parameter name="template" value="med.reportSent"/>
					<parameter name="attach" value="jbr.incoming.notification"/>
					<parameter name="specialFlag" value="MEDO"/>
					<parameter name="attach_dest_card_index" value="1"/>
					<parameter name="copy" value="
								date:jbr.incoming.outdate->date:medo.incoming.outdate;
								string:jbr.incoming.outnumber->string:medo.incoming.outnumber;
								string:JBR_REGD_REGNUM->string:MED_REGD_REGNUM;
								date:regdate->date:medo.regdate;
								#0@string:JBR_REGD_REGNUM->text:MED_OUTNUM_FOIV;
								#0@date:regdate->date:MED_DATE_OUTNUM_FOIV;
								#0@number:_ID->link:medo.outcomeLink
							"/>
					<!-- найти связанные входящие документы с определенным типом связи, в определенном статусе-->
					<parameter name="attr_link_path" value="_STATE;
															jbr.relatdocs@_CARDTYPE;
															_TEMPLATE;
															list: jbr.deliveryItem.method;
															~
															#1@jbr.incoming.notification@_TEMPLATE;
															link:medo.outcomeLink@number:_ID"/>
					<!-- тип связи «В ответ на», «Ответ», «Исполнение», «Связан с», «Во исполнение», «В связи с»
						шаблон - входящий
						статус - «зарегистрирован», «в дело»
						id = id исходящего документа в связанных с текущей карточкой уведомлениях-->
					<parameter name="attr_link_values" value="	=101,104;
																=1502,1503,1504,1600,1601,2134;
																=224,864;
																=1592;
																~
																=1065;
																#number:_ID"/>
					<parameter name="forceSaveChilds" value="true"/>
					<!-- Переводим в синхроннику, т.к. могут проблемы с дедлоками-->
					<parameter name="async" value="false" />
				</post-process>
				<!--
					Если регистрационный номер начинается на "ог-", то выставляем атрибут JBR_DEST_TEMPLATE,
					значение которого будет использоваться в процессе выгрузки документа по ГОСТу в качестве шаблона документа,
					что позволит выгружать Исходящие документы как ОГ.
					PS К сожалению отказаться от испоьзования хардкода в значении константы нельзя, так как это потребует
					значительных изменений в ахитектуре выгрузки по ГОСТу, либо значительное переписывание логики процессора
					с добавлением нового типа атрибута (т.к мы не может хранить шаблон как атрибут)
				
				Функционал временно отключен согласно задаче BR4J00039949
				<post-process class="SetAttributeValueProcessor" runOrder="99">
					<parameter name="attributeId" value="number: jbr.outcoming.destinationTemplate"/>
					<parameter name="value" value="1550"/>
					<parameter name="onlyCurrentCard" value="true" />
					<parameter name="saveKind" value="SAVE_ATTR"/>
					<parameter name="attr_condition" value="string: regnumber%=(?ui)^(ог-).+$"/>
				</post-process>
				-->
			</specific>
			<specific property="card.template" value="jbr.npa" load="true">
				<!-- При регистрации определенных шаблонов должно меняться и название карточки -->
				<post-process class="DeepGenerateName" runOrder="10">
					<!-- <parameter name="format" value="{0} {1}, {3}" /> -->
					<parameter name="format" value="{0} {1} от {2}, {3}"/> 
					<parameter name="dstAttrId" value="string: NAME" />
					<parameter name="srcAttrIds"
						value="
						link: JBR_INFD_TYPEDOC;
						string: regnumber; 
						date: regdate; 
						text: JBR_INFD_SHORTDESC
					" />
				</post-process>
				<post-process class="DeepGenerateName" runOrder="12">
					<parameter name="format"
					           value="{0}; {1}; {2}; {3}; {4}; {5}; {6}; {7}; {8}; {9}; {10}; {11}; {12}" />
					<parameter name="dstAttrId" value="string: KEYWORDS" />
					<parameter name="srcAttrIds"
					           value="
						user: author;
						link: jbr.hidden.external.executor;
						link: jbr.visa.ext.set;
						user: jbr.outcoming.signatory;
						user: jbr.incoming.addressee;
						user: jbr.resolutionExecutor;
						link: jbr.reg.doctype;
						link: regjournal;
						link: index;
						user: jbr.incoming.registrar;
						user: jbr.incoming.inspector;
						user: jbr.ext.curator.editor;
						user: jbr.npa.curator
					" />
					<parameter name="maxArgStrLen" value="3000" />
				</post-process>
			</specific>
			<specific property="card.template" value="jbr.incoming" load="true">
				<post-process class="GenerateUIDProcessor" runOrder="30">
					<parameter name="attrId" value="text:uid"/>
					<parameter name="setIfEmptyOnly" value ="true"/>
				</post-process>
				<post-process class="DeepGenerateName" runOrder="40">
					<!--  <parameter name="format" value="{0} {1}, (номер исходящего {3}), {4}" />  -->
					<parameter name="format" value="{0} {1} от {2}, (номер исходящего {3}), {4}"/>
					<parameter name="dstAttrId" value="string: NAME" />
					<parameter name="srcAttrIds"
						value="
						link: JBR_INFD_TYPEDOC; 
						string: regnumber; 
						date: regdate; 
						string: JBR_REGD_NUMOUT;
						text: JBR_INFD_SHORTDESC
					" />
					<parameter name="forceSave" value="true" />
					<parameter name="forceSaveMode" value="ATTRIBUTE" />
				</post-process>
				<!-- Keywords for search -->
				<post-process class="DeepGenerateName" runOrder="42">
					<parameter name="format"
					           value="{0}; {1}; {2}; {3}; {4}; {5}; {6}; {7}; {8}; {9}; {10}; {11}; {12}; {13}" />
					<parameter name="dstAttrId" value="string: KEYWORDS" />
					<parameter name="srcAttrIds"
					           value="
							user: author;
							link: jbr.hidden.external.executor;
							link: jbr.incoming.sender;
							link: jbr.signext;
							user: jbr.incoming.addressee;
							link: jbr.incoming.foiv;
							user: jbr.incoming.inspector;
							link: jbr.reg.doctype;
							link: regjournal;
							link: index;
							link: jbr.incoming.sender.actual;
							user: jbr.ext.curator.editor;
							user: jbr.incoming.registrar;
							user: jbr.npa.curator
					" />
					<parameter name="maxArgStrLen" value="3000" />
					<parameter name="forceSave" value="true" />
					<parameter name="forceSaveMode" value="ATTRIBUTE" />
				</post-process>
			</specific>
			<specific property="card.template" value="jbr.ord" load="true">
				<post-process class="GenerateUIDProcessor" runOrder="30">
					<parameter name="attrId" value="text:uid"/>
					<parameter name="setIfEmptyOnly" value ="true"/>
				</post-process>
				<post-process class="DeepGenerateName" runOrder="40">
					<!--  <parameter name="format" value="{0} {1}, {3}" /> -->
					<parameter name="format" value="{0} {1} от {2}, {3}" />
					<parameter name="dstAttrId" value="string: NAME" />
					<parameter name="srcAttrIds"
						value="
						link: JBR_INFD_TYPEDOC; 
						string: regnumber; 
						date: regdate; 
						text: JBR_INFD_SHORTDESC
					" />
					<parameter name="forceSave" value="true" />
					<parameter name="forceSaveMode" value="ATTRIBUTE" />
				</post-process>
			</specific>
			<specific property="card.template" value="jbr.informationrequest" load="true">
				<post-process class="DeepGenerateName" runOrder="40">
					<!--
						parameter name="format" value="Информационный запрос {0} от {1}"/
					-->
					<parameter name="format" value="Информационный запрос {0}" />
					<parameter name="dstAttrId" value="NAME" />
					<parameter name="srcAttrIds" value="string: regnumber; date: regdate" />
					<parameter name="forceSave" value="true" />
					<parameter name="forceSaveMode" value="ATTRIBUTE" />
				</post-process>
			</specific>
			<specific property="card.template" value="jbr.interndoc" load="true">
				<post-process class="DeepGenerateName" runOrder="40">
					<parameter name="format" value="{0} {1} от {2}, {3}"/>
					<!-- <parameter name="format" value="{0} {1}, {3}" />  -->
					<parameter name="dstAttrId" value="string: NAME" />
					<parameter name="srcAttrIds"
						value="
						link: JBR_INFD_TYPEDOC; 
						string: regnumber; 
						date: regdate; 
						text: JBR_INFD_SHORTDESC
					" />
					<parameter name="forceSave" value="true" />
					<parameter name="forceSaveMode" value="ATTRIBUTE" />
				</post-process>
				<!-- Keywords for search -->
				<post-process class="DeepGenerateName" runOrder="42">
					<parameter name="format"
					           value="{0}; {1}; {2}; {3}; {4}; {5}; {6}; {7}; {8}; {9}; {10}; {11}; {12}" />
					<parameter name="dstAttrId" value="string: KEYWORDS" />
					<parameter name="srcAttrIds"
					           value="
						user: author;
						user: jbr.ext.curator.editor;
						link: jbr.hidden.external.executor;
						link: jbr.visa.ext.set;
						user: jbr.outcoming.signatory;
						user: jbr.incoming.addressee;
						user: jbr.resolutionExecutor;
						link: jbr.reg.doctype;
						link: regjournal;
						link: index;
						user: jbr.incoming.registrar;
						user: jbr.incoming.inspector;
						user: jbr.npa.curator
					" />
					<parameter name="maxArgStrLen" value="3000" />
					<parameter name="forceSave" value="true" />
					<parameter name="forceSaveMode" value="ATTRIBUTE" />
				</post-process>
			<post-process class="DoDependentChangeState" runOrder="50">
				<parameter name="affectedStates" value="outofdate" />
				<parameter name="linkAttr" value="jbr.files" />
				<parameter name="targetState" value="outofdate.internal" />
			</post-process>
			<post-process class="DoDependentChangeState" runOrder="51">
				<parameter name="linkAttr" value="jbr.info.files" />
				<parameter name="targetState" value="outofdate.internal" />
			</post-process>
				<post-process class="DoDependentChangeState" runOrder="52">	
					<parameter name="targetState" value="outofdate.internal" />
					<parameter name="linkAttr" value="jbr.visa.set.hidden@jbr.files" />
				</post-process>
				<post-process class="DoDependentChangeState" runOrder="53">	
					<parameter name="targetState" value="outofdate.internal" />
					<parameter name="linkAttr" value="jbr.sign.set@jbr.sign.attachments" />
				</post-process>
			</specific>
		</specific>
		
		
		<!--
			В "Элементе списка рассылки" при переходе из "Черновик" в "Готов к
			отправке", если поле "Способ отправки" имеет значение e-mail,
			выполняем переход "Готов к отправке" -> "Отправлен"
		-->
		<specific property="workflowMove.id" value="jbr.distributionItem.ready">
			<post-process class="JumpStatePostProcessor">
				<parameter name="dest_wfm" value="jbr.distributionItem.send" />
				<parameter name="attr_test" value="jbr.distributionItem.method=jbr.distributionItem.method.email" /> 
			</post-process>
		</specific>
		<!--
			В "Элементе списка рассылки" при переходе из "Черновик" в "Готов к
			отправке", если поле "Способ отправки" имеет значение ДЕЛО,
			выполняем переход "Готов к отправке" -> "Отправлен"
		-->
		<specific property="workflowMove.id" value="jbr.distributionItem.ready">
			<post-process class="JumpStatePostProcessor">
				<parameter name="dest_wfm" value="jbr.distributionItem.send" />
				<parameter name="attr_test"	value="jbr.distributionItem.method=jbr.distributionItem.method.delo" />
			</post-process>
		</specific>
		<specific property="workflowMove.toState" value="jbr.distributionItem.notSent">
			<!-- Заполняем "Статус рассылки" в карточке "Элемент списка рассылки" в соответствии
				 со статусом карточки: -->
			<!-- Не отправлено -->
			<pre-process class="SetAttributeValueProcessor">
				<parameter name="attributeId" value="list:jbr.sendStatus"/>
				<parameter name="value" value="jbr.sendStatus.notLanded" />
			</pre-process>
		</specific>

		<!--
			В карточке "Элемент списка рассылки" при переходе из "Готов к
			отправке" в "Отправлено", значение атрибута "Номер последней попытки"
			устанавливаем текущей датой
		-->
		<specific property="workflowMove.id" value="jbr.distributionItem.send">
			<post-process class="RefreshDateAttribute">
				<parameter name="dateAttributeId" value="jbr.distributionItem.timeAttempt" />
			</post-process>
		</specific>

		<!-- Установка даты рассылки -->
		<specific property="workflowMove.id" value="jbr.distributionItem.send">
			<post-process class="RefreshDateAttribute">
				<parameter name="dateAttributeId" value="jbr.distributionItem.sendDate" />
			</post-process>
		</specific>
		<specific property="workflowMove.toState" value="jbr.sendInfo.registered">
			<!-- Заполняем "Статус рассылки" в карточке "Элемент списка рассылки" в соответствии
				 со статусом карточки информация о доставке: -->
			<!-- Зарегистрировано -->
			<pre-process class="SetAttributeValueProcessor">
				<parameter name="attributeId" value="list:jbr.sendStatus"/>
				<parameter name="value" value="jbr.sendStatus.registered" />
				<parameter name="linkId" value="jbr.distributionItem.sendInfo" />
				<parameter name="isReversedLink" value="true" />
			</pre-process>
		</specific>		
		<specific property="workflowMove.toState" value="jbr.sendInfo.refused">
			<!-- Заполняем "Статус рассылки" в карточке "Элемент списка рассылки" в соответствии
				 со статусом карточки информация о доставке: -->
			<!-- Отклонено -->
			<pre-process class="SetAttributeValueProcessor">
				<parameter name="attributeId" value="list:jbr.sendStatus"/>
				<parameter name="value" value="jbr.sendStatus.registrationRefused" />
				<parameter name="linkId" value="jbr.distributionItem.sendInfo" />
				<parameter name="isReversedLink" value="true" />
			</pre-process>
		</specific>	

		<!-- Отправка на подписание ... Закоментировано Лариным М 09.01.2010. Для исключения зацикливание. Подписывающего создаем аналогично ОРД
		на переходе из подготовки в согласование  -->
		<!-- specific property="workflowMove.toState" value="sign" load="true">
			<specific property="card.template" value="jbr.outcoming"
				load="true"-->
				<!--
					Создание карточки "Подпись" соответствующей "Подписанту" исходящего
				-->
				<!--pre-process class="SendToSignatory">
					<parameter name="srcPersonListAttrId" value="jbr.outcoming.signatory" />
					<parameter name="dstCardsListAttrId" value="jbr.sign.set" />
					<parameter name="newCardTemplateId" value="jbr.sign" />
					<parameter name="linkedPersonAttrId" value="jbr.sign.person" />
				</pre-process>
			</specific>
		</specific-->

		<!-- Перевод документа на регистрацию в случае подписания министром -->
		<specific property="workflowMove.id" value="jbr.outcoming.sign.filling-in-file-index">
			<post-process class="OutcomingAfterSignProcessor" />
		</specific>

		<!--
			Авто-перевод "Отчет об исполнении" (1044) авто переход в "Утверждён"
			(status=207) во время перехода (wfm=702314) из "Принят" в "Исполнен"
			(cardstate.done=206, ), если родительское поручение не на контроле.
			workflowmove.jbr.report.int.execute=702314 (!) remmed at (2010/10/03
			by Abdullin, on Shillin's demand) контрольность теперь роли не
			играет. <specific property="workflowMove.id"
			value="jbr.report.int.execute"> <specific property="card.template"
			value="jbr.report.internal" load="true"> <post-process
			class="JumpStatePostProcessor"> <parameter name="dest_wfm"
			value="jbr.report.int.approve"/> <parameter
			name="link_attr_fromParent" value="jbr.reports"/> <parameter
			name="parent_attr_test"
			value="jbr.oncontrol=jbr.commission.control.no" /> </post-process>
			</specific> </specific>
		-->

		<!--
			Авто-перевод "Отчет об исполнении" (1044) авто переход в "Утверждён"
			(status=207, wfm=702315) во время перехода "Исполнить" (wfm=818917)
			из "Обработка помощником"(73992) в "Исполнен"(206), если родительское
			поручение не на контроле.
			workflowmove.jbr.report.execute.after_assistant=818917 (!) remmed at
			(2010/10/03 by Abdullin, on Shillin's demand) контрольность теперь
			роли не играет. <specific property="workflowMove.id"
			value="jbr.report.execute.after_assistant"> <specific
			property="card.template" value="jbr.report.internal" load="true">
			<post-process class="JumpStatePostProcessor"> <parameter
			name="dest_wfm" value="jbr.report.int.approve"/> <parameter
			name="link_attr_fromParent" value="jbr.reports"/> <parameter
			name="parent_attr_test"
			value="jbr.oncontrol=jbr.commission.control.no" /> </post-process>
			</specific> </specific>
		-->

		<!--
			Шаблон "Отчет об исполнении" (1044) при переходе в "Утвержден"
			(status=207,ratified) надо проставить дату-время в атрибут "Дата
			утверждения" ("ADMIN_713534"=jbr.report.int.approvaldate)
		-->
		<specific property="workflowMove.id" value="jbr.report.int.approve">
			<specific property="card.template" value="jbr.report.internal"
				load="true">
				<pre-process class="RefreshDateAttribute" runOrder="5">
					<parameter name="dateAttributeId" value="jbr.report.int.approvaldate" />
				</pre-process>
				<post-process class="CopyCardLink" runOrder="10">
					<parameter name="from" value="@jbr.report.result"/>
					<parameter name="to" value="->jbr.report.int.document@jbr.relatdocs"/>
					<parameter name="merge" value="true"/>
				</post-process>

                <!-- Copy attachments from Report to BaseDocument -->
                <post-process class="CopyCardLink" runOrder="20">
                    <parameter name="from" value="@jbr.report.attachments"/>
                    <parameter name="to" value="->jbr.report.int.document@jbr.files"/>
					<parameter name="condition" value="link:jbr.report.int.document@jbr.dsp=jbr.noDsp"/>
                    <parameter name="merge" value="true"/>
                </post-process>
			</specific>
		</specific>

		<!--
			При изменении статуса карточки "Отчет (внутренний)" (1044) и приходе
			в состояние "Отправлен" = cardstate.sent=556656
		-->
		<!-- specific property="workflowMove.id" value="jbr.report.int.send" -->
		<specific property="workflowMove.toState" value="sent" load="true">
			<specific property="card.template" value="jbr.report.internal"
				load="true">
				<pre-process runOrder="5">ForceSaveCardProcessor</pre-process>
				<!--
					Чтобы заполнить название
				-->

				<!--
					Если есть помощник, прокидываем ему ... "Помощнику на обработку"
					(818914) из "Отправлен" (556656) в "Обработка помощником" (73992)
					workflowmove.jbr.report.execute.for_assistant=818914
					"Исполнитель"(U) = personattribute.jbr.report.int.executor =
					ADMIN_702335
				-->
				<post-process class="AssistantPassthrough" runOrder="10">
					<parameter name="personAttr" value="jbr.report.int.executor" />
					<parameter name="moveYes" value="jbr.report.execute.for_assistant" />
				</post-process>
			</specific>
			<specific property="card.template" value="jbr.DistributionListElement"
				load="true">
				<!-- Перед отправкой ЭСР в Отправлен проверяем привязку к ДО-->
				<validator class="TestEmptyAttrProcessor">
					<parameter name="test_attr" value="backLink: jbr.DistributionListElement.ParentDoc"/>
					<parameter name="must_empty" value="false"/>
					<parameter name="no_system_user" value="true"/>
					<parameter name="empty_message" value="Перед отправкой ЭСР необходимо сохранить документ-основание."/>
				</validator>
			</specific>
			<!-- Заполняем "Статус рассылки" в карточке "Элемент списка рассылки" в соответствии
				 со статусом карточки: -->
			<!-- Отправлено -->
			<pre-process class="SetAttributeValueProcessor">
				<parameter name="attributeId" value="list:jbr.sendStatus"/>
				<parameter name="value" value="jbr.sendStatus.sent" /> 
			</pre-process>
		</specific>

		<!--
			"Отчет об исполнении" (1044)(wf=702237) переход "В АРМ руководителю"
			из "Обработка помощником"/73992 в "Рассмотрение"/102:
			workflowmove.jbr.report.execute.investigate=818916 а так же при
			возврате на доработку 702317 из Исполнен/206 в Отправлен/556656
		-->
		<specific property="workflowMove.id" value="jbr.report.execute.investigate">
			<pre-process class="GenerateName">
				<parameter name="format" value="0" />
				<parameter name="dstAttrId" value="string: JBR_RPT_ARMFLAG" />
				<parameter name="forceSave" value="true" />
			</pre-process>
			<post-process class="RefreshDateAttribute">
				<parameter name="dateAttributeId" value="jbr.visa.income_date" />
				<parameter name="updateIfNullOnly" value="false" />
			</post-process>
		</specific>
		<specific property="workflowMove.id" value="jbr.report.int.decline">
			<pre-process class="GenerateName">
				<parameter name="format" value="0" />
				<parameter name="dstAttrId" value="string: JBR_RPT_ARMFLAG" />
				<parameter name="forceSave" value="true" />
			</pre-process>
		</specific>

		<!--
			При изменении статуса карточки "Ознакомления" (524) и "Ознакомление с
			поручением" (1144)
		-->
		<specific property="workflowMove.id" value="jbr.info.execute.wait.for_assistant">
			<!--
				Если есть помощник, прокидываем ему ... "Помощнику на
				обработку"(825529): из "Ожидание рассмотрения" (52086) в "Обработка
				помощником"(73992) workflowmove.jbr.info.execute.assistant=825529
				"нет помощника" : из "Ожидание рассмотрения" (52086) в
				"Ознакомление"(64424)
				workflowmove.jbr.info.execute.no_assistant=825576 "Кому
				ознакомиться:"
				personattribute.jbr.information.person=JBR_FOR_INFORMATION
			-->
			<!-- template.jbr.adnotamCommission=1144: -->
			<specific property="card.template" value="jbr.adnotamCommission"
				load="true">
				<post-process class="AssistantPassthrough">
					<parameter name="personAttr" value="ADMIN_726874" />
					<parameter name="moveYes" value="jbr.info.execute.assistant" />
					<parameter name="moveNo" value="jbr.info.execute.no_assistant" />
				</post-process>
			</specific>

			<!-- template.jbr.inform=524: -->
			<specific property="card.template" value="jbr.inform" load="true">
				<post-process class="AssistantPassthrough">
					<parameter name="personAttr" value="jbr.information.person" />
					<parameter name="moveYes" value="jbr.info.execute.assistant" />
					<parameter name="moveNo" value="jbr.info.execute.no_assistant" />
				</post-process>
			</specific>
		</specific>

		<!-- При изменении статуса  карточки "Отчет внешний" (1064)  -->
		<specific property="workflowMove.id" value="jbr.report.ext.send">
			<!-- Создание карточек рассылки для внешних исполнителей -->
			<post-process class="PopulateChildrenWithConditions" runOrder="10">
				<parameter name="template" value="jbr.DistributionListElement" />
				<parameter name="attach"
					value="jbr.Distribution.DistributionList" />
				<parameter name="attach_dest_card_index" value="2"/>
				<parameter name="split"
					value="#1@link:jbr.incoming.organization->jbr.distributionItem.recipient" />
				<parameter name="attr_link_path" value="link:jbr.report.ext.executor@link:jbr.incoming.organization
														~
														link:jbr.report.ext.document@_TEMPLATE"/>
				<parameter name="attr_link_values" value="#null
														~
														=jbr.citizenrequest"/>
				<parameter name="forceSaveChilds" value="true"/>
				<parameter name="attach_unique" value="link:jbr.distributionItem.recipient;list:_STATE"/>
				<parameter name="copy" value="#0@user:jbr.responsible_dow.resp_dow->user:jbr.responsible_dow.resp_dow.externalExecution"/>
				<parameter name="async" value="false"/>
			</post-process>
			<pre-process runOrder="5">ForceSaveCardProcessor</pre-process>
			
			<post-process class="RefreshDateAttribute" runOrder="10">
				<parameter name="dateAttributeId" value="jbr.visa.income_date" />
				<parameter name="updateIfNullOnly" value="false" />
			</post-process>
		</specific>
		
		<!-- 
            Проверка поля "Текущий отчет" при изменении статуса  карточки "Отчет внешний" (1064)
            из статуса "Отправлен" (556656) в статус "Исполнен" (206)
        -->
        <specific property="workflowMove.id" value="jbr.report.ext.execute" runOrder="5">
            <validator class="TestEmptyAttrProcessor">
                <parameter name="test_attr" value="text: jbr.report.currentText"/>
                <parameter name="must_empty" value="false"/>
                <parameter name="empty_message" value="Атрибут 'Текущий отчет' должен быть заполнен."/>
            </validator>
        </specific>

		<!--  Проверка наличия карточки подписи для Должность + ФИО -->
		<!--
			Для шаблонов: Исходящий (364) Исходящие на информационный запрос
			(775) Исходящий на обращения граждан (777)
			workflowmove.jbr.outcoming.preparation.agreement=355547
		-->
		<specific property="workflowMove.id" value="jbr.outcoming.preparation.agreement">
			<pre-process runOrder="5">EnsureSignCard</pre-process>
			
			<!-- при этом переходе перетряхивать "Карточки виз скрытые" -->
			<!--post-process class="ProcDynaRole" package="com.aplana.dbmi.jbr.processors.dbproc" runOrder="7">
					<parameter name="rootIsCurrent" value="true"/>
					<parameter name="destIsCurrent" value="true"/>
					<parameter name="nodeLinkAttrIds" value="jbr.visa.set;jbr.visa.enclosedSet"/>
					<parameter name="srcAttrIds" value="jbr.visa.person"/>

					<parameter name="writeOperation" value="OVERWRITE"/>
					<parameter name="srcAttrIds" value="_ID"/>
					<parameter name="copyToDestinations" value="*:jbr.visa.set.hidden"/>
			</post-process-->
			
			<post-process class="CopyAttributeToChildren" runOrder="12">
				<parameter name="from" value="jbr.visa.round"/>
				<parameter name="to" value="jbr.visa.visa.round"/>
				<parameter name="linkAttrId" value="jbr.visa.set"/>
				<!-- игнорируем визы в корзине -->
				<parameter name="ignoredStates" value="trash"/>
			</post-process>
			<!-- Копируем атрибут JBR_SEND_TO_RENEG из документа родителя в карточки Согласования -->
			<post-process class="CopyAttributeToChildren" runOrder="999">
		        <parameter name="children" value="JBR_VISA_VISA"/> 
		        <parameter name="from" value="JBR_SEND_TO_RENEG"/>
		        <parameter name="to" value="JBR_SEND_TO_RENEG"/>
		        <parameter name="type" value="L"/> 
			</post-process>
		</specific>

		<!--
			Для шаблонов: ОРД (764)
			workflowmove.jbr.ord.preparation.agreement=274765
		-->
		<specific property="workflowMove.id" value="jbr.ord.preparation.agreement">
			<!-- Проверяем, чтобы на любой итерации отправки по маршруту были неустаревшие вложения, независимо от обязательности вложений в БД -->
			<validator class="TestEmptyAttrProcessor" runOrder="1">
				<parameter name="test_attr" value="link:jbr.files"/>
				<parameter name="must_empty" value="false"/>
				<parameter name="hidden_status" value="outofdate"/>
				<parameter name="empty_message" value="Вы не добавили вложения для текущей итерации. Для корректной маршрутизации документа необходимо добавить все необходимые вложения."/>
				<parameter name="condition" value="list:jbr.dsp=jbr.noDsp"/>
			</validator>
			
			<pre-process runOrder="5">EnsureSignCard</pre-process>
			
			<!-- при этом переходе перетряхивать "Карточки виз скрытые" -->
			<post-process class="ProcDynaRole" package="com.aplana.dbmi.jbr.processors.dbproc" runOrder="7">
					<parameter name="rootIsCurrent" value="true"/>
					<parameter name="destIsCurrent" value="true"/>
					<parameter name="nodeLinkAttrIds" value="jbr.visa.set;jbr.visa.enclosedSet"/>
					<parameter name="srcAttrIds" value="jbr.visa.person"/>

					<parameter name="writeOperation" value="OVERWRITE"/>
					<parameter name="srcAttrIds" value="_ID"/>
					<parameter name="copyToDestinations" value="*:jbr.visa.set.hidden"/>
			</post-process>
			
			<post-process class="CopyAttributeToChildren" runOrder="11">
				<parameter name="from" value="jbr.visa.round"/>
				<parameter name="to" value="jbr.visa.visa.round"/>
				<parameter name="linkAttrId" value="jbr.visa.set"/>
				<!-- игнорируем визы в корзине -->
				<parameter name="ignoredStates" value="trash"/>
			</post-process>
			<!-- Копируем атрибут JBR_SEND_TO_RENEG из документа родителя в карточки Согласования -->
			<post-process class="CopyAttributeToChildren" runOrder="1">
		        <parameter name="children" value="JBR_VISA_VISA"/> 
		        <parameter name="from" value="JBR_SEND_TO_RENEG"/>
		        <parameter name="to" value="JBR_SEND_TO_RENEG"/>
		        <parameter name="type" value="L"/> 
			</post-process>
		</specific>
		
		<!-- Выполняем тот же набор действий для перехода "На рассмотрении у руководителя" - "Согласование" -->
		<specific property="workflowMove.id" value="jbr.ord.manager.approving">
			<pre-process runOrder="5">EnsureSignCard</pre-process>
			
			<!-- при этом переходе перетряхивать "Карточки виз скрытые" -->
			<post-process class="ProcDynaRole" package="com.aplana.dbmi.jbr.processors.dbproc" runOrder="7">
					<parameter name="rootIsCurrent" value="true"/>
					<parameter name="destIsCurrent" value="true"/>
					<parameter name="nodeLinkAttrIds" value="jbr.visa.set;jbr.visa.enclosedSet"/>
					<parameter name="srcAttrIds" value="jbr.visa.person"/>

					<parameter name="writeOperation" value="OVERWRITE"/>
					<parameter name="srcAttrIds" value="_ID"/>
					<parameter name="copyToDestinations" value="*:jbr.visa.set.hidden"/>
			</post-process>
			
			<post-process class="CopyAttributeToChildren" runOrder="11">
				<parameter name="from" value="jbr.visa.round"/>
				<parameter name="to" value="jbr.visa.visa.round"/>
				<parameter name="linkAttrId" value="jbr.visa.set"/>
				<!-- игнорируем визы в корзине -->
				<parameter name="ignoredStates" value="trash"/>
			</post-process>
		</specific>

		<!--
			При приходе в состояние "Зарегистрирован"(101) проставим "Дату
			регистрации" cardstate.registration=101
			dateattribute.jbr.maindoc.regdate=JBR_REGD_DATEREG Для шаблонов ОРД и
			Внутрений
		-->
		<specific property="workflowMove.toState" value="registration"
			load="true">
			<specific property="card.template" value="jbr.ord" load="true">
				<pre-process class="RefreshDateAttribute">
					<parameter name="dateAttributeId" value="jbr.maindoc.regdate" />
					<parameter name="updateIfNullOnly" value="true" />
				</pre-process>
			</specific>
			<specific property="card.template" value="jbr.npa" load="true">
				<pre-process class="RefreshDateAttribute">
					<parameter name="dateAttributeId" value="jbr.maindoc.regdate" />
					<parameter name="updateIfNullOnly" value="true" />
				</pre-process>
			</specific>
			<specific property="card.template" value="jbr.interndoc"
				load="true">
				<pre-process class="RefreshDateAttribute">
					<parameter name="dateAttributeId" value="jbr.maindoc.regdate" />
					<parameter name="updateIfNullOnly" value="true" />
				</pre-process>
			</specific>
			<specific property="card.template" value="jbr.outcoming"
				load="true">
				<pre-process class="RefreshDateAttribute">
					<parameter name="dateAttributeId" value="jbr.maindoc.regdate" />
					<!-- параметр ниже устанволен в true по багу 18368
					     иначе он перетирал зарезервированную дату регистрации    
					-->
					<parameter name="updateIfNullOnly" value="true" />
				</pre-process>
			</specific>
		</specific>

		<!--
			Для шаблонов: Внутренний документ (784)
			workflowmove.jbr.interndoc.preparation.agreement=273955
		-->
		<specific property="workflowMove.id" value="jbr.interndoc.preparation.agreement">
		
			<pre-process runOrder="5">EnsureSignCard</pre-process>
			
			<!-- при этом переходе перетряхивать "Карточки виз скрытые" -->
			<post-process class="ProcDynaRole" package="com.aplana.dbmi.jbr.processors.dbproc" runOrder="7">
					<parameter name="rootIsCurrent" value="true"/>
					<parameter name="destIsCurrent" value="true"/>
					<parameter name="nodeLinkAttrIds" value="jbr.visa.set;jbr.visa.enclosedSet"/>
					<parameter name="srcAttrIds" value="jbr.visa.person"/>

					<parameter name="writeOperation" value="OVERWRITE"/>
					<parameter name="srcAttrIds" value="_ID"/>
					<parameter name="copyToDestinations" value="*:jbr.visa.set.hidden"/>
			</post-process>
			
			<post-process class="CopyAttributeToChildren" runOrder="11">
				<parameter name="from" value="jbr.visa.round"/>
				<parameter name="to" value="jbr.visa.visa.round"/>
				<parameter name="linkAttrId" value="jbr.visa.set"/>
				<!-- игнорируем визы в корзине -->
				<parameter name="ignoredStates" value="trash"/>
			</post-process>
			<!-- Копируем атрибут JBR_SEND_TO_RENEG из документа родителя в карточки Согласования -->
			<post-process class="CopyAttributeToChildren" runOrder="1">
		        <parameter name="children" value="JBR_VISA_VISA"/> 
		        <parameter name="from" value="JBR_SEND_TO_RENEG"/>
		        <parameter name="to" value="JBR_SEND_TO_RENEG"/>
		        <parameter name="type" value="L"/> 
			</post-process>
		</specific>

		<!--
			Любой приход в статус "Подготовка"(cardstate.preparation=106) пишем
			единичку (признак повтора) в атрибут повтора перехода
		-->
		<specific property="workflowMove.toState" value="preparation" load="true">
			<specific property="workflowMove.fromState" value="trash" equals="false">
				<pre-process class="GenerateName">
					<parameter name="format" value="1" />
					<parameter name="dstAttrId" value="number: JBR_RPT_000000106" />
					<parameter name="forceSave" value="true" />
				</pre-process>
			</specific>

			<specific property="workflowMove.fromState" value="trash" equals="true">
				<pre-process class="GenerateName" runOrder="5">
					<parameter name="format" value="0" />
					<parameter name="dstAttrId" value="number: JBR_RPT_000000106" />
					<parameter name="forceSave" value="true" />
				</pre-process>
				<pre-process class="ClearCardAttributePostProcessorEx" runOrder="10">
					<parameter name="attrId" value="string:regnumber" />
				</pre-process>
				<pre-process class="ClearCardAttributePostProcessorEx" runOrder="15">
					<parameter name="attrId" value="number:regnumberdigital" />
				</pre-process>
				<pre-process class="ClearCardAttributePostProcessorEx" runOrder="20">
					<parameter name="attrId" value="date:regdate" />
				</pre-process>
				<pre-process class="ClearCardAttributePostProcessorEx" runOrder="25">
					<parameter name="attrId" value="user:jbr.outgoing.registrar" />
				</pre-process>
				<post-process class="ForceSaveCardProcessor" runOrder="30" />
				
				<!-- При возврате Исх/Вн/ОРД из корзины Подпись переводим в Черновик -->
				<specific property="card.template" value="jbr.outcoming" load="true">
					<post-process class="DoDependentChangeState" runOrder="90">
						<parameter name="linkAttr" value="jbr.sign.set" />
						<parameter name="targetState" value="draft" />
					</post-process>
				</specific>
				<specific property="card.template" value="jbr.interndoc" load="true">
					<post-process class="DoDependentChangeState" runOrder="90">
						<parameter name="linkAttr" value="jbr.sign.set" />
						<parameter name="targetState" value="draft" />
					</post-process>
				</specific>
				<specific property="card.template" value="jbr.ord" load="true">
					<post-process class="DoDependentChangeState" runOrder="90">
						<parameter name="linkAttr" value="jbr.sign.set" />
						<parameter name="targetState" value="draft" />
					</post-process>
				</specific>
			</specific>
			
			<!-- BR4J00009013, BR4J00032379
			При отправке на доработку, если стоит флаг "Да", то нужно проходить весь маршрут согласования заново -->
			<post-process package="com.aplana.dbmi.jbr.processors" class="CallOriginsProcessor" runOrder="10">	
				<parameter name="backLinkAttrId" value="jbr.visa.set@jbr.visa.parent"/>
				<parameter name="processorClassName" value="com.aplana.dbmi.jbr.processors.DoDependentChangeState"/>
				<parameter name="calling@affectedStates" value="jbr.visa.agreed,jbr.visa.cancelled" />
				<parameter name="calling@targetState" value="jbr.visa.draft" />
				<parameter name="calling@linkAttr" value="jbr.visa.set" />
				<parameter name="local@attr_test" value="jbt.send.reneg=jbr.commission.control.yes"/>
			</post-process>
		</specific>

		<!--
			Любой приход в статус "Черновик"(cardstate.draft=1) пишем единичку
			(признак повтора) в атрибут повтора перехода
		-->
		<specific property="workflowMove.toState" value="draft" load="true">
			<specific property="workflowMove.fromState" value="trash" equals="false">
				<pre-process class="GenerateName">
					<parameter name="format" value="1" />
					<parameter name="dstAttrId" value="number: JBR_RPT_000000001" />
				<parameter name="forceSave" value="true" />
			</pre-process>
			</specific>

			<specific property="workflowMove.fromState" value="trash" equals="true">
				<pre-process class="GenerateName" runOrder="5">
					<parameter name="format" value="0" />
					<parameter name="dstAttrId" value="number: JBR_RPT_000000001" />
					<parameter name="forceSave" value="true" />
				</pre-process>
				<pre-process class="ClearCardAttributePostProcessorEx" runOrder="10">
					<parameter name="attrId" value="string:regnumber" />
				</pre-process>
				<pre-process class="ClearCardAttributePostProcessorEx" runOrder="15">
					<parameter name="attrId" value="number:regnumberdigital" />
				</pre-process>
				<pre-process class="ClearCardAttributePostProcessorEx" runOrder="20">
					<parameter name="attrId" value="date:regdate" />
				</pre-process>
				<pre-process class="ClearCardAttributePostProcessorEx" runOrder="25">
					<parameter name="attrId" value="user:jbr.outgoing.registrar" />
				</pre-process>
				<post-process class="ForceSaveCardProcessor" runOrder="30" />
			</specific>
			
			<post-process class="ClearCardAttributePostProcessorEx" runOrder="5">
				<parameter name="attrId" value="text:jbr.visa.current.resolution" />
				<parameter name="templateId" value="jbr.visa" />
			</post-process>
			<post-process class="ClearCardAttributePostProcessorEx" runOrder="10">
				<parameter name="attrId" value="text:jbr.sign.current.resolution" />
				<parameter name="templateId" value="jbr.sign" />
			</post-process>
		</specific>
		<!--
			Устанавливаем дату и время отправки на ознакомление
			"JBR_INF_DATE_DISPATH" карточки Ознакомление, при переходе в статус
			Ознакомление
		-->
		<specific property="workflowMove.toState" value="acquaintance"
			load="true">
			<post-process class="RefreshDateAttribute">
				<parameter name="dateAttributeId" value="jbr.information.dispathDate"/>
			</post-process>
			<!-- Сбрасываем признак Скрыть в АРМ у шаблонов Ознакомление-->
			<specific property="card.template" value="jbr.inform_incoming" load="true">
				<post-process class="SetAttributeValueProcessor">
					<parameter name="attributeId" value="list:jbr.arm.hide"/>
					<parameter name="value" value="jbr.commission.control.no" />
				</post-process>
			</specific>
		</specific>

		<!-- В Исходящем при переходе в статус Зарегистрирован 
			 для каждого кто указан в "Получателе исходящего" создаем карточку Элемент списка рассылки 
			 и добавляет их к "Листу рассылки"-->
		<!-- BR4J00037191 При переходе "зарегистрировать" -->	 		
		<specific property="workflowMove.id" value="jbr.outcoming.before-registration.registration">		
				<!--pre-process class="PopulateChildren">
					<parameter name="template" value="jbr.DistributionListElement" />
					<parameter name="attach" value="jbr.Distribution.DistributionList" />
					<parameter name="split"
						value="link:jbr.outcoming.receiver->link:jbr.distributionItem.recipient" />
				</pre-process-->
		</specific>

		<!-- При переходе по маршруту -->
		<specific property="workflowMove.id" value="jbr.outcoming.preparation.registration">		
				<!--pre-process class="PopulateChildren">
					<parameter name="template" value="jbr.DistributionListElement" />
					<parameter name="attach" value="jbr.Distribution.DistributionList" />
					<parameter name="split"
						value="link:jbr.outcoming.receiver->link:jbr.distributionItem.recipient" />
				</pre-process-->
		</specific>

		<!--
			В Входящем при переходе в статус "Зарегистрирован" (101) проверяем,
			что бы "Дата документа" была меньше или равна текущей
		-->
		<specific property="workflowMove.toState" value="registration">
			<specific property="card.template" value="jbr.incoming"
				load="true">
				<validator class="ChkDateProcessor">
					<parameter name="checkdate1" value="jbr.incoming.outdate;;+0" />
					<parameter name="dateFormat" value="dd.MM.yyyy" />
				</validator>
			</specific>
		</specific>

		<specific property="workflowMove.id" value="jbr.outcoming.preparation.agreement">
			<!--Проверяем заполненность хотя бы одного из атрибутов: 
				Адресат ОГ (jbr.outcoming.citizenAppealAddressee) и Получатель исходящего (jbr.outcoming.receiver)
				Переход исходящего из Подготовка в Согласование (355547) 
			-->
			<validator class="CheckAttribute">
				<parameter name="attr_test" value="jbr.outcoming.citizenAppealAddressee#NULL;jbr.outcoming.receiver#NULL"/>
				<parameter name="nls_err_msgid_arg3" value="jbr.card.check.attribute.performer.1"/>
				<!--parameter name="checkIfUserHasRole" value="jbr.minister;jbr.minister.helper;jbr.deputyMinister;jbr.deputyMinister.helper"/-->
			</validator>
			
			<!-- Проверяем, чтобы на любой итерации отправки по маршруту были неустаревшие вложения, независимо от обязательности вложений в БД -->
			<validator class="TestEmptyAttrProcessor" runOrder="1">
				<parameter name="test_attr" value="link:jbr.files"/>
				<parameter name="must_empty" value="false"/>
				<parameter name="hidden_status" value="outofdate"/>
				<parameter name="empty_message" value="Вы не добавили вложения для текущей итерации. Для корректной маршрутизации документа необходимо добавить все необходимые вложения."/>
				<parameter name="condition" value="list:jbr.dsp=jbr.noDsp"/>
			</validator>
		</specific>

		<specific property="workflowMove.id" value="jbr.outcoming.agreement.sign">
			<pre-process class="SetCurrentPersonTo">
				<parameter name="farPersonAttribute" value="jbr.sign.set->author" />
			</pre-process>
			<post-process class="CopyAttributeToChildren">
				<parameter name="from" value="jbr.sign.round" />
				<parameter name="to" value="jbr.sign.sign.round" />
				<parameter name="linkAttrId" value="jbr.sign.set" />
			</post-process>
		</specific>

		<specific property="workflowMove.id" value="jbr.ord.agreement.sign">
			<post-process class="CopyAttributeToChildren">
				<parameter name="from" value="jbr.sign.round" />
				<parameter name="to" value="jbr.sign.sign.round" />
				<parameter name="linkAttrId" value="jbr.sign.set" />
			</post-process>
		</specific>

		<specific property="workflowMove.id" value="jbr.interndoc.agreement.sign">
			<post-process class="CopyAttributeToChildren">
				<parameter name="from" value="jbr.sign.round" />
				<parameter name="to" value="jbr.sign.sign.round" />
				<parameter name="linkAttrId" value="jbr.sign.set" />
			</post-process>
		</specific>

		<!--
			При переходе документа в состояние "На регистрации", если заполнено
			поле Регистрационный номер, выполняем переход "На регистрации" ->
			"Зарегистрирован"
		-->
		<specific property="workflowMove.id" value="jbr.ord.sign.before-registration">
			<!-- post-process class="JumpStatePostProcessor">
				<parameter name="dest_wfm"
					value="jbr.ord.before-registration.registration" />
				<parameter name="attr_test_1" value="regnumber#" />
				<parameter name="attr_test_2" value="regnumber#null" />
			</post-process -->
		</specific>
		<specific property="workflowMove.id" value="jbr.interndoc.sign.before-registration">
			<post-process class="JumpStatePostProcessor">
				<parameter name="dest_wfm"
					value="jbr.interndoc.before-registration.registration" />
				<parameter name="attr_test_1" value="regnumber#" />
				<parameter name="attr_test_2" value="regnumber#null" />
				<parameter name="attr_test_3" value="index#null" />
			</post-process>
		</specific>
		<specific property="workflowMove.id" value="jbr.outcoming.filling-in-file-index.before-registration">
			<post-process class="JumpStatePostProcessor">
				<parameter name="dest_wfm"
					value="jbr.outcoming.before-registration.registration" />
				<parameter name="attr_test_1" value="regnumber#" />
				<parameter name="attr_test_2" value="regnumber#null" />
				<parameter name="attr_test_3" value="index#null" />
			</post-process>
		</specific>

		<!--
			Устанавливаем дату и персону принявшую решение по резервированию
			номера
		-->
		<specific property="workflowMove.toState" value="jbr.reservationRequest.registered"
			load="true">
			<post-process class="RefreshCurrentPersonAttribute" runOrder="5">
				<parameter name="personAttributeId" value="jbr.reservationRequest.registrator" />
			</post-process>
			<post-process class="RefreshDateAttribute" runOrder="10">
				<parameter name="dateAttributeId" value="jbr.reservationRequest.decisionDate" />
			</post-process>
			<!-- Обновляет поле NAME у ДО -->
			<post-process class="CallOriginsProcessor" runOrder="90">
				<parameter name="backLinkAttrId" value="backLink: jbr.reservationRequest.document" />
				<parameter name="processorClassName"
					value="com.aplana.dbmi.jbr.processors.GenerateName" />
				<parameter name="format" value="{0} {1} от {2}, {3}" />
				<parameter name="dstAttrId" value="string: NAME" />
				<parameter name="srcAttrIds"
					value="link: JBR_INFD_TYPEDOC; 
					string: regnumber; 
					date: regdate; 
					text: JBR_INFD_SHORTDESC" />
				<parameter name="forceSave" value="true" />
				<parameter name="forceSaveMode" value="ATTRIBUTE" />
			</post-process>
		</specific>

		<!--
			Устанавливаем дату и персону принявшую решение по отказу в
			резервировании номера
		-->
		<specific property="workflowMove.toState" value="jbr.reservationRequest.rejected"
			load="true">
			<post-process class="RefreshCurrentPersonAttribute" runOrder="5">
				<parameter name="personAttributeId" value="jbr.reservationRequest.registrator" />
			</post-process>
			<post-process class="RefreshDateAttribute" runOrder="10">
				<parameter name="dateAttributeId" value="jbr.reservationRequest.decisionDate" />
			</post-process>
		</specific>

		<!-- Перевод неконтрольных входящих документов из статуса исполнен в статус готов к списанию в дело -->
		<specific property="workflowMove.id" value="jbr.interndoc.execution.done">
			<!-- post-process class="CurrentChangeState">
				<parameter name="MoveId" value="jbr.interndoc.done.ready-to-write-off"/>
				<parameter name="ConditionAttrHasValue" value="list:jbr.incoming.oncontrol=1433"/>
			</post-process-->
			<post-process class="JumpStatePostProcessor">
				<parameter name="dest_wfm" value="jbr.interndoc.done.ready-to-write-off" />

				<!--
					all theese variants works normally and are equevalent to each
					other: parameter name="attr_test"
					value="jbr.incoming.oncontrol=jbr.incoming.control.no" //
					comment="1433" parameter name="attr_test"
					value="jbr.incoming.oncontrol#jbr.incoming.control.yes" //
					comment="1432" parameter name="attr_test"
					value="list:JBR_IMPL_ONCONT#1432" // comment="1432 == yes"
				-->
				<parameter name="attr_test"
					value="jbr.incoming.oncontrol#jbr.incoming.control.yes" />
			</post-process>
		</specific>
	
		<!-- 
			Возвращаем на доработку Внутренний. 
			Переводим вложения документа в статус "Устаревший" и инкрементируем номер итерации.  
		-->
		<specific property="workflowMove.id" value="jbr.interndoc.agreement.preparation">
			<post-process class="ChangingOfFilesStatusToOutdated" runOrder="-5" />
			<post-process class="AttributeIncrementProcessor" runOrder="0">
				<parameter name="AttrId" value="jbr.visa.round" />
			</post-process>
			<!-- Копируем атрибут JBR_SEND_TO_RENEG из документа родителя в карточки Согласования -->
			<post-process class="CopyAttributeToChildren" runOrder="1">
		        <parameter name="children" value="JBR_VISA_VISA"/> 
		        <parameter name="from" value="JBR_SEND_TO_RENEG"/>
		        <parameter name="to" value="JBR_SEND_TO_RENEG"/>
		        <parameter name="type" value="L"/> 
			</post-process>
		</specific>
		<specific property="workflowMove.id" value="jbr.interndoc.sign.preparation">
			<post-process class="ChangingOfFilesStatusToOutdated" runOrder="5" />
			<post-process class="AttributeIncrementProcessor" runOrder="10">
				<parameter name="AttrId" value="jbr.visa.round" />
			</post-process>
			<post-process class="AttributeIncrementProcessor" runOrder="15">
				<parameter name="AttrId" value="jbr.sign.round" />
			</post-process>
		</specific>
		
		<!-- 
			Возвращаем на доработку ОРД. 
			Переводим вложения документа в статус "Устаревший" и инкрементируем номер итерации.  
		-->
		<specific property="workflowMove.id" value="jbr.ord.agreement.preparation">
			<post-process class="ChangingOfFilesStatusToOutdated" runOrder="-5" />
			<post-process class="AttributeIncrementProcessor" runOrder="0">
				<parameter name="AttrId" value="jbr.visa.round" />
			</post-process>
			<!-- Копируем атрибут JBR_SEND_TO_RENEG из документа родителя в карточки Согласования -->
			<post-process class="CopyAttributeToChildren" runOrder="1">
		        <parameter name="children" value="JBR_VISA_VISA"/> 
		        <parameter name="from" value="JBR_SEND_TO_RENEG"/>
		        <parameter name="to" value="JBR_SEND_TO_RENEG"/>
		        <parameter name="type" value="L"/> 
			</post-process>			
		</specific>
		<specific property="workflowMove.id" value="jbr.ord.sign.preparation">
			<post-process class="ChangingOfFilesStatusToOutdated" runOrder="5" />
			<post-process class="AttributeIncrementProcessor" runOrder="10">
				<parameter name="AttrId" value="jbr.visa.round" />
			</post-process>
			<post-process class="AttributeIncrementProcessor" runOrder="15">
				<parameter name="AttrId" value="jbr.sign.round" />
			</post-process>
		</specific>


		<specific property="workflowMove.id" value="jbr.outcoming.agreement.preparation">
				<!-- 
			Возвращаем на доработку Исходящий. 
			Переводим вложения документа в статус "Устаревший" и инкрементируем номер итерации.  
		-->
			<post-process class="ChangingOfFilesStatusToOutdated" runOrder="-5" />
			<post-process class="AttributeIncrementProcessor" runOrder="0">
				<parameter name="AttrId" value="jbr.visa.round" />
			</post-process>
			<!-- Копируем атрибут JBR_SEND_TO_RENEG из документа родителя в карточки Согласования -->
			<post-process class="CopyAttributeToChildren" runOrder="1">
		        <parameter name="children" value="JBR_VISA_VISA"/> 
		        <parameter name="from" value="JBR_SEND_TO_RENEG"/>
		        <parameter name="to" value="JBR_SEND_TO_RENEG"/>
		        <parameter name="type" value="L"/> 
			</post-process>			

		</specific>
		<specific property="workflowMove.id" value="jbr.outcoming.sign.preparation">
			<post-process class="ChangingOfFilesStatusToOutdated" runOrder="5" />
			<post-process class="AttributeIncrementProcessor" runOrder="10">
				<parameter name="AttrId" value="jbr.visa.round" />
			</post-process>
			<post-process class="AttributeIncrementProcessor" runOrder="15">
				<parameter name="AttrId" value="jbr.sign.round" />
			</post-process>
		</specific>
		<!-- Регистрация "Входящего"/"ОГ" из статуса "Поступивший из ВС"-->
		<specific property="workflowMove.id" value="jbr.incoming.register">
			<specific property="card.template" value="jbr.incoming"  load="true">
				<validator class="CheckCardNumber" runOrder="10">
					<!-- (YNikitin, 2013/07/09, BR4J00030089) Для  перехода в Зарегистрирован из Поступившие из ВС необходимо учитывать атрибут Проверить на повторность-->
					<parameter name="attr_test" value="jbr.income.repeatChkEnable=jbr.commission.control.yes"/>
					<parameter name="numberCanBeNullOrEmpty" value="true"/>
					<parameter name="dateCanBeNull" value="true"/>
					<parameter name="organizationCanBeNull" value="true"/>
				</validator>
				<pre-process package="com.aplana.dbmi.jbr.processors" class="RefreshDateAttribute" runOrder="0">
					<parameter name="dateAttributeId" value="regdate"/>
					<parameter name="updateIfNullOnly" value="true"/>
				</pre-process>
				<!-- Создание карточек "Уведомление: документ зарегистрирован" (1025) -->
				<pre-process class="PopulateChildrenWithConditions" runOrder="5">
					<parameter name="template" value="med.documentRegister"/>
					<parameter name="attach" value="jbr.incoming.notification"/>
					<parameter name="copy" value="
								date:jbr.incoming.outdate->date:medo.incoming.outdate;
								string:jbr.incoming.outnumber->string:medo.incoming.outnumber;
								string:JBR_REGD_REGNUM->string:MED_REGD_REGNUM;
								date:regdate->date:medo.regdate
							"/>
					<parameter name="attr_condition" value="list:jbr.deliveryItem.method=1592"/>
					<parameter name="forceSaveChilds" value="true"/>
				</pre-process>
				<!-- Создание карточки Уведомление ГОСТ (1501), если способ доставки = ДЕЛО -->
				<pre-process class="PopulateChildrenWithConditions" runOrder="10">
					<parameter name="template" value="jbr.gost.ack" />
					<parameter name="attach" value="jbr.incoming.notification" />
					<parameter name="attr_condition" value="list:jbr.deliveryItem.method=1521" />
					<parameter name="copy" value="
						date:regdate->date:jbr.gost.ack.regDate;
						string:regnumber->string:jbr.gost.ack.regNumber;
						link:jbr.original.source->link:jbr.original.source
					" />
					<parameter name="set" value="
						list:jbr.gost.ack.type=jbr.gost.ack.type.registered
					" />
					<parameter name="forceSaveMode" value="CARD" />
					<parameter name="forceSaveChilds" value="true"/>
				</pre-process>

			</specific>
			
			<specific property="card.template" value="jbr.incomingpeople"  load="true">
				<!-- Проверяем тип сообщения и если = без подписи, выставляем Автор обращения = Аноним -->
				<validator class="SetAttributeValueWithConditionProcessor" runOrder="1">
					<parameter name="attr_condition_1" value="link:jbr.AuthType=15921"/>
					<parameter name="attributeId" value="link:jbr.ReqAuthor"/>
					<parameter name="value" value="10" />
					<parameter name="saveKind" value="SAVE_ATTR"/>
				</validator>
				<validator class="TestEmptyAttrProcessor"  runOrder="3">
					<parameter name="test_attr" value="string:jbr.og.firstname"/>
					<parameter name="linked_attr" value="link:jbr.ReqAuthor"/>
					<parameter name="linked_attr_test" value=".template=jbr.medo_og.requestAuthor"/>
					<parameter name="condition" value="link:jbr.ReqAuthor=NULL" />
					<parameter name="must_empty" value="false"/>
					<parameter name="empty_message" value="Обязательная характеристика 'Информация о заявителе. Имя' не заполнена."/>
				</validator>
				<validator class="TestEmptyAttrProcessor"  runOrder="5">
					<parameter name="test_attr" value="string:jbr.og.lastname"/>
					<parameter name="linked_attr" value="link:jbr.ReqAuthor"/>
					<parameter name="linked_attr_test" value=".template=jbr.medo_og.requestAuthor"/>
					<parameter name="condition" value="link:jbr.ReqAuthor=NULL" />
					<parameter name="must_empty" value="false"/>
					<parameter name="empty_message" value="Обязательная характеристика 'Информация о заявителе. Фамилия' не заполнена."/>
				</validator>
				<validator class="CheckCardNumber"  runOrder="10">
					<parameter name="attr_test" value="jbr.income.repeatChkEnable=jbr.commission.control.yes"/>
					<parameter name="numberCanBeNullOrEmpty" value="true"/>
					<parameter name="dateCanBeNull" value="true"/>
					<parameter name="organizationCanBeNull" value="true"/>

					<parameter name="dups.templates" value="jbr.incomingpeople"/>
					<parameter name="dups.states.ignored" value="draft, inmedo, trash"/>
				</validator>
				<pre-process package="com.aplana.dbmi.jbr.processors" class="RefreshDateAttribute" runOrder="0">
					<parameter name="dateAttributeId" value="regdate"/>
					<parameter name="updateIfNullOnly" value="true"/>
				</pre-process>
				<!-- Создание карточек "Уведомление: документ зарегистрирован" (1025) -->
				<pre-process class="PopulateChildrenWithConditions"  runOrder="5">
					<parameter name="template" value="med.documentRegister"/>
					<parameter name="attach" value="jbr.incoming.notification"/>
					<parameter name="copy" value="
								date:jbr.incoming.outdate->date:medo.incoming.outdate;
								string:jbr.incoming.outnumber->string:medo.incoming.outnumber;
								string:JBR_REGD_REGNUM->string:MED_REGD_REGNUM;
								date:regdate->date:medo.regdate
							"/>
					<parameter name="attr_condition" value="list:jbr.deliveryItem.method=1592"/>
					<parameter name="forceSaveChilds" value="true"/>
				</pre-process>
				
				<!-- Создание карточки Уведомление ГОСТ (1501), если способ доставки = ДЕЛО -->
				<pre-process class="PopulateChildrenWithConditions" runOrder="10">
					<parameter name="template" value="jbr.gost.ack" />
					<parameter name="attach" value="jbr.incoming.notification" />
					<parameter name="attr_condition" value="list:jbr.deliveryItem.method=1521" />
					<parameter name="copy" value="
						date:regdate->date:jbr.gost.ack.regDate;
						string:regnumber->string:jbr.gost.ack.regNumber;
						link:jbr.original.source->link:jbr.original.source
					" />
					<parameter name="set" value="
						list:jbr.gost.ack.type=jbr.gost.ack.type.registered
					" />
					<parameter name="forceSaveMode" value="CARD" />
					<parameter name="forceSaveChilds" value="true"/>
				</pre-process>

			</specific>
			<!-- Копирование Отправителя из Входящего во все вложенные карточки "Файл"-->
				<post-process class="CopyAttributeToChildren" runOrder="5">
					<parameter name="from" value="jbr.incoming.sender" />
					<parameter name="to" value="jbr.file.sender" />
					<parameter name="children" value="jbr.files" />
				</post-process>
				<post-process class="ForceSaveCardProcessor" runOrder="10"> 
					<parameter name="linkAttrId" value="jbr.files" /> 
				</post-process>
				<post-process class="RefreshDateAttribute" runOrder="20">
					<parameter name="dateAttributeId" value="jbr.visa.income_date" />
					<parameter name="updateIfNullOnly" value="false" />
				</post-process>
		</specific>
		<!-- При переходе "Отказать в регистрации" входящего и ОГ из статуса "Создан по МЭДО" -->
		<specific property="workflowMove.id" value="jbr.incoming.registration.refuse">
			<specific property="card.template" value="jbr.incoming" load="true">
				<!-- Создание карточек "Уведомление: в регистрации документа отказано" (1025) -->
				<pre-process class="PopulateChildrenWithConditions" runOrder="5">
					<parameter name="template" value="med.registrDenied"/>
					<parameter name="attach" value="jbr.incoming.notification"/>
					<parameter name="copy" value="
								date:jbr.incoming.outdate->date:medo.incoming.outdate;
								string:jbr.incoming.outnumber->string:medo.incoming.outnumber;
								date:create->date:medo.doc.created
							"/>
					<parameter name="attr_condition" value="list:jbr.deliveryItem.method=1592"/>
					<parameter name="forceSaveChilds" value="true"/>
				</pre-process>
				<!-- Создание карточки Уведомление ГОСТ (1501), если способ доставки = ДЕЛО -->
				<pre-process class="PopulateChildrenWithConditions" runOrder="10" >
					<parameter name="template" value="jbr.gost.ack" />
					<parameter name="attach" value="jbr.incoming.notification" />
					<parameter name="attr_condition" value="list:jbr.deliveryItem.method=1521" />
					<parameter name="copy" value="
						string:JBR_MEDO_REASON_RFS->text:jbr.gost.ack.errorDescr;
						link:jbr.original.source->link:jbr.original.source
					" />
					<parameter name="set" value="
						list:jbr.gost.ack.type=jbr.gost.ack.type.registered
					" />
					<parameter name="forceSaveMode" value="CARD" />
					<parameter name="forceSaveChilds" value="true"/>
				</pre-process>
				
			</specific>
			
			<specific property="card.template" value="jbr.incomingpeople" load="true">
				<!-- Создание карточек "Уведомление: в регистрации документа отказано" (1025) -->
				<pre-process class="PopulateChildrenWithConditions" runOrder="5">
					<parameter name="template" value="med.registrDenied"/>
					<parameter name="attach" value="jbr.incoming.notification"/>
					<parameter name="copy" value="
								date:jbr.incoming.outdate->date:medo.incoming.outdate;
								string:jbr.incoming.outnumber->string:medo.incoming.outnumber;
								date:create->date:medo.doc.created
							"/>
					<parameter name="attr_condition" value="list:jbr.deliveryItem.method=1592"/>
					<parameter name="forceSaveChilds" value="true"/>
				</pre-process>
				<!-- Создание карточки Уведомление ГОСТ (1501), если способ доставки = ДЕЛО -->
				<pre-process class="PopulateChildrenWithConditions" runOrder="10" >
					<parameter name="template" value="jbr.gost.ack" />
					<parameter name="attach" value="jbr.incoming.notification" />
					<parameter name="attr_condition" value="list:jbr.deliveryItem.method=1521" />
					<parameter name="copy" value="
						string:JBR_MEDO_REASON_RFS->text:jbr.gost.ack.errorDescr;
						link:jbr.original.source->link:jbr.original.source
					" />
					<parameter name="set" value="
						list:jbr.gost.ack.type=jbr.gost.ack.type.registered
					" />
					<parameter name="forceSaveMode" value="CARD" />
					<parameter name="forceSaveChilds" value="true"/>
				</pre-process>
			</specific>
			
		</specific>
		<specific property="card.template" value="jbr.visa" load="true">
			<!-- при любом переходе визы, перетряхивать "Карточки виз скрытые" у документа-основания, если тот находится в статусе подготовка или согласование -->
				<post-process class="CallOriginsProcessor" runOrder="0">
					<parameter name="backLinkAttrId" value="jbr.visa.parent"/>
					<parameter name="attr_test" value=".state=106"/>
					<parameter name="attr_test" value=".template#324"/>
					<parameter name="async" value="true"/>
					<parameter name="processorClassName" 
						   value="com.aplana.dbmi.jbr.processors.dbproc.ProcDynaRole"/>
					<parameter name="rootIsCurrent" value="true"/>
					<parameter name="destIsCurrent" value="true"/>
					<parameter name="nodeLinkAttrIds" value="jbr.visa.set;link:ADMIN_6814498"/>
					<parameter name="writeOperation" value="OVERWRITE"/>
					<parameter name="srcAttrIds" value="_ID"/>
					<parameter name="copyToDestinations" value="*:jbr.visa.set.hidden"/>
				</post-process>

				<post-process class="CallOriginsProcessor" runOrder="1">
					<parameter name="backLinkAttrId" value="jbr.visa.parent"/>
					<parameter name="attr_test" value=".state=106"/>
					<parameter name="attr_test" value=".template=324"/>
					<parameter name="async" value="true"/>
					<parameter name="processorClassName" 
						   value="com.aplana.dbmi.jbr.processors.dbproc.ProcDynaRole"/>
					<parameter name="rootIsCurrent" value="true"/>
					<parameter name="destIsCurrent" value="true"/>
					<parameter name="nodeLinkAttrIds" value="jbr.visa.res;link:ADMIN_6814498"/>
					<parameter name="writeOperation" value="OVERWRITE"/>
					<parameter name="srcAttrIds" value="_ID"/>
					<parameter name="copyToDestinations" value="*:jbr.visa.set.hidden"/>
				</post-process>

				<post-process class="CallOriginsProcessor" runOrder="5">
					<parameter name="backLinkAttrId" value="jbr.visa.parent"/>
					<parameter name="attr_test" value=".state=107"/>
					<parameter name="attr_test" value=".template#324"/>
					<parameter name="async" value="true"/>
					<parameter name="processorClassName" 
						   value="com.aplana.dbmi.jbr.processors.dbproc.ProcDynaRole"/>
					<parameter name="rootIsCurrent" value="true"/>
					<parameter name="destIsCurrent" value="true"/>
					<parameter name="nodeLinkAttrIds" value="jbr.visa.set;link:ADMIN_6814498"/>
					<parameter name="writeOperation" value="OVERWRITE"/>
					<parameter name="srcAttrIds" value="_ID"/>
					<parameter name="copyToDestinations" value="*:jbr.visa.set.hidden"/>
				</post-process>

				<post-process class="CallOriginsProcessor" runOrder="5">
					<parameter name="backLinkAttrId" value="jbr.visa.parent"/>
					<parameter name="attr_test" value=".state=107"/>
					<parameter name="attr_test" value=".template=324"/>
					<parameter name="async" value="true"/>
					<parameter name="processorClassName" 
						   value="com.aplana.dbmi.jbr.processors.dbproc.ProcDynaRole"/>
					<parameter name="rootIsCurrent" value="true"/>
					<parameter name="destIsCurrent" value="true"/>
					<parameter name="nodeLinkAttrIds" value="jbr.visa.res;link:ADMIN_6814498"/>
					<parameter name="writeOperation" value="OVERWRITE"/>
					<parameter name="srcAttrIds" value="_ID"/>
					<parameter name="copyToDestinations" value="*:jbr.visa.set.hidden"/>
				</post-process>
		</specific>
		
		<!--
			Обновляем дату поступления при переходе в статус "Регистрация" (200)
		-->
		<specific property="workflowMove.toState" value="before-registration" load="true">
			<pre-process class="RefreshDateAttribute">
				<parameter name="dateAttributeId" value="jbr.visa.income_date" />
				<parameter name="updateIfNullOnly" value="false" />
			</pre-process>
		</specific>
		
		<!-- При переходе документа в статус "Корзина" -->
		<specific property="workflowMove.toState" value="trash">

			<!-- (YNikitin, 2011/04/14) при переводе визы в корзину права забираем (полностью перетряхиваем)-->
			<specific property="card.template" value="jbr.visa" load="true">
				<!-- (YNikitin, 2011/04/15) все дочерние визы независимо от их статуса переводим в "Корзину" -->
				<post-process class="DoDependentChangeState" runOrder="0">
					<parameter name="linkAttr" value="jbr.visa.enclosedSet"/>
					<parameter name="targetState" value="trash"/>
				</post-process>
				
			</specific>
			
			<!-- (Smirnov A. : 10.07.12) После перевода документа в статус «Корзина» связанная с ним карточка
			запроса на резервирование номера  переводится в статус «Корзина» 
			<post-process class="DoDependentChangeState">
				<parameter name="linkAttr" value="jbr.doc.reservationRequests" />
				<parameter name="affectedStates" value="jbr.reservationRequest.published" />
				<parameter name="targetState" value="trash" />
				<parameter name="moveId" value="jbr.reservationRequest.to.trash" />
			</post-process>-->
			
			<!-- (Smirnov A. : 24.07.12) Элемент списка рассылки,Подпись,Визы,Запрос на резервирование номера,
										 Ознакомление,Рассмотрение,Поручение
										 в статус "Отменен"-->
			<post-process class="DoDependentChangeState" runOrder="5">
				<parameter name="affectedStates" value="draft,prepareDELIVERY" />
				<parameter name="linkAttr" value="jbr.Distribution.DistributionList" />
				<parameter name="targetState" value="poruchcancelled" />
			</post-process>
			<post-process class="DoDependentChangeState" runOrder="10">
				<parameter name="affectedStates" value="draft,jbr.sign.assigned,jbr.sign.assistent,jbr.sign.waiting" />
				<parameter name="linkAttr" value="jbr.sign.set" />
				<parameter name="targetState" value="poruchcancelled" />
			</post-process>
			<post-process class="DoDependentChangeState" runOrder="15">
				<parameter name="affectedStates" value="draft,jbr.visa.assigned,jbr.visa.waitEnclosed,jbr.visa.assistent,jbr.visa.waiting" />
				<parameter name="linkAttr" value="jbr.visa.set" />
				<parameter name="targetState" value="poruchcancelled" />
			</post-process>
			
			<specific property="card.template" value="jbr.resolution" load="true">
				<!-- Проверка что нет запросов на смену рассматривающего в статусе Рассмотрение -->
				<validator class="CheckResolutions" runOrder="1"> 
					<parameter name="ATTR_NAME_4_LIST" value="jbr.main.doc->jbr.request.to.change.consid"/>
					<parameter name="LIST_OK" value="draft,poruchcancelled,cancelled,jbr.importedDoc.processed"/>
					<parameter name="INFO_CARD_FMT_4" value="Не обработано запросов на смену рассматривающего: {0}"/>
				</validator>
				<post-process class="DoDependentChangeState" runOrder="16">
					<parameter name="affectedStates" value="draft,jbr.visa.assigned,jbr.visa.waitEnclosed,jbr.visa.assistent,jbr.visa.waiting" />
					<parameter name="linkAttr" value="backLink:jbr.visa.res" />
					<parameter name="targetState" value="poruchcancelled" />
				</post-process>
			</specific>
			
			<post-process class="DoDependentChangeState" runOrder="20">
				<parameter name="affectedStates" value="jbr.reservationRequest.published,jbr.reservationRequest.registered,jbr.reservationRequest.rejected" />
				<parameter name="linkAttr" value="jbr.doc.reservationRequests" />
				<parameter name="targetState" value="poruchcancelled" />
			</post-process>
			<post-process class="DoDependentChangeState" runOrder="25">
				<parameter name="affectedStates" value="draft,jbr.exam.assigned,acquaintance,jbr.sign.assistent" />
				<parameter name="linkAttr" value="jbr.inform.list" />
				<parameter name="targetState" value="poruchcancelled" />
			</post-process>
			<post-process class="DoDependentChangeState" runOrder="30">
				<parameter name="affectedStates" value="draft,jbr.exam.assigned,boss.assistant,jbr.exam.archive.boss,jbr.exam.waiting,jbr.exam.execute.boss" />
				<parameter name="linkAttr" value="jbr.acquant" />
				<parameter name="targetState" value="poruchcancelled" />
			</post-process>
			<post-process class="DoDependentChangeState" runOrder="35">
				<parameter name="affectedStates" value="draft" />
				<parameter name="linkAttr" value="backLink:JBR_ALL_RESOLUTIONS" />
				<parameter name="targetState" value="poruchcancelled" />
			</post-process>
		</specific>
		
		<!-- При переходе документа в статус "Отменен" -->
		<specific property="workflowMove.toState" value="poruchcancelled">
			<specific property="card.template" value="jbr.resolution" load="true">
				<!-- Проверка что нет запросов на смену рассматривающего в статусе Рассмотрение -->
				<validator class="CheckResolutions" runOrder="1"> 
					<parameter name="ATTR_NAME_4_LIST" value="jbr.main.doc->jbr.request.to.change.consid"/>
					<parameter name="LIST_OK" value="draft,poruchcancelled,cancelled,jbr.importedDoc.processed"/>
					<parameter name="INFO_CARD_FMT_4" value="Не обработано запросов на смену рассматривающего: {0}"/>
				</validator>
				<post-process class="DoDependentChangeState" runOrder="2">
					<parameter name="affectedStates" value="draft" />
					<parameter name="linkAttr" value="backLink:jbr.reports" />
					<parameter name="targetState" value="poruchcancelled" />
				</post-process>
				<post-process class="DoDependentChangeState" runOrder="6">
					<parameter name="affectedStates" value="draft,sent" />
					<parameter name="linkAttr" value="backLink:jbr.resolution.ExtReport" />
					<parameter name="targetState" value="poruchcancelled" />
				</post-process>
				<post-process class="RefreshDateAttribute" runOrder="10">
					<parameter name="dateAttributeId" value="jbr.maindoc.canceldate" />
				</post-process>
			</specific>
			
			<!-- (2014/04/07, YNikitin, BR4J00035578) При отмене Рассмотрений очищаем Зоны ДОУ, чтобы у рассматривающих таких рассмотрений права на ДО исчезли гарантированно -->
			<specific property="card.template" value="jbr.rassm" load="true">
				<post-process class="ClearCardAttributePostProcessorEx" runOrder="20">
					<parameter name="attrId" value="link:jbr.zoneDOW" />
				</post-process>
			</specific>
		</specific>
		
		<specific property="workflowMove.id" value="jbr.state_service.accepted">
			<post-process class="SetAttributeValueProcessor">
				<parameter name="attributeId" value="list:jbr.state_service.cardProcessing"/>
				<parameter name="value" value="jbr.state_service.cardProcessing.processed" />
				<parameter name="saveKind" value="SAVE_ATTR"/>
			</post-process>
		</specific>
		
		<specific property="workflowMove.toState" value="jbr.importedDoc.processed">
			<specific class="NotificationSendSelector" package="com.aplana.dbmi.jbr.util">
				<post-process class="PopulateChildrenWithConditions">
					<parameter name="template" value="jbr.gost.ack" />
					<parameter name="attach" value="jbr.incoming.notification" />
					<parameter name="attach_dest_card_index" value="1"/>
					<parameter name="copy" value="
							link:jbr.original.source->link:jbr.original.source
						" />
					<parameter name="attr_link_path" value="
										backLink:ImportedDocument.document@list:jbr.deliveryItem.method;
										_TEMPLATE" />
					<parameter name="attr_link_values" value="
										=1521;
										=224,864
					"/>
					<parameter name="set" value="
						list:jbr.gost.ack.type=jbr.gost.ack.type.recieved
					" />
					<parameter name="forceSaveMode" value="CARD" />
					<parameter name="forceSaveChilds" value="true"/>
				</post-process>	
			</specific>			
		</specific>
		<specific property="workflowMove.id" value="jbr.importedDoc.notRecoverable">
				<post-process class="PopulateChildrenWithConditions">
					<parameter name="template" value="jbr.gost.ack" />
					<parameter name="attach" value="jbr.incoming.notification" />
					<parameter name="attach_dest_card_index" value="0"/>
					<parameter name="copy" value="
							text:jbr.importedDoc.result->text:jbr.gost.ack.errorDescr;
							number:_ID->link:jbr.original.source							
						" />
					<parameter name="attr_link_path" value="
										list:jbr.dmsi.deliveryType;
										_TEMPLATE" />
					<parameter name="attr_link_values" value="
										=1521;
										=2264
					"/>
					<parameter name="set" value="
						list:jbr.gost.ack.type=jbr.gost.ack.type.recieved;
						string:jbr.gost.ack.errorCode=-1
					" />
					<parameter name="forceSaveMode" value="CARD" />
					<parameter name="forceSaveChilds" value="true"/>
				</post-process>				
		</specific>
		<specific property="workflowMove.id" value="jbr.visa.change.approver">
			<!-- (YNikitin, 2013/11/13, BR4J00034081) в рамках оптимизации системы, убираем лишние процессоры и донастраиваем оставшиеся, чтобы не было лишних пересчётов прав и лишних копирований атрибутов -->
			<!-- 
			<post-process class="CopyPersonsFromFarParent">
					<parameter name="backLinkAttrId" value="jbr.visa.parent" />
					<parameter name="srcPersonAttrIds" value="jbr.visa.person" />
					<parameter name="dstPersonAttrId" value="jbr.hidden.visa" />
					<parameter name="writeOperation" value="OVERWRITE" />
					<parameter name="async" value="true" />					
				</post-process>
			-->
		</specific>

		<specific property="workflowMove.toState" value="doublet" async="true" policy="IterationPolicy">
			<!-- Проверяем заполненость атрибутов Оригинальное значение в различных шаблонах при переходе в статус Дубликат-->
			<specific property="card.template" value="jbr.organization" load="true">
				<validator class="TestEmptyAttrProcessor">
					<parameter name="test_attr" value="link:jbr.organization.originalOrganization"/>
					<parameter name="must_empty" value="false"/>
					<parameter name="empty_message" value="Атрибут Оригинальное значение организации должен быть заполнен."/>
				</validator>
				<post-process class="CopyAttributeToChildren" runOrder="16">
					<parameter name="from" value="jbr.organization.originalOrganization" />
					<parameter name="to" value="jbr.person.organization" />
					<parameter name="children" value="jbr.organization.OrganizationPerson" />
				</post-process>
			</specific>
			<specific property="card.template" value="jbr.externalPerson" load="true">
					<validator class="TestEmptyAttrProcessor">
						<parameter name="test_attr" value="link:jbr.externalPerson.originalValue"/>
						<parameter name="must_empty" value="false"/>
						<parameter name="empty_message" value="Атрибут Оригинальное значение должен быть заполнен."/>
					</validator>
			</specific>
			<specific property="card.template" value="jbr.medo_og.requestAuthor" load="true">
					<validator class="TestEmptyAttrProcessor">
						<parameter name="test_attr" value="link:jbr.requestAuthor.originalValue"/>
						<parameter name="must_empty" value="false"/>
						<parameter name="empty_message" value="Атрибут Оригинальное значение должен быть заполнен."/>
					</validator>
			</specific>
			<specific property="card.template" value="typeOfDoc" load="true">
					<validator class="TestEmptyAttrProcessor">
						<parameter name="test_attr" value="link:jbr.typeOfDoc.originalValue"/>
						<parameter name="must_empty" value="false"/>
						<parameter name="empty_message" value="Атрибут Оригинальное значение должен быть заполнен."/>
					</validator>
			</specific>
			<specific property="card.template" value="jbr.RefQuestionOfAddress" load="true">
					<validator class="TestEmptyAttrProcessor">
						<parameter name="test_attr" value="link:jbr.originalQuestionValue"/>
						<parameter name="must_empty" value="false"/>
						<parameter name="empty_message" value="Атрибут 'Оригинальное значение вопроса' должен быть заполнен"/>
					</validator>
			</specific>
		</specific>

		<specific property="workflowMove.id" value="dublet.published">
				<!-- Очищаем атрибут Оригинальное значение в различных шаблонах при переходе из статуса Дубликат в Оригинальное значение-->
				<pre-process class="ClearCardAttributePostProcessorEx" runOrder="5">
					<parameter name="attrId" value="link:jbr.organization.originalOrganization"/>
					<parameter name="templateId" value="jbr.organization"/>
				</pre-process>
				<pre-process class="ClearCardAttributePostProcessorEx" runOrder="10">
					<parameter name="attrId" value="link:jbr.externalPerson.originalValue"/>
					<parameter name="templateId" value="jbr.externalPerson"/>
				</pre-process>
				<pre-process class="ClearCardAttributePostProcessorEx" runOrder="15">
					<parameter name="attrId" value="link:jbr.requestAuthor.originalValue"/>
					<parameter name="templateId" value="jbr.medo_og.requestAuthor"/>
				</pre-process>
				<pre-process class="ClearCardAttributePostProcessorEx" runOrder="20">
					<parameter name="attrId" value="link:jbr.typeOfDoc.originalValue"/>
					<parameter name="templateId" value="typeOfDoc"/>
				</pre-process>
				<pre-process class="ClearCardAttributePostProcessorEx" runOrder="25">
					<parameter name="attrId" value="link:jbr.originalQuestionValue"/>
					<parameter name="templateId" value="jbr.RefQuestionOfAddress"/>
				</pre-process>
		</specific>

		<specific property="workflowMove.id" value="jbr.taskVisa.visa.assign">			
			
			<post-process class="CallOriginsProcessor" runOrder="10">
				<parameter name="backLinkAttrId" value="jbr.visa.parent" />
				<parameter name="processorClassName"
						value="com.aplana.dbmi.jbr.processors.dbproc.ProcDynaRole"/>
				<parameter name="rootIsCurrent" value="true"/>
				<parameter name="destIsCurrent" value="true"/>
				<parameter name="nodeLinkAttrIds" value="jbr.visa.res;jbr.visa.enclosedSet"/>
				<parameter name="srcAttrIds" value="jbr.visa.person"/>
				<parameter name="nodeCardsNotStateIds" value="1, 303990"/>

				<parameter name="writeOperation" value="OVERWRITE"/>
				<parameter name="copyToDestinations" value="*:jbr.hidden.visa"/>
				<parameter name="async" value="false"/>
			</post-process>
	

			<post-process class="CallOriginsProcessor" runOrder="15">
				<parameter name="backLinkAttrId" value="jbr.visa.parent" />
				<parameter name="processorClassName"
						value="com.aplana.dbmi.jbr.processors.dbproc.ProcDynaRole"/>
				<parameter name="rootIsCurrent" value="true"/>
				<parameter name="destIsCurrent" value="true"/>
				<parameter name="nodeLinkAttrIds" value="jbr.visa.res;jbr.visa.enclosedSet"/>
				<parameter name="srcAttrIds" value="jbr.visa.hidden.assistent.response"/>
				<parameter name="nodeCardsNotStateIds" value="1, 303990"/>
		
				<parameter name="writeOperation" value="OVERWRITE"/>
				<parameter name="copyToDestinations" value="*:jbr.hidden.visa.assistant"/>
				<parameter name="async" value="false"/>
			</post-process>

			<post-process class="ForceSaveCardProcessor" runOrder="25"/>
		</specific>

			<specific property="workflowMove.id" value="jbr.outcoming.before-registration.preparation">
				<!-- (YNikitin, 2013/05/28) Баг 28100, при возврате на доработку из статуса Регистрация в статус Подготовка надо переводить все вложения в статус Устаревший-->
				<post-process class="ChangingOfFilesStatusToOutdated" runOrder="-5" />
				<post-process package="com.aplana.dbmi.jbr.processors" class="DoDependentChangeState" runOrder="0">
					<parameter name="linkAttr" value="jbr.sign.set" />
					<parameter name="affectedStates" value="jbr.sign.signed" />
					<parameter name="targetState" value="jbr.sign.draft" />
				</post-process>
				<post-process class="AttributeIncrementProcessor" runOrder="5">
					<parameter name="AttrId" value="jbr.visa.round" />
				</post-process>
				<post-process class="AttributeIncrementProcessor" runOrder="9">
					<parameter name="AttrId" value="jbr.sign.round" />
				</post-process>
			</specific>
			<specific property="workflowMove.id" value="jbr.ord.before-registration.preparation">
				<!-- (YNikitin, 2013/05/28) Баг 28100, при возврате на доработку из статуса Регистрация в статус Подготовка надо переводить все вложения в статус Устаревший-->
				<post-process class="ChangingOfFilesStatusToOutdated" runOrder="-5" />
				<post-process package="com.aplana.dbmi.jbr.processors" class="DoDependentChangeState" runOrder="0">
					<parameter name="linkAttr" value="jbr.sign.set" />
					<parameter name="affectedStates" value="jbr.sign.signed" />
					<parameter name="targetState" value="jbr.sign.draft" />
				</post-process>
				<post-process class="AttributeIncrementProcessor" runOrder="5">
					<parameter name="AttrId" value="jbr.visa.round" />
				</post-process>
				<post-process class="AttributeIncrementProcessor" runOrder="9">
					<parameter name="AttrId" value="jbr.sign.round" />
				</post-process>
			</specific>
			<specific property="workflowMove.id" value="jbr.interndoc.before-registration.preparation">
				<!-- (YNikitin, 2013/05/28) Баг 28100, при возврате на доработку из статуса Регистрация в статус Подготовка надо переводить все вложения в статус Устаревший-->
				<post-process class="ChangingOfFilesStatusToOutdated" runOrder="-5" />
				<post-process package="com.aplana.dbmi.jbr.processors" class="DoDependentChangeState" runOrder="0">
					<parameter name="linkAttr" value="jbr.sign.set" />
					<parameter name="affectedStates" value="jbr.sign.signed" />
					<parameter name="targetState" value="jbr.sign.draft" />
				</post-process>
				<post-process class="AttributeIncrementProcessor" runOrder="5">
					<parameter name="AttrId" value="jbr.visa.round" />
				</post-process>
				<post-process class="AttributeIncrementProcessor" runOrder="9">
					<parameter name="AttrId" value="jbr.sign.round" />
				</post-process>
			</specific>
			
			<!-- BR4J00019400 -->
			<specific property="workflowMove.id" value="jbr.visa.assistent.additional.approving">
				<validator class="DenyActionByLinkedCardStatesConsist">
					<parameter name="linkAttr" value="jbr.visa.enclosedSet" />
					<parameter name="states" value="draft" />
					<parameter name="messageKey" value="jbr.processor.visa.person.error" />
				</validator>			
			</specific>
			<!-- BR4J00033211 -->
			<specific property="workflowMove.id" value="jbr.visa.startEnclosed">
				<validator class="DenyActionByLinkedCardStatesConsist">
					<parameter name="linkAttr" value="jbr.visa.enclosedSet" />
					<parameter name="states" value="draft" />
					<parameter name="messageKey" value="jbr.processor.visa.person.error" />
				</validator>	
				<post-process class="CopyAttributeToChildren" runOrder="1030">
					<parameter name="from" value="jbr.visa.visa.round"/>
					<parameter name="to" value="jbr.visa.visa.round"/>
					<parameter name="linkAttrId" value="jbr.visa.enclosedSet"/>
					<!-- игнорируем визы в корзине -->
					<parameter name="ignoredStates" value="trash"/>
				</post-process>		
			</specific>			
		<!-- BR4J00014869
+		     При переходе Согласования в статус "Отменен" 
+		     копируем из согласования атрибут Текущее решение
+		     в док-основние в атрибут Комментарий отклонения
+		-->
		<specific property="workflowMove.toState" value="jbr.visa.rejected">
			<specific property="card.template" value="jbr.visa" load="true">
				<post-process class="CopyAttributeToChildren">
					<parameter name="from" value="jbr.visa.current.resolution" />
					<parameter name="linkAttrId" value="backLink:jbr.visa.parent" />
					<parameter name="to" value="jbr.reject.comment" />
					<parameter name="writeOperation" value="append" />
					<!--parameter name="attr_condition" value="number:JBR_SIGN_NUMBER=0" /-->
				</post-process>
			</specific>
		</specific>
		
		<!-- BR4J00014869
+		     При переходе Подписания в статус "Отменен"
+			 копируем из подписания атрибут Текущее решение
+		     в док-основние в атрибут Комментарий отклонения
+		-->
		<specific property="workflowMove.toState" value="jbr.sign.notsigned">
			<specific property="card.template" value="jbr.sign" load="true">
				<post-process class="CopyAttributeToChildren">
					<parameter name="from" value="jbr.sign.current.resolution" />
					<parameter name="linkAttrId" value="backLink:jbr.sign.parent" />
					<parameter name="to" value="jbr.reject.comment" />
					<!--parameter name="attr_condition" value="number:JBR_SIGN_NUMBER=0" /-->
				</post-process>
			</specific>
		</specific>
				<!--BR4J00021177 
			При переходе в "Подготовка" обновляем дату поступления 
		 -->
		<specific property="workflowMove.toState" value="preparation">
			<pre-process class="RefreshDateAttribute">
				<parameter name="dateAttributeId" value="jbr.visa.income_date" />
				<parameter name="updateIfNullOnly" value="false" />
			</pre-process>
		</specific>

		<!-- (YNikitin, 2013/09/09) баг 32749, для всех переходов из статуса Подготовка в шаблонах Внутренний, Исходящий, ОРД, НПА, добавить обязательность заполнения Вложений (если данная обязательность ещё и в БД прописана на переход) -->
		<specific property="workflowMove.fromState" value="preparation">
			<!-- Проверяем, чтобы при переходе из Подготовки были неустаревшие вложения -->
			<specific property="card.template" value="jbr.interndoc" load="true">
				<validator class="TestEmptyAttrProcessor" runOrder="2">
					<parameter name="test_attr" value="link:jbr.files"/>
					<parameter name="checkWfmRequiredFields" value="true"/>
					<parameter name="must_empty" value="false"/>
					<parameter name="hidden_status" value="outofdate"/>
					<parameter name="empty_message" value="Вы не добавили вложения для текущей итерации. Для корректной маршрутизации документа необходимо добавить все необходимые вложения."/>
					<parameter name="condition" value="list:jbr.dsp=jbr.noDsp"/>
				</validator>
			</specific> 
			<specific property="card.template" value="jbr.ord" load="true">
				<validator class="TestEmptyAttrProcessor" runOrder="2">
					<parameter name="test_attr" value="link:jbr.files"/>
					<parameter name="checkWfmRequiredFields" value="true"/>
					<parameter name="hidden_status" value="outofdate"/>
					<parameter name="must_empty" value="false"/>
					<parameter name="empty_message" value="Вы не добавили вложения для текущей итерации. Для корректной маршрутизации документа необходимо добавить все необходимые вложения."/>
					<parameter name="condition" value="list:jbr.dsp=jbr.noDsp"/>
				</validator>
			</specific> 
			<specific property="card.template" value="jbr.npa" load="true">
				<validator class="TestEmptyAttrProcessor" runOrder="2">
					<parameter name="test_attr" value="link:jbr.files"/>
					<parameter name="checkWfmRequiredFields" value="true"/>
					<parameter name="hidden_status" value="outofdate"/>
					<parameter name="must_empty" value="false"/>
					<parameter name="empty_message" value="Вы не добавили вложения для текущей итерации. Для корректной маршрутизации документа необходимо добавить все необходимые вложения."/>
					<parameter name="condition" value="list:jbr.dsp=jbr.noDsp"/>
				</validator>
			</specific> 
			<specific property="card.template" value="jbr.outcoming" load="true">
				<validator class="TestEmptyAttrProcessor" runOrder="2">
					<parameter name="test_attr" value="link:jbr.files"/>
					<parameter name="checkWfmRequiredFields" value="true"/>
					<parameter name="hidden_status" value="outofdate"/>
					<parameter name="must_empty" value="false"/>
					<parameter name="empty_message" value="Вы не добавили вложения для текущей итерации. Для корректной маршрутизации документа необходимо добавить все необходимые вложения."/>
					<parameter name="condition" value="list:jbr.dsp=jbr.noDsp"/>
				</validator>
			</specific> 
		</specific>
		<specific property="workflowMove.toState" value="execution">
			<post-process class="RefreshDateAttribute">
				<parameter name="dateAttributeId" value="jbr.visa.income_date" />
				<parameter name="updateIfNullOnly" value="false" />
			</post-process>
		</specific>
		<specific property="workflowMove.toState" value="done">
			<post-process class="RefreshDateAttribute">
				<parameter name="dateAttributeId" value="jbr.visa.income_date" />
				<parameter name="updateIfNullOnly" value="false" />
			</post-process>
		</specific>

		<specific property="workflowMove.id" value="jbr.taskVisa.approval.help">
			<post-process class="RefreshDateAttribute" runOrder="6">
				<parameter name="dateAttributeId" value="jbr.visa.income_date" />
				<parameter name="updateIfNullOnly" value="false" />
			</post-process>
		</specific>
		<specific property="workflowMove.id" value="jbr.taskVisa.approval">
			<post-process class="RefreshDateAttribute" runOrder="6">
				<parameter name="dateAttributeId" value="jbr.visa.income_date" />
				<parameter name="updateIfNullOnly" value="false" />
			</post-process>
		</specific>
		<specific property="workflowMove.id" value="jbr.taskVisa.send.boss">
			<post-process class="RefreshDateAttribute" runOrder="6">
				<parameter name="dateAttributeId" value="jbr.visa.income_date" />
				<parameter name="updateIfNullOnly" value="false" />
			</post-process>
		</specific>
		<specific property="workflowMove.id" value="jbr.incoming.delo.registration">
			<specific property="card.template" value="jbr.citizenrequest" load="true">
				<!-- Проверяем тип сообщения и если = без подписи, выставляем Автор обращения = Аноним -->
				<validator class="SetAttributeValueWithConditionProcessor"  runOrder="1">
					<parameter name="attr_condition_1" value="link:jbr.AuthType=15921"/>
					<parameter name="attributeId" value="link:jbr.ReqAuthor"/>
					<parameter name="value" value="10" />
					<parameter name="saveKind" value="SAVE_ATTR"/>
				</validator>
				<validator class="TestEmptyAttrProcessor"  runOrder="3">
					<parameter name="test_attr" value="string:jbr.og.firstname"/>
					<parameter name="linked_attr" value="link:jbr.ReqAuthor"/>
					<parameter name="linked_attr_test" value=".template=jbr.medo_og.requestAuthor"/>
					<parameter name="condition" value="link:jbr.ReqAuthor=NULL" />
					<parameter name="must_empty" value="false"/>
					<parameter name="empty_message" value="Обязательная характеристика 'Информация о заявителе. Имя' не заполнена."/>
				</validator>
				<validator class="TestEmptyAttrProcessor"  runOrder="5">
					<parameter name="test_attr" value="string:jbr.og.lastname"/>
					<parameter name="linked_attr" value="link:jbr.ReqAuthor"/>
					<parameter name="linked_attr_test" value=".template=jbr.medo_og.requestAuthor"/>
					<parameter name="condition" value="link:jbr.ReqAuthor=NULL" />
					<parameter name="must_empty" value="false"/>
					<parameter name="empty_message" value="Обязательная характеристика 'Информация о заявителе. Фамилия' не заполнена."/>
				</validator>
			</specific>
			<post-process class="RefreshDateAttribute" runOrder="6">
				<parameter name="dateAttributeId" value="jbr.visa.income_date" />
				<parameter name="updateIfNullOnly" value="false" />
			</post-process>
		</specific>
		
		<specific property="workflowMove.id" value="jbr.exam.assistant.boss">
			<post-process class="RefreshDateAttribute">
				<parameter name="dateAttributeId" value="jbr.visa.income_date" />
				<parameter name="updateIfNullOnly" value="false" />
			</post-process>
		</specific>
		<specific property="workflowMove.id" value="jbr.visa.sign.to.boss.arm">
			<post-process class="RefreshDateAttribute">
				<parameter name="dateAttributeId" value="jbr.visa.income_date" />
				<parameter name="updateIfNullOnly" value="false" />
			</post-process>
		</specific>
		<specific property="workflowMove.id" value="jbr.visa.to.boss.arm">
			<post-process class="RefreshDateAttribute">
				<parameter name="dateAttributeId" value="jbr.visa.income_date" />
				<parameter name="updateIfNullOnly" value="false" />
			</post-process>
		</specific>

		<specific property="workflowMove.toState" value="acquaintance">
			<post-process class="RefreshDateAttribute">
				<parameter name="dateAttributeId" value="jbr.visa.income_date" />
				<parameter name="updateIfNullOnly" value="false" />
			</post-process>
		</specific>
		
		<specific property="workflowMove.id" value="jbr.visa.return.to.assistent">
			<post-process class="RefreshDateAttribute">
				<parameter name="dateAttributeId" value="jbr.visa.income_date" />
				<parameter name="updateIfNullOnly" value="false" />
			</post-process>
		</specific>	
			
		<specific property="workflowMove.id" value="jbr.exam.draft.send.assistan">
			<post-process class="RefreshDateAttribute">
				<parameter name="dateAttributeId" value="jbr.visa.income_date" />
				<parameter name="updateIfNullOnly" value="false" />
			</post-process>
		</specific>	
		
		<specific property="workflowMove.id" value="jbr.outcoming.preparation.register">
			<post-process class="ClearCardAttributePostProcessorEx">
				<parameter name="condition" value="list:jbr.dsp=jbr.isDsp"/>
				<parameter name="attrId" value="link:jbr.files"/>
			</post-process>
		</specific>	
		<specific property="workflowMove.id" value="jbr.outcoming.preparation.registration">
			<post-process class="ClearCardAttributePostProcessorEx">
				<parameter name="condition" value="list:jbr.dsp=jbr.isDsp"/>
				<parameter name="attrId" value="link:jbr.files"/>
			</post-process>
		</specific>	
		<specific property="workflowMove.id" value="jbr.outcoming.preparation.agreement">
			<post-process class="ClearCardAttributePostProcessorEx">
				<parameter name="condition" value="list:jbr.dsp=jbr.isDsp"/>
				<parameter name="attrId" value="link:jbr.files"/>
			</post-process>
		</specific>	

		<specific property="workflowMove.id" value="jbr.interndoc.preparation.register">
			<post-process class="ClearCardAttributePostProcessorEx">
				<parameter name="condition" value="list:jbr.dsp=jbr.isDsp"/>
				<parameter name="attrId" value="link:jbr.files"/>
			</post-process>
		</specific>

		<specific property="workflowMove.id" value="jbr.interndoc.preparation.registration">
			<specific property="card.template" value="jbr.interndoc">
				<!-- При регистрации внутреннего копируем Зону адресата -->
				<pre-process class="CopyAttributeFromParent" runOrder="20">
					<parameter name="isOnlyModel" value="false" />
					<parameter name="from" value="jbr.zoneDOW"/>
					<parameter name="to" value="jbr.zoneDOW"/>
					<parameter name="parent" value="jbr.incoming.addressee"/>
					<parameter name="parentTemplate" value="jbr.internalPerson"/>
					<parameter name="type" value="C"/>
					<parameter name="writeOperation" value="append" />
				</pre-process>
			</specific>
			<post-process class="ClearCardAttributePostProcessorEx">
				<parameter name="condition" value="list:jbr.dsp=jbr.isDsp"/>
				<parameter name="attrId" value="link:jbr.files"/>
			</post-process>
		</specific>

		<specific property="workflowMove.id" value="jbr.interndoc.preparation.agreement">
			<post-process class="ClearCardAttributePostProcessorEx">
				<parameter name="condition" value="list:jbr.dsp=jbr.isDsp"/>
				<parameter name="attrId" value="link:jbr.files"/>
			</post-process>
		</specific>
		<specific property="workflowMove.id" value="jbr.ord.preparation.register">
			<post-process class="ClearCardAttributePostProcessorEx">
				<parameter name="condition" value="list:jbr.dsp=jbr.isDsp"/>
				<parameter name="attrId" value="link:jbr.files"/>
			</post-process>
		</specific>	
		<specific property="workflowMove.id" value="jbr.ord.preparation.registration">
			<post-process class="ClearCardAttributePostProcessorEx">
				<parameter name="condition" value="list:jbr.dsp=jbr.isDsp"/>
				<parameter name="attrId" value="link:jbr.files"/>
			</post-process>
		</specific>
		<specific property="workflowMove.id" value="jbr.ord.preparation.agreement">
			<post-process class="ClearCardAttributePostProcessorEx">
				<parameter name="condition" value="list:jbr.dsp=jbr.isDsp"/>
				<parameter name="attrId" value="link:jbr.files"/>
			</post-process>
		</specific>
		<specific property="workflowMove.id" value="jbr.ord.preparation.manager">
			<post-process class="ClearCardAttributePostProcessorEx">
				<parameter name="condition" value="list:jbr.dsp=jbr.isDsp"/>
				<parameter name="attrId" value="link:jbr.files"/>
			</post-process>
		</specific>
		<specific property="workflowMove.id" value="jbr.incoming.draft.registration">
			<post-process class="ClearCardAttributePostProcessorEx">
				<parameter name="condition" value="list:jbr.dsp=jbr.isDsp"/>
				<parameter name="attrId" value="link:jbr.files"/>
			</post-process>
		</specific>
		<specific property="workflowMove.id" value="jbr.incoming.registration.ready">
			<post-process class="ClearCardAttributePostProcessorEx">
				<parameter name="condition" value="list:jbr.dsp=jbr.isDsp"/>
				<parameter name="attrId" value="link:jbr.files"/>
			</post-process>
		</specific>
		<specific property="workflowMove.id" value="jbr.incoming.register">
			<post-process class="ClearCardAttributePostProcessorEx">
				<parameter name="condition" value="list:jbr.dsp=jbr.isDsp"/>
				<parameter name="attrId" value="link:jbr.files"/>
			</post-process>
		</specific>
		<specific property="workflowMove.id" value="jbr.ord.before-registration.registration">
			<post-process class="ClearCardAttributePostProcessorEx">
				<parameter name="condition" value="list:jbr.dsp=jbr.isDsp"/>
				<parameter name="attrId" value="link:jbr.files"/>
			</post-process>
		</specific>
		<specific property="workflowMove.id" value="jbr.outcoming.before-registration.registration">
			<post-process class="ClearCardAttributePostProcessorEx">
				<parameter name="condition" value="list:jbr.dsp=jbr.isDsp"/>
				<parameter name="attrId" value="link:jbr.files"/>
			</post-process>
		</specific>
		<specific property="workflowMove.id" value="jbr.interndoc.before-registration.registration">
			<specific property="card.template" value="jbr.interndoc">
				<!-- При регистрации внутреннего копируем Зону адресата -->
				<pre-process class="CopyAttributeFromParent" runOrder="20">
					<parameter name="isOnlyModel" value="false" />
					<parameter name="from" value="jbr.zoneDOW"/>
					<parameter name="to" value="jbr.zoneDOW"/>
					<parameter name="parent" value="jbr.incoming.addressee"/>
					<parameter name="parentTemplate" value="jbr.internalPerson"/>
					<parameter name="type" value="C"/>
					<parameter name="writeOperation" value="append" />
				</pre-process>
			</specific>
			<post-process class="ClearCardAttributePostProcessorEx">
				<parameter name="condition" value="list:jbr.dsp=jbr.isDsp"/>
				<parameter name="attrId" value="link:jbr.files"/>
			</post-process>
		</specific>
		
		<!-- Работа с шаблоном "Запрос на изменение рассматривающего" -->
		<!-- Переход "На рассмотрение" (Черновик -> Рассмотрение) -->
		<specific property="workflowMove.id" value="jbr.cc_request.to.consideration">
			<!-- Все валидаторы перенесены на момент сохранения карточки в статусе Черновик. Это сделано для того, что бы
				 при срабатывании валидатора во время перехода карточка не сохранялась и не оставалась в статусе Черновик -->
			<post-process class="CopyCardLinkToExtendedLink" runOrder="60">
				<parameter name="from" value="->jbr.maindoc.request@jbr.exam.set"/>
				<parameter name="fromList" value="list:jbr.responsibility.consider"/>
				<parameter name="fromDate" value="date:jbr.exam.term"/>
				<parameter name="to" value="@jbr.request.prev"/>
				<parameter name="merge" value="false"/>
				<parameter name="from_condition1" value=".state#poruchcancelled"/>
				<parameter name="from_condition2" value=".state#trash"/>
				<parameter name="checkPersonFrom" value="user:jbr.exam.person"/>
				<parameter name="checkPersonTo" value="datedTypedLink:jbr.request.new"/>
				<parameter name="checkCurrentPerson" value="link:jbr.request.cons"/>
			</post-process>
		</specific>

		<!-- Переход "Принять запрос" (Рассмотрение -> Обработано) -->
		<specific property="workflowMove.id" value="jbr.cc_request.process">
			<post-process class="ProcessRequestToChangeConsideration" runOrder="10">
				<parameter name="requestType" value="list:jbr.request.type"/>
				<parameter name="currentCons" value="link:jbr.request.cons"/>
				<parameter name="newCons" value="datedTypedLink:jbr.request.new"/>
				<parameter name="mainDoc" value="link:jbr.maindoc.request"/>
				<parameter name="consWayInMain" value="link:jbr.acquant"/>
			</post-process>
			<post-process class="RefreshCurrentPersonAttribute" runOrder="20">
				<parameter name="personAttributeId" value="jbr.reqres.reg" />
			</post-process>
			<post-process class="RefreshDateAttribute" runOrder="30">
				<parameter name="dateAttributeId" value="jbr.reqres.date"/>
				<parameter name="updateIfNullOnly" value="false" />
			</post-process>
			<post-process class="FillRequestToChangeHistory" runOrder="40"/>
		</specific>

		<!-- Переход "Отклонить запрос" (Рассмотрение -> Отклонено) -->
		<specific property="workflowMove.id" value="jbr.cc_request.reject">
			<post-process class="RejectRequestToChangeConsideration" runOrder="10">
				<parameter name="mainDoc" value="link:jbr.maindoc.request"/>
			</post-process>
			<post-process class="RefreshCurrentPersonAttribute" runOrder="20">
				<parameter name="personAttributeId" value="jbr.reqres.reg" />
			</post-process>
			<post-process class="RefreshDateAttribute" runOrder="30">
				<parameter name="dateAttributeId" value="jbr.reqres.date"/>
				<parameter name="updateIfNullOnly" value="false" />
			</post-process>
		</specific>
		<specific property="workflowMove.id" value="user.makeActive">
			<post-process class="EnablePortalUserProcessor" runOrder="120" >
				<parameter name="isEnabled" value="true"/>
			</post-process>
			<post-process class="SyncPortalUserProcessor" runOrder="130" />		
		</specific>
		<specific property="workflowMove.id" value="user.makeInactive">
			<post-process class="EnablePortalUserProcessor" runOrder="120" >
				<parameter name="isEnabled" value="false"/>
			</post-process>			
		</specific>
	</action>

	<action type="CheckRegisteredReservationRequest">
		<query package="com.aplana.dbmi.jbr.query">DoCheckRegisteredReservationRequest</query>
	</action>

	<!-- ===================================================== -->
	<action type="CreateCardByExample">
		<query package="com.aplana.dbmi.jbr.query">DoCreateCardByExample</query>
	</action>

	<!-- ===================================================== -->
	<action package="com.aplana.dbmi.jbr.action" type="CheckCardNumber">
		<query package="com.aplana.dbmi.jbr.query" class="DoCheckCardNumber">
			<parameter name="config" value="dbmi/checkstate/query_card_info.xml" />
		</query>
	</action>

	<!-- ===================================================== -->
	<action type="CloneCard">
		<post-process class="ClearCardAttributePostProcessor" runOrder="5">
			<parameter name="attrId" value="string:NAME" />
			<parameter name="templateId" value="jbr.incoming" />
		</post-process>
		
		<!-- Для копии входящего документа убираем номер и дату регистрации -->
		<post-process class="ClearCardAttributePostProcessor" runOrder="10">
			<parameter name="attrId" value="string:regnumber" />
			<parameter name="templateId" value="jbr.incoming" />
		</post-process>
		<post-process class="ClearCardAttributePostProcessor" runOrder="15">
			<parameter name="attrId" value="number:regnumberdigital" />
			<parameter name="templateId" value="jbr.incoming" />
		</post-process>
		<post-process class="ClearCardAttributePostProcessor" runOrder="20">
			<parameter name="attrId" value="date:regdate" />
			<parameter name="templateId" value="jbr.incoming" />
		</post-process>
		<post-process class="ClearCardAttributePostProcessor" runOrder="25">
			<parameter name="attrId" value="list:jbr.deliveryItem.method" />
			<parameter name="templateId" value="jbr.incoming" />
		</post-process>
		
		<!-- Для копии исходящего документа убираем номер и дату регистрации -->
		<post-process class="ClearCardAttributePostProcessor" runOrder="25">
			<parameter name="attrId" value="string:regnumber" />
			<parameter name="templateId" value="jbr.outcoming" />
		</post-process>
		<post-process class="ClearCardAttributePostProcessor" runOrder="30">
			<parameter name="attrId" value="number:regnumberdigital" />
			<parameter name="templateId" value="jbr.outcoming" />
		</post-process>
		<post-process class="ClearCardAttributePostProcessor" runOrder="35">
			<parameter name="attrId" value="date:regdate" />
			<parameter name="templateId" value="jbr.outcoming" />
		</post-process>
		
		<!-- Для копии ОРД убираем номер и дату регистрации -->
		<post-process class="ClearCardAttributePostProcessor" runOrder="40">
			<parameter name="attrId" value="string:regnumber" />
			<parameter name="templateId" value="jbr.ord" />
		</post-process>
		<post-process class="ClearCardAttributePostProcessor" runOrder="45">
			<parameter name="attrId" value="number:regnumberdigital" />
			<parameter name="templateId" value="jbr.ord" />
		</post-process>
		<post-process class="ClearCardAttributePostProcessor" runOrder="50">
			<parameter name="attrId" value="date:regdate" />
			<parameter name="templateId" value="jbr.ord" />
		</post-process>
				
		<!-- Для копии внутреннего документа убираем номер и дату регистрации -->
		<post-process class="ClearCardAttributePostProcessor" runOrder="55">
			<parameter name="attrId" value="string:regnumber" />
			<parameter name="templateId" value="jbr.interndoc" />
		</post-process>
		<post-process class="ClearCardAttributePostProcessor" runOrder="60">
			<parameter name="attrId" value="number:regnumberdigital" />
			<parameter name="templateId" value="jbr.interndoc" />
		</post-process>
		<post-process class="ClearCardAttributePostProcessor" runOrder="65">
			<parameter name="attrId" value="date:regdate" />
			<parameter name="templateId" value="jbr.interndoc" />
		</post-process>
		
		<!-- Для копии Обращений граждан убираем номер и дату регистрации -->
		<post-process class="ClearCardAttributePostProcessor" runOrder="70">
			<parameter name="attrId" value="string:regnumber" />
			<parameter name="templateId" value="jbr.citizenrequest" />
		</post-process>
		<post-process class="ClearCardAttributePostProcessor" runOrder="75">
			<parameter name="attrId" value="number:regnumberdigital" />
			<parameter name="templateId" value="jbr.citizenrequest" />
		</post-process>
		<post-process class="ClearCardAttributePostProcessor" runOrder="80">
			<parameter name="attrId" value="date:regdate" />
			<parameter name="templateId" value="jbr.citizenrequest" />
		</post-process>
		
		<!-- Для копии Обращений граждан убираем заголовок документа -->
		<post-process class="ClearCardAttributePostProcessor" runOrder="85">
			<parameter name="attrId" value="string:name" />
			<parameter name="templateId" value="jbr.citizenrequest" />
		</post-process>
		
		<!-- Для копии НПА убираем номер и дату регистрации -->
		<post-process class="ClearCardAttributePostProcessor" runOrder="90">
			<parameter name="attrId" value="string:regnumber" />
			<parameter name="templateId" value="jbr.npa" />
		</post-process>
		<post-process class="ClearCardAttributePostProcessor" runOrder="95">
			<parameter name="attrId" value="number:regnumberdigital" />
			<parameter name="templateId" value="jbr.npa" />
		</post-process>
		<post-process class="ClearCardAttributePostProcessor" runOrder="100">
			<parameter name="attrId" value="date:regdate" />
			<parameter name="templateId" value="jbr.npa" />
		</post-process>
        <specific property="template" value="jbr.npa">
            <post-process class="SetCurrentProjectNumber" />
        </specific>
	</action>

	<!-- ===================================================== -->
	<action type="UploadFile">
		<post-process class="ForceSaveCardProcessor" />
	</action>

	<!-- ===================================================== -->
	<action type="CreateCard">
		<!-- "Поручение" template.jbr.massResolution=1324 -->
		<specific property="template" value="jbr.massResolution">
			<post-process class="SetCurrentPersonTo" runOrder="5">
				<parameter name="personAttribute" value="jbr.massResolution.FioSign" />
				<parameter name="userSubordinate" value="BOSS" />
				<parameter name="addUserIfEmptySubordinate" value="true" />
			</post-process>
			<post-process class="SetAttributeValueProcessor" runOrder="10">
				<parameter name="attributeId"       value="list:jbr.oncontrol" />
				<parameter name="value"             value="jbr.commission.control.yes" />
				<parameter name="onlyCurrentCard"   value="true" />
				<parameter name="saveKind"          value="NO_SAVE" />
				<!-- условие на документ-основание (backlink & condition) -->
				<parameter name="mainDoc.AttrId"    value="jbr.main.doc" />
				<parameter name="mainDoc.condition" value="list:jbr.incoming.oncontrol=jbr.incoming.control.yes" />
			</post-process>
			<!-- в поле "контролер": в случае наличия поля "контролер" в РК "настройки для АРМ руководителя", 
			     устанавливать значение из поля "контролер" данной РК если док-осн. на контроле (1432) -->
			<post-process class="SetCurrentPersonTo" runOrder="20">
				<parameter name="personAttribute"   value="jbr.commission.inspector"/>
				<parameter name="checkIsLinked"     value="false"/>
				<parameter name="loadCard"          value="true"/>
				<parameter name="forceSaveCard"     value="true"/>
				<parameter name="userSubordinate"   value="BY_RULE"/>
				<parameter name="calcUserPostRule"  value="$arm -> user: JBR_ARM_INSPECTOR" />
				<parameter name="addUserIfEmptySubordinate" value="true" /> <!-- нет контроллера - записывать текущего пользователя. -->
				<!-- условие на документ-основание (backlink & condition) -->
				<parameter name="mainDoc.AttrId"    value="jbr.main.doc" />
				<parameter name="mainDoc.condition" value="list:jbr.incoming.oncontrol=jbr.incoming.control.yes" />
			</post-process>
			<post-process class="RefreshDateFromAttribute" runOrder="110">
				<parameter name="dateAttributeId"        value="jbr.resolutionTerm" />
				<parameter name="backlinkAttributeId"    value="jbr.main.doc" />
				<parameter name="parent_dateAttributeId" value="jbr.maindoc.regdate" />
				<parameter name="updateIfNullOnly"       value="true" />
				<parameter name="dateOffset"             value="+29d" />
				<!-- условие на документ-основание (backlink & condition) -->
				<parameter name="mainDoc.AttrId"         value="jbr.main.doc" />
				<parameter name="mainDoc.condition"      value="list:jbr.incoming.oncontrol#jbr.incoming.control.yes" />
			</post-process>
			<!-- устанавливаем Срок как текущая дата +29 дней, если док-осн. на контроле (1432=jbr.incoming.control.yes) -->
			<post-process class="RefreshDateAttribute" runOrder="111">
				<parameter name="dateAttributeId"        value="jbr.resolutionTerm" />
				<parameter name="updateIfNullOnly"       value="true" />
				<parameter name="dateOffset"             value="+29d" />
				<!-- условие на документ-основание (backlink & condition) -->
				<parameter name="mainDoc.AttrId"         value="jbr.main.doc" />
				<parameter name="mainDoc.condition"      value="list:jbr.incoming.oncontrol=jbr.incoming.control.yes" />
			</post-process>
			<!-- Копировать "Срок исполнения или предоставления ответа" из документа-основания в "Срок", 
			     если док-осн. на контроле (1432=jbr.incoming.control.yes) и текущий "Срок" поручения больше "Срок исполнения или предоставления ответа"-->
			<post-process class="RefreshDateFromAttribute" runOrder="112">
				<parameter name="backlinkAttributeId"    value="jbr.main.doc" />
				<parameter name="dateAttributeId"        value="jbr.resolutionTerm" />
				<parameter name="parent_dateAttributeId" value="jbr.incoming.deadline" />
				<!-- условие на документ-основание (backlink & condition) -->
				<parameter name="mainDoc.AttrId"         value="jbr.main.doc" />
				<parameter name="mainDoc.condition"      value="list:jbr.incoming.oncontrol=jbr.incoming.control.yes" />
				<!-- условия на атрибут родительской и текущей карточки -->
				<parameter name="conditionParentDateAttribute"      value="jbr.incoming.deadline"/>
				<parameter name="condition" value=".lte." />
				<parameter name="conditionCurrentDateAttribute"     value="jbr.resolutionTerm"/>
			</post-process>
			<!-- если после всех манипуляций, Срок меньше текущей даты, то надо его установить в Текущий день+1 -->
			<post-process class="RefreshDateAttribute" runOrder="113">
				<parameter name="dateAttributeId"        value="jbr.resolutionTerm" />
				<parameter name="updateIfLessCurDate"    value="true" />
				<parameter name="dateOffset"             value="+1d" />
			</post-process>
			<!-- Установить время 23:59:59 в атрибуте Срок -->
			<post-process class="SetTimeToDateAttribute" runOrder="114">
				<parameter name="dateAttributeId" value="jbr.resolutionTerm" />
				<parameter name="hours" value="23" />
				<parameter name="minutes" value="59" />
				<parameter name="seconds" value="59" />
			</post-process>
		</specific>
		<!-- "Поручение" template.jbr.resolution=324 -->
		<specific property="template" value="jbr.resolution">
			<post-process class="SetCurrentPersonTo" runOrder="5">
				<parameter name="personAttribute" value="jbr.resolution.FioSign" />
				<parameter name="checkIsLinked" value="true" />
				<parameter name="userSubordinate" value="BOSS" />
				<parameter name="addUserIfEmptySubordinate" value="true" />
				<parameter name="skipInactivePerson" value="true" />
			</post-process>
			
			<!-- START BR4J00013034 -->
			<!-- Копировать "На контроле" из документа-основания, если док-осн. на контроле (1432) -->
			<!-- post-process class="CopyAttributeFromParent" -->
			<!-- !!! Копировать нельзя, так там разные атрибуты привязаны к разным values-листам !!! -->
			<post-process class="SetAttributeValueProcessor" runOrder="10">
				<parameter name="attributeId"       value="list:jbr.oncontrol" />
				<parameter name="value"             value="jbr.commission.control.yes" />
				<parameter name="onlyCurrentCard"   value="true" />
				<parameter name="saveKind"          value="NO_SAVE" />
				<!-- условие на документ-основание (backlink & condition) -->
				<parameter name="mainDoc.AttrId"    value="jbr.main.doc" />
				<parameter name="mainDoc.condition" value="list:jbr.incoming.oncontrol=jbr.incoming.control.yes" />
			</post-process>
			<!-- Случай, когда поручение создается как дочернее -->
			<post-process class="SetAttributeValueProcessor" runOrder="15">
				<parameter name="attributeId"       value="list:jbr.oncontrol" />
				<parameter name="value"             value="jbr.commission.control.yes" />
				<parameter name="onlyCurrentCard"   value="true" />
				<parameter name="saveKind"          value="NO_SAVE" />
				<!-- условие на документ-основание (backlink & condition) -->
				<parameter name="mainDoc.AttrId"    value="jbr.main.doc" />
				<parameter name="mainDoc.condition" value="list:jbr.oncontrol=jbr.commission.control.yes" />
			</post-process>
			<!-- в поле "контролер": в случае наличия поля "контролер" в РК "настройки для АРМ руководителя", 
			     устанавливать значение из поля "контролер" данной РК если док-осн. на контроле (1432) -->
			<post-process class="SetCurrentPersonTo" runOrder="20">
				<parameter name="personAttribute"   value="jbr.commission.inspector"/>
				<parameter name="checkIsLinked"     value="false"/>
				<parameter name="loadCard"          value="true"/>
				<parameter name="forceSaveCard"     value="true"/>
				<parameter name="userSubordinate"   value="BY_RULE"/>
				<parameter name="calcUserPostRule"  value="$arm -> user: JBR_ARM_INSPECTOR" />
				<parameter name="addUserIfEmptySubordinate" value="true" /> <!-- нет контроллера - записывать текущего пользователя. -->
				<!-- условие на документ-основание (backlink & condition) -->
				<parameter name="mainDoc.AttrId"    value="jbr.main.doc" />
				<parameter name="mainDoc.condition" value="list:jbr.incoming.oncontrol=jbr.incoming.control.yes" />
			</post-process>
			<!-- Случай, когда поручение создается как дочернее -->
			<post-process class="SetCurrentPersonTo" runOrder="25">
				<parameter name="personAttribute"   value="jbr.commission.inspector"/>
				<parameter name="checkIsLinked"     value="false"/>
				<parameter name="loadCard"          value="true"/>
				<parameter name="forceSaveCard"     value="true"/>
				<parameter name="userSubordinate"   value="BY_RULE"/>
				<parameter name="calcUserPostRule"  value="$arm -> user: JBR_ARM_INSPECTOR" />
				<parameter name="addUserIfEmptySubordinate" value="true" /> <!-- нет контроллера - записывать текущего пользователя. -->
				<!-- условие на документ-основание (backlink & condition) -->
				<parameter name="mainDoc.AttrId"    value="jbr.main.doc" />
				<parameter name="mainDoc.condition" value="list:jbr.oncontrol=jbr.commission.control.yes" />
			</post-process>
			<!-- END BR4J00013034 -->
						<!--Для неконтрольного документа:
					При создании поручения поле "Срок" в блоке "Срок и контроль" шаблона "Поручение"
			    	должно автоматически заполнятся датой, равной +29 КАЛЕНДАРНЫХ дней с даты регистрации 
			    	родительского документа -->
			<post-process class="RefreshDateFromAttribute" runOrder="110">
				<parameter name="dateAttributeId"        value="jbr.resolutionTerm" />
				<parameter name="backlinkAttributeId"    value="jbr.main.doc" />
				<parameter name="parent_dateAttributeId" value="jbr.maindoc.regdate" />
				<parameter name="updateIfNullOnly"       value="true" />
				<parameter name="dateOffset"             value="+29d" />
				<!-- условие на документ-основание (backlink & condition) -->
				<parameter name="mainDoc.AttrId"         value="jbr.main.doc" />
				<parameter name="mainDoc.condition"      value="list:jbr.incoming.oncontrol#jbr.incoming.control.yes" />
			</post-process>
			<!-- устанавливаем Срок как текущая дата +29 дней, если док-осн. на контроле (1432=jbr.incoming.control.yes) -->
			<post-process class="RefreshDateAttribute" runOrder="111">
				<parameter name="dateAttributeId"        value="jbr.resolutionTerm" />
				<parameter name="updateIfNullOnly"       value="true" />
				<parameter name="dateOffset"             value="+29d" />
				<!-- условие на документ-основание (backlink & condition) -->
				<parameter name="mainDoc.AttrId"         value="jbr.main.doc" />
				<parameter name="mainDoc.condition"      value="list:jbr.incoming.oncontrol=jbr.incoming.control.yes" />
			</post-process>
			<!-- Копировать "Срок исполнения или предоставления ответа" из документа-основания в "Срок", 
			     если док-осн. на контроле (1432=jbr.incoming.control.yes) и текущий "Срок" поручения больше "Срок исполнения или предоставления ответа"-->
			<post-process class="RefreshDateFromAttribute" runOrder="112">
				<parameter name="backlinkAttributeId"    value="jbr.main.doc" />
				<parameter name="dateAttributeId"        value="jbr.resolutionTerm" />
				<parameter name="parent_dateAttributeId" value="jbr.incoming.deadline" />
				<!-- условие на документ-основание (backlink & condition) -->
				<parameter name="mainDoc.AttrId"         value="jbr.main.doc" />
				<parameter name="mainDoc.condition"      value="list:jbr.incoming.oncontrol=jbr.incoming.control.yes" />
				<!-- условия на атрибут родительской и текущей карточки -->
				<parameter name="conditionParentDateAttribute"      value="jbr.incoming.deadline"/>
				<parameter name="condition" value=".lte." />
				<parameter name="conditionCurrentDateAttribute"     value="jbr.resolutionTerm"/>
			</post-process>
			<!-- если после всех манипуляций, Срок меньше текущей даты, то надо его установить в Текущий день+1 -->
			<post-process class="RefreshDateAttribute" runOrder="113">
				<parameter name="dateAttributeId"        value="jbr.resolutionTerm" />
				<parameter name="updateIfLessCurDate"    value="true" />
				<parameter name="dateOffset"             value="+1d" />
			</post-process>
			
			<!-- Установить время 23:59:59 в атрибуте Срок -->
			<post-process class="SetTimeToDateAttribute" runOrder="114">
				<parameter name="dateAttributeId" value="jbr.resolutionTerm" />
				<parameter name="hours" value="23" />
				<parameter name="minutes" value="59" />
				<parameter name="seconds" value="59" />
			</post-process>

			<post-process class="CopyPersonFromPaths" runOrder="30">
				<parameter name="targetAttr" value="jbr.report.role.supervise" />
				<parameter name="replaceTargetAttrList" value="false"/>
				<paremeter name="reloadCard" value="true"/>
				<parameter name="paths"
					value="
					link:jbr.main.doc->user:jbr.incoming.inspector;
					link:jbr.main.doc->user:author;
				" />
			</post-process>
		</specific>
		
		<specific property="template" value="jbr.group.resolution">
			<post-process class="SetCurrentPersonTo" runOrder="5">
				<parameter name="personAttribute" value="jbr.resolution.FioSign" />
				<parameter name="userSubordinate" value="BOSS" />
				<parameter name="addUserIfEmptySubordinate" value="true" />
			</post-process>
			
			<post-process class="RefreshDateAttribute" runOrder="110">
				<parameter name="dateAttributeId"        value="jbr.resolutionTerm" />
				<parameter name="updateIfNullOnly"       value="true" />
				<parameter name="dateOffset"             value="+29d" />
			</post-process>
			
			<!-- Установить время 23:59:59 в атрибуте Срок -->
			<post-process class="SetTimeToDateAttribute" runOrder="114">
				<parameter name="dateAttributeId" value="jbr.resolutionTerm" />
				<parameter name="hours" value="23" />
				<parameter name="minutes" value="59" />
				<parameter name="seconds" value="59" />
			</post-process>
		</specific>
		
		<!-- "НПА" template.jbr.npa=1226 При создании НПА увеличивается номер проекта -->
		<specific property="template" value="jbr.npa">
			<post-process class="SetCurrentProjectNumber" />
		</specific>

		<specific property="template" value="med.notifyForApplicant">
			<post-process class="SetCurrentPersonTo">
				<parameter name="personAttribute" value="medo.notification.sender"/>
				<parameter name="checkIsLinked" value="false"/>
				<parameter name="userSubordinate" value="USER"/>
				<parameter name="addUserIfEmptySubordinate" value="false"/>
			</post-process>
		</specific>		
		
		<specific property="template" value="jbr.reservationRequest">
				<post-process class="RefreshDateAttribute">
					<parameter name="dateAttributeId" value="jbr.visa.income_date" />
					<parameter name="updateIfNullOnly" value="true" />
				</post-process>
		</specific>
		
		<!-- Создание карточки Независимое поручение (1255) -->
		<specific property="template" value="jbr.independent.resolution">
			<!-- Заполянем поле ФИО и должность подписавшего текущим пользователем -->
			<post-process class="SetCurrentPersonTo" runOrder="5">
				<parameter name="personAttribute" value="jbr.resolution.FioSign" />
				<parameter name="checkIsLinked" value="false" />
				<parameter name="userSubordinate" value="BOSS" />
				<parameter name="addUserIfEmptySubordinate" value="true" />
			</post-process>
			<!-- Задаем вид документа по умолчанию -->
			<post-process class="SetAttributeValueForCardlinkProcessor" runOrder="15">
				<parameter name="attributeId" value="link:jbr.reg.doctype" />
				<parameter name="templateId" value="typeOfDoc" />
				<parameter name="value" value="Независимое поручение" />
			</post-process>
			<!-- Заполняем контрольность значением по умолчанию (Не на контроле) -->
			<post-process class="SetAttributeValueProcessor" runOrder="20">
				<parameter name="attributeId"       value="list:jbr.incoming.oncontrol" />
				<parameter name="value"             value="jbr.incoming.control.no" />
				<parameter name="onlyCurrentCard"   value="true" />
				<parameter name="saveKind"          value="NO_SAVE" />
			</post-process>
		</specific>
		<!-- для всех шаблонов, кроме Зона ДОУ при создании прописываем Зону ДОУ Автора -->
		<specific property="template" value="jbr.zoneDOW" equals="false">
			<post-process class="SetCurrentPersonTo" runOrder="15">
				<parameter name="cardlinkAttribute" value="jbr.zoneDOW"/>
				<parameter name="checkIsLinked" value="false"/>
				<parameter name="forceSaveCard" value="true"/>
				<parameter name="userSubordinate" value="BY_RULE"/>
				<parameter name="addOnlyIfDestIsEmpty" value="true"/>
				<parameter name="calcUserPostRule" value="
						user:AUTHOR
						-> link:jbr.zoneDOW" />
				<parameter name="addUserIfEmptySubordinate" value="false"/>
			</post-process>
		</specific>
		
			<!-- При создании ОРД/НПА/Внутр атрибут Зона ДОУ на основе Зоны ДОУ ФИО Подписанта документа и Автора (предыдущее значение перед изменением очищать) -->
		<specific property="template" value="jbr.ord" equals="true">
			<post-process class="CopyAttributeFromParent" runOrder="18">
				<parameter name="isOnlyModel" value="true" />
				<parameter name="from" value="jbr.zoneDOW"/>
				<parameter name="to" value="jbr.zoneDOW"/>
				<parameter name="parent" value="jbr.outcoming.signatory"/>
				<parameter name="parentTemplate" value="jbr.internalPerson"/>
				<parameter name="writeOperation" value="append" />
				<parameter name="type" value="C"/>
			</post-process>
		</specific>
		
			<!-- При создании ОРД/НПА/Внутр атрибут Зона ДОУ на основе Зоны ДОУ ФИО Подписанта документа и Автора (предыдущее значение перед изменением очищать) -->
		<specific property="template" value="jbr.npa" equals="true">
			<post-process class="CopyAttributeFromParent" runOrder="18">
				<parameter name="isOnlyModel" value="true" />
				<parameter name="from" value="jbr.zoneDOW"/>
				<parameter name="to" value="jbr.zoneDOW"/>
				<parameter name="parent" value="jbr.outcoming.signatory"/>
				<parameter name="parentTemplate" value="jbr.internalPerson"/>
				<parameter name="writeOperation" value="append" />
				<parameter name="type" value="C"/>
			</post-process>
		</specific>

			<!-- При создании ОРД/НПА/Внутр атрибут Зона ДОУ на основе Зоны ДОУ ФИО Подписанта документа и Автора (предыдущее значение перед изменением очищать) -->
		<specific property="template" value="jbr.interndoc" equals="true">
			<post-process class="CopyAttributeFromParent" runOrder="18">
				<parameter name="isOnlyModel" value="true" />
				<parameter name="from" value="jbr.zoneDOW"/>
				<parameter name="to" value="jbr.zoneDOW"/>
				<parameter name="parent" value="jbr.outcoming.signatory"/>
				<parameter name="parentTemplate" value="jbr.internalPerson"/>
				<parameter name="writeOperation" value="append" />
				<parameter name="type" value="C"/>
			</post-process>
		</specific>
		
		<!-- Создание ОГ jbr.citizenrequest=jbr.incomingpeople=864 -->
		<specific property="template" value="jbr.citizenrequest" equals="true">
			<!-- Задаем журнал регистрации по умолчанию -->
			<post-process class="SetAttributeValueForCardlinkProcessor" runOrder="10">
				<parameter name="attributeId" value="link:regjournal" />
				<parameter name="templateId" value="jbr.journal" />
				<parameter name="value" value="Журнал учета входящих обращений граждан (ОГ)" />
				<parameter name="onlyCurrentCard" value="true" />
				<parameter name="saveKind" value="NO_SAVE" />
			</post-process>
			<!-- Задаем вид обращения по умолчанию -->
			<post-process class="SetAttributeValueProcessor" runOrder="20">
				<parameter name="attributeId" value="list:jbr.reg.requestType" />
				<parameter name="value" value="jbr.reg.requestType.statement" />
				<parameter name="onlyCurrentCard" value="true" />
				<parameter name="saveKind" value="NO_SAVE" />
			</post-process>
			<!-- Задаем формат обращения по умолчанию -->
			<post-process class="SetAttributeValueProcessor" runOrder="30">
				<parameter name="attributeId" value="list:jbr.address.format" />
				<parameter name="value" value="jbr.address.format.letter" />
				<parameter name="onlyCurrentCard" value="true" />
				<parameter name="saveKind" value="NO_SAVE" />
			</post-process>
			<!-- Ставим "На контроле" значение "нет" -->
			<post-process class="SetAttributeValueProcessor" runOrder="40">
				<parameter name="attributeId" value="list:jbr.incoming.oncontrol" />
				<parameter name="value" value="jbr.incoming.control.no" />
				<parameter name="onlyCurrentCard" value="true" />
				<parameter name="saveKind" value="NO_SAVE" />
			</post-process>
			<!-- 34703/34735 Устанавливаем "Срок исполнения или предоставления ответа" как дата создания +29 дней -->
			<post-process class="RefreshDateAttribute" runOrder="50">
				<parameter name="dateAttributeId" value="jbr.incoming.deadline" />
				<parameter name="updateIfNullOnly" value="true" />
				<parameter name="dateOffset" value="+29d" />
			</post-process>
			<!-- Установить время 23:59:59 в атрибуте "Срок исполнения или предоставления ответа" -->
			<post-process class="SetTimeToDateAttribute" runOrder="60">
				<parameter name="dateAttributeId" value="jbr.incoming.deadline" />
				<parameter name="hours" value="23" />
				<parameter name="minutes" value="59" />
				<parameter name="seconds" value="59" />
			</post-process>
			<!-- Ставим "ДСП" значение "нет" -->
			<post-process class="SetAttributeValueProcessor" runOrder="70">
				<parameter name="attributeId" value="list:jbr.dsp" />
				<parameter name="value" value="jbr.noDsp" />
				<parameter name="onlyCurrentCard" value="true" />
				<parameter name="saveKind" value="NO_SAVE" />
			</post-process>
		</specific>
		<specific property="template" value="jbr.user.settings" equals="true">
				<post-process class="ForceSaveCardProcessor" runOrder="30">
				</post-process>
		</specific>
	</action>
	<!-- ===================================================== -->
	<action package="com.aplana.dbmi.jbr.processors" type="AddDigitalSignature">
		<query package="com.aplana.dbmi.jbr.query" class="DoAddDigitalSignature" />
	</action>
	
	<!-- Получение карточек вложений  документа. Параметром может быть карточка документа, карточка подписи-->
	<action type="GetAttachments" package="com.aplana.dbmi.jbr.processors">
		<query class="DoGetAttachments" package="com.aplana.dbmi.jbr.processors"/>
	</action>
	
</queries>

